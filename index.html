<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìì‚° í”Œë˜ë„ˆ</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="config.js"></script>
    <script type="text/babel" src="modals.js"></script>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.css" />
    <style>
        * { font-family: 'Pretendard', sans-serif !important; }
        input, select, button, textarea { font-family: 'Pretendard', sans-serif !important; }
        input[type="number"] { font-weight: 600 !important; }
        .tabular-nums { font-variant-numeric: tabular-nums; }
        @keyframes slideUpFade {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-toast { animation: slideUpFade 0.3s ease-out forwards; }
        .animate-flip { animation: flipIn 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        @keyframes flipIn { from { transform: rotateY(90deg); opacity: 0; } to { transform: rotateY(0); opacity: 1; } }
        /* ì»¤ìŠ¤í…€ ìŠ¤í¬ë¡¤ë°” */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: rgba(156, 163, 175, 0.5); border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background-color: rgba(107, 114, 128, 0.8); }
    </style>
    <script src="defaultData.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/decimal.js/10.4.3/decimal.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-gradient@0.6.1/dist/chartjs-plugin-gradient.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // [ì¶”ê°€] ì¸ì•± ë¸Œë¼ìš°ì €(ì¹´ì¹´ì˜¤í†¡) ê°ì§€ ë° ì™¸ë¶€ ë¸Œë¼ìš°ì € ì „í™˜ ìŠ¤í¬ë¦½íŠ¸
        (function() {
            const userAgent = navigator.userAgent.toLowerCase();
            const targetUrl = window.location.href;

            if (userAgent.indexOf('kakaotalk') > -1) {
                if (userAgent.indexOf('android') > -1) {
                    location.href = 'intent://' + targetUrl.replace(/https?:\/\//i, '') + '#Intent;scheme=https;end';
                } else if (userAgent.indexOf('iphone') > -1 || userAgent.indexOf('ipad') > -1) {
                    location.href = 'kakaotalk://web/openExternal?url=' + encodeURIComponent(targetUrl);
                }
            }
        })();
    </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-200 font-sans">
    <div id="root"></div>

    <script type="text/babel">
            const { useState, useMemo, useEffect, useRef } = React;

        // [ì¶”ê°€] ìŠ¤ë§ˆíŠ¸ íˆ´íŒ ê°€ì´ë“œ ì»´í¬ë„ŒíŠ¸
        const TooltipGuide = ({ tip }) => (
            <div className="group relative inline-block ml-1 align-middle">
                <svg className="w-4 h-4 text-gray-400 cursor-help hover:text-blue-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                <div className="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-56 p-2.5 bg-gray-800/95 backdrop-blur text-white text-xs rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50 text-center leading-relaxed border border-gray-700 font-normal">
                    {tip}
                    <div className="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-800/95"></div>
                </div>
            </div>
        );

        // [í†µí•©] SummaryPanel.js ë‚´ìš© (CORS ì˜¤ë¥˜ í•´ê²°ì„ ìœ„í•´ íŒŒì¼ ë³‘í•©)
        const AssetSummaryCard = ({ calculation, projectionMonths, baseMonth, displayMode }) => {
            const formatNumber = window.formatNumber || ((n) => Number(n || 0).toLocaleString());
            const formatPercent = window.formatPercent || ((n) => (Number(n || 0)).toFixed(1));
            const TEXTS = window.TEXTS || {};
            const lastProj = calculation.monthlyProjections && calculation.monthlyProjections[projectionMonths - 1];
            let compLabel = "";
            let compVal = 0;
            let compPct = 0;
        
            if (!calculation.error && projectionMonths >= 1 && calculation.monthlyProjections?.length >= projectionMonths) {
                if (projectionMonths <= 12) {
                    const prevProj = projectionMonths > 1 ? calculation.monthlyProjections[projectionMonths - 2] : { gross: calculation.currentGross };
                    compVal = lastProj.gross - prevProj.gross;
                    compPct = prevProj.gross !== 0 ? (compVal / Math.abs(prevProj.gross)) * 100 : 0;
                    compLabel = "ì „ì›” ëŒ€ë¹„";
                } else {
                    const prevProj = calculation.monthlyProjections[projectionMonths - 12];
                    compVal = lastProj.gross - prevProj.gross;
                    compPct = prevProj.gross !== 0 ? (compVal / Math.abs(prevProj.gross)) * 100 : 0;
                    compLabel = "1ë…„ ì „ ëŒ€ë¹„";
                }
            }
        
            return (
                <div className="md:col-span-1 bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-blue-900/40 dark:to-indigo-900/40 rounded-xl shadow-lg p-6">
                    <div>
                        <h2 className="text-lg font-semibold mb-2 text-gray-600 dark:text-white">{TEXTS.summary?.currentTotal || "í˜„ì¬ ì´ìì‚°"}</h2>
                        <div className="flex items-end gap-2">
                            <p className="text-3xl font-bold text-blue-600 dark:text-blue-400">{formatNumber(calculation.currentGross, displayMode)}ë§Œì›</p>
                            <span className="text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">(ìˆœìì‚° {formatNumber(calculation.currentNet, displayMode)}ë§Œì›)</span>
                        </div>
                    </div>
                    <div className="mt-6"> 
                        <h2 className="text-lg font-semibold mb-2 text-gray-600 dark:text-white">{projectionMonths}{TEXTS.summary?.projectedTotal || "ê°œì›” í›„ ì˜ˆìƒ"} <span className="text-gray-400 text-sm">({(() => { try { const [y,m]= (baseMonth||'').split('-').map(Number); const d = new Date(y||new Date().getFullYear(), (m||1)-1, 1); d.setMonth(d.getMonth()+projectionMonths); return `${String(d.getFullYear()).slice(2)}ë…„ ${String(d.getMonth()+1).padStart(2,'0')}ì›”`; } catch { return ''; } })()})</span></h2>
                        <div className="flex items-end gap-2">
                            <p className="text-3xl font-bold text-green-600 dark:text-green-400">{formatNumber(calculation.projectedGross, displayMode)}ë§Œì›</p>
                            <span className="text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">(ìˆœìì‚° {formatNumber(calculation.projectedNet, displayMode)}ë§Œì›)</span>
                        </div>
                        <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">{TEXTS.summary?.expectedIncrease || "ì˜ˆìƒ ì¦ê°€ì•¡"}: +{formatNumber(calculation.growth, displayMode)}ë§Œì› ({formatPercent((calculation.growth) / Math.max(1, calculation.currentGross) * 100)}%)</p>         
                        {compLabel && (
                            <p className="text-xs text-gray-400 mt-1">
                                ({compLabel}: {compVal >= 0 ? '+' : ''}{formatNumber(compVal, displayMode)}ë§Œì›, {compVal >= 0 ? '+' : ''}{formatPercent(compPct)}%)
                            </p>
                        )}
                        <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">
                            {TEXTS.summary?.inflationAdjusted || "ì¸í”Œë ˆì´ì…˜ ê³ ë ¤ ì‹œ"}: {formatNumber(calculation.realValue, displayMode)}ë§Œì›
                            <TooltipGuide tip="ë¬¼ê°€ ìƒìŠ¹ë¥ ì„ ë°˜ì˜í•˜ì—¬ í˜„ì¬ ê°€ì¹˜ë¡œ í™˜ì‚°í•œ ê¸ˆì•¡ì…ë‹ˆë‹¤." />
                        </p>
                        {calculation.fireMetrics && (
                            <div className="mt-6 pt-6 border-t border-blue-200 dark:border-blue-800">
                                <h3 className="text-[10px] font-bold text-indigo-500 dark:text-indigo-400 uppercase tracking-wider mb-3 flex items-center">
                                    {TEXTS.summary?.fireAnalysis || "ìë¦½ ê°€ëŠ¥ì„± ë¶„ì„ (FIRE Analysis)"}
                                    <TooltipGuide tip="ê²½ì œì  ìë¦½ì„ í†µí•´ ì¡°ê¸° ì€í‡´ê°€ ê°€ëŠ¥í•œì§€ ë¶„ì„í•©ë‹ˆë‹¤." />
                                </h3>
                                <div className="grid grid-cols-1 gap-3">
                                    <div className="flex justify-between items-center p-2 bg-white dark:bg-gray-800 rounded-lg border border-gray-100 dark:border-gray-700">
                                        <span className="text-xs text-gray-500 flex items-center">
                                            {TEXTS.summary?.survivalPeriod || "ìƒì¡´ ê°€ëŠ¥ ê¸°ê°„"}
                                            <TooltipGuide tip="ì¶”ê°€ ì†Œë“ ì—†ì´ í˜„ì¬ ìì‚°ìœ¼ë¡œ ìƒí™œ ê°€ëŠ¥í•œ ì˜ˆìƒ ê¸°ê°„ì…ë‹ˆë‹¤." />
                                        </span>
                                        <span className="text-xs font-bold text-gray-900 dark:text-white">
                                            {calculation.totalMonthlyExpense > 0 ? (
                                                calculation.fireMetrics.runwayMonths >= 1200 ? '100ë…„ ì´ìƒ' : `${Math.floor(calculation.fireMetrics.runwayMonths / 12)}ë…„ ${calculation.fireMetrics.runwayMonths % 12}ê°œì›”`
                                            ) : (
                                                <span className="text-red-500">ì§€ì¶œ ì„¤ì • í•„ìš”</span>
                                            )}
                                        </span>
                                    </div>
                                    <div className="flex justify-between items-center p-2 bg-white dark:bg-gray-800 rounded-lg border border-gray-100 dark:border-gray-700">
                                        <span className="text-xs text-gray-500 flex items-center">
                                            {TEXTS.summary?.fireNeeded || "FIRE (4% ë²•ì¹™) í•„ìš”ìì‚°"}
                                            <TooltipGuide tip="ì—°ê°„ ì§€ì¶œì˜ 25ë°°ë¥¼ ëª¨ìœ¼ë©´ ë§¤ë…„ 4%ì”© ì¸ì¶œí•´ë„ ì›ê¸ˆì´ ìœ ì§€ëœë‹¤ëŠ” ë²•ì¹™ì…ë‹ˆë‹¤." />
                                        </span>
                                        <span className="text-xs font-bold text-gray-900 dark:text-white">
                                            {calculation.totalMonthlyExpense > 0 ? formatNumber(calculation.fireMetrics.swr4PercentCapital, displayMode) + 'ë§Œì›' : '-'}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const CoreSettingsCard = ({
            monthlySalary, setMonthlySalary, baseMonth, setBaseMonth,
            setIsExportModalOpen, setIsImportModalOpen,
            exportToCSV, importFromCSV, saveToPDF, saveCurrentAsset, saveScenario
        }) => {
            const TEXTS = window.TEXTS || {};
            return (
                <div className="md:col-span-1 bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6"> 
                    <h2 className="text-xl font-bold text-gray-800 dark:text-white mb-4">{TEXTS.settings?.coreSettings || "í•µì‹¬ ì„¤ì •"}</h2>
                    <div className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 dark:text-white mb-1">{TEXTS.settings?.monthlySalary || "ì›” ê³ ì • ìˆ˜ì… (ë§Œì›)"}</label>
                            <input type="number" className="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" value={monthlySalary} onChange={(e) => setMonthlySalary(Number(e.target.value))} />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 dark:text-white mb-1">{TEXTS.settings?.baseMonth || "ê¸°ì¤€ì›” (ê³„ì‚° ì‹œì‘)"}</label>
                            <input type="month" className="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" value={baseMonth} onChange={(e) => setBaseMonth(e.target.value)} />
                        </div>
                        <div className="pt-4 border-t dark:border-gray-700">
                            <h3 className="text-sm font-bold text-gray-700 dark:text-white mb-2">{TEXTS.settings?.dataManagement || "ë°ì´í„° ê´€ë¦¬"}</h3>
                            <div className="grid grid-cols-2 gap-2">
                                <button onClick={() => setIsExportModalOpen(true)} className="flex items-center justify-center gap-2 px-2 py-2 bg-emerald-500 text-white text-sm font-semibold rounded-lg hover:bg-emerald-600 shadow-sm transition-all">
                                    <span>ğŸ“¤</span> {TEXTS.settings?.exportData || "ë°ì´í„° ë‚´ë³´ë‚´ê¸°"}
                                </button>
                                <button onClick={() => setIsImportModalOpen(true)} className="flex items-center justify-center gap-2 px-2 py-2 bg-purple-500 text-white text-sm font-semibold rounded-lg hover:bg-purple-600 shadow-sm transition-all">
                                    <span>ğŸ“¥</span> {TEXTS.settings?.importData || "ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°"}
                                </button>
                                <div className="col-span-2 mt-2">
                                    <h4 className="text-sm font-bold text-gray-500 dark:text-gray-400 mb-2 px-1 uppercase tracking-wider">ë‚´ë³´ë‚´ê¸°</h4>
                                    <div className="grid grid-cols-2 gap-2">
                                        <button onClick={exportToCSV} className="flex items-center justify-center gap-2 px-2 py-2 bg-emerald-500 text-white text-sm font-semibold rounded-lg hover:bg-emerald-600 shadow-sm transition-all">
                                            <span>ğŸ“Š</span> {TEXTS.settings?.exportCSV || "CSV ë‚´ë³´ë‚´ê¸°"}
                                        </button>
                                        <label className="flex items-center justify-center gap-2 px-2 py-2 bg-purple-500 text-white text-sm font-semibold rounded-lg hover:bg-purple-600 shadow-sm transition-all cursor-pointer">
                                            <span>ğŸ“¥</span> {TEXTS.settings?.importCSV || "CSV ë¶ˆëŸ¬ì˜¤ê¸°"}
                                            <input type="file" accept=".csv" onChange={importFromCSV} className="hidden" />
                                        </label>
                                    </div>
                                </div>
                                <button onClick={saveCurrentAsset} className="flex items-center justify-center gap-2 px-3 py-2 bg-indigo-500 text-white text-sm font-semibold rounded-lg hover:bg-indigo-600 shadow-sm hover:shadow-md transition-all mt-2">
                                    <span>ğŸ’¾</span> {TEXTS.settings?.saveHistory || "íˆìŠ¤í† ë¦¬ ì €ì¥"}
                                </button>
                                <button onClick={saveScenario} className="flex items-center justify-center gap-2 px-3 py-2 bg-gray-600 text-white text-sm font-semibold rounded-lg hover:bg-gray-700 shadow-sm hover:shadow-md transition-all mt-2">
                                    <span>ğŸ’¾</span> ì‹œë‚˜ë¦¬ì˜¤ ì €ì¥
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const GoalSettingsCard = ({
            goalMode, setGoalMode, setGoalSeekResult,
            projectionMonths, setProjectionMonths, targetAmount, setTargetAmount,
            calculateGoalSeek, goalSeekResult,
            inflationRate, setInflationRate
        }) => {
            const TEXTS = window.TEXTS || {};
            const [isPlaying, setIsPlaying] = useState(false);

            useEffect(() => {
                let interval;
                if (isPlaying) {
                    setProjectionMonths(prev => prev >= 120 ? 0 : prev);
                    interval = setInterval(() => {
                        setProjectionMonths(prev => {
                            if (prev >= 120) { setIsPlaying(false); return 120; }
                            return prev + 1;
                        });
                    }, 100);
                }
                return () => clearInterval(interval);
            }, [isPlaying, setProjectionMonths]);

            return (
                <div className="md:col-span-1 bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6"> 
                    <h2 className="text-xl font-bold text-gray-800 dark:text-white mb-4">{TEXTS.settings?.goalSettings || "ëª©í‘œ ì„¤ì •"}</h2>
                    <div className="mb-4">
                        <div className="flex border border-gray-200 dark:border-gray-700 rounded-lg p-1 bg-gray-100 dark:bg-gray-900">
                            <button onClick={() => { setGoalMode('period'); setGoalSeekResult(null); }} className={`flex-1 py-2 text-sm font-semibold rounded-md transition-colors ${goalMode === 'period' ? 'bg-white dark:bg-gray-700 text-blue-600 dark:text-blue-400 shadow' : 'text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-800'}`}>
                                {TEXTS.settings?.periodBased || "ê¸°ê°„ ê¸°ì¤€"}
                            </button>
                            <button onClick={() => setGoalMode('target')} className={`flex-1 py-2 text-sm font-semibold rounded-md transition-colors ${goalMode === 'target' ? 'bg-white dark:bg-gray-700 text-blue-600 dark:text-blue-400 shadow' : 'text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-800'}`}>
                                {TEXTS.settings?.assetBased || "ìì‚° ê¸°ì¤€"}
                            </button>
                        </div>
                    </div>
                    <div className="space-y-4"> 
                        {goalMode === 'period' ? (
                            <div>
                                <div className="flex justify-between items-center mb-2">
                                    <label className="text-sm font-medium text-gray-700 dark:text-white">{TEXTS.settings?.expectedPeriod || "ì˜ˆìƒ ê¸°ê°„"}</label>
                                    <span className="text-sm font-bold text-blue-600 dark:text-blue-400">{projectionMonths}ê°œì›” í›„</span>
                                </div>
                                <div className="flex items-center gap-3">
                                    <button 
                                        onClick={() => setIsPlaying(!isPlaying)}
                                        className={`p-2 rounded-full transition-colors flex-shrink-0 ${isPlaying ? 'bg-red-100 text-red-600 hover:bg-red-200 dark:bg-red-900/30 dark:text-red-400' : 'bg-blue-100 text-blue-600 hover:bg-blue-200 dark:bg-blue-900/30 dark:text-blue-400'}`}
                                        title={isPlaying ? "ì •ì§€" : "íƒ€ì„ë©ìŠ¤ ì¬ìƒ"}
                                    >
                                        {isPlaying ? <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg> : <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>}
                                    </button>
                                    <input 
                                        type="range" 
                                        min="0" 
                                        max="120" 
                                        step="1" 
                                        className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700 accent-blue-600"
                                        value={projectionMonths} 
                                        onChange={(e) => { setProjectionMonths(Number(e.target.value)); setIsPlaying(false); }} 
                                    />
                                </div>
                                <div className="flex justify-between text-xs text-gray-400 mt-1 px-1">
                                    <span>í˜„ì¬</span>
                                    <span>5ë…„</span>
                                    <span>10ë…„</span>
                                </div>
                            </div>
                        ) : (
                            <div className="space-y-2">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 dark:text-white mb-1">{TEXTS.settings?.targetAsset || "ëª©í‘œ ìì‚° (ë§Œì›)"}</label>
                                    <input type="number" className="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-green-500" value={targetAmount} onChange={(e) => setTargetAmount(Number(e.target.value))} />
                                </div>
                                <button onClick={calculateGoalSeek} className="w-full bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 font-semibold shadow-sm hover:shadow-md transition-all">
                                    {TEXTS.settings?.calcGoal || "ë‹¬ì„± ê¸°ê°„ ê³„ì‚°"}
                                </button>
                            </div>
                        )}
                        <div>
                            <label className="block text-sm font-medium text-gray-700 dark:text-white mb-1">{TEXTS.settings?.inflationRate || "ì—°ê°„ ì¸í”Œë ˆì´ì…˜ ì¦ê°€ìœ¨ (%)"}</label>
                            <input type="number" step="0.1" className="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" value={inflationRate} onChange={(e) => setInflationRate(Number(e.target.value))} />
                        </div>
                        {goalMode === 'target' && goalSeekResult && (
                            <div className="mt-2 p-3 bg-green-50 dark:bg-green-900/30 border border-green-200 dark:border-green-800 rounded-lg">
                                <p className="text-green-800 dark:text-green-300 font-medium text-center">{goalSeekResult}</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const SummaryPanel = (props) => {
            return (
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 transition-colors">
                    <AssetSummaryCard {...props} />
                    <CoreSettingsCard {...props} />
                    <GoalSettingsCard {...props} />
                </div>
            );
        };

        // [ì¶”ê°€] ì‹¤í–‰ ì·¨ì†Œ/ë‹¤ì‹œ ì‹¤í–‰ í›… (Undo/Redo) - ë””ë°”ìš´ì‹± í¬í•¨
        const useUndoRedo = (initialState) => {
            // [ìˆ˜ì •] ìƒíƒœ ê´€ë¦¬ë¥¼ í•˜ë‚˜ì˜ ê°ì²´ë¡œ í†µí•©í•˜ì—¬ setState ë‚´ë¶€ ì‚¬ì´ë“œ ì´í™íŠ¸ ì œê±°
            const [history, setHistory] = useState({
                past: [],
                present: initialState,
                future: []
            });
            const { past, present, future } = history;
            
            // [ì¶”ê°€] ìƒíƒœ ë™ê¸°í™”ë¥¼ ìœ„í•œ Ref (ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë‚´ ìµœì‹  ìƒíƒœ ì°¸ì¡°ìš©)
            const historyRef = useRef(history);
            useEffect(() => { historyRef.current = history; }, [history]);
            
            const lastHistoryTime = useRef(0);

            const set = React.useCallback((newState) => {
                const curr = historyRef.current;
                const computedState = typeof newState === 'function' ? newState(curr.present) : newState;
                
                // ìƒíƒœê°€ ë³€ê²½ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ë¦¬í„´
                if (JSON.stringify(curr.present) === JSON.stringify(computedState)) return;

                const now = Date.now();
                const shouldSave = now - lastHistoryTime.current > 500;

                if (shouldSave) {
                    lastHistoryTime.current = now;
                    setHistory(prev => ({
                        past: [...prev.past, prev.present].slice(-30),
                        present: computedState,
                        future: []
                    }));
                } else {
                    setHistory(prev => ({
                        ...prev,
                        present: computedState,
                        future: []
                    }));
                }
            }, []);

            const undo = React.useCallback(() => {
                setHistory(curr => {
                    if (curr.past.length === 0) return curr;
                    const previous = curr.past[curr.past.length - 1];
                    const newPast = curr.past.slice(0, curr.past.length - 1);
                    return {
                        past: newPast,
                        present: previous,
                        future: [curr.present, ...curr.future]
                    };
                });
                lastHistoryTime.current = Date.now();
            }, []);

            const redo = React.useCallback(() => {
                setHistory(curr => {
                    if (curr.future.length === 0) return curr;
                    const next = curr.future[0];
                    const newFuture = curr.future.slice(1);
                    return {
                        past: [...curr.past, curr.present],
                        present: next,
                        future: newFuture
                    };
                });
                lastHistoryTime.current = Date.now();
            }, []);

            const reset = React.useCallback((newState) => {
                setHistory({
                    past: [],
                    present: newState,
                    future: []
                });
            }, []);

            return { state: present, setState: set, undo, redo, canUndo: past.length > 0, canRedo: future.length > 0, reset };
        };

        // [ìˆ˜ì •] íŒ¨ë„ ë˜í¼ ì»´í¬ë„ŒíŠ¸ (ì ‘ê¸°/í´ê¸° ê¸°ëŠ¥ ì¶”ê°€)
        const PanelWrapper = ({ id, title, moveUp, moveDown, isFirst, isLast, isCollapsed, onToggle, children, className = "bg-white dark:bg-gray-900 rounded-lg shadow" }) => {
            return (
                <div id={id}>
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-semibold text-gray-700 dark:text-white flex items-center gap-2 cursor-pointer group" onClick={onToggle}>
                            <svg xmlns="http://www.w3.org/2000/svg" className={`h-5 w-5 text-gray-500 transform transition-transform duration-200 ${!isCollapsed ? 'rotate-90' : ''}`} viewBox="0 0 20 20" fill="currentColor">
                                <path fillRule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clipRule="evenodd" />
                            </svg>
                            <span className="group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">{title}</span>
                        </h2>
                        <div className="flex items-center gap-1">
                            <button 
                                type="button"
                                onClick={moveUp} 
                                disabled={isFirst} 
                                className="p-1.5 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 disabled:opacity-30 disabled:cursor-not-allowed active:scale-90 transition-transform"
                                title="ìœ„ë¡œ ì´ë™"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fillRule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clipRule="evenodd" />
                                </svg>
                            </button>
                            <button 
                                type="button"
                                onClick={moveDown} 
                                disabled={isLast} 
                                className="p-1.5 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 disabled:opacity-30 disabled:cursor-not-allowed active:scale-90 transition-transform"
                                title="ì•„ë˜ë¡œ ì´ë™"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fillRule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clipRule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    {!isCollapsed && (
                        <div className={className}>
                            {children}
                        </div>
                    )}
                </div>
            );
        };

        // [ì¶”ê°€] ë¦¬ë°¸ëŸ°ì‹± ì‹œê°í™”ë¥¼ ìœ„í•œ ëˆ„ì  ë§‰ëŒ€ ê·¸ë˜í”„ ì»´í¬ë„ŒíŠ¸
        const StackedBarDisplay = ({ targets, sectorInfo }) => {
            const validSectors = Object.keys(sectorInfo).filter(k => k !== 'loan');
            const defaultPct = Math.round(100 / validSectors.length);
            
            const total = validSectors.reduce((sum, key) => {
                return sum + (targets[key] ?? defaultPct);
            }, 0);

            // 100% ê¸°ì¤€ìœ¼ë¡œ ë¹„ìœ¨ ì¬ê³„ì‚° (ì •ê·œí™”)
            const normalizedTargets = validSectors.map(key => {
                const value = targets[key] ?? defaultPct;
                return {
                    key: key,
                    name: sectorInfo[key].name,
                    color: sectorInfo[key].color,
                    percentage: total === 0 ? 0 : (value / total) * 100,
                    originalValue: value
                };
            });

            return (
                <div className="w-full mb-4">
                    <div className="flex h-6 w-full rounded-full overflow-hidden border border-gray-300 dark:border-gray-600 bg-gray-200 dark:bg-gray-700">
                        {normalizedTargets.map(item => (
                            <div
                                key={item.key}
                                className={`flex items-center justify-center bg-${item.color}-500 transition-all duration-300`}
                                style={{ width: `${item.percentage}%` }}
                                title={`${item.name}: ${item.originalValue}%`}
                            >
                                <span className="text-xs font-medium text-white overflow-hidden whitespace-nowrap px-1">
                                    {item.percentage > 10 ? `${item.originalValue}%` : ''}
                                </span>
                            </div>
                        ))}
                    </div>
                    {total !== 100 && (
                        <div className="text-right text-xs text-red-600 dark:text-red-400 mt-1">
                            ì´í•©ì´ {total}%ì…ë‹ˆë‹¤. 100%ë¡œ ì¡°ì •í•´ì£¼ì„¸ìš”.
                        </div>
                    )}
                </div>
            );
        };

        // [ì¶”ê°€] ì‹œì¥ ì§€í‘œ ìœ„ì ¯
        const MarketDataWidget = ({ darkMode }) => {
            const [currentIndex, setCurrentIndex] = useState(0);
            const canvasRef = useRef(null);
            const chartInstance = useRef(null);
            const [isLoading, setIsLoading] = useState(false);
            const [isLive, setIsLive] = useState(false);
            const [marketItems, setMarketItems] = useState([
                { name: 'USD/KRW', value: '1,340.50', change: '+0.5%', color: 'red', data: [1328, 1330, 1332, 1335, 1331, 1334, 1338, 1340, 1342, 1339, 1335, 1330, 1328, 1332, 1335, 1338, 1340, 1345, 1342, 1340, 1338, 1335, 1332, 1330, 1335, 1338, 1340, 1342, 1341, 1340.50] },
                { name: 'S&P 500', value: '5,120.30', change: '+1.2%', color: 'green', data: [4700, 4720, 4750, 4730, 4780, 4800, 4820, 4850, 4840, 4880, 4900, 4920, 4910, 4950, 4980, 5000, 5020, 5010, 5050, 5080, 5100, 5090, 5120, 5150, 5140, 5160, 5150, 5130, 5120, 5120.30] },
                { name: 'NASDAQ', value: '16,050.20', change: '+1.5%', color: 'green', data: [15780, 15800, 15820, 15850, 15830, 15860, 15880, 15900, 15890, 15920, 15940, 15960, 15950, 15980, 16000, 16020, 16010, 16030, 16040, 16020, 16000, 15980, 16000, 16020, 16040, 16060, 16050, 16030, 16040, 16050.20] },
                { name: 'Bitcoin', value: '$65,400', change: '-0.8%', color: 'blue', data: [63800, 64000, 64200, 64500, 64300, 64600, 64800, 65000, 64900, 65200, 65400, 65600, 65500, 65800, 66000, 66200, 66100, 66300, 66400, 66200, 66000, 65800, 66000, 66200, 66400, 66600, 66500, 66300, 66400, 65400] },
                { name: 'Gold', value: '$2,150.00', change: '+0.3%', color: 'orange', data: [2095, 2100, 2105, 2110, 2108, 2112, 2115, 2120, 2118, 2122, 2125, 2130, 2128, 2132, 2135, 2140, 2138, 2142, 2145, 2142, 2140, 2138, 2140, 2142, 2145, 2148, 2145, 2142, 2145, 2150] }
            ]);

            // [ì¶”ê°€] ì‹¤ì œ API ë°ì´í„° í˜ì¹­ í•¨ìˆ˜ (ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ ì§€ì›)
            const fetchMarketData = React.useCallback(async () => {
                setIsLoading(true);
                    // Yahoo Finance ë°ì´í„° ê°€ì ¸ì˜¤ê¸° í—¬í¼ (CORS í”„ë¡ì‹œ ì‚¬ìš©)
                    const fetchYahooData = async (symbol) => {
                        try {
                            // 1ê°œì›”ì¹˜ ì¼ë´‰ ë°ì´í„° ìš”ì²­
                            const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?range=1mo&interval=1d`;
                            const response = await fetch(`https://corsproxy.io/?` + encodeURIComponent(url));
                            const json = await response.json();
                            
                            const result = json.chart.result[0];
                            const quotes = result.indicators.quote[0];
                            const prices = quotes.close.filter(p => p !== null); // null ê°’ ì œê±°
                            
                            // í˜„ì¬ê°€ ë° ë³€ë™ë¥  ê³„ì‚°
                            const currentPrice = prices[prices.length - 1];
                            const prevPrice = prices[prices.length - 2] || currentPrice;
                            const changePct = ((currentPrice - prevPrice) / prevPrice * 100);
                            
                            return {
                                price: currentPrice,
                                change: changePct,
                                data: prices
                            };
                        } catch (e) {
                            console.warn(`Failed to fetch ${symbol}`, e);
                            return null;
                        }
                    };

                    try {
                        // ë³‘ë ¬ë¡œ ë°ì´í„° ìš”ì²­
                        const [usdData, sp500Data, nasdaqData, goldData, btcRes] = await Promise.all([
                            fetchYahooData('KRW=X'),   // í™˜ìœ¨
                            fetchYahooData('^GSPC'),   // S&P 500
                            fetchYahooData('^IXIC'),   // NASDAQ
                            fetchYahooData('GC=F'),    // ê¸ˆ ì„ ë¬¼
                            fetch(`https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=30&interval=daily`).catch(() => null) // ë¹„íŠ¸ì½”ì¸
                        ]);

                        let successCount = 0;
                        // ë¹„íŠ¸ì½”ì¸ ë°ì´í„° ì²˜ë¦¬
                        let btcData = null;
                        if (btcRes) {
                            const json = await btcRes.json();
                            if (json.prices) {
                                const prices = json.prices.map(p => p[1]);
                                const current = prices[prices.length - 1];
                                const prev = prices[prices.length - 2] || current;
                                btcData = {
                                    price: current,
                                    change: ((current - prev) / prev * 100),
                                    data: prices
                                };
                                successCount++;
                            }
                        }

                        // ìƒíƒœ ì—…ë°ì´íŠ¸ í—¬í¼
                        const updateItem = (item, data, isCurrency = false) => {
                            if (!data) return item;
                            successCount++;
                            const sign = data.change >= 0 ? '+' : '';
                            const color = data.change >= 0 ? 'red' : 'blue'; // í•œêµ­ì‹: ìƒìŠ¹=ë¹¨ê°•
                            const formattedValue = isCurrency 
                                ? `$${data.price.toLocaleString(undefined, {maximumFractionDigits: 2})}`
                                : data.price.toLocaleString(undefined, {maximumFractionDigits: 2});

                            return {
                                ...item,
                                value: formattedValue,
                                change: `${sign}${data.change.toFixed(2)}%`,
                                color: color,
                                data: data.data
                            };
                        };
                        
                        setMarketItems(prev => prev.map(item => {
                            if (item.name === 'USD/KRW') return updateItem(item, usdData, false);
                            if (item.name === 'S&P 500') return updateItem(item, sp500Data, false);
                            if (item.name === 'NASDAQ') return updateItem(item, nasdaqData, false);
                            if (item.name === 'Gold') return updateItem(item, goldData, true);
                            if (item.name === 'Bitcoin') return updateItem(item, btcData, true);
                            return item;
                        }));
                        
                        if (successCount > 0) setIsLive(true);
                    } catch (e) {
                        console.warn("Market data fetch failed, using fallback data", e);
                    } finally {
                        setIsLoading(false);
                    }
            }, []);

            useEffect(() => {
                fetchMarketData();
            }, [fetchMarketData]);

            const currentItem = marketItems[currentIndex];
            const nextItem = () => setCurrentIndex((prev) => (prev + 1) % marketItems.length);
            const prevItem = () => setCurrentIndex((prev) => (prev - 1 + marketItems.length) % marketItems.length);

            useEffect(() => {
                if (canvasRef.current && typeof Chart !== 'undefined') {
                    if (chartInstance.current) chartInstance.current.destroy();
                    const ctx = canvasRef.current.getContext('2d');
                    const isPositive = currentItem.change.startsWith('+');
                    const lineColor = isPositive ? '#ef4444' : '#3b82f6';
                    const bgColor = isPositive ? 'rgba(239, 68, 68, 0.1)' : 'rgba(59, 130, 246, 0.1)';

                    // ìµœê·¼ 30ì¼ ë‚ ì§œ ë¼ë²¨ ìƒì„±
                    const labels = Array.from({length: currentItem.data.length}, (_, i) => {
                        const d = new Date();
                        d.setDate(d.getDate() - (currentItem.data.length - 1 - i));
                        return `${d.getMonth()+1}/${d.getDate()}`;
                    });

                    chartInstance.current = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: currentItem.data,
                                borderColor: lineColor,
                                backgroundColor: bgColor,
                                borderWidth: 2,
                                pointRadius: 0,
                                pointHoverRadius: 4,
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false,
                            },
                            plugins: { 
                                legend: { display: false }, 
                                tooltip: { 
                                    enabled: true,
                                    backgroundColor: darkMode ? 'rgba(255, 255, 255, 0.9)' : 'rgba(0, 0, 0, 0.8)',
                                    titleColor: darkMode ? '#000' : '#fff',
                                    bodyColor: darkMode ? '#000' : '#fff',
                                    displayColors: false,
                                    callbacks: {
                                        label: (context) => {
                                            const val = context.parsed.y;
                                            if (currentItem.name === 'USD/KRW') return `â‚©${val.toLocaleString()}`;
                                            if (['Bitcoin', 'Gold'].includes(currentItem.name)) return `$${val.toLocaleString()}`;
                                            return val.toLocaleString();
                                        }
                                    }
                                } 
                            },
                            scales: { 
                                x: { display: true, ticks: { display: false }, grid: { display: false } }, // Xì¶• ì„ ì€ í‘œì‹œí•˜ë˜ ëˆˆê¸ˆ ìˆ¨ê¹€
                                y: { display: false } 
                            },
                            layout: { padding: 0 },
                            animation: { duration: 0 }
                        }
                    });
                }
                return () => { if (chartInstance.current) chartInstance.current.destroy(); };
            }, [currentIndex, darkMode, currentItem]);

            return (
                <div className="bg-white dark:bg-gray-900 rounded-xl shadow-sm border border-gray-100 dark:border-gray-800 p-4">
                    <div className="flex justify-between items-center mb-2">
                        <div className="flex items-center gap-2">
                            <h3 className="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">ì‹œì¥ ì§€í‘œ</h3>
                            {isLoading ? (
                                <span className="text-[10px] text-blue-500 animate-pulse">ì—…ë°ì´íŠ¸ ì¤‘...</span>
                            ) : (
                                <span className={`text-[10px] ${isLive ? 'text-green-500' : 'text-gray-400'}`}>{isLive ? 'â— ì‹¤ì‹œê°„' : 'â—‹ ë°ëª¨'}</span>
                            )}
                        </div>
                        <div className="flex gap-1">
                            <button onClick={fetchMarketData} className="p-1 hover:bg-gray-100 dark:hover:bg-gray-800 rounded" title="ìƒˆë¡œê³ ì¹¨"><svg className="w-3 h-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg></button>
                            <button onClick={prevItem} className="p-1 hover:bg-gray-100 dark:hover:bg-gray-800 rounded"><svg className="w-3 h-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 19l-7-7 7-7" /></svg></button>
                            <button onClick={nextItem} className="p-1 hover:bg-gray-100 dark:hover:bg-gray-800 rounded"><svg className="w-3 h-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5l7 7-7 7" /></svg></button>
                        </div>
                    </div>
                    <div className="flex flex-col">
                        <div className="flex justify-between items-end mb-2">
                            <div>
                                <div className="text-sm font-bold text-gray-800 dark:text-white">{currentItem.name}</div>
                                <div className="text-lg font-bold text-gray-900 dark:text-gray-100">{currentItem.value}</div>
                            </div>
                            <div className={`text-xs font-bold px-1.5 py-0.5 rounded ${currentItem.change.startsWith('+') ? 'bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-400' : 'bg-blue-100 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400'}`}>
                                {currentItem.change}
                            </div>
                        </div>
                        <div className="h-20 w-full">
                            <canvas ref={canvasRef}></canvas>
                        </div>
                        <div className="flex justify-between text-[10px] text-gray-400 mt-1">
                            <span>30ì¼ ì „</span>
                            <span>ì˜¤ëŠ˜</span>
                        </div>
                    </div>
                </div>
            );
        };

        // [ì¶”ê°€] ìŠ¤ì¼ˆë ˆí†¤ ëŒ€ì‹œë³´ë“œ ì»´í¬ë„ŒíŠ¸
        const SkeletonDashboard = () => {
            const [showReset, setShowReset] = useState(false);

            useEffect(() => {
                const timer = setTimeout(() => setShowReset(true), 3000); // 3ì´ˆ ì´ìƒ ë¡œë”© ì‹œ ì´ˆê¸°í™” ë²„íŠ¼ í‘œì‹œ
                return () => clearTimeout(timer);
            }, []);

            return (
            <div className="min-h-screen bg-gray-50 dark:bg-gray-900 transition-colors duration-200 relative">
                <div className="animate-pulse">
                {/* Header Skeleton */}
                <div className="sticky top-0 z-50 bg-white dark:bg-gray-800 shadow-sm border-b dark:border-gray-700 h-16">
                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-full flex justify-between items-center">
                        <div className="h-8 w-48 bg-gray-200 dark:bg-gray-700 rounded"></div>
                        <div className="hidden sm:flex gap-3">
                            <div className="h-9 w-24 bg-gray-200 dark:bg-gray-700 rounded"></div>
                            <div className="h-9 w-24 bg-gray-200 dark:bg-gray-700 rounded"></div>
                            <div className="h-9 w-24 bg-gray-200 dark:bg-gray-700 rounded"></div>
                        </div>
                    </div>
                </div>

                <div className="p-4 sm:p-6 max-w-[90rem] mx-auto flex flex-col lg:flex-row gap-8">
                    {/* Sidebar Skeleton */}
                    <div className="hidden lg:block w-52 flex-shrink-0 space-y-4">
                        <div className="h-40 bg-gray-200 dark:bg-gray-700 rounded-xl"></div>
                        <div className="h-96 bg-gray-200 dark:bg-gray-700 rounded-xl"></div>
                    </div>

                    <div className="flex-1 space-y-8 min-w-0">
                        {/* Summary Section Skeleton */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            {[1, 2, 3].map((i) => (
                                <div key={i} className="h-64 bg-gray-200 dark:bg-gray-700 rounded-xl"></div>
                            ))}
                        </div>

                        {/* Charts Section Skeleton */}
                        <div className="bg-white dark:bg-gray-900 rounded-lg shadow p-6">
                            <div className="h-8 w-48 bg-gray-200 dark:bg-gray-700 rounded mb-6"></div>
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <div className="aspect-square rounded-full bg-gray-200 dark:bg-gray-700 mx-auto w-3/4"></div>
                                <div className="aspect-square rounded-full bg-gray-200 dark:bg-gray-700 mx-auto w-3/4"></div>
                                <div className="h-full w-full bg-gray-200 dark:bg-gray-700 rounded-lg"></div>
                            </div>
                        </div>

                        {/* Asset List Skeleton */}
                        <div className="space-y-8">
                            {[1, 2].map((section) => (
                                <div key={section} className="bg-white dark:bg-gray-900 rounded-lg shadow p-6">
                                    <div className="flex justify-between items-center mb-6">
                                        <div className="h-8 w-40 bg-gray-200 dark:bg-gray-700 rounded"></div>
                                        <div className="h-9 w-28 bg-gray-200 dark:bg-gray-700 rounded"></div>
                                    </div>
                                    <div className="space-y-4">
                                        {[1, 2, 3].map((row) => (
                                            <div key={row} className="flex flex-col sm:flex-row gap-3">
                                                <div className="h-10 flex-[2] bg-gray-200 dark:bg-gray-700 rounded"></div>
                                                <div className="h-10 flex-1 bg-gray-200 dark:bg-gray-700 rounded"></div>
                                                <div className="h-10 flex-1 bg-gray-200 dark:bg-gray-700 rounded"></div>
                                                <div className="h-10 flex-1 bg-gray-200 dark:bg-gray-700 rounded"></div>
                                                <div className="h-10 flex-1 bg-gray-200 dark:bg-gray-700 rounded"></div>
                                                <div className="h-10 w-16 bg-gray-200 dark:bg-gray-700 rounded"></div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
                </div>
                {showReset && (
                    <div className="fixed bottom-10 left-1/2 transform -translate-x-1/2 z-[9999]">
                        <button 
                            onClick={() => { if(confirm('ë¡œë”©ì´ ë©ˆì·„ë‚˜ìš”? ë¡œì»¬ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³  ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { localStorage.clear(); window.location.reload(); } }}
                            className="bg-white dark:bg-gray-800 border border-red-300 dark:border-red-700 text-red-500 px-5 py-2 rounded-full shadow-xl text-sm font-bold hover:bg-red-50 dark:hover:bg-red-900/30 transition-all animate-bounce"
                        >
                            âš ï¸ ë¡œë”©ì´ ëŠ¦ì–´ì§€ë‚˜ìš”? ë°ì´í„° ì´ˆê¸°í™”
                        </button>
                    </div>
                )}
            </div>
            );
        };


        // [ìµœì í™”] ì •ì  ë°ì´í„° ì™¸ë¶€ë¡œ ì´ë™ ë° ìŠ¤íƒ€ì¼ í´ë˜ìŠ¤ í•˜ë“œì½”ë”© (ë‹¤í¬ëª¨ë“œ í•´ê²°)
        const AssetDashboard = () => {
            // config.jsì—ì„œ ë¡œë“œëœ sectorInfo ì‚¬ìš©
            const sectorInfo = window.sectorInfo || {};
            
            // [ìˆ˜ì •] utils.jsì˜ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ì„ ë¡œì»¬ ìŠ¤ì½”í”„ë¡œ ê°€ì ¸ì˜¤ê¸° (ReferenceError ë°©ì§€)
            const { 
                formatNumber, formatPercent, calculateGrossTotal, getSectorTotals, 
                calculateMonthlyProjection, withRetry, encryptData, decryptData, 
                getRGB, createGradient 
            } = window;

            // ===== ëª¨ë“  ìƒíƒœë¥¼ ë¨¼ì € ì„ ì–¸ =====
            // [ìˆ˜ì •] Undo/Redo í›… ì ìš©
            const { state: appData, setState: setAppData, undo, redo, canUndo, canRedo, reset: resetAppData } = useUndoRedo(null);
            const [darkMode, setDarkMode] = useState(() => localStorage.getItem('assetDashboardDarkMode') === 'true');
            const [inflationRate, setInflationRate] = useState(2.5);
            const [scenarios, setScenarios] = useState([]);
            const [originalUserData, setOriginalUserData] = useState(null); // [ì¶”ê°€] ì›ë³¸ ë°ì´í„° ìºì‹œ
            const [isDemoMode, setIsDemoMode] = useState(false); // [ì¶”ê°€] ë°ëª¨ ëª¨ë“œ ìƒíƒœ
            const [isPro, setIsPro] = useState(false); // [ì¶”ê°€] ìœ ë£Œ ì´ìš©ì ì—¬ë¶€
            const [verifiedEmail, setVerifiedEmail] = useState(null);
            const [userProfile, setUserProfile] = useState(null); // [ì¶”ê°€] ì‚¬ìš©ì í”„ë¡œí•„ ì •ë³´
            const [syncStatus, setSyncStatus] = useState('idle'); // 'idle' | 'syncing' | 'synced' | 'error'
            const [syncError, setSyncStatusError] = useState(''); // [ì¶”ê°€] êµ¬ì²´ì  ì—ëŸ¬ ë©”ì‹œì§€
            const [dbStatus, setDbStatus] = useState('idle'); // [ì¶”ê°€] DB ì—°ê²° ìƒíƒœ
            const [isLoadingCloud, setIsLoadingCloud] = useState(false); // [ì¶”ê°€] í´ë¼ìš°ë“œ ë¡œë”© ìƒíƒœ
            const [isLoading, setIsLoading] = useState(true); // [ì¶”ê°€] ì•± ì´ˆê¸° ë¡œë”© ìƒíƒœ
            const [isInitialized, setIsInitialized] = useState(false); // [ì¶”ê°€] ì´ˆê¸°í™” ì™„ë£Œ ìƒíƒœ
            const isFetchingRef = useRef(false); // [ì¶”ê°€] ë™ê¸°í™” ë¬´í•œ ë£¨í”„ ë°©ì§€ë¥¼ ìœ„í•œ Ref
            const isProcessing = useRef(false); // [ì¶”ê°€] ìƒíƒœ ì—…ë°ì´íŠ¸ ë½(Lock)
            const [isCloudLoaded, setIsCloudLoaded] = useState(false); // [ì¶”ê°€] í´ë¼ìš°ë“œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ ì—¬ë¶€ (Race Condition ë°©ì§€)
            const lastSavedDataRef = useRef(''); // [ì¶”ê°€] ì¤‘ë³µ ì €ì¥ ë°©ì§€ë¥¼ ìœ„í•œ ë°ì´í„° ìŠ¤ëƒ…ìƒ·
            const isCheckingSubscriptionRef = useRef(false); // [ì¶”ê°€] êµ¬ë… í™•ì¸ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ Ref
            const [lastSyncTime, setLastSyncTime] = useState(null); // [ì¶”ê°€] ë§ˆì§€ë§‰ ë™ê¸°í™” ì‹œê°„
            
            // [ì¶”ê°€] í•˜ë‹¨ì— ìˆë˜ ìƒíƒœë“¤ì„ ì´ˆê¸°í™” ìˆœì„œ ë³´ì¥ì„ ìœ„í•´ ìœ„ë¡œ ì´ë™
            const [assetHistory, setAssetHistory] = useState([]);
            const [showProjectionInHistory, setShowProjectionInHistory] = useState(false);
            const [logoutBehavior, setLogoutBehavior] = useState(() => localStorage.getItem('assetLogoutBehavior') || 'keep');
            useEffect(() => { localStorage.setItem('assetLogoutBehavior', logoutBehavior); }, [logoutBehavior]);


            // [ìˆ˜ì •] ì„¤ì • ê²€ì¦ ë° ì¶”ì¶œ (utils.jsì˜ í—¬í¼ ì‚¬ìš© - í”Œë ˆì´ìŠ¤í™€ë” í•„í„°ë§)
            const { SUPABASE_URL, SUPABASE_KEY, SECURITY_KEY } = useMemo(() => window.validateSupabaseConfig ? window.validateSupabaseConfig() : {}, []);

            const supabase = useMemo(() => {
                // í”Œë ˆì´ìŠ¤í™€ë” ì²´í¬: ë¹Œë“œê°€ ì•ˆ ë˜ì—ˆê±°ë‚˜ í™˜ê²½ë³€ìˆ˜ê°€ ì—†ìœ¼ë©´ í´ë¼ì´ì–¸íŠ¸ ìƒì„± ì•ˆ í•¨
                if (!window.supabase || !SUPABASE_URL || !SUPABASE_KEY) {
                    if (window.supabase) console.warn("Supabase: Config missing or empty. URL:", SUPABASE_URL, "KEY:", !!SUPABASE_KEY);
                    return null;
                }
                
                try {
                    return window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                } catch (e) {
                    console.error("Supabase client creation failed:", e);
                    return null;
                }
            }, [SUPABASE_URL, SUPABASE_KEY]);
            

            const [goalSeekResult, setGoalSeekResult] = useState(null);
            // ì°¨íŠ¸ refë“¤
            const currentPieRef = useRef(null);
            const projectedPieRef = useRef(null);
            const comparisonBarRef = useRef(null);
            const historyChartRef = useRef(null);
            // ì„¹í„° ì ‘í˜ ìƒíƒœëŠ” í•­ìƒ ìƒë‹¨ì—ì„œ ì„ ì–¸í•˜ì—¬ í›… ìˆœì„œ ê³ ì •
            const [hiddenSectors, setHiddenSectors] = useState(() => {
                try {
                    const raw = localStorage.getItem('assetDashboardHiddenSectors');
                    return raw ? JSON.parse(raw) : {};
                } catch { return {}; }
            });
            useEffect(()=>{
                try {
                    localStorage.setItem('assetDashboardHiddenSectors', JSON.stringify(hiddenSectors));
                } catch {}
            }, [hiddenSectors]);

            // [ì¶”ê°€] ë°ì´í„° ì „ì†¡ ëª¨ë‹¬ ìƒíƒœ
            const [isExportModalOpen, setIsExportModalOpen] = useState(false);
            const [isImportModalOpen, setIsImportModalOpen] = useState(false);
            const [exportSelection, setExportSelection] = useState({ appData: true, scenarios: true, assetHistory: true });
            const [importSelection, setImportSelection] = useState({ appData: true, scenarios: true, assetHistory: true });            
            const [isPrivacyModalOpen, setIsPrivacyModalOpen] = useState(false); // [ì¶”ê°€] ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ ëª¨ë‹¬ ìƒíƒœ
            const [isSuggestionModalOpen, setIsSuggestionModalOpen] = useState(false); // [ì¶”ê°€] ê¸°ëŠ¥ ì œì•ˆ ëª¨ë‹¬ ìƒíƒœ
            const [isProModalOpen, setIsProModalOpen] = useState(false); // [ì¶”ê°€] PRO ê¸°ëŠ¥ ì•ˆë‚´ ëª¨ë‹¬ ìƒíƒœ
            const [isQuickPanelOpen, setIsQuickPanelOpen] = useState(false); // [ì¶”ê°€] ëª¨ë°”ì¼ í€µ íŒ¨ë„ ìƒíƒœ
            const [isSettingsModalOpen, setIsSettingsModalOpen] = useState(false); // [ì¶”ê°€] í†µí•© ì„¤ì • ëª¨ë‹¬ ìƒíƒœ
            const [isGuideOpen, setIsGuideOpen] = useState(false); // [ì¶”ê°€] ì˜¨ë³´ë”© ê°€ì´ë“œ ìƒíƒœ
            const [showSaveToast, setShowSaveToast] = useState(false); // [ì¶”ê°€] ì €ì¥ í”¼ë“œë°± ìƒíƒœ
            const [encryptionMode, setEncryptionMode] = useState(null); // [ì¶”ê°€] ì•”í˜¸í™” ëª¨ë“œ
            const [userSecretKey, setUserSecretKey] = useState(() => sessionStorage.getItem('assetDashboardSecretKey') || ''); // [ìˆ˜ì •] ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ ì—°ë™
            const [isEncryptionModalOpen, setIsEncryptionModalOpen] = useState(false); // [ì¶”ê°€] ì•”í˜¸í™” ì„ íƒ ëª¨ë‹¬
            const [isPasswordPromptOpen, setIsPasswordPromptOpen] = useState(false); // [ì¶”ê°€] ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ëª¨ë‹¬
            const [currentDrillDown, setCurrentDrillDown] = useState(null); // [ìˆ˜ì •] í˜„ì¬ ì°¨íŠ¸ ë“œë¦´ë‹¤ìš´ ìƒíƒœ
            const [projectedDrillDown, setProjectedDrillDown] = useState(null); // [ìˆ˜ì •] ì˜ˆìƒ ì°¨íŠ¸ ë“œë¦´ë‹¤ìš´ ìƒíƒœ
            const [editingRebalanceSector, setEditingRebalanceSector] = useState(null); // [ì¶”ê°€] ë¦¬ë°¸ëŸ°ì‹± ìƒì„¸ í¸ì§‘ ì„¹í„°
            const [iconPickerState, setIconPickerState] = useState(null); // [ì¶”ê°€] ì•„ì´ì½˜ ì„ íƒê¸° ìƒíƒœ { sector, index }
            const [isAIModalOpen, setIsAIModalOpen] = useState(false); // [ì¶”ê°€] AI ë¶„ì„ ëª¨ë‹¬ ìƒíƒœ
            
            // [ì¶”ê°€] ë©”ëª¨ ê´€ë ¨ ìƒíƒœ
            const [currentMemoIndex, setCurrentMemoIndex] = useState(0);
            const [isEditingMemoTitle, setIsEditingMemoTitle] = useState(false);
            const [tempMemoTitle, setTempMemoTitle] = useState('');
            
            // [ì¶”ê°€] í† ìŠ¤íŠ¸ ìƒíƒœ ê´€ë¦¬
            const [toasts, setToasts] = useState([]);
            const addToast = React.useCallback((message, type = 'info') => {
                const id = Date.now();
                setToasts(prev => {
                    // [ìˆ˜ì •] FIFO ë¡œì§: ìµœëŒ€ 3ê°œê¹Œì§€ë§Œ ìœ ì§€í•˜ê³ , ì˜¤ë˜ëœ(ìœ„ìª½) ì•Œë¦¼ë¶€í„° ìì—°ìŠ¤ëŸ½ê²Œ ì œê±°
                    const newToasts = [...prev, { id, message, type }];
                    return newToasts.slice(-3);
                });
            }, []);
            const removeToast = React.useCallback((id) => {
                setToasts(prev => prev.filter(t => t.id !== id));
            }, []);

            const chartInstancesRef = useRef({}); // [ì¶”ê°€] ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ê´€ë¦¬ìš© Ref
            const pendingCiphertext = useRef(null);
            const pendingSave = useRef(false);

            // [ìˆ˜ì •] ë ˆì´ì•„ì›ƒ ë° íŒ¨ë„ ìƒíƒœ ê´€ë¦¬
            const [layoutOrder, setLayoutOrder] = useState(() => {
                try {
                    const savedOrder = localStorage.getItem('assetDashboardLayoutOrder');
                    const defaultOrder = window.DEFAULT_LAYOUT_ORDER || ['summary', 'scenario', 'charts', 'history', 'budget', 'memo', 'rebalance', 'assets', 'expenses', 'events', 'detail-analysis', 'assumptions'];
                    if (savedOrder) {
                        const parsed = JSON.parse(savedOrder);
                        const missing = defaultOrder.filter(id => !parsed.includes(id));
                        return [...parsed, ...missing];
                    }
                    return defaultOrder;
                } catch {
                    return window.DEFAULT_LAYOUT_ORDER || ['summary', 'scenario', 'charts', 'history', 'budget', 'memo', 'rebalance', 'assets', 'expenses', 'events', 'detail-analysis', 'assumptions'];
                }
            });
            useEffect(() => {
                localStorage.setItem('assetDashboardLayoutOrder', JSON.stringify(layoutOrder));
            }, [layoutOrder]);

            const [panelCollapseState, setPanelCollapseState] = useState(() => {
                try {
                    const savedState = localStorage.getItem('assetDashboardPanelCollapse');
                    return savedState ? JSON.parse(savedState) : {};
                } catch {
                    return {};
                }
            });
            useEffect(() => {
                localStorage.setItem('assetDashboardPanelCollapse', JSON.stringify(panelCollapseState));
            }, [panelCollapseState]);

            const [assetSectorOrder, setAssetSectorOrder] = useState(() => {
                try {
                    const savedOrder = localStorage.getItem('assetDashboardAssetSectorOrder');
                    const defaultOrder = window.DEFAULT_SECTOR_ORDER || ['deposit', 'savings', 'investment', 'pension', 'realestate', 'car', 'loan', 'misc'];
                    return savedOrder ? JSON.parse(savedOrder) : defaultOrder;
                } catch {
                    return window.DEFAULT_SECTOR_ORDER || ['deposit', 'savings', 'investment', 'pension', 'realestate', 'car', 'loan', 'misc'];
                }
            });
            useEffect(() => {
                localStorage.setItem('assetDashboardAssetSectorOrder', JSON.stringify(assetSectorOrder));
            }, [assetSectorOrder]);

            // [ì¶”ê°€] íŒ¨ë„ ì´ë™ í•¨ìˆ˜
            const scrollToPanel = (id) => {
                const element = document.getElementById(id);
                if (element) {
                    const headerOffset = 100;
                    const elementPosition = element.getBoundingClientRect().top;
                    const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
                    window.scrollTo({ top: offsetPosition, behavior: "smooth" });
                }
            };

            // ===== ì´ˆê¸° ë°ì´í„° ë¡œë“œ =====
            useEffect(() => {
                // [ìš”êµ¬ì‚¬í•­ 3] Fix the Infinite Loading (Lifecycle Management)
                const loadInitialData = async () => {
                    try {
                        // [ìš”êµ¬ì‚¬í•­ 5] loadServerConfig ì•ˆì „ ì‹¤í–‰
                        try {
                            if (typeof loadServerConfig === 'function') {
                                await loadServerConfig();
                            }
                        } catch (e) {
                            console.warn("Server config load failed, proceeding with defaults:", e);
                        }

                    const baseData = window.publicDefaultData || {};
                    let mergedData = baseData;
                    
                    // 1. ë¡œì»¬ ë°ì´í„° ë¡œë“œ ì‹œë„
                    try {
                        const savedData = localStorage.getItem('assetDashboardDataV3');
                        const savedScenarios = localStorage.getItem('assetDashboardScenarios');
                        const savedHistory = localStorage.getItem('assetDashboardHistory');

                        const initialScenarios = savedScenarios ? JSON.parse(savedScenarios) : [];
                        const initialHistory = savedHistory ? JSON.parse(savedHistory) : (baseData.history || []);
                        
                        if (savedScenarios) setScenarios(initialScenarios);
                        setAssetHistory(initialHistory);

                if (savedData) {
                            const parsedData = JSON.parse(savedData);
                            mergedData = {
                                ...baseData,
                                ...parsedData,
                                assets: { ...baseData.assets, ...parsedData.assets }, 
                                rebalancingAlerts: { ...baseData.rebalancingAlerts, ...parsedData.rebalancingAlerts },
                            };
                            if (mergedData.memo === undefined) mergedData.memo = baseData.memo;

                            // ë§ˆì´ê·¸ë ˆì´ì…˜: ID, ëŒ€ì¶œ ì‹œì‘ì¼, ë‹¤í¬ëª¨ë“œ í•„ë“œ ë³´ê°•
                            Object.keys(parsedData.assets||{}).forEach(sector=>{
                                (parsedData.assets[sector]||[]).forEach(a=>{ 
                                    if (!a.id) a.id = Date.now() + Math.random();
                                    if (sector === 'loan' && !a.loanStartDate) a.loanStartDate = parsedData.baseMonth || baseData.baseMonth;
                                });
                            });

                            // ë§ˆì´ê·¸ë ˆì´ì…˜: ìì‚°ë³„ ìˆ˜ìˆ˜ë£Œ/ì„¸ê¸ˆ í•„ë“œ ê¸°ë³¸ê°’(0)
                            Object.keys(parsedData.assets||{}).forEach(sector=>{
                                (parsedData.assets[sector]||[]).forEach(a=>{ if (a.feeRate === undefined) a.feeRate = 0; });
                            });
                            setAppData(mergedData); // [ìˆ˜ì •] parsedData ëŒ€ì‹  mergedData ì‚¬ìš©
                            setOriginalUserData(parsedData); // [ì¶”ê°€]
                            lastSavedDataRef.current = JSON.stringify({ appData: mergedData, scenarios: initialScenarios, assetHistory: initialHistory });
                        } else {
                            setAppData(baseData);
                            setOriginalUserData(baseData); // [ì¶”ê°€]
                            lastSavedDataRef.current = JSON.stringify({ appData: baseData, scenarios: initialScenarios, assetHistory: initialHistory });
                        }
                    } catch (error) {
                        console.error("ë¡œì»¬ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜ (ì´ˆê¸°í™” ì§„í–‰):", error);
                        // [ìˆ˜ì •] ë°ì´í„° ì†ìƒ ì‹œ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì´ˆê¸°í™”í•˜ì—¬ ë¬´í•œ ë¡œë”©/ì—ëŸ¬ ë°©ì§€
                        localStorage.removeItem('assetDashboardDataV3');
                        setAppData(baseData);
                        lastSavedDataRef.current = JSON.stringify(baseData);
                    }

                    // [ìš”êµ¬ì‚¬í•­ 3] Safe Session Handling
                    if (supabase) {
                        setDbStatus('connected');
                        const { data: { session } } = await withRetry(() => supabase.auth.getSession(), 3, 2000)
                            .catch(err => ({ data: { session: null }, error: err }));
                        
                        if (session) {
                            await checkSubscription(session, false, mergedData);
                        }
                    } else {
                        console.log('Mode: Local Storage');
                        setDbStatus('local');
                    }
                    } catch (error) {
                        console.error("Initialization error:", error);
                        setDbStatus('error');
                    } finally {
                        // [ìš”êµ¬ì‚¬í•­ 3] Crucial: Loading screen always disappears
                        setIsLoading(false);
                        setIsInitialized(true);
                    }
                };
                
                loadInitialData();
            }, [supabase]);

            // [ì¶”ê°€] ì˜¨ë³´ë”© ê°€ì´ë“œ íŠ¸ë¦¬ê±° ë¡œì§
            useEffect(() => {
                const guideCompleted = localStorage.getItem('asset_planner_guide_completed');
                if (!isLoading && !guideCompleted) {
                    setIsGuideOpen(true);
                }
            }, [isLoading]);

        // [ìµœì í™”] ìƒíƒœ ì¶”ì ì„ ìœ„í•œ Ref (ë‹¨ì¶•í‚¤ ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ stale closure ë°©ì§€)
            const appDataRef = useRef(appData);
        const scenariosRef = useRef(scenarios);
        const assetHistoryRef = useRef(assetHistory);

        // [ìµœì í™”] í´ë¼ìš°ë“œ ì €ì¥ í•¨ìˆ˜ (ìˆœì„œ ì¡°ì •: ë¦¬ìŠ¤ë„ˆë³´ë‹¤ ë¨¼ì € ì„ ì–¸ë˜ì–´ì•¼ í•¨)
        const saveToCloud = React.useCallback(async (unifiedData, force = false, emailOverride = null, proOverride = null, keyOverride = null, modeOverride = null) => {
            if (!supabase) {
                if (force) console.warn("Cloud save skipped: Supabase not initialized.");
                return;
            }

            const targetEmail = emailOverride || verifiedEmail;
            const targetPro = proOverride !== null ? proOverride : isPro;
            const targetMode = modeOverride || encryptionMode;
            if (!targetEmail || isDemoMode || !unifiedData || !isInitialized || !isCloudLoaded) return;
            if (!force && (!isCloudLoaded || isFetchingRef.current)) return;

            const currentDataStr = JSON.stringify(unifiedData);
            if (!force && currentDataStr === lastSavedDataRef.current) return;

            let payloadData = unifiedData;
            if (targetPro && targetMode) {
                let key = keyOverride;
                
                if (!key) {
                    let secret = null;
                    if (targetMode === 'secure') {
                        secret = userSecretKey || sessionStorage.getItem('assetDashboardSecretKey');
                        if (!secret) {
                            pendingSave.current = true;
                            setIsPasswordPromptOpen(true);
                            return;
                        }
                    }
                    key = window.getEncryptionKey(targetMode, secret, targetEmail, SECURITY_KEY);
                }

                if (!key) {
                    if (targetMode === 'normal') {
                        addToast('Cloud sync disabled: System Security Key missing.', 'error');
                    } else {
                        addToast('ë³´ì•ˆ í‚¤ ì„¤ì • ì˜¤ë¥˜ë¡œ ì €ì¥ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.', 'error');
                    }
                    setSyncStatus('error');
                    return;
                }
                try {
                    payloadData = encryptData(unifiedData, key);
                } catch (e) {
                    console.error("Encryption error:", e);
                    addToast('ë°ì´í„° ì•”í˜¸í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                    setSyncStatus('error');
                    return; // Early return on encryption failure
                }
            }

            setSyncStatus('syncing');
            try {
                await withRetry(() => supabase.auth.refreshSession());
                const { data, error } = await withRetry(() => 
                    supabase.from('user_assets').upsert({ 
                        email: targetEmail, data: payloadData,
                        encryption_type: targetPro ? targetMode : null,
                        updated_at: new Date().toISOString()
                    }, { onConflict: 'email' }).select('updated_at').single()
                );
                if (error) throw error;
                if (data) {
                    setSyncStatus('synced');
                    setLastSyncTime(new Date().toLocaleTimeString('ko-KR', { hour12: false }));
                    localStorage.setItem('assetDashboardLastUpdate', data.updated_at);
                    lastSavedDataRef.current = currentDataStr;
                }
            } catch (error) {
                console.error('Sync error:', error);
                setSyncStatus('error');
                setSyncStatusError(error.message || 'ì €ì¥ ì‹¤íŒ¨');
                setLastSyncTime(null);
            } // This finally block was removed as it was empty and unnecessary
        }, [verifiedEmail, isPro, encryptionMode, userSecretKey, userProfile, isDemoMode, supabase, isInitialized, isCloudLoaded, withRetry, getEncryptionKey]);

        // í´ë¼ìš°ë“œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        const fetchFromCloud = React.useCallback(async (email = verifiedEmail, pro = isPro, isInitialLoad = false, isManual = false, localDataOverride = null) => {
            if (!supabase || isProcessing.current || isFetchingRef.current) return;
            isFetchingRef.current = true; // Lock fetching
            setSyncStatus('syncing');
            setIsLoadingCloud(true);
            try {
                const { data, error } = await withRetry(() => 
                    supabase.from('user_assets').select('data, updated_at, encryption_type').eq('email', email).maybeSingle()
                );
                if (error) throw error;

                if (data && data.data) {
                    const encType = data.encryption_type;
                    const isLegacy = !encType || encType === 'none';
                    if (pro && isLegacy) setIsEncryptionModalOpen(true);
                    else if (pro) setEncryptionMode(encType);

                    let decryptedData = data.data;
                    if (!isLegacy && pro) {
                        // [ìˆ˜ì •] ì¼ë°˜ ë³´ì•ˆ ëª¨ë“œ(normal)ì¼ ë•ŒëŠ” ë¹„ë°€ë²ˆí˜¸ë¥¼ ì°¸ì¡°í•˜ì§€ ì•ŠìŒ
                        let secret = null;
                        if (encType === 'secure') {
                            secret = userSecretKey || sessionStorage.getItem('assetDashboardSecretKey');
                            if (!secret) {
                                pendingCiphertext.current = data.data;
                                setIsPasswordPromptOpen(true);
                                return; // finally block will handle state reset
                            }
                        }
                        
                        // [Fix] Consistent Encryption Identity: Always use email via global helper
                        const key = window.getEncryptionKey(encType, secret, email, SECURITY_KEY);

                        // [ìˆ˜ì •] ì¼ë°˜ ëª¨ë“œì—ì„œ ë³´ì•ˆ í‚¤(SECURITY_KEY)ê°€ ì—†ëŠ” ê²½ìš° ì˜ˆì™¸ ì²˜ë¦¬
                        if (!key && encType === 'normal') {
                            addToast('ì‹œìŠ¤í…œ ë³´ì•ˆ í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (í™˜ê²½ë³€ìˆ˜ í™•ì¸ í•„ìš”)', 'error');
                            setSyncStatus('error');
                            return; // finally block will handle state reset
                        }

                        try {
                            decryptedData = decryptData(data.data, key);
                        } catch (err) {
                            let recovered = false;
                            // [ì¶”ê°€] ì´ì „ ë²„ì „ ë°ì´í„°(ì´ë©”ì¼ ì†”íŠ¸ ì—†ìŒ) ë³µêµ¬ ì‹œë„ (Fallback)
                            if (encType === 'normal' && SECURITY_KEY && key !== SECURITY_KEY) {
                                try {
                                    decryptedData = decryptData(data.data, SECURITY_KEY);
                                    recovered = true;
                                    addToast('ì´ì „ ë³´ì•ˆ í˜•ì‹ì˜ ë°ì´í„°ë¥¼ ë³€í™˜í•˜ì—¬ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.', 'success');
                                } catch (e) { /* Fallback failed */ }
                            }

                            if (!recovered) {
                                if (encType === 'normal') {
                                    // [ìˆ˜ì •] ë®ì–´ì“°ê¸° ì „ ìœ íš¨í•œ ë³´ì•ˆ í‚¤ê°€ ìˆëŠ”ì§€ ë¨¼ì € í™•ì¸ (ë¬´í•œ ë£¨í”„ ë°©ì§€)
                                    const newKey = window.getEncryptionKey('normal', null, email, SECURITY_KEY);
                                    if (!newKey) {
                                        addToast("ì‹œìŠ¤í…œ ë³´ì•ˆ í‚¤(SECURITY_KEY)ê°€ ì„¤ì •ë˜ì§€ ì•Šì•„ ë°ì´í„°ë¥¼ ë®ì–´ì“¸ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í™˜ê²½ë³€ìˆ˜ë¥¼ í™•ì¸í•˜ê±°ë‚˜ ì„¤ì •ì—ì„œ 'ë³´ì•ˆ ëª¨ë“œ'ë¡œ ì „í™˜í•˜ì„¸ìš”.", 'error');
                                        setSyncStatus('error');
                                        return;
                                    }

                                    // [Fix] Safe Recovery: Block overwrite if local data is default
                                    const isLocalDataDefault = JSON.stringify(appDataRef.current) === JSON.stringify(window.publicDefaultData);
                                    if (isLocalDataDefault) {
                                        addToast("ë³µí˜¸í™” ì‹¤íŒ¨: ë³´ì•ˆ í‚¤ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë¡œì»¬ ë°ì´í„°ê°€ ì´ˆê¸° ìƒíƒœë¼ ë®ì–´ì“°ê¸°ê°€ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. í™˜ê²½ë³€ìˆ˜ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.", 'error');
                                    } else if (confirm("ë³´ì•ˆ í‚¤ ë¶ˆì¼ì¹˜: í´ë¼ìš°ë“œ ë°ì´í„°ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜„ì¬ ë¡œì»¬ ë°ì´í„°ë¡œ í´ë¼ìš°ë“œë¥¼ ë®ì–´ì“°ê³  ë¬¸ì œë¥¼ í•´ê²°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                                        const localData = localDataOverride || { appData: appDataRef.current, scenarios: scenariosRef.current, assetHistory: assetHistoryRef.current };
                                        await saveToCloud(localData, true, email, pro);
                                        // [ì¶”ê°€] ë®ì–´ì“°ê¸° ì„±ê³µ ì‹œ ì¦‰ì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸í•˜ì—¬ ì¬ì§„ì… ë°©ì§€
                                        setIsCloudLoaded(true);
                                        setSyncStatus('synced');
                                        addToast('í´ë¼ìš°ë“œ ë°ì´í„°ê°€ í˜„ì¬ ë¡œì»¬ ë°ì´í„°ë¡œ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                                    }
                                    return;
                                } else {
                                    addToast('ë°ì´í„° ë³µí˜¸í™” ì‹¤íŒ¨: ë¹„ë°€ë²ˆí˜¸ê°€ ë‹¤ë¥´ê±°ë‚˜ ë°ì´í„°ê°€ ì†ìƒë˜ì—ˆìŠµë‹ˆë‹¤.', 'error');
                                    console.error("Decryption failed:", err);
                                    setSyncStatus('error');
                                    return; // Stop further processing
                                }
                            }
                        }
                    }
                    const cloudTime = new Date(data.updated_at).getTime();
                    const localTime = new Date(localStorage.getItem('assetDashboardLastUpdate') || 0).getTime();

                    let shouldUpdateFromCloud = isManual || !localTime || cloudTime >= localTime;

                    if (!shouldUpdateFromCloud && isInitialLoad && localTime > cloudTime) {
                        if (confirm("ê¸°ê¸°ì˜ ë°ì´í„°ê°€ ë” ìµœì‹ ì…ë‹ˆë‹¤. í´ë¼ìš°ë“œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                            shouldUpdateFromCloud = true;
                        } else {
                            const localData = localDataOverride || { appData: appDataRef.current, scenarios: scenariosRef.current, assetHistory: assetHistoryRef.current };
                            await saveToCloud(localData, true, email, pro);
                        }
                    }

                    if (shouldUpdateFromCloud) {
                        const actualAppData = decryptedData.appData || decryptedData;
                        const fullCloudData = decryptedData.appData ? decryptedData : { appData: actualAppData, scenarios: [], assetHistory: [] };
                        
                        lastSavedDataRef.current = JSON.stringify(fullCloudData);
                        resetAppData(actualAppData);
                        if (fullCloudData.scenarios) setScenarios(fullCloudData.scenarios);
                        if (fullCloudData.assetHistory) setAssetHistory(fullCloudData.assetHistory);

                        localStorage.setItem('assetDashboardDataV3', JSON.stringify(actualAppData));
                        if (fullCloudData.scenarios) localStorage.setItem('assetDashboardScenarios', JSON.stringify(fullCloudData.scenarios));
                        if (fullCloudData.assetHistory) localStorage.setItem('assetDashboardHistory', JSON.stringify(fullCloudData.assetHistory));
                        localStorage.setItem('assetDashboardLastUpdate', data.updated_at);
                    } else {
                        const currentLocal = localDataOverride || { appData: appDataRef.current, scenarios: scenariosRef.current, assetHistory: assetHistoryRef.current };
                        lastSavedDataRef.current = JSON.stringify(currentLocal);
                    }
                    setSyncStatus('synced');
                    setIsCloudLoaded(true);
                } else {
                    setIsCloudLoaded(true);
                    setSyncStatus('synced');
                }
            } catch (err) {
                setSyncStatus('error');
                addToast(`ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${err.message}`, 'error');
            } finally {
                setIsLoadingCloud(false);
                isFetchingRef.current = false; // Always unlock fetching regardless of return path
            }
        }, [supabase, withRetry, resetAppData, saveToCloud, addToast, encryptionMode, userSecretKey, userProfile, verifiedEmail, isPro, SECURITY_KEY]);

        // ë¡œê·¸ì•„ì›ƒ í•¸ë“¤ëŸ¬
        const handleLogout = React.useCallback(async (skipSignOut = false) => {
            if (isProcessing.current) return;
            isProcessing.current = true;
            try {
                if (supabase && !skipSignOut) {
                    await withRetry(() => supabase.auth.signOut(), 2, 500);
                }
            } catch (error) {
                console.error('Logout error:', error);
            } finally {
                if (!skipSignOut && logoutBehavior === 'reset') {
                    resetAppData(window.publicDefaultData || {});
                    localStorage.removeItem('assetDashboardDataV3');
                }
                setVerifiedEmail(null); 
                setUserProfile(null);
                setIsPro(false);
                setSyncStatus('idle');
                setSyncStatusError('');
                setIsCloudLoaded(false);
                // [ë³´ì•ˆ] ë¡œê·¸ì•„ì›ƒ ì‹œ ì €ì¥ëœ API í‚¤ë„ ì‚­ì œ
                localStorage.removeItem('asset_gemini_api_key');
                // [ì¶”ê°€] ë¡œê·¸ì•„ì›ƒ ì‹œ ë³´ì•ˆ í‚¤ ì„¸ì…˜ ë° ìƒíƒœ ì´ˆê¸°í™” (ë³´ì•ˆ ê°•í™”)
                setUserSecretKey('');
                sessionStorage.removeItem('assetDashboardSecretKey');
                setTimeout(() => { isProcessing.current = false; }, 100);
            }
        }, [supabase, logoutBehavior, resetAppData]);

            // êµ¬ë… ìƒíƒœ í™•ì¸ ë° ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
            const checkSubscription = React.useCallback(async (session, isManualCheck = false, localDataOverride = null) => {
                if (!session?.user || (isCheckingSubscriptionRef.current && !isManualCheck)) return;
                if (isManualCheck) setIsLoadingCloud(true);
                isCheckingSubscriptionRef.current = true;
                setSyncStatus('syncing');
                setVerifiedEmail(session.user.email);
                // [ìˆ˜ì •] userProfileì— id í¬í•¨ (ì•”í˜¸í™” í‚¤ ìƒì„± ì‹œ UUID ì‚¬ìš© ë³´ì¥)
                setUserProfile({ ...session.user.user_metadata, id: session.user.id });

                if (!navigator.onLine) {
                    isCheckingSubscriptionRef.current = false;
                    if (isManualCheck) setIsLoadingCloud(false);
                    return;
                }

                try {
                    const { data: profile, error: fetchError } = await withRetry(
                        () => supabase.from('user_profiles').select('is_paid').eq('id', session.user.id).maybeSingle()
                    );
                    if (!fetchError) {
                        const proStatus = profile ? profile.is_paid : false;
                        setIsPro(proStatus);
                        if (proStatus) {
                            await fetchFromCloud(session.user.email, proStatus, true, false, localDataOverride);
                        } else {
                            setSyncStatus('idle');
                        }
                    } else {
                        console.warn('Profile fetch error after retries:', fetchError);
                        setSyncStatus('error');
                        if (isManualCheck) addToast('ì„œë²„ ì—°ê²° ìƒíƒœê°€ ì¢‹ì§€ ì•Šì•„ êµ¬ë… ì •ë³´ë¥¼ í™•ì¸í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', 'error');
                    }
                } catch (err) {
                    console.error('Subscription check error:', err);
                    setSyncStatus('error');
                    if (isManualCheck) addToast('êµ¬ë… ìƒíƒœ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                } finally {
                    isCheckingSubscriptionRef.current = false;
                    if (isManualCheck) setIsLoadingCloud(false);
                }
            }, [supabase, withRetry, fetchFromCloud, addToast]);

        useEffect(() => { 
            appDataRef.current = appData; 
            scenariosRef.current = scenarios;
            assetHistoryRef.current = assetHistory;
        }, [appData, scenarios, assetHistory]);

            // [ì¶”ê°€] ë³´ì•ˆ í‚¤ ì„¸ì…˜ ìœ ì§€
            useEffect(() => {
                if (userSecretKey) {
                    sessionStorage.setItem('assetDashboardSecretKey', userSecretKey);
                }
            }, [userSecretKey]);

            // [ì¶”ê°€] CSV ë‚´ë³´ë‚´ê¸°/ë¶ˆëŸ¬ì˜¤ê¸° ê¸°ëŠ¥
            const exportToCSV = () => {
                // [ìˆ˜ì •] utils.jsì˜ generateCSV ì‚¬ìš©
                const csvContent = window.generateCSV(assets);
                const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `asset_data_${new Date().toISOString().slice(0,10)}.csv`;
                link.click();
            };

            const importFromCSV = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const text = event.target.result;
                        // [ìˆ˜ì •] utils.jsì˜ parseCSV ì‚¬ìš©
                        const newAssets = window.parseCSV(text);
                        if (confirm('CSV ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ? ê¸°ì¡´ ìì‚° ë°ì´í„°ê°€ ëŒ€ì²´ë©ë‹ˆë‹¤.')) {
                            setAssets(newAssets);
                            addToast('CSV ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.', 'success');
                        }
                    } catch (err) {
                        console.error('CSV Import Error:', err);
                        addToast('CSV íŒŒì¼ì„ íŒŒì‹±í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                    }
                };
                reader.readAsText(file);
                e.target.value = '';
            };

        // [ìµœì í™”] í†µí•© í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ ë¦¬ìŠ¤ë„ˆ (ì¤‘ë³µ ì œê±° ë° Ref í™œìš©)
        useEffect(() => {
            const handleKeyDown = (e) => {
                const isSave = ((e.ctrlKey || e.metaKey) && e.key === 's') || (e.altKey && e.key === 's');
                if (isSave) {
                    e.preventDefault();
                    const currentData = appDataRef.current;
                    if (currentData) {
                        localStorage.setItem('assetDashboardDataV3', JSON.stringify(currentData));
                        saveToCloud({ appData: currentData, scenarios: scenariosRef.current, assetHistory: assetHistoryRef.current }, true);
                        setShowSaveToast(true);
                        setTimeout(() => setShowSaveToast(false), 2000);
                    }
                }
                if (e.key === 'Escape') {
                    setIsExportModalOpen(false); setIsImportModalOpen(false);
                    setIsPrivacyModalOpen(false); setIsSuggestionModalOpen(false);
                    setIsProModalOpen(false); setIsEncryptionModalOpen(false);
                    setIsPasswordPromptOpen(false); setIsQuickPanelOpen(false);
                    setIsGuideOpen(false);
                }
                if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey && canUndo) { 
                    e.preventDefault(); 
                    undo(); 
                    addToast('ì‹¤í–‰ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
                }
                if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.shiftKey && e.key === 'z')) && canRedo) { 
                    e.preventDefault(); 
                    redo(); 
                    addToast('ë‹¤ì‹œ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
                }
            };
            window.addEventListener('keydown', handleKeyDown);
            return () => window.removeEventListener('keydown', handleKeyDown);
        
        }, [canUndo, canRedo, undo, redo, saveToCloud, scenarios, assetHistory]);


            // [ìˆ˜ì •] ë°ì´í„° ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ìë™ ì €ì¥ ë° íƒ€ì„ìŠ¤íƒ¬í”„ ê´€ë¦¬ í†µí•©
            useEffect(() => {
                if (!isInitialized) return;

                try {
                    const fullState = { appData, scenarios, assetHistory };
                    const fullStateStr = JSON.stringify(fullState);

                    // 1. ê° í•­ëª©ë³„ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì €ì¥
                    if (appData) localStorage.setItem('assetDashboardDataV3', JSON.stringify(appData));
                    localStorage.setItem('assetDashboardScenarios', JSON.stringify(scenarios));
                    localStorage.setItem('assetDashboardHistory', JSON.stringify(assetHistory));

                    // 2. ë¡œì»¬ ìˆ˜ì • ì—¬ë¶€ íŒë‹¨ (ë§ˆì§€ë§‰ ë™ê¸°í™” ì‹œì ê³¼ ë¹„êµ)
                    // lastSavedDataRefëŠ” í´ë¼ìš°ë“œì—ì„œ ë¶ˆëŸ¬ì˜¤ê±°ë‚˜ í´ë¼ìš°ë“œì— ì €ì¥ ì„±ê³µí–ˆì„ ë•Œë§Œ ê°±ì‹ ë¨
                    if (fullStateStr !== lastSavedDataRef.current) {
                        // ë°ì´í„°ê°€ ë³€ê²½ë˜ì—ˆë‹¤ë©´ ë¡œì»¬ íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ í˜„ì¬ ì‹œê°„ìœ¼ë¡œ ê°±ì‹ 
                        // ì´ë ‡ê²Œ í•´ì•¼ ë¡œê·¸ì¸ ì‹œ "ê¸°ê¸°ì˜ ë°ì´í„°ê°€ ë” ìµœì‹ ì…ë‹ˆë‹¤" íŒì—…ì´ ì •ìƒì ìœ¼ë¡œ ëœ¸
                        const now = new Date().toISOString();
                        localStorage.setItem('assetDashboardLastUpdate', now);
                    }
                } catch (e) {
                    console.error("Local Storage Save Failed:", e);
                    // ì €ì¥ ì‹¤íŒ¨ ì‹œ ì•±ì´ ë©ˆì¶”ì§€ ì•Šë„ë¡ ì˜ˆì™¸ ì²˜ë¦¬ (í•„ìš” ì‹œ í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ì¶”ê°€ ê°€ëŠ¥)
                }
            }, [appData, scenarios, assetHistory, isInitialized]);

            // [ì‚­ì œ] ê¸°ì¡´ì˜ ê°œë³„ scenarios, assetHistory ì €ì¥ useEffectëŠ” ìœ„ í†µí•© ë¡œì§ìœ¼ë¡œ ëŒ€ì²´ë¨


            // í˜„ì¬ ìì‚° ì €ì¥ í•¨ìˆ˜
            const saveCurrentAsset = () => {
                try {
                    const now = new Date();
                    const currentDate = now.toISOString().split('T')[0]; // YYYY-MM-DD
                    const currentTime = now.toTimeString().split(' ')[0]; // HH:MM:SS
                    const netWorth = calculation?.grand || 0;
                    
                    setAssetHistory(prev => {
                        const newHistory = [...prev];
                        const existingIndex = newHistory.findIndex(item => item.date === currentDate);
                        
                        if (existingIndex >= 0) {
                            // ê°™ì€ ë‚ ì§œê°€ ìˆìœ¼ë©´ ì‹œê°„ ì •ë³´ì™€ í•¨ê»˜ ì—…ë°ì´íŠ¸ (ë§ˆì§€ë§‰ ì‹œê°„ëŒ€ë§Œ ìœ ì§€)
                            newHistory[existingIndex] = { 
                                date: currentDate, 
                                time: currentTime,
                                netWorth,
                                timestamp: now.getTime()
                            };
                        } else {
                            // ìƒˆë¡œìš´ ë‚ ì§œë©´ ì¶”ê°€
                            newHistory.push({ 
                                date: currentDate, 
                                time: currentTime,
                                netWorth,
                                timestamp: now.getTime()
                            });
                        }
                        
                        // íƒ€ì„ìŠ¤íƒ¬í”„ìˆœìœ¼ë¡œ ì •ë ¬ (ìµœì‹ ì´ ë§ˆì§€ë§‰)
                        return newHistory.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
                    });
                    
                    addToast(`í˜„ì¬ ìˆœìì‚° ${formatNumber(netWorth, displayMode)}ë§Œì›ì´ íˆìŠ¤í† ë¦¬ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                } catch (error) {
                    console.error('ìì‚° ì €ì¥ ì˜¤ë¥˜:', error);
                    addToast('ìì‚° ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            };

            // ===== ë°ì´í„° ì´ì‚¿ì§ì‹¸ê¸° ê¸°ëŠ¥ =====
            const handleExport = async (selection) => {
                try {
                    const exportData = {};
                    if (selection.appData) exportData.appData = appData; 
                    if (selection.scenarios) exportData.scenarios = scenarios;
                    if (selection.assetHistory) exportData.assetHistory = assetHistory;

                    exportData.exportDate = new Date().toISOString();
                    exportData.version = '1.0';
 
                    // [ìˆ˜ì •] utils.jsì˜ compressData ì‚¬ìš©
                    const compressed = window.compressData(exportData);

                    // í´ë¦½ë³´ë“œì— ë³µì‚¬
                    navigator.clipboard.writeText(compressed).then(() => {
                        addToast('ìì‚° ë°ì´í„°ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    }).catch(() => {
                        // í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨ ì‹œ í…ìŠ¤íŠ¸ ì˜ì—­ìœ¼ë¡œ í‘œì‹œ
                        const textArea = document.createElement('textarea');
                        textArea.value = compressed;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        addToast('ìì‚° ë°ì´í„°ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    });
                } catch (error) {
                    console.error('ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜:', error);
                    addToast('ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            };

            const handleImport = (selection) => {
                const compressedData = prompt('ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ë³µì‚¬í•œ ì•”í˜¸ë¬¸ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”:');
                if (!compressedData) return;
                
                try {
                    // [ìˆ˜ì •] utils.jsì˜ decompressData ì‚¬ìš©
                    const importData = window.decompressData(compressedData);
                    
                    if (!importData.version) {
                        throw new Error('ì˜ëª»ëœ ë°ì´í„° í˜•ì‹ì…ë‹ˆë‹¤.');
                    }

                    if (confirm('í˜„ì¬ ë°ì´í„°ë¥¼ ëª¨ë‘ ë®ì–´ì“°ê³  ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        if (selection.appData && importData.appData) setAppData(importData.appData);
                        if (selection.scenarios && importData.scenarios) setScenarios(importData.scenarios);
                        if (selection.assetHistory && importData.assetHistory) setAssetHistory(importData.assetHistory);
                        addToast('ìì‚° ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™€ì¡ŒìŠµë‹ˆë‹¤!', 'success');
                    }
                } catch (error) {
                    console.error('ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error);
                    addToast('ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì•”í˜¸ë¬¸ì„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
                }
            };

            // ===== ê¸°ë³¸ê°’ ì„¤ì • (appDataê°€ ì—†ì„ ë•Œë„ ì•ˆì „í•˜ê²Œ) =====
            const {
                projectionMonths = 12, monthlySalary = 280, assets = {}, monthlyExpenses = [],
                targetAmount = 10000, 
                goalMode = 'period', displayMode = 'amount',
                rebalancingAlerts = {}, baseMonth = new Date().toISOString().slice(0,7),
                rebalanceMonths = 12, // [ì¶”ê°€] ë¦¬ë°¸ëŸ°ì‹± ëª©í‘œ ê¸°ê°„
                mainCashFlowAccount = 'ìƒí™œë¹„í†µì¥',
                residualAccount = 'ìƒí™œë¹„í†µì¥', // [ì¶”ê°€] ì”ì—¬ì•¡ ì €ì¶• ê³„ì¢Œ
                rebalancingTargets = {},
                memo = '', // [ì¶”ê°€]
                itemTargets = {}, // [ì¶”ê°€] í•­ëª©ë³„ ëª©í‘œ ë¹„ì¤‘
                // [Refactor] Safe defaults during destructuring
                incomeEvents = [],
                expenseEvents = []
            } = appData || {};

            // ===== Setter í•¨ìˆ˜ë“¤ =====
            // [ìµœì í™”] ëª¨ë“  Setter í•¨ìˆ˜ì— useCallback ì ìš©í•˜ì—¬ ìì‹ ì»´í¬ë„ŒíŠ¸ì˜ ë¶ˆí•„ìš”í•œ ë¦¬ë Œë”ë§ ë°©ì§€
            const setProjectionMonths = React.useCallback((value) => setAppData(prev => ({ ...prev, projectionMonths: Math.max(0, typeof value === 'function' ? value(prev.projectionMonths) : value) })), [setAppData]);
            const setMonthlySalary = React.useCallback((value) => setAppData(prev => ({ ...prev, monthlySalary: value })), [setAppData]);
            const setAssets = React.useCallback((value) => setAppData(prev => ({ ...prev, assets: typeof value === 'function' ? value(prev.assets) : value })), [setAppData]);
            const setMonthlyExpenses = React.useCallback((value) => setAppData(prev => ({ 
                ...prev, 
                monthlyExpenses: typeof value === 'function' ? value(Array.isArray(prev.monthlyExpenses) ? prev.monthlyExpenses : []) : value 
            })), [setAppData]);

            const setMainCashFlowAccount = React.useCallback((value) => setAppData(prev => ({ ...prev, mainCashFlowAccount: value })), [setAppData]);
            const setResidualAccount = React.useCallback((value) => setAppData(prev => ({ ...prev, residualAccount: value })), [setAppData]);
            const setIncomeEvents = React.useCallback((value) => setAppData(prev => ({ 
                ...prev, 
                incomeEvents: typeof value === 'function' ? value(Array.isArray(prev.incomeEvents) ? prev.incomeEvents : []) : value 
            })), [setAppData]);
            const setExpenseEvents = React.useCallback((value) => setAppData(prev => ({ 
                ...prev, 
                expenseEvents: typeof value === 'function' ? value(Array.isArray(prev.expenseEvents) ? prev.expenseEvents : []) : value 
            })), [setAppData]);
            
            const setTargetAmount = React.useCallback((value) => setAppData(prev => ({ ...prev, targetAmount: value })), [setAppData]);
            const setGoalMode = React.useCallback((value) => setAppData(prev => ({ ...prev, goalMode: value })), [setAppData]);
            const setDisplayMode = React.useCallback((value) => setAppData(prev => ({ ...prev, displayMode: value })), [setAppData]); 
            const setRebalanceMonths = React.useCallback((value) => setAppData(prev => ({ ...prev, rebalanceMonths: Math.max(1, value) })), [setAppData]);
            const setRebalancingAlerts = React.useCallback((value) => setAppData(prev => ({ ...prev, rebalancingAlerts: typeof value === 'function' ? value(prev.rebalancingAlerts) : value })), [setAppData]);
            const setBaseMonth = React.useCallback((value) => setAppData(prev => ({ ...prev, baseMonth: value })), [setAppData]);
            const setRebalancingTargets = React.useCallback((value) => setAppData(prev => ({ ...prev, rebalancingTargets: typeof value === 'function' ? value(prev.rebalancingTargets) : value })), [setAppData]);
            const setItemTargets = React.useCallback((value) => setAppData(prev => ({ ...prev, itemTargets: typeof value === 'function' ? value(prev.itemTargets) : value })), [setAppData]);
            const setRebalancingGlobal = React.useCallback((value) => setAppData(prev => ({ ...prev, rebalancingGlobal: typeof value === 'function' ? value(prev.rebalancingGlobal) : value })), [setAppData]);
            const setMemo = React.useCallback((value) => setAppData(prev => ({ ...prev, memo: value })), [setAppData]);

            // [ì¶”ê°€] ë‹¤í¬ëª¨ë“œ í† ê¸€ í•¸ë“¤ëŸ¬ (PRO ì œí•œ ë¡œì§)
            const handleDarkModeToggle = () => {
                if (!isPro) {
                    if (!verifiedEmail) {
                        if (confirm('PRO ê¸°ëŠ¥(ë‹¤í¬ëª¨ë“œ ë“±)ì„ í™•ì¸í•˜ê±°ë‚˜ í›„ì›í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.\në¡œê·¸ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                            handleLogin();
                        }
                        return;
                    }
                    return setIsProModalOpen(true);
                }
                setDarkMode(!darkMode);
            };

            // [ìˆ˜ì •] ë‹¤í¬ëª¨ë“œ í´ë˜ìŠ¤ ì ìš© (isPro ì—¬ë¶€ì™€ ë¬´ê´€í•˜ê²Œ ìƒíƒœ ê¸°ë°˜ ì ìš©)
            useEffect(() => {
                if (darkMode) {
                    document.documentElement.classList.add('dark');
                    document.documentElement.style.colorScheme = 'dark';
                } else {
                    document.documentElement.classList.remove('dark');
                    document.documentElement.style.colorScheme = 'light';
                }
                localStorage.setItem('assetDashboardDarkMode', darkMode);
            }, [darkMode]);

            // [ì¶”ê°€] PRO ê¶Œí•œ ìƒì‹¤ ì‹œ íˆìŠ¤í† ë¦¬ ì˜ˆìƒ ìì‚° í‘œì‹œ ê°•ì œ í•´ì œ
            useEffect(() => {
                if (!isPro && showProjectionInHistory) {
                    setShowProjectionInHistory(false);
                }
            }, [isPro, showProjectionInHistory]);

            // [ì¶”ê°€] ê¸°ëŠ¥ ì œì•ˆ ì „ì†¡ í•¸ë“¤ëŸ¬
            const handleSuggestionSubmit = async (content) => {
                if (!supabase) return;
                try {
                    const { data: { user } } = await withRetry(() => supabase.auth.getUser());
                    if (!user) return addToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                    const { data: currentProfile, error: fetchError } = await withRetry(() => 
                        supabase.from('user_profiles').select('suggestions').eq('id', user.id).maybeSingle()
                    );
                    if (fetchError) throw fetchError;
                    const timestamp = new Date().toLocaleString();
                    const newEntry = `[${timestamp}] ${content}`;
                    const updatedSuggestions = currentProfile?.suggestions ? currentProfile.suggestions + '\n\n' + newEntry : newEntry;
                    const { error } = await withRetry(() => 
                        supabase.from('user_profiles').update({ suggestions: updatedSuggestions }).eq('id', user.id)
                    );
                    if (error) throw error;
                    addToast('ì†Œì¤‘í•œ ì˜ê²¬ ê°ì‚¬í•©ë‹ˆë‹¤!', 'success');
                } catch (error) {
                    console.error('Suggestion error:', error);
                    addToast('ì˜ê²¬ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            };

            const handleLogin = async () => {
                if (!supabase) {
                    let msg = 'ë¡œê·¸ì¸ ë¶ˆê°€: ';
                    if (!window.supabase) {
                        msg += 'Supabase ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨';
                    } else if (!SUPABASE_URL || !SUPABASE_KEY) {
                        msg += 'ì„¤ì •ê°’ì´ ì—†ìŠµë‹ˆë‹¤. (Cloudflare í™˜ê²½ë³€ìˆ˜ ë¯¸ì„¤ì •)';
                    } else {
                        msg += 'Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨ (ì„¤ì •ê°’ì„ í™•ì¸í•´ì£¼ì„¸ìš”)';
                    }
                    addToast(msg, 'error');
                    return;
                }
                try {
                    const { error } = await withRetry(() => supabase.auth.signInWithOAuth({
                        provider: 'google',
                        options: { redirectTo: window.location.origin }
                    }));
                    if (error) addToast('ë¡œê·¸ì¸ ì˜¤ë¥˜: ' + error.message, 'error');
                } catch (err) {
                    addToast('ë¡œê·¸ì¸ ìš”ì²­ ì‹œê°„ ì´ˆê³¼: ' + err.message, 'error');
                }
            };

            // ì‹¤ì‹œê°„ í´ë¼ìš°ë“œ ë™ê¸°í™” (Debounced)
            useEffect(() => {
                if (!appData || !isInitialized || isFetchingRef.current || !isCloudLoaded) return;
                const AUTO_SYNC_DELAY = 2000;
                const timer = setTimeout(() => {
                    saveToCloud({ appData, scenarios, assetHistory });
                }, AUTO_SYNC_DELAY);
                return () => clearTimeout(timer);
            }, [appData, scenarios, assetHistory, isInitialized, isCloudLoaded, saveToCloud]);

            // [ì¶”ê°€] ì•”í˜¸í™” ëª¨ë“œ ì„ íƒ í•¸ë“¤ëŸ¬
            const handleEncryptionSelect = (mode) => {
                setEncryptionMode(mode);
                setIsEncryptionModalOpen(false);
                if (mode === 'secure') setIsPasswordPromptOpen(true);
                else saveToCloud({ appData: appDataRef.current, scenarios: scenariosRef.current, assetHistory: assetHistoryRef.current }, true);
            };

            // [ì¶”ê°€] ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í™•ì¸ í•¸ë“¤ëŸ¬
            const handlePasswordConfirm = (password) => {
                setUserSecretKey(password);
                setIsPasswordPromptOpen(false);
                const unifiedData = { appData: appDataRef.current, scenarios: scenariosRef.current, assetHistory: assetHistoryRef.current };
                if (pendingCiphertext.current) {
                    try {
                        const key = window.getEncryptionKey('secure', password, verifiedEmail, SECURITY_KEY);
                        const decrypted = decryptData(pendingCiphertext.current, key);
                        resetAppData(decrypted.appData || decrypted);
                        if (decrypted.scenarios) setScenarios(decrypted.scenarios);
                        if (decrypted.assetHistory) setAssetHistory(decrypted.assetHistory);
                        pendingCiphertext.current = null;
                        setSyncStatus('synced');
                        setIsCloudLoaded(true);
                    } catch (err) {
                        addToast('ë³µí˜¸í™” ì‹¤íŒ¨. ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
                        setIsPasswordPromptOpen(true);
                    }
                } else if (pendingSave.current) {
                    pendingSave.current = false;
                    setEncryptionMode('secure');
                    const key = window.getEncryptionKey('secure', password, verifiedEmail, SECURITY_KEY);
                    saveToCloud(unifiedData, true, null, null, key, 'secure');
                }
            };

            // [ì¶”ê°€] ì•”í˜¸í™” ëª¨ë“œ ë³€ê²½ í•¸ë“¤ëŸ¬
            const handleModeChange = async (newMode) => {
                if (!isPro) return setIsProModalOpen(true);
                if (newMode === encryptionMode) return;
                if (newMode === 'secure') {
                    pendingSave.current = true;
                    setIsPasswordPromptOpen(true);
                } else if (confirm('ì¼ë°˜ ë³´ì•ˆ ëª¨ë“œë¡œ ì „í™˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    setEncryptionMode('normal');
                    setUserSecretKey('');
                    sessionStorage.removeItem('assetDashboardSecretKey');
                    const key = window.getEncryptionKey('normal', '', verifiedEmail, SECURITY_KEY);
                    await saveToCloud({ appData: appDataRef.current, scenarios: scenariosRef.current, assetHistory: assetHistoryRef.current }, true, null, null, key, 'normal');
                }
            };

            // [ì¶”ê°€] ì‹¤ì‹œê°„ ë™ê¸°í™” êµ¬ë…
            useEffect(() => {
                if (!supabase || !verifiedEmail) return;
                const channel = supabase.channel('realtime_assets').on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'user_assets', filter: `email=eq.${verifiedEmail}` }, (payload) => {
                    const cloudTime = new Date(payload.new.updated_at).getTime();
                    const localTime = new Date(localStorage.getItem('assetDashboardLastUpdate') || 0).getTime();
                    if (cloudTime > localTime) fetchFromCloud(verifiedEmail, isPro, false, false);
                }).subscribe();
                return () => supabase.removeChannel(channel);
            }, [supabase, verifiedEmail, isPro, fetchFromCloud]);

            const saveAsDefault = () => {
                if (confirm('í˜„ì¬ ì„¤ì •ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    localStorage.setItem('assetDashboardCustomDefault', JSON.stringify(appData));
                    addToast('í˜„ì¬ ì„¤ì •ì´ ê¸°ë³¸ê°’ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                }
            };

            const loadCustomDefault = () => {
                try {
                    const customDefault = localStorage.getItem('assetDashboardCustomDefault');
                    if (customDefault && confirm('ì €ì¥ëœ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        resetAppData(JSON.parse(customDefault));
                        setIsDemoMode(false);
                        addToast('ê¸°ë³¸ê°’ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.', 'success');
                    } else if (!customDefault && confirm('ì €ì¥ëœ ê¸°ë³¸ê°’ì´ ì—†ìŠµë‹ˆë‹¤. ì‚¬ì´íŠ¸ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        resetAppData(window.publicDefaultData || {});
                        setIsDemoMode(false);
                        addToast('ì‚¬ì´íŠ¸ ê¸°ë³¸ê°’ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.', 'info');
                    }
                } catch (error) {
                    addToast('ê¸°ë³¸ê°’ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            };

            const cycleDisplayMode = () => {
                if (!isDemoMode && appData?.displayMode === 'amount') setAppData(prev => ({ ...prev, displayMode: 'percent' }));
                else if (!isDemoMode && appData?.displayMode === 'percent') { resetAppData(window.publicDefaultData || {}); setIsDemoMode(true); }
                else { resetAppData({...originalUserData, displayMode: 'amount'}); setIsDemoMode(false); }
            };

            // ì œëª©ì— í‘œì‹œë  í…ìŠ¤íŠ¸
            const titleText = isDemoMode 
                ? <span className="text-sm text-red-500">(ë°ëª¨ ëª¨ë“œ)</span>
                : appData?.displayMode === 'percent' 
                    ? <span className="text-sm text-blue-500">(í”„ë¼ì´ë¹— ëª¨ë“œ)</span> : null;

            // ===== ê°œì„ ëœ PDF ì €ì¥ í•¨ìˆ˜ =====
            const saveToPDF = async () => {
                const originalDarkMode = darkMode;
                const loadingAlert = document.createElement('div');

                try {
                    // ë¡œë”© ì•Œë¦¼ í‘œì‹œ
                    loadingAlert.className = 'fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded shadow-lg z-50';
                    loadingAlert.textContent = 'PDF ìƒì„± ì¤‘...';
                    document.body.appendChild(loadingAlert);

                    // [ì¶”ê°€] ë‹¤í¬ëª¨ë“œì¸ ê²½ìš° ë¼ì´íŠ¸ëª¨ë“œë¡œ ì¼ì‹œ ì „í™˜ (ì°¨íŠ¸ ìƒ‰ìƒ ë° í°íŠ¸ ë°˜ì˜)
                    if (originalDarkMode) {
                        setDarkMode(false);
                        // React ìƒíƒœ ë°˜ì˜ ë° ì°¨íŠ¸ ì—…ë°ì´íŠ¸ ëŒ€ê¸° (ì• ë‹ˆë©”ì´ì…˜ ê³ ë ¤)
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }

                    // ìš”ì†Œ í™•ì¸
                    const element = document.getElementById('dashboard-content');
                    if (!element) {
                        throw new Error('ëŒ€ì‹œë³´ë“œ ì½˜í…ì¸ ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }

                    // [ìˆ˜ì •] PDF ì €ì¥ ì‹œ ë¼ì´íŠ¸ëª¨ë“œ ê°•ì œ ì ìš© (onclone í™œìš©)
                    const canvas = await html2canvas(element, {
                        scale: 1.2,
                        useCORS: true,
                        allowTaint: false,
                        // [ìˆ˜ì • ì‚¬í•­ 4] PDF ë°°ê²½ìƒ‰ì„ í°ìƒ‰ìœ¼ë¡œ ëª…ì‹œì  ì„¤ì •
                        backgroundColor: '#ffffff',
                        onclone: (clonedDoc) => {
                            clonedDoc.documentElement.classList.remove('dark');
                            clonedDoc.getElementById('dashboard-content').style.backgroundColor = '#f9fafb';
                        },
                        logging: false,
                        width: element.scrollWidth,
                        height: element.scrollHeight,
                        scrollX: 0,
                        scrollY: 0
                    });
                    
                    const imgData = canvas.toDataURL('image/png', 0.8);
                    
                    // jsPDF ì¸ìŠ¤í„´ìŠ¤ ìƒì„± í™•ì¸ (UMD ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í˜¸í™˜)
                    const JSPDF_NS = window.jspdf || window.jsPDF || window.jsPDFModule;
                    if (!JSPDF_NS || !JSPDF_NS.jsPDF) {
                        throw new Error('PDF ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                    const pdf = new JSPDF_NS.jsPDF('p', 'mm', 'a4');
                    const imgWidth = 210;
                    const pageHeight = 295;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 0;

                    // ì²« í˜ì´ì§€
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;

                    // ì¶”ê°€ í˜ì´ì§€
                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }

                    // íŒŒì¼ëª… ìƒì„±
                    const fileName = `ìì‚°ë¶„ì„ë³´ê³ ì„œ_${new Date().toISOString().split('T')[0]}.pdf`;
                    pdf.save(fileName);
                    
                    // ì„±ê³µ ì•Œë¦¼
                    loadingAlert.textContent = 'PDF ì €ì¥ ì™„ë£Œ!';
                    loadingAlert.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow-lg z-50';

                } catch (error) {
                    console.error('PDF ì €ì¥ ì˜¤ë¥˜:', error);
                    
                    // ì˜¤ë¥˜ ì•Œë¦¼
                    const errorAlert = document.createElement('div');
                    errorAlert.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded shadow-lg z-50';
                    errorAlert.textContent = `PDF ì €ì¥ ì‹¤íŒ¨: ${error.message}`;
                    document.body.appendChild(errorAlert);
                    
                    setTimeout(() => {
                        if (document.body.contains(errorAlert)) {
                            document.body.removeChild(errorAlert);
                        }
                    }, 5000);
                    } finally {
                    // [ì¶”ê°€] ì›ë˜ ëª¨ë“œë¡œ ë³µêµ¬ (ë‹¤í¬ëª¨ë“œì˜€ë‹¤ë©´ ë‹¤ì‹œ ë‹¤í¬ëª¨ë“œë¡œ)
                    if (originalDarkMode) {
                        setDarkMode(true);
                    }

                    // [ì¶”ê°€] ë¡œë”© ì•Œë¦¼ ì œê±° (ì„±ê³µ/ì‹¤íŒ¨ ê´€ê³„ì—†ì´ 2ì´ˆ í›„ ì œê±°)
                    setTimeout(() => {
                        if (document.body.contains(loadingAlert)) {
                            document.body.removeChild(loadingAlert);
                        }
                    
                    }, 2000);
                }
            };

            // ===== ì‹œë‚˜ë¦¬ì˜¤ ê´€ë¦¬ í•¨ìˆ˜ë“¤ =====
            const saveScenario = () => {
                // [ìˆ˜ì •] ì‹œë‚˜ë¦¬ì˜¤ ì €ì¥ ì‹œ ê¹”ë”í•œ ê¸°ë³¸ ì´ë¦„ ì œê³µ (ì§€ì €ë¶„í•œ ìë™ì™„ì„± ë°©ì§€)
                const name = prompt('ì‹œë‚˜ë¦¬ì˜¤ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', `ì‹œë‚˜ë¦¬ì˜¤ ${new Date().toISOString().slice(0,10)}`);
                if (name && name.trim()) {
                    const newScenario = {
                        id: Date.now(),
                        name: name.trim(),
                        data: { ...appData },
                        createdAt: new Date().toISOString()
                    };
                    setScenarios(prev => [...prev, newScenario]);
                    addToast('ì‹œë‚˜ë¦¬ì˜¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                }
            };

            const loadScenario = (scenario) => {
                if (confirm(`"${scenario.name}" ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    // [ì¶”ê°€] ë¶ˆëŸ¬ì˜¤ê¸° ì „ í˜„ì¬ ë°ì´í„° ë°±ì—… í™•ì¸
                    if (confirm('í˜„ì¬ ë°ì´í„°ë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ë°±ì—…í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ë°±ì—…í•˜ì§€ ì•Šìœ¼ë©´ í˜„ì¬ ì‘ì—… ë‚´ìš©ì´ ë®ì–´ì“°ì—¬ì§‘ë‹ˆë‹¤)')) {
                        localStorage.setItem('assetDashboardCustomDefault', JSON.stringify(appData));
                        addToast('í˜„ì¬ ë°ì´í„°ê°€ ê¸°ë³¸ê°’ìœ¼ë¡œ ë°±ì—…ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    }

                    // [ìˆ˜ì •] ì‹œë‚˜ë¦¬ì˜¤ ë°ì´í„° ë³‘í•© ë¡œì§ ê°œì„  (ëˆ„ë½ëœ í•„ë“œ ë³´ì™„)
                    const base = JSON.parse(JSON.stringify(window.publicDefaultData || {}));
                    const loaded = scenario.data || {};
                    
                    const mergedData = {
                        ...base,
                        ...loaded,
                        assets: { ...base.assets, ...(loaded.assets || {}) },
                        monthlyExpenses: Array.isArray(loaded.monthlyExpenses) ? loaded.monthlyExpenses : base.monthlyExpenses,
                        incomeEvents: Array.isArray(loaded.incomeEvents) ? loaded.incomeEvents : base.incomeEvents,
                        expenseEvents: Array.isArray(loaded.expenseEvents) ? loaded.expenseEvents : base.expenseEvents,
                    };
                    resetAppData(mergedData);
                }
            };

            const deleteScenario = (id) => {
                if (confirm('ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    setScenarios(prev => prev.filter(s => s.id !== id));
                }
            };

            // ===== ì˜ˆì‚° ê³„ì‚° =====
            const totalMonthlyExpense = useMemo(() => {
                if (!monthlyExpenses || !Array.isArray(monthlyExpenses)) return 0;
                return monthlyExpenses.reduce((sum, e) => sum + Number(e.amount || 0), 0);
            }, [monthlyExpenses]);
            
            const totalSectorMonthlyContrib = useMemo(() => {
                if (!assets || typeof assets !== 'object') return 0;
                let sum = 0;
                Object.entries(assets).forEach(([sector, arr]) => {
                    if (Array.isArray(arr)) {
                        arr.forEach(asset => { sum += Number(asset.monthlyContrib || 0); });
                    }
                });
                return sum;
            }, [assets]);
            
            const maxSectorMonthlyContrib = useMemo(() => Math.max(0, monthlySalary - totalMonthlyExpense), [monthlySalary, totalMonthlyExpense]);
            const autoDepositAmount = Math.max(0, maxSectorMonthlyContrib - totalSectorMonthlyContrib);

            // ===== ê°œì„ ëœ ëª©í‘œ ë‹¬ì„± ê³„ì‚° =====
            const calculateGoalSeek = () => {
                if (!targetAmount || targetAmount <= 0) {
                    addToast('ìœ íš¨í•œ ëª©í‘œ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                    return;
                }

                // [ìµœì í™”] ë§¤ë‹¬ ì‹œë®¬ë ˆì´ì…˜ì„ ìƒˆë¡œ ëŒë¦¬ëŠ” ëŒ€ì‹ , í•œ ë²ˆì˜ ê¸´ ì‹œë®¬ë ˆì´ì…˜(600ê°œì›”) í›„ ê²°ê³¼ íƒìƒ‰
                const MAX_MONTHS = 600;
                const result = calculateMonthlyProjection(appData, MAX_MONTHS);
                
                if (result.error) {
                    setGoalSeekResult(`ê³„ì‚° ì¤‘ ì˜¤ë¥˜ ë°œìƒ`);
                    return;
                }

                const projections = result.projections;
                let lastNetWorth = -Infinity;
                let stagnationCount = 0;
                let targetMonth = -1;

                for (let i = 1; i < projections.length; i++) {
                    const p = projections[i];
                    
                    // ìì‚° ì •ì²´ ì²´í¬
                    if (p.total <= lastNetWorth) {
                        stagnationCount++;
                    } else {
                        stagnationCount = 0;
                    }
                    lastNetWorth = p.total;

                    if (stagnationCount >= 3) {
                        setGoalSeekResult('ìì‚° ì •ì²´/ê°ì†Œë¡œ ì¸í•´ ëª©í‘œ ë‹¬ì„±ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.');
                        return;
                    }

                    if (p.total >= targetAmount) {
                        targetMonth = p.month;
                        break;
                    }
                }

                if (targetMonth !== -1) {
                    setGoalSeekResult(`ëª©í‘œ ë‹¬ì„±ê¹Œì§€ ì•½ ${targetMonth}ê°œì›” ì†Œìš”ë©ë‹ˆë‹¤.`);
                    setProjectionMonths(targetMonth);
                } else {
                    setGoalSeekResult('í˜„ì¬ ì¡°ê±´ìœ¼ë¡œëŠ” 50ë…„ ë‚´ ëª©í‘œ ë‹¬ì„±ì´ ì–´ë µìŠµë‹ˆë‹¤.');
                }
            };

            // [ì¶”ê°€] ë ˆì´ì•„ì›ƒ ì´ë™ í•¨ìˆ˜
            const movePanel = (id, direction) => {
                setLayoutOrder(prev => {
                    const index = prev.indexOf(id);
                    if (index === -1) return prev;
                    const newIndex = index + direction;
                    if (newIndex < 0 || newIndex >= prev.length) return prev;
                    const newOrder = [...prev];
                    [newOrder[index], newOrder[newIndex]] = [newOrder[newIndex], newOrder[index]];
                    return newOrder;
                });
            };

            const togglePanelCollapse = (panelId) => {
                setPanelCollapseState(prev => ({
                    ...prev,
                    [panelId]: !prev[panelId]
                }));
            };

            const moveAssetSector = (sectorKey, direction) => {
                setAssetSectorOrder(prev => {
                    const index = prev.indexOf(sectorKey);
                    if (index === -1) return prev;
                    const newIndex = index + direction;
                    if (newIndex < 0 || newIndex >= prev.length) return prev;
                    const newOrder = [...prev];
                    [newOrder[index], newOrder[newIndex]] = [newOrder[newIndex], newOrder[index]];
                    return newOrder;
                });
            };

            // [ì¶”ê°€] íŒ¨ë„(ë¹ ë¥¸ ì´ë™) ë“œë˜ê·¸ ì•¤ ë“œë¡­ ìƒíƒœ ë° í•¸ë“¤ëŸ¬
            const [draggedPanelId, setDraggedPanelId] = useState(null);

            const handlePanelDragStart = React.useCallback((e, id) => {
                setDraggedPanelId(id);
                e.dataTransfer.effectAllowed = "move";
            }, []);

            const handlePanelDragOver = React.useCallback((e) => e.preventDefault(), []);

            const handlePanelDrop = React.useCallback((e, targetId) => {
                e.preventDefault();
                if (!draggedPanelId || draggedPanelId === targetId) return;

                setLayoutOrder(prev => {
                    const oldIndex = prev.indexOf(draggedPanelId);
                    const newIndex = prev.indexOf(targetId);
                    if (oldIndex === -1 || newIndex === -1) return prev;
                    const newOrder = [...prev];
                    newOrder.splice(oldIndex, 1);
                    newOrder.splice(newIndex, 0, draggedPanelId);
                    return newOrder;
                });
                setDraggedPanelId(null);
            }, [draggedPanelId]);

            const calculation = useMemo(() => {
                if (!appData || !appData.assets || typeof appData.assets !== 'object') {
                    return {
                        initial: {},
                        projected: {},
                        currentTotal: 0,
                        projectedTotal: 0,
                        growth: 0,
                        grand: 0,
                        realValue: 0,
                        monthlyProjections: [],
                        warnings: [],
                        fireMetrics: null,
                        rebalanceInfo: null
                    };
                }
                
                const months = projectionMonths;
                // [ìˆ˜ì •] ì¸í”Œë ˆì´ì…˜ ë³´ì • ë° ì´ë²¤íŠ¸ ë°°ì—´ ì•ˆì „ì„± í™•ë³´ (undefined ë°©ì§€)
                const safeAppData = {
                    ...appData,
                    incomeEvents: Array.isArray(appData.incomeEvents) ? appData.incomeEvents : [],
                    expenseEvents: Array.isArray(appData.expenseEvents) ? appData.expenseEvents : [],
                };

                const localTotalMonthlyExpense = (appData.monthlyExpenses || []).reduce((sum, e) => sum + Number(e.amount || 0), 0);
                
                // 1. High-Precision Initial Metrics
                let currentTotal = 0;
                let totalNetProfitMonthlyInitial = 0;
                let totalInvestedPrincipal = 0;
                const sectorSums = {};
                
                Object.keys(appData.assets).forEach(sector => {
                    if (!sectorSums[sector]) sectorSums[sector] = 0;
                    (appData.assets[sector] || []).forEach(asset => {
                        const amt = Number(asset.amount || 0);
                        if (sector === 'loan') {
                            currentTotal -= amt;
                        } else {
                            currentTotal += amt;
                            sectorSums[sector] += amt;
                            totalInvestedPrincipal += amt;
                            // Monthly_Net_Profit = (Amount * rate / 1200) * (1 - feeRate / 100)
                            const monthlyProfit = (amt * (Number(asset.rate || 0) / 1200)) * (1 - (Number(asset.feeRate || 0) / 100));
                            totalNetProfitMonthlyInitial += monthlyProfit;
                        }
                    });
                });

                // 2. Individual Asset Simulation (Runway - 1200 Months)
                let runwayMonths = 0;
                let debtFreeMonth = -1;
                const maxSimMonths = 1200;
                const simAssets = JSON.parse(JSON.stringify(appData.assets));
                
                // [ìˆ˜ì •] ì´ˆê¸° ìì‚°ì´ 0 ì´í•˜ì¸ ê²½ìš° ìƒì¡´ ê¸°ê°„ 0ìœ¼ë¡œ ì²˜ë¦¬
                if (currentTotal <= 0) {
                    runwayMonths = 0;
                } else {
                    // [Refactor] Find Main Account in Simulation Data
                    let simMainAccount = null;
                    for (const s in simAssets) {
                        const found = simAssets[s].find(a => a.name === appData.mainCashFlowAccount);
                        if (found) { simMainAccount = found; break; }
                    }
                    if (!simMainAccount) {
                        const firstSector = Object.keys(simAssets).find(s => s !== 'loan' && simAssets[s].length > 0);
                        if (firstSector) simMainAccount = simAssets[firstSector][0];
                    }

                    for (let m = 1; m <= maxSimMonths; m++) {
                        // 1. Inflation Adjusted Expense
                        const inflationFactor = Math.pow(1 + inflationRate / 1200, m);
                        const currentMonthlyExpense = localTotalMonthlyExpense * inflationFactor;

                        // 2. Loan Repayment & Interest
                        let totalLoanRepayment = 0;
                        let currentLoanBalance = 0;

                        if (simAssets.loan) {
                            simAssets.loan.forEach(loan => {
                                if (loan.amount > 0) {
                                    const interest = loan.amount * (Number(loan.rate || 0) / 1200);
                                    const monthlyPayment = Number(loan.monthlyContrib || 0);
                                    
                                    let cashOutflow = monthlyPayment;
                                    let principalPayment = monthlyPayment - interest;

                                    if (loan.amount + interest <= monthlyPayment) {
                                        cashOutflow = loan.amount + interest;
                                        principalPayment = loan.amount;
                                        loan.amount = 0;
                                    } else {
                                        loan.amount -= principalPayment;
                                    }
                                    
                                    totalLoanRepayment += cashOutflow;
                                    currentLoanBalance += loan.amount;
                                }
                            });
                        }

                        if (currentLoanBalance <= 0 && debtFreeMonth === -1) {
                            debtFreeMonth = m;
                        }
                        
                        // 3. Net Flow (Salary = 0 for Survival Mode)
                        let eventFlow = 0;
                        const checkEvent = (e) => {
                            if (!e.startMonth || typeof e.startMonth !== 'string' || !e.endMonth || typeof e.endMonth !== 'string') return false;
                            const [bY, bM] = baseMonth.split('-').map(Number);
                            const [sY, sM] = e.startMonth.split('-').map(Number);
                            const [eY, eM] = e.endMonth.split('-').map(Number);
                            const cur = bY * 12 + bM + m - 1;
                            return cur >= (sY * 12 + sM) && cur <= (eY * 12 + eM);
                        };
                        safeAppData.incomeEvents.forEach(e => { if (checkEvent(e)) eventFlow += Number(e.amount || 0); });
                        safeAppData.expenseEvents.forEach(e => { if (checkEvent(e)) eventFlow -= Number(e.amount || 0); });

                        const netFlow = eventFlow - currentMonthlyExpense - totalLoanRepayment;

                        // 4. Apply to Main Account & Liquidate
                        if (simMainAccount) {
                            simMainAccount.amount += netFlow;
                        }

                        // Liquidation Logic (Prevent Negative Cash)
                        if (simMainAccount && simMainAccount.amount < 0) {
                            let deficit = -simMainAccount.amount;
                            simMainAccount.amount = 0;

                            const liquidationOrder = ['deposit', 'savings', 'investment'];
                            for (const sector of liquidationOrder) {
                                if (deficit <= 0) break;
                                if (!simAssets[sector]) continue;

                                for (const asset of simAssets[sector]) {
                                    if (deficit <= 0) break;
                                    if (asset.name === simMainAccount.name) continue;
                                    if (asset.amount <= 0) continue;

                                    const taken = Math.min(asset.amount, deficit);
                                    asset.amount -= taken;
                                    deficit -= taken;
                                }
                            }

                            if (deficit > 0) {
                                runwayMonths = m - 1;
                                break;
                            }
                        } else if (!simMainAccount && netFlow < 0) {
                             runwayMonths = m - 1;
                             break;
                        }

                        // 5. Apply Profits (Growth)
                        Object.keys(simAssets).forEach(sector => {
                            if (sector === 'loan') return;
                            simAssets[sector].forEach(asset => {
                                if (asset.amount > 0) {
                                    const profit = asset.amount * (Number(asset.rate || 0) / 1200) * (1 - (Number(asset.feeRate || 0) / 100));
                                    asset.amount += profit;
                                }
                            });
                        });

                        if (m === maxSimMonths) runwayMonths = maxSimMonths;
                    }
                }

                // 3. FIRE Indicators (Reverse Engineered)
                const loanInterestInitial = (appData.assets.loan || []).reduce((sum, l) => sum + (Number(l.amount || 0) * Number(l.rate || 0) / 1200), 0);
                const annualFixedExp = (localTotalMonthlyExpense + loanInterestInitial) * 12;
                const annualFixedExpPostDebt = localTotalMonthlyExpense * 12;

                const swr4PercentCapital = annualFixedExpPostDebt * 25; // 4% Rule Reference

                // 4. Soft Rebalancing Engine (Pro-rata)
                const disposableIncome = Math.max(0, (appData.monthlySalary || 0) - localTotalMonthlyExpense);
                const targetMonths = appData.rebalanceMonths || 12;
                const futureValue = currentTotal + (disposableIncome * targetMonths);
                const sectorGaps = {};
                let totalGap = 0;
                const validSectors = Object.keys(sectorInfo).filter(k => k !== 'loan');
                const itemRecs = {};
                const rebalancingGlobal = appData.rebalancingGlobal || { sector: { warning: 5, danger: 10 }, item: { warning: 5, danger: 10 } };
                
                validSectors.forEach(sector => {
                    const targetPct = (appData.rebalancingTargets && appData.rebalancingTargets[sector] !== undefined) 
                        ? appData.rebalancingTargets[sector] 
                        : Math.round(100 / validSectors.length);
                    const targetBalance = futureValue * (targetPct / 100);
                    const currentBalance = sectorSums[sector] || 0;
                    const gap = Math.max(0, targetBalance - currentBalance);
                    sectorGaps[sector] = gap;
                    totalGap += gap;
                });

                const budgetLimited = (totalGap / targetMonths) > disposableIncome;
                const sectorRecs = {};
                validSectors.forEach(sector => {
                    if (totalGap === 0) sectorRecs[sector] = 0;
                    else {
                        sectorRecs[sector] = budgetLimited 
                            ? (sectorGaps[sector] / totalGap) * disposableIncome 
                            : (sectorGaps[sector] / targetMonths);
                    }
                });

                // [ì¶”ê°€] í•­ëª©ë³„ ë¦¬ë°¸ëŸ°ì‹± ì¶”ì²œ ê³„ì‚°
                validSectors.forEach(sector => {
                    const sectorAssets = appData.assets[sector] || [];
                    if (sectorAssets.length === 0) return;
                    
                    const sectorMonthlyContrib = sectorRecs[sector] || 0;
                    const sectorTargetPct = (appData.rebalancingTargets && appData.rebalancingTargets[sector] !== undefined) ? appData.rebalancingTargets[sector] : Math.round(100 / validSectors.length);
                    const sectorFutureValue = futureValue * (sectorTargetPct / 100);
                    
                    let totalItemWeight = 0;
                    const currentItemTargets = appData.itemTargets || {};
                    sectorAssets.forEach(a => { totalItemWeight += (currentItemTargets[a.id] ?? Math.round(100/sectorAssets.length)); });
                    
                    let totalItemGap = 0;
                    const currentItemGaps = {};
                    
                    sectorAssets.forEach(a => {
                        const weight = (currentItemTargets[a.id] ?? Math.round(100/sectorAssets.length));
                        const normWeight = totalItemWeight === 0 ? 0 : (weight / totalItemWeight);
                        const targetVal = sectorFutureValue * normWeight;
                        const gap = Math.max(0, targetVal - (a.amount || 0));
                        currentItemGaps[a.id] = gap;
                        totalItemGap += gap;
                    });
                    
                    sectorAssets.forEach(a => {
                        itemRecs[a.id] = totalItemGap > 0 ? (currentItemGaps[a.id] / totalItemGap) * sectorMonthlyContrib : 0;
                    });
                });

                const { projections: monthlyProjections, warnings } = calculateMonthlyProjection({ ...safeAppData, inflationRate }, months);

                if (!monthlyProjections || monthlyProjections.length === 0) {
                    return { error: true, warnings: [] };
                }

                const initialProjection = monthlyProjections[0] || {};
                const newCurrentTotal = initialProjection.total || 0;
                const newCurrentNet = initialProjection.net || 0;
                const newCurrentGross = initialProjection.gross || 0;

                const finalProjection = monthlyProjections[monthlyProjections.length - 1];
                const newProjectedTotal = finalProjection ? finalProjection.total : newCurrentTotal;
                const newProjectedNet = finalProjection ? finalProjection.net : newCurrentNet;
                const newProjectedGross = finalProjection ? finalProjection.gross : newCurrentGross;

                const realValue = newProjectedGross / Math.pow(1 + inflationRate / 100, months / 12);

                return {
                    initial: appData.assets,
                    projected: finalProjection ? finalProjection.assets : appData.assets,
                    currentTotal: newCurrentTotal,
                    currentNet: newCurrentNet,
                    currentGross: newCurrentGross,
                    projectedTotal: newProjectedTotal,
                    projectedNet: newProjectedNet,
                    projectedGross: newProjectedGross,
                    realValue,
                    growth: newProjectedGross - newCurrentGross,
                    grand: newCurrentNet, // grand for history is net assets
                    monthlyProjections: monthlyProjections,
                    warnings: warnings,
                    fireMetrics: {
                        runwayMonths,
                        debtFreeMonth,
                        swr4PercentCapital
                    },
                    totalMonthlyExpense: localTotalMonthlyExpense,
                    rebalanceInfo: {
                        recs: sectorRecs,
                        budgetLimited,
                        targetMonths: targetMonths,
                        itemRecs
                    }
                };
            }, [appData, inflationRate, projectionMonths, baseMonth]);


            // [ìˆ˜ì •] ì°¨íŠ¸ ë Œë”ë§ ìµœì í™”ë¥¼ ìœ„í•œ ë°ì´í„° ë©”ëª¨ì´ì œì´ì…˜ (ë¶ˆí•„ìš”í•œ ë¦¬ë Œë”ë§ ë°©ì§€)
            const { currentGrossTotal, projectedGrossTotal, currentSectorTotals, projectedSectorTotals } = useMemo(() => {
                const cGross = calculateGrossTotal(calculation.initial);
                const pGross = calculateGrossTotal(calculation.projected);
                return {
                    currentGrossTotal: cGross,
                    projectedGrossTotal: pGross,
                    currentSectorTotals: getSectorTotals(calculation.initial, cGross),
                    projectedSectorTotals: getSectorTotals(calculation.projected, pGross)
                };
            }, [calculation]);

            // [ì¶”ê°€] ì°¨íŠ¸ìš© í‚¤ ë°°ì—´ (ì»´í¬ë„ŒíŠ¸ ìŠ¤ì½”í”„ë¡œ ì´ë™í•˜ì—¬ í•¸ë“¤ëŸ¬ì—ì„œ ì°¸ì¡° ê°€ëŠ¥í•˜ë„ë¡ í•¨)
            const filteredKeys = useMemo(() => Object.keys(currentSectorTotals).filter(k => k !== 'loan'), [currentSectorTotals]);
            const projectedKeys = useMemo(() => Object.keys(projectedSectorTotals).filter(k => k !== 'loan'), [projectedSectorTotals]);

            // ===== ë¦¬ë°¸ëŸ°ì‹± ê²½ê³  í•¨ìˆ˜ (ëª©í‘œ ë¹„ì¤‘ ê¸°ì¤€ í¸ì°¨) =====
            const getRebalanceStatus = (key, percentage, isItem = false, itemId = null, sectorKey = null) => {
                const globalSettings = appData.rebalancingGlobal || { sector: { warning: 5, danger: 10 }, item: { warning: 5, danger: 10 } };
                const thresholds = isItem ? globalSettings.item : globalSettings.sector;
                
                let target;
                if (isItem && sectorKey) {
                    const assetsInSector = assets[sectorKey] || [];
                    const totalWeight = assetsInSector.reduce((sum, a) => sum + (appData.itemTargets?.[a.id] ?? Math.round(100/assetsInSector.length)), 0);
                    const rawTarget = appData.itemTargets?.[itemId] ?? Math.round(100/assetsInSector.length);
                    target = totalWeight === 0 ? 0 : (rawTarget / totalWeight) * 100;
                } else {
                    target = rebalancingTargets[key] ?? (100 / Object.keys(sectorInfo).length);
                }

                const deviation = Math.abs(percentage - target);
                if (isItem) {
                    if (deviation >= thresholds.danger) return 'text-red-600 dark:text-red-400 font-bold';
                    if (deviation >= thresholds.warning) return 'text-yellow-600 dark:text-yellow-400 font-bold';
                } else {
                    if (deviation >= thresholds.danger) return 'bg-red-100 text-red-800 dark:bg-red-900/60 dark:text-red-100';
                    if (deviation >= thresholds.warning) return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/60 dark:text-yellow-100';
                }
                return '';
            };

            // ===== ìë™ì…ê¸ˆ ê³„ì‚°ì‹ í‘œì‹œ í•¨ìˆ˜ =====
            const getAutoDepositBreakdown = () => {
                const breakdown = [];
                Object.keys(assets).forEach(sectorKey => {
                    if (Array.isArray(assets[sectorKey])) {
                        assets[sectorKey].forEach(asset => {
                            if (asset.monthlyContrib > 0) {
                                breakdown.push({
                                    sector: sectorKey,
                                    name: asset.name,
                                    amount: asset.monthlyContrib
                                });
                            }
                        });
                    }
                });
                return breakdown;
            };

            const autoDepositBreakdown = getAutoDepositBreakdown();

            // ===== ì°¨íŠ¸ í—¬í¼ ë° ì„¤ì • =====

            const initChart = (id, ref, config) => {
                if (ref.current) {
                    const ctx = ref.current.getContext('2d');
                    if (ctx) {
                        chartInstancesRef.current[id] = new Chart(ctx, config);
                    }
                }
            };

            const commonChartOptions = useMemo(() => {
                const textColor = darkMode ? '#e5e7eb' : '#111827';
                const gridColor = darkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                return {
                    maintainAspectRatio: false,
                    responsive: true,
                    animation: { animateScale: true, animateRotate: true, duration: 1000 },
                    plugins: {
                        legend: { position: 'bottom', labels: { color: textColor, padding: 15, font: { family: 'Pretendard' } } },
                        datalabels: {
                            color: darkMode ? '#ffffff' : '#111827',
                            anchor: 'center', // [ìˆ˜ì •] ì¤‘ì•™ ë°°ì¹˜
                            align: 'center',  // [ìˆ˜ì •] ì¤‘ì•™ ë°°ì¹˜
                            font: { weight: 'bold', size: 11 },
                            formatter: (value, ctx) => {
                                const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0) || 1;
                                const pct = (value / total) * 100;
                                return pct > 4 ? `${pct.toFixed(1)}%` : '';
                            }
                        },
                        tooltip: {
                            backgroundColor: darkMode ? 'rgba(15, 23, 42, 0.95)' : 'rgba(255, 255, 255, 0.95)',
                            titleColor: darkMode ? '#f8fafc' : '#1e293b',
                            bodyColor: darkMode ? '#cbd5e1' : '#475569',
                            borderColor: gridColor,
                            borderWidth: 1,
                            padding: 10,
                            cornerRadius: 8,
                            callbacks: {
                                label: (ctx) => {
                                    const label = ctx.label || '';
                                    const val = ctx.parsed || 0;
                                    const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                    const pct = ((val / total) * 100).toFixed(1);
                                    return ` ${label}: ${Math.round(val).toLocaleString()}ë§Œì› (${pct}%)`;
                                }
                            }
                        }
                    }
                };
            }, [darkMode]);

            const chartBorderColor = darkMode ? '#1e293b' : '#ffffff';

            // [ìˆ˜ì •] 1. í˜„ì¬ í¬íŠ¸í´ë¦¬ì˜¤ ì°¨íŠ¸ (ë…ë¦½ ë Œë”ë§)
            useEffect(() => {
                if (isLoading || panelCollapseState['charts'] || typeof Chart === 'undefined') return;

                const renderCurrentPie = () => {
                    if (!currentPieRef.current) return;
                    let labels, data, colors;
                    if (currentDrillDown) {
                        const sectorAssets = assets[currentDrillDown] || [];
                        labels = sectorAssets.map(a => a.name);
                        data = sectorAssets.map(a => a.amount);
                        // [ìˆ˜ì •] ì „ì—­ getRGB í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ë“œë¦´ë‹¤ìš´ ìƒ‰ìƒ ì¼ê´€ì„± ìœ ì§€
                        const baseRGB = window.getRGB(sectorInfo[currentDrillDown].color);
                        colors = sectorAssets.map((_, i) => `rgba(${baseRGB}, ${0.9 - (i * 0.1)})`);
                    } else {
                        labels = filteredKeys.map(key => sectorInfo[key]?.name || key);
                        data = filteredKeys.map(key => currentSectorTotals[key]?.amount || 0);
                    }

                    const ctx = currentPieRef.current.getContext('2d');
                    const bgColors = currentDrillDown ? colors : filteredKeys.map(key => {
                        const c = tailwind?.config?.theme?.extend?.colors?.[key] || { start: '#3b82f6', end: '#1d4ed8' };
                        return createGradient(ctx, c);
                    });

                    const chartConfig = {
                            type: 'doughnut',
                            data: {
                                labels: labels,
                                datasets: [{
                                    data: data,
                                    backgroundColor: bgColors,
                                    borderWidth: 2,
                                    borderColor: chartBorderColor,
                                    hoverOffset: 15
                                }]
                            },
                            options: {
                                ...commonChartOptions,
                                onClick: (evt, elements) => {
                                    if (currentDrillDown) {
                                        setCurrentDrillDown(null);
                                    } else if (elements && elements.length > 0) {
                                        const index = elements[0].index;
                                        setCurrentDrillDown(filteredKeys[index]);
                                    }
                                },
                                plugins: {
                                    ...commonChartOptions.plugins,
                                    title: { display: true, text: currentDrillDown ? `${sectorInfo[currentDrillDown]?.name || currentDrillDown} ìƒì„¸` : 'í˜„ì¬ í¬íŠ¸í´ë¦¬ì˜¤', color: darkMode ? '#e5e7eb' : '#111827', font: { size: 16, weight: 'bold' } }
                                }
                            },
                            plugins: [ChartDataLabels]
                    };

                    if (chartInstancesRef.current['currentPie']) {
                        const chart = chartInstancesRef.current['currentPie'];
                        chart.data = chartConfig.data;
                        chart.options = chartConfig.options;
                        chart.update('none');
                    } else {
                        chartInstancesRef.current['currentPie'] = new Chart(ctx, chartConfig);
                    }
                };
                const timerId = setTimeout(renderCurrentPie, 50);
                return () => clearTimeout(timerId);
            }, [currentDrillDown, currentSectorTotals, filteredKeys, assets, darkMode, isLoading, panelCollapseState['charts']]);

            // [ìˆ˜ì •] 2. ì˜ˆìƒ í¬íŠ¸í´ë¦¬ì˜¤ ì°¨íŠ¸ (ë…ë¦½ ë Œë”ë§)
            useEffect(() => {
                if (isLoading || panelCollapseState['charts'] || typeof Chart === 'undefined') return;

                const renderProjectedPie = () => {
                    if (!projectedPieRef.current) return;
                    let labels, data, colors;
                    if (projectedDrillDown) {
                        const projAssets = calculation.projected[projectedDrillDown] || [];
                        labels = projAssets.map(a => a.name);
                        data = projAssets.map(a => a.amount);
                        // [ìˆ˜ì •] ì „ì—­ getRGB í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ë“œë¦´ë‹¤ìš´ ìƒ‰ìƒ ì¼ê´€ì„± ìœ ì§€
                        const baseRGB = window.getRGB(sectorInfo[projectedDrillDown].color);
                        colors = projAssets.map((_, i) => `rgba(${baseRGB}, ${0.9 - (i * 0.1)})`);
                    } else {
                        labels = projectedKeys.map(key => sectorInfo[key]?.name || key);
                        data = projectedKeys.map(key => projectedSectorTotals[key]?.amount || 0);
                    }

                    const ctx = projectedPieRef.current.getContext('2d');
                    const bgColors = projectedDrillDown ? colors : projectedKeys.map(key => {
                        const c = tailwind?.config?.theme?.extend?.colors?.[key] || { start: '#10b981', end: '#059669' };
                        return createGradient(ctx, c);
                    });

                    const chartConfig = {
                            type: 'doughnut',
                            data: {
                                labels: labels,
                                datasets: [{
                                    data: data,
                                    backgroundColor: bgColors,
                                    borderWidth: 2,
                                    borderColor: chartBorderColor,
                                    hoverOffset: 15
                                }]
                            },
                            options: {
                                ...commonChartOptions,
                                onClick: (evt, elements) => {
                                    if (projectedDrillDown) {
                                        setProjectedDrillDown(null);
                                    } else if (elements && elements.length > 0) {
                                        const index = elements[0].index;
                                        setProjectedDrillDown(projectedKeys[index]);
                                    }
                                },
                                plugins: {
                                    ...commonChartOptions.plugins,
                                    title: { 
                                        display: true, 
                                        text: projectedDrillDown ? `${sectorInfo[projectedDrillDown]?.name || projectedDrillDown} ì˜ˆìƒ` : `${projectionMonths}ê°œì›” í›„ ì˜ˆìƒ`, 
                                        color: darkMode ? '#e5e7eb' : '#111827', 
                                        font: { size: 16, weight: 'bold' } 
                                    }
                                }
                            },
                            plugins: [ChartDataLabels]
                    };

                    if (chartInstancesRef.current['projectedPie']) {
                        const chart = chartInstancesRef.current['projectedPie'];
                        chart.data = chartConfig.data;
                        chart.options = chartConfig.options;
                        chart.update('none');
                    } else {
                        chartInstancesRef.current['projectedPie'] = new Chart(ctx, chartConfig);
                    }
                };
                const timerId = setTimeout(renderProjectedPie, 50);
                return () => clearTimeout(timerId);
            }, [projectedDrillDown, projectedSectorTotals, projectedKeys, calculation.projected, darkMode, isLoading, panelCollapseState['charts']]);

            // [ìˆ˜ì •] 3. ë¹„êµ ì°¨íŠ¸ (ë…ë¦½ ë Œë”ë§ - ë“œë¦´ë‹¤ìš´ ì˜í–¥ ì—†ìŒ)
            useEffect(() => {
                if (isLoading || panelCollapseState['charts'] || typeof Chart === 'undefined') return;

                const renderComparisonBar = () => {
                    if (!comparisonBarRef.current) return;
                    const comparisonLabels = projectedKeys.map(key => sectorInfo[key]?.name || key);
                    const comparisonCurrentData = projectedKeys.map(key => currentSectorTotals[key]?.amount || 0);
                    const comparisonProjectedData = projectedKeys.map(key => projectedSectorTotals[key]?.amount || 0);

                    const chartConfig = {
                            type: 'bar',
                            data: {
                                labels: comparisonLabels,
                                datasets: [
                                    { label: 'í˜„ì¬', data: comparisonCurrentData, backgroundColor: 'rgba(59, 130, 246, 0.7)', borderRadius: 4 },
                                    { label: 'ì˜ˆìƒ', data: comparisonProjectedData, backgroundColor: 'rgba(34, 197, 94, 0.7)', borderRadius: 4 }
                                ]
                            },
                            options: {
                                maintainAspectRatio: false,
                                responsive: true,
                                scales: {
                                    x: { ticks: { color: darkMode ? '#e5e7eb' : '#111827' }, grid: { display: false } },
                                    y: { beginAtZero: true, ticks: { color: darkMode ? '#e5e7eb' : '#111827' }, grid: { color: darkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)' } }
                                },
                                plugins: {
                                    legend: { labels: { color: darkMode ? '#e5e7eb' : '#111827' } },
                                    datalabels: { display: false },
                                    title: { display: true, text: 'í˜„ì¬ vs ì˜ˆìƒ ìì‚° ë¹„êµ', color: darkMode ? '#e5e7eb' : '#111827', font: { size: 16, weight: 'bold' } }
                                }
                            }
                    };

                    if (chartInstancesRef.current['comparisonBar']) {
                        const chart = chartInstancesRef.current['comparisonBar'];
                        chart.data = chartConfig.data;
                        chart.options = chartConfig.options;
                        chart.update('none');
                    } else {
                        const ctx = comparisonBarRef.current.getContext('2d');
                        chartInstancesRef.current['comparisonBar'] = new Chart(ctx, chartConfig);
                    }
                };
                const timerId = setTimeout(renderComparisonBar, 50);
                return () => clearTimeout(timerId);
            }, [currentSectorTotals, projectedSectorTotals, projectedKeys, darkMode, isLoading, panelCollapseState['charts']]);

            // [ì¶”ê°€] ì»´í¬ë„ŒíŠ¸ ì–¸ë§ˆìš´íŠ¸ ì‹œ ëª¨ë“  ì°¨íŠ¸ ì •ë¦¬
            useEffect(() => {
                return () => {
                    Object.values(chartInstancesRef.current).forEach(instance => {
                        if (instance) instance.destroy();
                    });
                };
            }, []);

            // [ë¶„ë¦¬] íˆìŠ¤í† ë¦¬ ì°¨íŠ¸ ì „ìš© useEffect
            useEffect(() => {
                if (panelCollapseState['history'] || assetHistory.length === 0) return;
                
                const renderHistoryChart = () => {
                    if (!historyChartRef.current) return; // [ìˆ˜ì •] ë Œë”ë§ ì‹œì ì— ref í™•ì¸ (ë¹„ë™ê¸° ì²˜ë¦¬)

                    const textColor = darkMode ? '#e5e7eb' : '#111827';
                    const gridColor = darkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';

                    // [ìˆ˜ì •] ë°ì´í„° ê°œìˆ˜ì— ë”°ë¥¸ ì¡°ê±´ë¶€ ê·¸ë£¹í™” (24ê°œ ì´ˆê³¼ ì‹œ ì›”ë³„ í‰ê· , ì´í•˜ ì‹œ ì›ë³¸ ìœ ì§€)
                    const MAX_HISTORY_POINTS = 24;
                    const useMonthlyAverage = assetHistory.length > MAX_HISTORY_POINTS;

                    let finalLabels = [];
                    let finalHistoryData = [];

                    if (useMonthlyAverage) {
                        // ë°ì´í„°ê°€ ë§ìœ¼ë©´ ì›”ë³„ í‰ê· ìœ¼ë¡œ ê·¸ë£¹í™”
                        const monthlyGroups = {};
                        assetHistory.forEach(item => {
                            const monthKey = item.date.substring(0, 7); // YYYY-MM
                            if (!monthlyGroups[monthKey]) {
                                monthlyGroups[monthKey] = { sum: 0, count: 0 };
                            }
                            monthlyGroups[monthKey].sum += Number(item.netWorth);
                            monthlyGroups[monthKey].count += 1;
                        });

                        const sortedMonthKeys = Object.keys(monthlyGroups).sort();
                        finalLabels = sortedMonthKeys.map(key => {
                            const [y, m] = key.split('-');
                            return `${y.slice(2)}ë…„ ${m}ì›”`;
                        });
                        finalHistoryData = sortedMonthKeys.map(key => monthlyGroups[key].sum / monthlyGroups[key].count);
                    } else {
                        // ë°ì´í„°ê°€ ì ìœ¼ë©´ ì›ë³¸ ë‚ ì§œ ê·¸ëŒ€ë¡œ ì‚¬ìš©
                        finalLabels = assetHistory.map(item => {
                            const [y, m, d] = item.date.split('-');
                            return `${Number(m)}/${Number(d)}`;
                        });
                        finalHistoryData = assetHistory.map(item => Number(item.netWorth));
                    }
                
                    let projectionData = new Array(finalHistoryData.length).fill(null);

                if (showProjectionInHistory && calculation.monthlyProjections && calculation.monthlyProjections.length > 0) {
                    // ë§ˆì§€ë§‰ íˆìŠ¤í† ë¦¬ ì§€ì ê³¼ ì—°ê²°í•˜ì—¬ ì—°ì†ì„± í™•ë³´
                    if (finalHistoryData.length > 0) {
                        projectionData[finalHistoryData.length - 1] = finalHistoryData[finalHistoryData.length - 1];
                    }
                    
                    calculation.monthlyProjections.forEach((p, idx) => {
                        if (idx === 0) return;
                        
                        // ë¯¸ë˜ ë‚ ì§œ ë¼ë²¨ ìƒì„±
                        const [y, m] = (baseMonth || new Date().toISOString().slice(0, 7)).split('-').map(Number);
                        const d = new Date(y, m - 1 + idx);
                        const label = `${String(d.getFullYear()).slice(2)}ë…„ ${String(d.getMonth() + 1).padStart(2, '0')}ì›”`; // ë¯¸ë˜ëŠ” í•­ìƒ ì›” ë‹¨ìœ„
                        
                        // ë¼ë²¨ ì¤‘ë³µ ì²´í¬ (íˆìŠ¤í† ë¦¬ì™€ ê²¹ì¹˜ì§€ ì•Šê²Œ)
                        if (!finalLabels.includes(label)) {
                            finalLabels.push(label);
                            projectionData.push(Math.floor(p.total)); // ë§Œì› ì´í•˜ ì ˆì‚­
                            finalHistoryData.push(null);
                        }
                    });
                }

                const datasets = [
                    {
                        label: 'ìˆœìì‚° (ë§Œì›)',
                        data: finalHistoryData,
                        borderColor: 'rgb(79, 70, 229)',
                        backgroundColor: darkMode ? 'rgba(79, 70, 229, 0.5)' : 'rgba(79, 70, 229, 0.3)',
                        backgroundColor: (context) => {
                            const ctx = context.chart.ctx;
                            const gradient = ctx.createLinearGradient(0, 0, 0, 200);
                            gradient.addColorStop(0, 'rgba(79, 70, 229, 0.3)');
                            gradient.addColorStop(1, 'rgba(79, 70, 229, 0)');
                            return gradient;
                        },
                        tension: 0.3,
                        fill: true,
                        pointBackgroundColor: 'rgb(79, 70, 229)',
                        pointHoverRadius: 6,
                        pointHoverBackgroundColor: 'rgb(255, 255, 255)',
                        pointHoverBorderWidth: 2,
                        pointHoverBorderColor: 'rgb(79, 70, 229)'
                    }
                ];

                if (showProjectionInHistory) {
                    datasets.push({
                        label: 'ì˜ˆìƒ ìì‚° (ë§Œì›)',
                        data: projectionData,
                        borderColor: 'rgba(79, 70, 229, 0.5)',
                        borderDash: [5, 5], // ì ì„  í‘œì‹œ
                        tension: 0.3,
                        fill: false,
                        pointRadius: 2,
                        pointBackgroundColor: 'rgba(79, 70, 229, 0.5)'
                    });
                }

                if (goalMode === 'target' && targetAmount > 0) {
                    datasets.push({
                        label: `ëª©í‘œ ìì‚° (${formatNumber(targetAmount, displayMode)}ë§Œì›)`,
                        data: new Array(finalLabels.length).fill(targetAmount),
                        borderColor: 'rgba(239, 68, 68, 0.8)',
                        borderDash: [5, 5],
                        pointRadius: 0,
                        fill: false,
                        borderWidth: 2
                    });
                }

                // [ìµœì í™”] íˆìŠ¤í† ë¦¬ ì°¨íŠ¸ë„ updateOrCreateChart íŒ¨í„´ ì ìš© (ì§ì ‘ êµ¬í˜„)
                const chartConfig = {
                    type: 'line',
                    data: {
                        labels: finalLabels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom', labels: { color: textColor } },
                            title: { display: false },
                            tooltip: { mode: 'index', intersect: false },
                            // [ì¶”ê°€] ì¤Œ í”ŒëŸ¬ê·¸ì¸ ì„¤ì •
                            zoom: {
                                zoom: {
                                    wheel: { enabled: true },
                                    pinch: { enabled: true },
                                    mode: 'x',
                                },
                                pan: {
                                    enabled: true,
                                    mode: 'x',
                                }
                            }
                        },
                        scales: { 
                            y: { 
                                beginAtZero: true,
                                ticks: { color: textColor },
                                grid: { color: gridColor }
                            },
                            x: {
                                ticks: { color: textColor },
                                grid: { color: gridColor }
                            }
                        }
                    }
                };

                    if (chartInstancesRef.current['historyChart']) {
                        const chart = chartInstancesRef.current['historyChart'];
                        chart.data = chartConfig.data;
                        chart.options = chartConfig.options;
                        chart.update('none');
                    } else {
                        chartInstancesRef.current['historyChart'] = new Chart(historyChartRef.current, chartConfig);
                    }
                };

                const timerId = setTimeout(renderHistoryChart, 50);
                return () => clearTimeout(timerId);
            }, [assetHistory, panelCollapseState['history'], goalMode, targetAmount, displayMode, showProjectionInHistory, calculation.monthlyProjections, baseMonth, darkMode]);

            // ===== ìì‚° ê´€ë¦¬ í•¨ìˆ˜ë“¤ =====
            const addAsset = (sector) => setAssets(prev => ({
                ...prev,
                [sector]: [...(prev[sector] || []), {
                    id: Date.now() + Math.random(), // ê³ ìœ  ID ì¶”ê°€
                    name: 'ìƒˆ í•­ëª©',
                    amount: 0,
                    rate: sector === 'loan' ? 3.0 : (sector === 'car' ? -2.0 : 10.0),
                    feeRate: 0,
                    monthlyContrib: 0, // ëŒ€ì¶œì˜ ê²½ìš° 'ì›” ìƒí™˜ì•¡'ìœ¼ë¡œ ì‚¬ìš©
                    extraContrib: 0, 
                    extraFrom: (Object.values(prev).flat().find(a => a.name === 'ìƒí™œë¹„í†µì¥')?.name) || (Object.values(prev).flat()[0]?.name) || '',
                    // [ìˆ˜ì •] ëŒ€ì¶œ ì „ìš© í•„ë“œ ì¶”ê°€
                    repaymentMethod: 'ì›ë¦¬ê¸ˆê· ë“±', // ìƒí™˜ë°©ì‹
                    repaymentAccount: (Object.values(prev).flat().find(a => a.name === 'ìƒí™œë¹„í†µì¥')?.name) || (Object.values(prev).flat()[0]?.name) || '',
                    maturityMonth: 36,
                    loanStartDate: baseMonth
                }]
            }));

            const updateAsset = React.useCallback((sector, index, field, value) => {
                const numberFields = ['amount', 'rate', 'feeRate', 'monthlyContrib', 'extraContrib', 'maturityMonth']; 

                let newValue = numberFields.includes(field) ? Number(value) : value; 

                if (numberFields.includes(field) && isNaN(newValue)) {
                    newValue = 0; // ìˆ«ìê°€ ì•„ë‹Œ ê°’ì´ ë“¤ì–´ì˜¤ë©´ 0ìœ¼ë¡œ ì²˜ë¦¬
                }

                // [ìˆ˜ì •] ìœ íš¨ì„± ê²€ì‚¬ ê°•í™”: ìŒìˆ˜ ì…ë ¥ ë°©ì§€ (ìˆ˜ìµë¥  ì œì™¸)
                if (numberFields.includes(field) && newValue < 0 && field !== 'rate') return;
                
                // [ìˆ˜ì •] ìì‚° ì´ë¦„ ë³€ê²½ ì‹œ ì°¸ì¡°(ìƒí™˜ê³„ì¢Œ, ì´ì²´ì¶œì²˜ ë“±)ë„ í•¨ê»˜ ì—…ë°ì´íŠ¸í•˜ì—¬ ì‹œë®¬ë ˆì´ì…˜ ì˜¤ë¥˜ ë°©ì§€
                setAppData(prevData => {
                    const prevAssets = prevData.assets;
                    const targetAsset = prevAssets[sector][index];
                    const oldName = targetAsset.name;
                    
                    // 1. ìì‚° ì •ë³´ ì—…ë°ì´íŠ¸
                    const newSectorAssets = prevAssets[sector].map((a, i) => 
                        i === index ? { ...a, [field]: newValue } : a
                    );
                    const newAssets = { ...prevAssets, [sector]: newSectorAssets };
                    let newData = { ...prevData, assets: newAssets };

                    // 2. ì´ë¦„ì´ ë³€ê²½ëœ ê²½ìš°, í•´ë‹¹ ì´ë¦„ì„ ì°¸ì¡°í•˜ëŠ” ë‹¤ë¥¸ ì„¤ì •ë“¤ë„ ì—…ë°ì´íŠ¸
                    if (field === 'name' && oldName !== newValue) {
                        // ì£¼ í˜„ê¸ˆíë¦„ ê³„ì¢Œ ì´ë¦„ ì—…ë°ì´íŠ¸
                        if (prevData.mainCashFlowAccount === oldName) {
                            newData.mainCashFlowAccount = newValue;
                        }
                        // ë‹¤ë¥¸ ìì‚°ì—ì„œì˜ ì°¸ì¡° ì—…ë°ì´íŠ¸ (ëŒ€ì¶œ ìƒí™˜ê³„ì¢Œ, ì¶”ê°€ë‚©ì… ì¶œì²˜)
                        Object.keys(newAssets).forEach(s => {
                            newAssets[s] = newAssets[s].map(a => {
                                let changed = false;
                                let newA = { ...a };
                                if (newA.extraFrom === oldName) { newA.extraFrom = newValue; changed = true; }
                                if (s === 'loan' && newA.repaymentAccount === oldName) { newA.repaymentAccount = newValue; changed = true; }
                                return changed ? newA : a;
                            });
                        });
                    }
                    return newData;
                });
            }, [setAppData]);

            const removeAsset = React.useCallback((sector, index) => {
                const currentData = appDataRef.current;
                if (!currentData) return;
                const currentAssets = currentData.assets;
                const currentMainAccount = currentData.mainCashFlowAccount;

                const assetToRemove = currentAssets[sector][index];
                
                if (assetToRemove.name === currentMainAccount) {
                    const allAccounts = Object.values(currentAssets).flat();
                    const nextAccount = allAccounts.find(a => a.id !== assetToRemove.id);
                    
                    if (nextAccount) {
                        setMainCashFlowAccount(nextAccount.name);
                    } else {
                        addToast('ìµœì†Œ í•œ ê°œì˜ ê³„ì¢ŒëŠ” ìœ ì§€ë˜ì–´ì•¼ í•˜ë©°, ì£¼ í˜„ê¸ˆíë¦„ ê³„ì¢Œë¡œ ì„¤ì •ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.', 'error');
                        return;
                    }
                }
                setAssets(prev => ({
                    ...prev,
                    [sector]: prev[sector].filter((_, i) => i !== index)
                }));
            }, [setAssets, setMainCashFlowAccount, addToast]); // [ìˆ˜ì •] ì˜ì¡´ì„± ëª…ì‹œ

            // [ìµœì í™”] ê³„ì¢Œ ëª©ë¡ ë©”ëª¨ì´ì œì´ì…˜ (ìì‚° ì´ë¦„ ë³€ê²½ ì‹œì—ë§Œ ê°±ì‹ )
            const accountOptions = useMemo(() => {
                return Object.values(assets).flat().map(a => a.name);
            }, [JSON.stringify(Object.values(assets).flat().map(a => a.name))]);

            // ===== ì§€ì¶œ ê´€ë¦¬ í•¨ìˆ˜ë“¤ =====
            const addExpense = () => setMonthlyExpenses(prev => [...prev, { name: 'ìƒˆ ì§€ì¶œ', amount: 0 }]);
            const updateExpense = (index, field, value) => setMonthlyExpenses(prev => prev.map((expense, i) => {
                if (i !== index) return expense;
                if (field === 'amount' && Number(value) < 0) return expense; // [ì¶”ê°€] ìŒìˆ˜ ë°©ì§€
                return { ...expense, [field]: field === 'name' ? value : Number(value) };
            }));
            const removeExpense = (index) => setMonthlyExpenses(prev => prev.filter((_, i) => i !== index));

            // ===== ì„¹í„° ì •ë³´ (í•¨ìˆ˜ ì •ì˜ ì „ì— ìœ„ì¹˜) =====
            // ===== ì´ë²¤íŠ¸ ê´€ë¦¬ í•¨ìˆ˜ë“¤ =====
            const addIncomeEvent = () => {
                setIncomeEvents(prev => {
                    // prevê°€ ë°°ì—´ì´ ì•„ë‹ ê²½ìš°ë¥¼ ëŒ€ë¹„í•˜ì—¬ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
                    const currentEvents = Array.isArray(prev) ? prev : [];
                    return [...currentEvents, { 
                        name: 'ìƒˆ ìˆ˜ì… ì´ë²¤íŠ¸', amount: 0, startMonth: baseMonth, endMonth: baseMonth, targetSector: 'deposit', targetAsset: 0 
                    }];
                });
            };
            
            const updateIncomeEvent = (index, field, value) => {
                try {
                    // incomeEventsê°€ ë°°ì—´ì¸ì§€ í™•ì¸
                    if (!Array.isArray(incomeEvents)) {
                        console.warn('incomeEvents is not an array:', incomeEvents);
                        return;
                    }
                    
                    // ì…ë ¥ê°’ ê²€ì¦
                    if (index < 0 || index >= incomeEvents.length) {
                        console.warn('Invalid income event index:', index);
                        return;
                    }
                    
                    let newValue = value;
                    
                    // ìˆ«ì í•„ë“œ ê²€ì¦
                    if (field === 'amount' || field === 'targetAsset') {
                        const numValue = Number(value);
                        if (isNaN(numValue)) {
                            console.warn('Invalid number value:', value);
                            return;
                        }
                        newValue = Math.max(0, numValue); // ìŒìˆ˜ ë°©ì§€
                    }
                    
                    // ì„¹í„° í•„ë“œ ê²€ì¦
                    if (field === 'targetSector' && !Object.keys(sectorInfo).includes(value)) {
                        console.warn('Invalid target sector:', value);
                        return;
                    }
                    
                    setIncomeEvents(prev => {
                        if (!Array.isArray(prev)) {
                            console.warn('Previous incomeEvents is not an array:', prev);
                            return prev;
                        }
                        return prev.map((event, i) => {
                            if (i !== index) return event;
                            const updated = { ...event, [field]: newValue };
                            // [ìˆ˜ì •] ì„¹í„° ë³€ê²½ ì‹œ ê³„ì¢Œ ì¸ë±ìŠ¤ ì´ˆê¸°í™” (ì˜¤ë¥˜ ë°©ì§€)
                            if (field === 'targetSector') updated.targetAsset = 0;
                            return updated;
                        });
                    });
                } catch (error) {
                    console.error('Error updating income event:', error);
                }
            };
            
            const removeIncomeEvent = (index) => {
                try {
                    // incomeEventsê°€ ë°°ì—´ì¸ì§€ í™•ì¸
                    if (!Array.isArray(incomeEvents)) {
                        console.warn('incomeEvents is not an array:', incomeEvents);
                        return;
                    }
                    
                    // ì¸ë±ìŠ¤ ê²€ì¦
                    if (index < 0 || index >= incomeEvents.length) {
                        console.warn('Invalid income event index for removal:', index);
                        return;
                    }
                    
                    setIncomeEvents(prev => {
                        if (!Array.isArray(prev)) {
                            console.warn('Previous incomeEvents is not an array:', prev);
                            return prev;
                        }
                        return prev.filter((_, i) => i !== index);
                    });
                } catch (error) {
                    console.error('Error removing income event:', error);
                }
            };

            const addExpenseEvent = () => setExpenseEvents(prev => {
                // prevê°€ ë°°ì—´ì´ ì•„ë‹ ê²½ìš°ë¥¼ ëŒ€ë¹„í•˜ì—¬ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
                const currentEvents = Array.isArray(prev) ? prev : [];
                return [...currentEvents, { 
                    name: 'ìƒˆ ì§€ì¶œ ì´ë²¤íŠ¸', amount: 0, startMonth: baseMonth, endMonth: baseMonth, targetSector: 'deposit', targetAsset: 0 
                }];
            });
            const updateExpenseEvent = (index, field, value) => {
                let newValue = value;
                const numberFields = ['amount', 'targetAsset'];

                if (numberFields.includes(field)) {
                    const numValue = Number(value);
                    if (!isNaN(numValue)) {
                        newValue = Math.max(0, numValue); // ìŒìˆ˜ ë°©ì§€
                    }
                }

                setExpenseEvents(prev => {
                    // prevê°€ ë°°ì—´ì´ ì•„ë‹ ê²½ìš°ë¥¼ ëŒ€ë¹„í•˜ì—¬ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
                    const currentEvents = Array.isArray(prev) ? prev : [];
                    return currentEvents.map((event, i) => {
                        if (i !== index) return event;
                        const updated = { ...event, [field]: newValue };
                        // [ìˆ˜ì •] ì„¹í„° ë³€ê²½ ì‹œ ê³„ì¢Œ ì¸ë±ìŠ¤ ì´ˆê¸°í™” (ì˜¤ë¥˜ ë°©ì§€)
                        if (field === 'targetSector') updated.targetAsset = 0;
                        return updated;
                    });
                });
            };
            const removeExpenseEvent = (index) => setExpenseEvents(prev => {
                // prevê°€ ë°°ì—´ì´ ì•„ë‹ ê²½ìš°ë¥¼ ëŒ€ë¹„í•˜ì—¬ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
                const currentEvents = Array.isArray(prev) ? prev : [];
                return currentEvents.filter((_, i) => i !== index);
            });
            // ===== ë¦¬ë°¸ëŸ°ì‹± ì•Œë¦¼ ì„¤ì • í•¨ìˆ˜ë“¤ =====


            const renderScenarioPanel = () => ( 
                <div className="flex flex-col lg:flex-row lg:items-start gap-6">
                    <div className="lg:w-full lg:max-w-md">
                        <h3 className="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-4">ì €ì¥ëœ ì‹œë‚˜ë¦¬ì˜¤</h3>
                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-1 gap-4">
                            {scenarios.map(scenario => (
                                <div key={scenario.id} className="border dark:border-gray-700 rounded-lg p-4">
                                    <h4 className="font-medium text-gray-900 dark:text-white">{scenario.name}</h4>
                                    <p className="text-sm text-gray-500">{new Date(scenario.createdAt).toLocaleDateString()}</p>
                                    <div className="mt-2 flex gap-2">
                                        <button onClick={() => loadScenario(scenario)} className="flex-1 px-3 py-1 rounded text-sm bg-indigo-500 text-white hover:bg-indigo-600">ë¶ˆëŸ¬ì˜¤ê¸°</button>
                                        <button onClick={() => deleteScenario(scenario.id)} className="px-3 py-1 rounded text-sm bg-rose-500 text-white hover:bg-rose-600">ì‚­ì œ</button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                    <div className="flex-grow border-l border-gray-200 dark:border-gray-700 pl-6">
                        <h3 className="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-3">ì‹œë‚˜ë¦¬ì˜¤ ë¹„êµ (ìµœëŒ€ 3ê°œ)</h3>
                        <ScenarioCompare scenarios={scenarios} sectorInfo={sectorInfo} calculateMonthlyProjection={calculateMonthlyProjection} formatNumber={formatNumber} className="bg-gray-50 dark:bg-gray-900" />
                    </div>
                </div>
            );

            const renderChartsPanel = () => ( 
                <div className="space-y-4">
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div className="bg-white dark:bg-slate-800 rounded-lg shadow p-4 h-[350px] w-full relative"><canvas ref={currentPieRef}></canvas></div>
                        <div className="bg-white dark:bg-slate-800 rounded-lg shadow p-4 h-[350px] w-full relative"><canvas ref={projectedPieRef}></canvas></div>
                        <div className="bg-white dark:bg-slate-800 rounded-lg shadow p-4 h-[350px] w-full relative"><canvas ref={comparisonBarRef}></canvas></div>
                    </div>
                </div>
            );

            const renderHistoryPanel = () => (
                <>
                    <div className="flex justify-between items-center mb-4 px-4 pt-2">
                        <div className="text-sm text-gray-600 dark:text-gray-400">
                            ì´ {assetHistory.length}ê°œì˜ ê¸°ë¡ì´ ìˆìŠµë‹ˆë‹¤. 
                            ìµœê·¼ ê¸°ë¡: {assetHistory[assetHistory.length - 1]?.date} {assetHistory[assetHistory.length - 1]?.time ? `(${assetHistory[assetHistory.length - 1].time.split(':').slice(0, 2).join(':')})` : ''} ({formatNumber(assetHistory[assetHistory.length - 1]?.netWorth, displayMode)}ë§Œì›)
                        </div>
                        <label className={`flex items-center gap-2 cursor-pointer px-3 py-1 rounded-full border transition-colors ${!isPro ? 'bg-gray-100 border-gray-200' : 'bg-blue-50 dark:bg-blue-900/30 border-blue-100 dark:border-blue-800 hover:bg-blue-100'}`}>
                            <input 
                                type="checkbox" 
                                checked={showProjectionInHistory} 
                                onChange={(e) => {
                                    if (!isPro) {
                                        if (!verifiedEmail) {
                                            if (confirm('PRO ê¸°ëŠ¥(ë¯¸ë˜ ì˜ˆìƒ ìì‚° í‘œì‹œ)ì„ í™•ì¸í•˜ê±°ë‚˜ í›„ì›í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.\në¡œê·¸ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                                                handleLogin();
                                            }
                                            return;
                                        }
                                        setIsProModalOpen(true); // PRO ê¸°ëŠ¥ ì•ˆë‚´ ëª¨ë‹¬ ë„ìš°ê¸°
                                        return;
                                    }
                                    setShowProjectionInHistory(e.target.checked);
                                }}
                                className={`w-4 h-4 rounded focus:ring-blue-500 ${!isPro ? 'text-gray-400' : 'text-blue-600'}`}
                            />
                            <span className={`text-xs font-semibold flex items-center gap-1 ${!isPro ? 'text-gray-500' : 'text-blue-700'}`}>
                                {!isPro && <span>ğŸ”’</span>}
                                ë¯¸ë˜ ì˜ˆìƒ ìì‚° í‘œì‹œ
                            </span>
                        </label>
                    </div>
                    <div className="bg-gray-50 dark:bg-gray-900/50 rounded-lg p-4 h-[600px] relative">
                        <canvas ref={historyChartRef}></canvas>
                    </div>
                </>
            );

            const renderBudgetPanel = () => ( 
                <div className="bg-blue-50 dark:bg-slate-800 rounded-lg shadow p-6">
                    <div className="grid grid-cols-2 sm:grid-cols-4 gap-4">
                        <div className="text-center"><div className="text-sm text-gray-600 dark:text-white">ì›” ê³ ì • ìˆ˜ì…</div><div className="text-xl font-bold text-blue-600 dark:text-blue-400">{formatNumber(monthlySalary, displayMode)}ë§Œì›</div></div>
                        <div className="text-center"><div className="text-sm text-gray-600 dark:text-white">ì›”ë³„ ì§€ì¶œ</div><div className="text-xl font-bold text-red-600 dark:text-red-400">{formatNumber(totalMonthlyExpense, displayMode)}ë§Œì›</div></div>
                        <div className="text-center"><div className="text-sm text-gray-600 dark:text-white">ì›”ë‚©ì… ê°€ëŠ¥ì•¡</div><div className="text-xl font-bold text-green-600 dark:text-green-400">{formatNumber(maxSectorMonthlyContrib, displayMode)}ë§Œì›</div></div>
                        <div className="text-center"><div className="text-sm text-gray-600 dark:text-white">ì›”ë‚©ì… ì‚¬ìš©ì•¡</div><div className={`text-xl font-bold ${totalSectorMonthlyContrib > maxSectorMonthlyContrib ? 'text-red-600' : 'text-blue-600 dark:text-blue-400'}`}>{formatNumber(totalSectorMonthlyContrib, displayMode)}ë§Œì›</div></div>
                    </div>
                    {totalSectorMonthlyContrib > maxSectorMonthlyContrib && (<div className="bg-red-100 dark:bg-red-900/40 border border-red-400 dark:border-red-800 text-red-700 dark:text-red-300 px-4 py-3 rounded my-4">âš ï¸ ì›”ë‚©ì… í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤ ({formatNumber(totalSectorMonthlyContrib - maxSectorMonthlyContrib, displayMode)}ë§Œì› ì´ˆê³¼). ì›”ìˆ˜ì…ì™¸ ë‚©ì…ì„ ì´ìš©í•˜ê±°ë‚˜ ì›”ë‚©ì…ì„ ì¤„ì—¬ì£¼ì„¸ìš”.</div>)}
                    <div className="bg-white dark:bg-gray-900 rounded-lg p-4 my-4"><h4 className="text-sm font-medium text-gray-700 dark:text-white mb-3">ğŸ’¡ ì”ì—¬ì•¡ ê³„ì‚°ì‹</h4><div className="text-sm space-y-2"><div className="flex justify-between text-gray-600 dark:text-gray-300"><span>ì›”ìˆ˜ì…</span><span className="font-medium text-blue-600 dark:text-blue-400">+{formatNumber(monthlySalary, displayMode)}ë§Œì›</span></div><div className="flex justify-between text-gray-600 dark:text-gray-300"><span>ì›”ë³„ ì§€ì¶œ</span><span className="font-medium text-red-600 dark:text-red-400">-{formatNumber(totalMonthlyExpense, displayMode)}ë§Œì›</span></div><hr className="border-gray-200 dark:border-gray-700" /><div className="flex justify-between font-medium text-gray-700 dark:text-white"><span>ì›”ë‚©ì… ê°€ëŠ¥ì•¡</span><span className="text-green-600 dark:text-green-400">{formatNumber(maxSectorMonthlyContrib, displayMode)}ë§Œì›</span></div><div className="text-xs text-gray-500 dark:text-gray-400 mt-2">í˜„ì¬ ì›”ë‚©ì… ì„¤ì •:</div>{autoDepositBreakdown.map((item, index) => (<div key={index} className="flex justify-between text-xs text-gray-600 dark:text-gray-300"><span className={`text-${sectorInfo[item.sector]?.color || 'gray'}-600 dark:text-${sectorInfo[item.sector]?.color || 'gray'}-400`}>{sectorInfo[item.sector]?.icon} {item.name}</span><span className="font-medium">-{formatNumber(item.amount, displayMode)}ë§Œì›</span></div>))}<hr className="border-gray-200 dark:border-gray-700" /><div className="flex justify-between font-bold text-gray-800 dark:text-white"><span>ì”ì—¬ì•¡</span><span className="text-green-600 dark:text-green-400">{formatNumber(autoDepositAmount, displayMode)}ë§Œì›</span></div></div></div>
                    <div className="flex flex-col sm:flex-row items-center justify-between bg-white dark:bg-gray-900 rounded-lg p-4 gap-4 mt-4"><div className="text-center sm:text-left"><div className="text-sm text-gray-600 dark:text-white">ì”ì—¬ì•¡</div><div className="text-2xl font-bold text-green-600 dark:text-green-400">{formatNumber(autoDepositAmount, displayMode)}ë§Œì›</div><div className="text-xs text-gray-500 dark:text-gray-400">ì›”ë‚©ì… ê°€ëŠ¥ì•¡ {formatNumber(maxSectorMonthlyContrib, displayMode)}ë§Œì› - ì›”ë‚©ì… ì‚¬ìš©ì•¡ {formatNumber(totalSectorMonthlyContrib, displayMode)}ë§Œì›</div></div>
                    <div className="flex flex-col sm:flex-row items-center gap-4">
                        <div><label className="block text-sm text-gray-600 dark:text-gray-400 text-center sm:text-left mb-1">ì›” ê³ ì • ìˆ˜ì… ì…ê¸ˆ ê³„ì¢Œ</label><select className="border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded px-3 py-2" value={mainCashFlowAccount} onChange={e => setMainCashFlowAccount(e.target.value)}>{Object.values(assets).flat().filter(item => item.name !== 'ìƒˆ í•­ëª©').map((asset, idx) => (<option key={idx} value={asset.name}>{asset.name}</option>))}</select></div>
                        <div><label className="block text-sm text-gray-600 dark:text-gray-400 text-center sm:text-left mb-1">ì”ì—¬ì•¡ ì…ê¸ˆ ê³„ì¢Œ</label><select className="border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded px-3 py-2" value={residualAccount} onChange={e => setResidualAccount(e.target.value)}>{Object.values(assets).flat().filter(item => item.name !== 'ìƒˆ í•­ëª©').map((asset, idx) => (<option key={idx} value={asset.name}>{asset.name}</option>))}</select></div>
                    </div></div>
                </div>
            );

            const renderMemoPanel = () => {
                // í•˜ìœ„ í˜¸í™˜ì„±: ë¬¸ìì—´ì´ë©´ ë°°ì—´ë¡œ ë³€í™˜í•˜ì—¬ ì²˜ë¦¬
                const rawMemo = memo;
                const memos = Array.isArray(rawMemo) 
                    ? rawMemo 
                    : [{ id: 'default', title: 'ê¸°ë³¸ ë©”ëª¨', content: typeof rawMemo === 'string' ? rawMemo : '' }];
                
                // ì¸ë±ìŠ¤ ì•ˆì „ ì¥ì¹˜
                const activeIndex = Math.min(currentMemoIndex, memos.length - 1);
                const currentMemo = memos[activeIndex] || { title: '', content: '' };

                const handleUpdateMemo = (field, value) => {
                    const newMemos = [...memos];
                    newMemos[activeIndex] = { ...newMemos[activeIndex], [field]: value };
                    setMemo(newMemos);
                };

                const handleAddMemo = () => {
                    const newMemos = [...memos, { id: Date.now(), title: `ë©”ëª¨ ${memos.length + 1}`, content: '' }];
                    setMemo(newMemos);
                    setCurrentMemoIndex(newMemos.length - 1);
                };

                const handleDeleteMemo = () => {
                    if (confirm('ì´ ë©”ëª¨ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        if (memos.length <= 1) {
                            setMemo([{ id: Date.now(), title: 'ê¸°ë³¸ ë©”ëª¨', content: '' }]);
                        } else {
                            const newMemos = memos.filter((_, i) => i !== activeIndex);
                            setMemo(newMemos);
                            setCurrentMemoIndex(Math.max(0, activeIndex - 1));
                        }
                    }
                };

                const startEditingTitle = () => {
                    setTempMemoTitle(currentMemo.title);
                    setIsEditingMemoTitle(true);
                };

                const saveTitle = () => {
                    handleUpdateMemo('title', tempMemoTitle);
                    setIsEditingMemoTitle(false);
                };

                return (
                    <div className="flex flex-col h-full">
                        <div className="flex items-center justify-between mb-2 bg-gray-100 dark:bg-gray-800 p-2 rounded-t-lg border-b dark:border-gray-700">
                            <div className="flex items-center gap-2">
                                <button 
                                    onClick={() => setCurrentMemoIndex(Math.max(0, activeIndex - 1))} 
                                    disabled={activeIndex === 0}
                                    className="p-1 rounded hover:bg-gray-200 dark:hover:bg-gray-700 disabled:opacity-30"
                                >
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 19l-7-7 7-7" /></svg>
                                </button>
                                <span className="text-xs text-gray-500 dark:text-gray-400 font-mono">
                                    {activeIndex + 1} / {memos.length}
                                </span>
                                <button 
                                    onClick={() => setCurrentMemoIndex(Math.min(memos.length - 1, activeIndex + 1))} 
                                    disabled={activeIndex === memos.length - 1}
                                    className="p-1 rounded hover:bg-gray-200 dark:hover:bg-gray-700 disabled:opacity-30"
                                >
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5l7 7-7 7" /></svg>
                                </button>
                            </div>

                            <div className="flex-1 mx-4 flex items-center justify-center">
                                {isEditingMemoTitle ? (
                                    <div className="flex items-center gap-2 w-full max-w-[200px]">
                                        <input 
                                            type="text" 
                                            value={tempMemoTitle} 
                                            onChange={(e) => setTempMemoTitle(e.target.value)}
                                            className="w-full px-2 py-1 text-sm text-gray-900 bg-white border border-blue-500 rounded focus:outline-none"
                                            autoFocus
                                            onKeyDown={(e) => e.key === 'Enter' && saveTitle()}
                                        />
                                        <button onClick={saveTitle} className="text-green-600 hover:text-green-700">
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7" /></svg>
                                        </button>
                                    </div>
                                ) : (
                                    <div className="flex items-center gap-2 group cursor-pointer" onClick={startEditingTitle}>
                                        <span className="font-bold text-gray-700 dark:text-gray-200 text-sm truncate max-w-[150px] sm:max-w-[200px]">
                                            {currentMemo.title}
                                        </span>
                                        <svg className="w-3 h-3 text-gray-400 group-hover:text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                                    </div>
                                )}
                            </div>

                            <div className="flex items-center gap-1">
                                <button onClick={handleAddMemo} className="p-1 text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/30 rounded" title="ìƒˆ ë©”ëª¨ ì¶”ê°€">
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4" /></svg>
                                </button>
                                <button onClick={handleDeleteMemo} className="p-1 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 rounded" title="í˜„ì¬ ë©”ëª¨ ì‚­ì œ">
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                </button>
                            </div>
                        </div>
                        <textarea 
                            className="w-full h-40 p-3 border-x border-b dark:border-gray-600 dark:bg-gray-900 dark:text-white rounded-b-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none" 
                            placeholder="ì—¬ê¸°ì— ììœ ë¡­ê²Œ ë©”ëª¨ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”." 
                            value={currentMemo.content} 
                            onChange={(e) => handleUpdateMemo('content', e.target.value)} 
                        />
                    </div>
                );
            };

            const renderRebalancePanel = () => {
                const validSectors = Object.keys(sectorInfo).filter(k=>k!=='loan');
                const defaultPct = Math.round(100 / validSectors.length);
                const rebalancingGlobal = appData.rebalancingGlobal || { sector: { warning: 5, danger: 10 }, item: { warning: 5, danger: 10 } };
                const currentItemTargets = appData.itemTargets || {};
                
                const totalTarget = validSectors.reduce((sum, key) => { 
                    const value = rebalancingTargets[key];
                    const numericValue = (value === undefined || value === null) ? defaultPct : Number(value);
                    return sum + numericValue;
                }, 0);

                const handleNormalize = () => {
                    if (totalTarget === 0) return;
                    const newTargets = {};
                    validSectors.forEach(key => {
                        const value = rebalancingTargets[key];
                        const currentVal = (value === undefined || value === null) ? defaultPct : Number(value);
                        newTargets[key] = Math.round((currentVal / totalTarget) * 100);
                    });

                    const finalTotal = Object.values(newTargets).reduce((s, v) => s + v, 0);
                    const diff = 100 - finalTotal;
                    if (diff !== 0) {
                        const maxKey = Object.keys(newTargets).reduce((a, b) => newTargets[a] > newTargets[b] ? a : b);
                        newTargets[maxKey] += diff;
                    }
                    setRebalancingTargets(newTargets);
                };

                const updateGlobalSetting = (type, field, value) => {
                    setRebalancingGlobal(prev => ({
                        ...prev,
                        [type]: { ...(prev?.[type] || {}), [field]: Number(value) }
                    }));
                };

                return (
                    <div className="bg-yellow-50 dark:bg-yellow-900/20 rounded-lg shadow p-6"> 
                        {/* ê³µí†µ ì„ê³„ê°’ ì„¤ì • íŒ¨ë„ */}
                        <div className="mb-6 bg-white dark:bg-gray-800 p-4 rounded-lg border border-yellow-100 dark:border-yellow-900/50">
                            <h4 className="text-sm font-bold text-gray-800 dark:text-white mb-3 flex items-center gap-2">âš™ï¸ ê³µí†µ ì„ê³„ê°’ ì„¤ì •</h4>
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                <div>
                                    <div className="text-xs font-semibold text-gray-500 dark:text-gray-400 mb-2 uppercase">ì„¹í„° ë‹¨ìœ„</div>
                                    <div className="flex gap-4">
                                        <div className="flex-1">
                                            <label className="block text-xs text-gray-600 dark:text-gray-300 mb-1">ê²½ê³  ì„ê³„ê°’ Â±%</label>
                                            <input type="number" className="w-full border rounded px-2 py-1 text-sm bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={rebalancingGlobal.sector?.warning ?? 5} onChange={(e) => updateGlobalSetting('sector', 'warning', e.target.value)} />
                                        </div>
                                        <div className="flex-1">
                                            <label className="block text-xs text-gray-600 dark:text-gray-300 mb-1">ìœ„í—˜ ì„ê³„ê°’ Â±%</label>
                                            <input type="number" className="w-full border rounded px-2 py-1 text-sm bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={rebalancingGlobal.sector?.danger ?? 10} onChange={(e) => updateGlobalSetting('sector', 'danger', e.target.value)} />
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <div className="text-xs font-semibold text-gray-500 dark:text-gray-400 mb-2 uppercase">í•­ëª© ë‹¨ìœ„</div>
                                    <div className="flex gap-4">
                                        <div className="flex-1">
                                            <label className="block text-xs text-gray-600 dark:text-gray-300 mb-1">ê²½ê³  ì„ê³„ê°’ Â±%</label>
                                            <input type="number" className="w-full border rounded px-2 py-1 text-sm bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={rebalancingGlobal.item?.warning ?? 5} onChange={(e) => updateGlobalSetting('item', 'warning', e.target.value)} />
                                        </div>
                                        <div className="flex-1">
                                            <label className="block text-xs text-gray-600 dark:text-gray-300 mb-1">ìœ„í—˜ ì„ê³„ê°’ Â±%</label>
                                            <input type="number" className="w-full border rounded px-2 py-1 text-sm bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={rebalancingGlobal.item?.danger ?? 10} onChange={(e) => updateGlobalSetting('item', 'danger', e.target.value)} />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <StackedBarDisplay targets={rebalancingTargets} sectorInfo={sectorInfo} />
                        <div className="mb-4 grid grid-cols-1 lg:grid-cols-3 gap-4 text-sm">                                        
                            <div className="flex items-center gap-2">
                                <span className="text-gray-700 dark:text-gray-200 whitespace-nowrap">ëª©í‘œ ë¹„ì¤‘ ì´í•©:</span>
                                <span className={`font-bold ${totalTarget !== 100 ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400'}`}>
                                    {totalTarget}%
                                </span>
                                <button 
                                    onClick={handleNormalize} 
                                    className="ml-2 px-3 py-1 bg-yellow-600 text-white text-xs rounded hover:bg-yellow-700 disabled:bg-gray-400"
                                    disabled={totalTarget === 100}
                                >
                                    100% ìë™ì¡°ì •
                                </button>
                            </div>
                            {/* [ì¶”ê°€] ë¦¬ë°¸ëŸ°ì‹± ëª©í‘œ ê¸°ê°„ ì„¤ì • ë° ìƒíƒœ ë©”ì‹œì§€ */}
                            <div className="flex items-center gap-3">
                                <span className="text-gray-700 dark:text-gray-200 whitespace-nowrap">ëª©í‘œ ë‹¬ì„± ê¸°ê°„:</span>
                                <input 
                                    type="number" 
                                    className="w-16 border rounded px-2 py-1 text-sm bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" 
                                    value={rebalanceMonths} 
                                    onChange={(e) => setRebalanceMonths(Number(e.target.value))} 
                                />
                                <span className="text-xs text-gray-500">ê°œì›”</span>
                            </div>
                        </div>
                        {calculation.rebalanceInfo && (
                            <div className={`mb-4 p-3 rounded-lg border text-xs font-medium ${calculation.rebalanceInfo.budgetLimited ? 'bg-orange-50 border-orange-200 text-orange-700 dark:bg-orange-900/20 dark:border-orange-800 dark:text-orange-300' : 'bg-blue-50 border-blue-200 text-blue-700 dark:bg-blue-900/20 dark:border-blue-800 dark:text-blue-300'}`}>
                                {calculation.rebalanceInfo.budgetLimited 
                                    ? `âš ï¸ ì˜ˆì‚° ë¶€ì¡±ìœ¼ë¡œ ${calculation.rebalanceInfo.targetMonths}ê°œì›” ë‚´ ë‹¬ì„±ì´ ì–´ë µìŠµë‹ˆë‹¤. í˜„ì¬ ìì‚° ë¹„ì¤‘ ê²°ì†ìœ¨ì— ë”°ë¼ ë¹„ë¡€ ë°°ë¶„ëœ ìˆ˜ì¹˜ë¥¼ ì œì•ˆí•©ë‹ˆë‹¤.` 
                                    : `âœ… í˜„ì¬ ì˜ˆì‚°ìœ¼ë¡œ ${calculation.rebalanceInfo.targetMonths}ê°œì›” ë‚´ ëª©í‘œ ë¹„ì¤‘ ë‹¬ì„±ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.`}
                            </div>
                        )}
                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                            {validSectors.map(sectorKey => {
                                const currentValue = rebalancingTargets[sectorKey] ?? defaultPct;
                                const isEditing = editingRebalanceSector === sectorKey;
                                const sectorAssets = assets[sectorKey] || [];
                                const totalItemWeight = sectorAssets.reduce((sum, a) => sum + (currentItemTargets[a.id] ?? Math.round(100/sectorAssets.length)), 0);

                                return (
                                    <div key={sectorKey} className={`rounded-lg p-4 transition-all duration-300 relative ${isEditing ? 'bg-blue-50 dark:bg-blue-900/30 ring-2 ring-blue-500 shadow-lg scale-105 z-10' : 'bg-white dark:bg-gray-800 hover:shadow-md cursor-pointer'}`} onClick={() => !isEditing && setEditingRebalanceSector(sectorKey)}>
                                        {!isEditing ? (
                                            // [Front Side] ì„¹í„° ë¹„ì¤‘ ì„¤ì •
                                            <div className="space-y-3">
                                                <div className="flex justify-between items-start">
                                                    <h4 className="font-medium text-gray-900 dark:text-white flex items-center gap-2">
                                                        {sectorInfo[sectorKey].icon} {sectorInfo[sectorKey].name}
                                                    </h4>
                                                    <svg className="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                                                </div>
                                                <div className="flex items-center gap-2" onClick={(e) => e.stopPropagation()}>
                                                    <label className="block text-xs text-gray-600 dark:text-gray-300 whitespace-nowrap">ëª©í‘œ ë¹„ì¤‘</label>
                                                    <input 
                                                        type="number" 
                                                        min="0" 
                                                        max="100" 
                                                        className="w-full border rounded px-2 py-1 text-sm bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white font-bold text-right" 
                                                        value={currentValue} 
                                                        onChange={(e)=> setRebalancingTargets(prev=> ({ ...prev, [sectorKey]: Number(e.target.value) }))} 
                                                    />
                                                    <span className="text-sm text-gray-500">%</span>
                                                </div>
                                                <div className="text-[10px] text-gray-400 text-center pt-1 border-t dark:border-gray-700">
                                                    í´ë¦­í•˜ì—¬ í•­ëª©ë³„ ì„¤ì •
                                                </div>
                                            </div>
                                        ) : (
                                            // [Back Side] í•­ëª©ë³„ ë¹„ì¤‘ ì„¤ì • (Flip Effect Content)
                                            <div className="animate-flip h-full flex flex-col">
                                                <div className="flex justify-between items-center mb-3 border-b dark:border-blue-800/50 pb-2">
                                                    <h4 className="text-sm font-bold text-blue-800 dark:text-blue-200">{sectorInfo[sectorKey].name} í•­ëª©</h4>
                                                    <button onClick={(e) => { e.stopPropagation(); setEditingRebalanceSector(null); }} className="text-xs bg-blue-200 dark:bg-blue-800 text-blue-800 dark:text-blue-100 px-2 py-1 rounded hover:bg-blue-300">ì™„ë£Œ</button>
                                                </div>
                                                <div className="flex-1 overflow-y-auto max-h-[200px] custom-scrollbar space-y-2 pr-1">
                                                    {sectorAssets.length > 0 ? sectorAssets.map(asset => (
                                                        <div key={asset.id} className="flex items-center justify-between text-xs">
                                                            <span className="truncate mr-2 text-gray-700 dark:text-gray-300 flex-1" title={asset.name}>{asset.name}</span>
                                                            <div className="flex items-center gap-1 w-16">
                                                                <input 
                                                                    type="number" 
                                                                    className="w-full border rounded px-1 py-0.5 text-right bg-white dark:bg-gray-700 border-blue-200 dark:border-blue-800"
                                                                    value={currentItemTargets[asset.id] ?? Math.round(100/sectorAssets.length)}
                                                                    onChange={(e) => setItemTargets(prev => ({ ...prev, [asset.id]: Number(e.target.value) }))}
                                                                />
                                                            </div>
                                                        </div>
                                                    )) : <div className="text-xs text-gray-400 text-center py-4">í•­ëª© ì—†ìŒ</div>}
                                                </div>
                                                <div className="mt-3 pt-2 border-t dark:border-blue-800/50 flex justify-between items-center text-xs">
                                                    <span className="text-gray-500 dark:text-gray-400">í•©ê³„</span>
                                                    <span className={`font-bold ${totalItemWeight !== 100 ? 'text-red-500' : 'text-green-600'}`}>{totalItemWeight}%</span>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )
                            })}
                        </div>
                    </div>
                );
            };

            const renderAssetsPanel = () => (
                <div className="space-y-8"> 
                    {assetSectorOrder.map((sectorKey, index) => {
                        if (!sectorInfo[sectorKey]) return null;

                        const isLoan = sectorKey === 'loan';
                        
                        // [ìˆ˜ì •] Tailwind JITê°€ ë™ì  í´ë˜ìŠ¤ë¥¼ ê°ì§€í•˜ì§€ ëª»í•˜ëŠ” ë¬¸ì œ í•´ê²°ì„ ìœ„í•´ ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ë¡œ ë³€ê²½
                        const sectorColor = sectorInfo[sectorKey].color;
                        const themeColors = window.tailwind?.config?.theme?.extend?.colors || {};
                        const colorObj = themeColors[sectorColor] || {};
                        // config.jsì— ì •ì˜ëœ start/end ìƒ‰ìƒ ì‚¬ìš© (ì—†ì„ ê²½ìš° ê¸°ë³¸ê°’)
                        const startColor = colorObj.start || '#6366f1'; 
                        const endColor = colorObj.end || '#a855f7';
                        const gradientStyle = { background: `linear-gradient(to right, ${startColor}, ${endColor})` };

                            return (
                                <div key={sectorKey} className="bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-100 dark:border-gray-700 overflow-hidden transition-all duration-300 hover:shadow-xl">
                                    {/* Header */}
                                    <div className="p-5 sm:p-6 text-white flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4" style={gradientStyle}>
                                        <div className="flex items-center gap-4 cursor-pointer w-full sm:w-auto" onClick={()=> setHiddenSectors(prev=> ({...prev, [sectorKey]: !prev[sectorKey]}))}>
                                            <div className="p-3 bg-white/20 rounded-xl backdrop-blur-sm shadow-inner">
                                                <span className="text-2xl">{sectorInfo[sectorKey].icon}</span>
                                            </div>
                                            <div>
                                                <h3 className="text-lg sm:text-xl font-bold flex items-center gap-2">
                                                    {sectorInfo[sectorKey].name}
                                                    <span className="text-xs font-normal bg-white/20 px-2 py-0.5 rounded-full border border-white/10">
                                                        {assets[sectorKey]?.length || 0}ê°œ
                                                    </span>
                                                </h3>
                                                <p className="text-xs sm:text-sm text-white/90 font-medium mt-0.5">
                                                    ì´ {formatNumber(currentSectorTotals[sectorKey]?.amount || 0)}ë§Œì› ({formatPercent(currentSectorTotals[sectorKey]?.percentage || 0)}%)
                                                </p>
                                                {!isLoan && calculation.rebalanceInfo?.recs[sectorKey] > 0 && (
                                                    <div className="mt-1 inline-block bg-white/20 px-2 py-0.5 rounded text-[10px] font-bold border border-white/10">
                                                        ê¶Œì¥ ë‚©ì…: {formatNumber(calculation.rebalanceInfo.recs[sectorKey])}ë§Œì›
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-2 self-end sm:self-auto">
                                            <div className="flex bg-black/20 rounded-lg p-1 mr-2 backdrop-blur-sm">
                                                <button onClick={(e) => { e.stopPropagation(); moveAssetSector(sectorKey, -1); }} disabled={index === 0} className="p-1.5 hover:bg-white/20 rounded-md disabled:opacity-30 transition-colors"><svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 15l7-7 7 7" /></svg></button>
                                                <button onClick={(e) => { e.stopPropagation(); moveAssetSector(sectorKey, 1); }} disabled={index === assetSectorOrder.length - 1} className="p-1.5 hover:bg-white/20 rounded-md disabled:opacity-30 transition-colors"><svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" /></svg></button>
                                            </div>
                                            <button onClick={() => addAsset(sectorKey)} className={`bg-white text-${sectorColor}-600 px-4 py-2 rounded-lg text-sm font-bold hover:bg-${sectorColor}-50 transition-all shadow-lg hover:shadow-xl flex items-center gap-1.5 active:scale-95`}>
                                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2.5" d="M12 4v16m8-8H4" /></svg>
                                                ì¶”ê°€
                                            </button>
                                        </div>
                                    </div>

                                    {/* Body */}
                                    {!hiddenSectors[sectorKey] && (
                                        <div className="p-4 sm:p-6 bg-gray-50 dark:bg-gray-900/50 space-y-4">
                                            {assets[sectorKey]?.map((asset, idx) => {
                                                const itemRec = calculation.rebalanceInfo?.itemRecs?.[asset.id] || 0;
                                                return (
                                                <div key={asset.id || idx} className="group bg-white dark:bg-gray-800 rounded-xl p-5 shadow-sm border border-gray-200 dark:border-gray-700 hover:border-indigo-300 dark:hover:border-indigo-500 hover:shadow-md transition-all duration-200">
                                                    <div className="flex flex-col lg:flex-row gap-6 items-start lg:items-center">
                                                        {/* Icon & Name */}
                                                        <div className="flex-1 w-full lg:w-auto">
                                                            <label className="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1.5 block">{isLoan ? 'ëŒ€ì¶œëª…' : 'ê³„ì¢Œëª…'}</label>
                                                            <div className="flex items-center gap-3">
                                                                <div
                                                                    onClick={() => setIconPickerState({ sector: sectorKey, index: idx })}
                                                                    className="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 cursor-pointer hover:opacity-80 transition-opacity relative group/icon"
                                                                    style={{
                                                                        backgroundColor: darkMode ? `${colorObj[600] || '#4f46e5'}33` : (colorObj[50] || '#eef2ff'),
                                                                        color: darkMode ? (colorObj.start || '#a5b4fc') : (colorObj[500] || '#6366f1')
                                                                    }}
                                                                >
                                                                    {asset.icon ? <span className="text-xl leading-none select-none">{asset.icon}</span> : <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" /></svg>}
                                                                    <div className="absolute -bottom-1 -right-1 bg-gray-100 dark:bg-gray-700 rounded-full p-0.5 border border-gray-200 dark:border-gray-600 opacity-0 group-hover/icon:opacity-100 transition-opacity">
                                                                        <svg className="w-2.5 h-2.5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                                                                    </div>
                                                                </div>
                                                                <input 
                                                                    type="text" 
                                                                    value={asset.name} 
                                                                    onChange={(e) => updateAsset(sectorKey, idx, 'name', e.target.value)}
                                                                    className="w-full bg-transparent border-b-2 border-transparent focus:border-indigo-500 text-lg font-bold text-gray-800 dark:text-white focus:outline-none px-1 py-0.5 transition-colors placeholder-gray-300"
                                                                    placeholder={isLoan ? "ëŒ€ì¶œ ì´ë¦„ ì…ë ¥" : "ê³„ì¢Œ ì´ë¦„ ì…ë ¥"}
                                                                />
                                                            </div>
                                                        </div>

                                                        {/* Amount */}
                                                        <div className="w-full lg:w-64">
                                                            <label className="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1.5 block">{isLoan ? 'ëŒ€ì¶œ ì”ì•¡ (ë§Œì›)' : 'í˜„ì¬ ì”ì•¡ (ë§Œì›)'}</label>
                                                            <div className="relative">
                                                                <CalculatorInput 
                                                                    value={asset.amount} 
                                                                    onChange={(e) => updateAsset(sectorKey, idx, 'amount', e.target.value)}
                                                                    className="w-full bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-600 rounded-lg pl-8 pr-4 py-2.5 text-right font-bold text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all"
                                                                />
                                                                <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm font-bold">â‚©</span>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    {/* Divider */}
                                                    <div className="h-px bg-gray-100 dark:bg-gray-700 my-4"></div>

                                                    {/* Secondary Details */}
                                                    <div className="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-5 gap-4 items-end">
                                                        {isLoan ? (
                                                            <>
                                                                <div><label className="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1 block">ì´ììœ¨</label><div className="relative"><input type="number" step="0.1" value={asset.rate} onChange={(e) => updateAsset(sectorKey, idx, 'rate', e.target.value)} className="w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-md px-2 py-1.5 text-sm text-gray-700 dark:text-gray-200 focus:ring-1 focus:ring-indigo-500 text-right pr-6" /><span className="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 text-xs">%</span></div></div>
                                                                <div><label className="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1 block">ì›” ìƒí™˜ì•¡</label><CalculatorInput value={asset.monthlyContrib} onChange={(e) => updateAsset(sectorKey, idx, 'monthlyContrib', e.target.value)} className="w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-md px-2 py-1.5 text-sm text-gray-700 dark:text-gray-200 focus:ring-1 focus:ring-indigo-500 text-right" /></div>
                                                                <div><label className="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1 block">ë§Œê¸° (ê°œì›”)</label><input type="number" value={asset.maturityMonth ?? 12} onChange={(e) => updateAsset(sectorKey, idx, 'maturityMonth', e.target.value)} className="w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-md px-2 py-1.5 text-sm text-gray-700 dark:text-gray-200 focus:ring-1 focus:ring-indigo-500 text-right" /></div>
                                                                <div>
                                                                    <label className="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1 block">ìƒí™˜ ë°©ì‹</label>
                                                                    <select value={asset.repaymentMethod || 'ì›ë¦¬ê¸ˆê· ë“±'} onChange={(e) => updateAsset(sectorKey, idx, 'repaymentMethod', e.target.value)} className="w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-md px-2 py-1.5 text-sm text-gray-700 dark:text-gray-200 focus:ring-1 focus:ring-indigo-500">
                                                                        <option value="ì›ë¦¬ê¸ˆê· ë“±">ì›ë¦¬ê¸ˆê· ë“±</option>
                                                                        <option value="ì›ê¸ˆê· ë“±">ì›ê¸ˆê· ë“±</option>
                                                                        <option value="ë§Œê¸°ì¼ì‹œ">ë§Œê¸°ì¼ì‹œ</option>
                                                                    </select>
                                                                </div>
                                                            </>
                                                        ) : (
                                                            <>
                                                                <div><label className="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1 block">ì—° ìˆ˜ìµë¥ </label><div className="relative"><input type="number" step="0.1" value={asset.rate} onChange={(e) => updateAsset(sectorKey, idx, 'rate', e.target.value)} className="w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-md px-2 py-1.5 text-sm text-gray-700 dark:text-gray-200 focus:ring-1 focus:ring-indigo-500 text-right pr-6" /><span className="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 text-xs">%</span></div></div>
                                                                <div>
                                                                    <label className="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1 block">ì›” ë‚©ì…ì•¡</label>
                                                                    <div className="relative">
                                                                        <CalculatorInput value={asset.monthlyContrib} onChange={(e) => updateAsset(sectorKey, idx, 'monthlyContrib', e.target.value)} className="w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-md px-2 py-1.5 text-sm text-gray-700 dark:text-gray-200 focus:ring-1 focus:ring-indigo-500 text-right" />
                                                                        {itemRec > 0 && <span className="absolute -top-5 right-0 text-[9px] text-blue-500 font-bold bg-blue-50 px-1 rounded">ê¶Œì¥: {Math.round(itemRec).toLocaleString()}</span>}
                                                                    </div>
                                                                </div>
                                                                <div>
                                                                    <label className="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1 block">ì¶”ê°€ ë‚©ì…</label>
                                                                    <div className="flex gap-1">
                                                                        <input type="number" value={asset.extraContrib} onChange={(e) => updateAsset(sectorKey, idx, 'extraContrib', e.target.value)} className="w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-md px-2 py-1.5 text-sm text-gray-700 dark:text-gray-200 focus:ring-1 focus:ring-indigo-500 text-right" />
                                                                        {asset.extraContrib > 0 && (
                                                                            <select value={asset.extraFrom} onChange={(e) => updateAsset(sectorKey, idx, 'extraFrom', e.target.value)} className="w-16 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-md text-[10px] text-gray-700 dark:text-gray-200 focus:ring-1 focus:ring-indigo-500" title="ì¶œê¸ˆ ê³„ì¢Œ ì„ íƒ">
                                                                                {accountOptions.filter(name => name !== asset.name).map((name, i) => (<option key={i} value={name}>{name}</option>))}
                                                                            </select>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                                <div><label className="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1 block">ìˆ˜ìˆ˜ë£Œ/ì„¸ê¸ˆ</label><div className="relative"><input type="number" step="0.01" value={asset.feeRate ?? 0} onChange={(e) => updateAsset(sectorKey, idx, 'feeRate', e.target.value)} className="w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-md px-2 py-1.5 text-sm text-gray-700 dark:text-gray-200 focus:ring-1 focus:ring-indigo-500 text-right pr-6" /><span className="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 text-xs">%</span></div></div>
                                                            </>
                                                        )}
                                                        <div className="flex justify-end col-span-2 sm:col-span-4 lg:col-span-1">
                                                            <button onClick={() => removeAsset(sectorKey, idx)} className="text-red-400 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 px-3 py-1.5 rounded-lg text-xs font-bold transition-colors flex items-center gap-1 w-full justify-center lg:w-auto">
                                                                <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                                                ì‚­ì œ
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                                );
                                            })}
                                            {(!assets[sectorKey] || assets[sectorKey].length === 0) && (
                                                <div className="text-center py-12 text-gray-400 bg-white dark:bg-gray-800 rounded-xl border-2 border-dashed border-gray-200 dark:border-gray-700 hover:border-indigo-300 transition-colors cursor-pointer" onClick={() => addAsset(sectorKey)}>
                                                    <div className="w-12 h-12 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-3 text-gray-400">
                                                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                                                    </div>
                                                    <p className="font-medium text-gray-500 dark:text-gray-400">ë“±ë¡ëœ ê³„ì¢Œê°€ ì—†ìŠµë‹ˆë‹¤</p>
                                                    <p className="text-sm text-indigo-500 mt-1">ì²« ë²ˆì§¸ ê³„ì¢Œë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”</p>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            );
                    })}
                </div>
            );

            const renderExpensesPanel = () => {
                const totalMonthly = monthlyExpenses.reduce((sum, e) => sum + Number(e.amount||0), 0);
                const totalAnnual = totalMonthly * 12;

                return (
                    <div className="space-y-6">
                        {/* Summary Card */}
                        <div className="bg-gradient-to-r from-rose-500 to-pink-600 rounded-2xl shadow-lg p-6 text-white flex flex-col sm:flex-row justify-between items-center gap-4">
                            <div>
                                <h3 className="text-lg font-bold flex items-center gap-2">
                                    <span className="text-2xl">ğŸ’¸</span> ì›” ê³ ì • ì§€ì¶œ
                                </h3>
                                <p className="text-rose-100 text-sm mt-1">ë§¤ë‹¬ ë‚˜ê°€ëŠ” ê³ ì •ë¹„ìš©ì„ ê´€ë¦¬í•˜ì„¸ìš”.</p>
                            </div>
                            <div className="text-right">
                                <div className="text-3xl font-bold">{formatNumber(totalMonthly)}ë§Œì›</div>
                                <div className="text-rose-100 text-sm">ì—°ê°„ ì•½ {formatNumber(totalAnnual)}ë§Œì›</div>
                            </div>
                        </div>

                        {/* Expense List */}
                        <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
                            <div className="p-4 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-800/50">
                                <span className="text-sm font-bold text-gray-500 dark:text-gray-400">ì´ {monthlyExpenses.length}ê±´</span>
                                <button onClick={addExpense} className="text-sm font-bold text-rose-500 hover:text-rose-600 flex items-center gap-1 px-3 py-1.5 rounded-lg hover:bg-rose-50 dark:hover:bg-rose-900/20 transition-colors">
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4" /></svg>
                                    ì§€ì¶œ ì¶”ê°€
                                </button>
                            </div>
                            
                            <div className="divide-y divide-gray-100 dark:divide-gray-700">
                        {monthlyExpenses.map((expense, index) => (
                                    <div key={index} className="p-4 hover:bg-gray-50 dark:hover:bg-gray-700/30 transition-colors group">
                                        <div className="flex flex-col sm:flex-row items-center gap-4">
                                            <div className="flex-1 w-full sm:w-auto flex items-center gap-3">
                                                <div className="w-10 h-10 rounded-full bg-rose-50 dark:bg-rose-900/30 flex items-center justify-center text-rose-500 dark:text-rose-400 flex-shrink-0">
                                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                                                </div>
                                                <input 
                                                    type="text" 
                                                    placeholder="ì§€ì¶œ í•­ëª©ëª… (ì˜ˆ: ì›”ì„¸, í†µì‹ ë¹„)" 
                                                    className="w-full bg-transparent border-b border-transparent focus:border-rose-500 text-gray-900 dark:text-white font-medium focus:outline-none py-1 transition-colors placeholder-gray-400"
                                                    value={expense.name} 
                                                    onChange={(e) => updateExpense(index, 'name', e.target.value)} 
                                                />
                                            </div>
                                    
                                            <div className="flex items-center gap-4 w-full sm:w-auto justify-between sm:justify-end">
                                                <div className="relative w-32">
                                                    <input 
                                                        type="number" 
                                                        placeholder="0" 
                                                        className="w-full bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-600 rounded-lg pl-3 pr-8 py-2 text-right font-bold text-gray-900 dark:text-white focus:ring-2 focus:ring-rose-500 focus:border-transparent transition-all"
                                                        value={expense.amount} 
                                                        onChange={(e) => updateExpense(index, 'amount', e.target.value)} 
                                                    />
                                                    <span className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs">ë§Œì›</span>
                                                </div>
                                                
                                                <button onClick={() => removeExpense(index)} className="p-2 text-gray-400 hover:text-rose-500 hover:bg-rose-50 dark:hover:bg-rose-900/20 rounded-full transition-colors" title="ì‚­ì œ">
                                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                                </button>
                                    </div>
                                </div>
                            </div>
                        ))}
                                {monthlyExpenses.length === 0 && (
                                    <div className="p-8 text-center text-gray-400">
                                        ë“±ë¡ëœ ì§€ì¶œì´ ì—†ìŠµë‹ˆë‹¤.
                    </div>
                                )}
                            </div>
                </div>
                    </div>
                );
            };

            // [ìˆ˜ì •] EventSectionì„ ì™¸ë¶€ë¡œ ë¶„ë¦¬í•˜ì—¬ ì…ë ¥ í¬ì»¤ìŠ¤ ëŠê¹€ ë°©ì§€
            const EventSection = React.memo(({ title, total, events, type, addFn, updateFn, removeFn, sectorInfo, assets, formatNumber }) => {
                const isIncome = type === 'income';
                const gradientClass = isIncome ? 'from-emerald-500 to-teal-600' : 'from-orange-500 to-amber-600';
                const icon = isIncome ? 'ğŸ’°' : 'ğŸ›’';
                const colorName = isIncome ? 'emerald' : 'orange';

                return (
                    <div className="space-y-6">
                        {/* Summary Card */}
                        <div className={`bg-gradient-to-r ${gradientClass} rounded-2xl shadow-lg p-6 text-white flex flex-col sm:flex-row justify-between items-center gap-4`}>
                            <div>
                                <h3 className="text-lg font-bold flex items-center gap-2">
                                    <span className="text-2xl">{icon}</span> {title}
                                </h3>
                                <p className="text-white/80 text-sm mt-1">ë¹„ì •ê¸°ì ì¸ {isIncome ? 'ìˆ˜ì…' : 'ì§€ì¶œ'} ì´ë²¤íŠ¸ë¥¼ ê´€ë¦¬í•˜ì„¸ìš”.</p>
                            </div>
                            <div className="text-right">
                                <div className="text-3xl font-bold">{formatNumber(total)}ë§Œì›</div>
                                <div className="text-white/80 text-sm">ì´ {events.length}ê±´ ì˜ˆì •</div>
                            </div>
                        </div>

                        {/* List */}
                        <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
                            <div className="p-4 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-800/50">
                                <span className="text-sm font-bold text-gray-500 dark:text-gray-400">ëª©ë¡</span>
                                <button onClick={addFn} className={`text-sm font-bold text-${colorName}-500 hover:text-${colorName}-600 flex items-center gap-1 px-3 py-1.5 rounded-lg hover:bg-${colorName}-50 dark:hover:bg-${colorName}-900/20 transition-colors`}>
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4" /></svg>
                                    ì¶”ê°€
                                </button>
                            </div>
                            
                            <div className="divide-y divide-gray-100 dark:divide-gray-700">
                                {events.map((event, index) => (
                                    <div key={index} className="p-4 hover:bg-gray-50 dark:hover:bg-gray-700/30 transition-colors">
                                        <div className="flex flex-col lg:flex-row gap-4 items-start lg:items-center">
                                            {/* Name */}
                                            <div className="flex-1 w-full lg:w-auto">
                                                <label className="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1 block">ì´ë²¤íŠ¸ëª…</label>
                                                <div className="flex items-center gap-3">
                                                    <div className={`w-8 h-8 rounded-full bg-${colorName}-50 dark:bg-${colorName}-900/30 flex items-center justify-center text-${colorName}-500 dark:text-${colorName}-400 flex-shrink-0`}>
                                                        {isIncome ? <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> : <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>}
                                                    </div>
                                                    <input 
                                                        type="text" 
                                                        value={event.name} 
                                                        onChange={(e) => updateFn(index, 'name', e.target.value)}
                                                        className="w-full bg-transparent border-b border-transparent focus:border-current text-gray-900 dark:text-white font-bold focus:outline-none py-1 transition-colors placeholder-gray-400"
                                                        placeholder="ì´ë²¤íŠ¸ ì´ë¦„"
                                                    />
                                                </div>
                                            </div>

                                            {/* Amount */}
                                            <div className="w-full lg:w-32">
                                                <label className="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1 block">ê¸ˆì•¡ (ë§Œì›)</label>
                                                <div className="relative">
                                                    <input 
                                                        type="number" 
                                                        value={event.amount} 
                                                        onChange={(e) => updateFn(index, 'amount', e.target.value)}
                                                        className="w-full bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-600 rounded-lg px-3 py-1.5 text-right font-bold text-gray-900 dark:text-white focus:ring-2 focus:ring-opacity-50 focus:outline-none"
                                                        style={{ borderColor: isIncome ? '#10b981' : '#f97316' }}
                                                    />
                                                </div>
                                            </div>

                                            {/* Date Range */}
                                            <div className="w-full lg:w-auto flex gap-2">
                                                <div>
                                                    <label className="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1 block">ì‹œì‘ ì›”</label>
                                                    <input type="month" value={event.startMonth} onChange={(e) => updateFn(index, 'startMonth', e.target.value)} className="w-32 text-xs border rounded px-2 py-1.5 bg-white dark:bg-gray-800 dark:text-white dark:border-gray-600" />
                                                </div>
                                                <div>
                                                    <label className="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1 block">ì¢…ë£Œ ì›”</label>
                                                    <input type="month" value={event.endMonth} onChange={(e) => updateFn(index, 'endMonth', e.target.value)} className="w-32 text-xs border rounded px-2 py-1.5 bg-white dark:bg-gray-800 dark:text-white dark:border-gray-600" />
                                                </div>
                                            </div>

                                            {/* Target */}
                                            <div className="w-full lg:w-auto">
                                                <label className="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1 block">{isIncome ? 'ì…ê¸ˆ ê³„ì¢Œ' : 'ì¶œê¸ˆ ê³„ì¢Œ'}</label>
                                                <div className="flex gap-1">
                                                    <select 
                                                        value={event.targetSector} 
                                                        onChange={(e) => updateFn(index, 'targetSector', e.target.value)}
                                                        className="w-24 text-xs border rounded px-2 py-1.5 bg-white dark:bg-gray-800 dark:text-white dark:border-gray-600"
                                                    >
                                                        {Object.keys(sectorInfo).map(key => <option key={key} value={key}>{sectorInfo[key].name}</option>)}
                                                    </select>
                                                    <select 
                                                        value={event.targetAsset} 
                                                        onChange={(e) => updateFn(index, 'targetAsset', e.target.value)}
                                                        className="w-24 text-xs border rounded px-2 py-1.5 bg-white dark:bg-gray-800 dark:text-white dark:border-gray-600"
                                                    >
                                                        {assets[event.targetSector]?.map((asset, i) => <option key={i} value={i}>{asset.name}</option>)}
                                                    </select>
                                                </div>
                                            </div>

                                            {/* Delete */}
                                            <div className="flex items-end h-full pb-1">
                                                <button onClick={() => removeFn(index)} className="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-full transition-colors" title="ì‚­ì œ">
                                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                                {events.length === 0 && (
                                    <div className="p-8 text-center text-gray-400">
                                        ë“±ë¡ëœ ì´ë²¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            });

            const renderEventsPanel = () => {
                const totalIncome = incomeEvents.reduce((sum, e) => sum + Number(e.amount||0), 0);
                const totalExpense = expenseEvents.reduce((sum, e) => sum + Number(e.amount||0), 0);

                return (
                    <div className="space-y-8">
                        <EventSection 
                            title="ìˆ˜ì… ì´ë²¤íŠ¸" 
                            total={totalIncome} 
                            events={incomeEvents} 
                            type="income" 
                            addFn={addIncomeEvent} 
                            updateFn={updateIncomeEvent} 
                            removeFn={removeIncomeEvent} 
                            sectorInfo={sectorInfo}
                            assets={assets}
                            formatNumber={formatNumber}
                        />
                        <EventSection 
                            title="ì§€ì¶œ ì´ë²¤íŠ¸" 
                            total={totalExpense} 
                            events={expenseEvents} 
                            type="expense" 
                            addFn={addExpenseEvent} 
                            updateFn={updateExpenseEvent} 
                            removeFn={removeExpenseEvent} 
                            sectorInfo={sectorInfo}
                            assets={assets}
                            formatNumber={formatNumber}
                        />
                    </div>
                );
            };

            const renderDetailAnalysisPanel = () => (
                <>
                    {/* [ì¶”ê°€] ëª¨ë°”ì¼ ì¹´ë“œ ë·° (ë°˜ì‘í˜• UX ê°œì„ ) */}
                    <div className="sm:hidden space-y-4">
                        {Object.keys(sectorInfo).map(sectorKey => {
                            const current = currentSectorTotals[sectorKey] || { amount: 0, percentage: 0 };
                            const projected = projectedSectorTotals[sectorKey] || { amount: 0, percentage: 0 };
                            const growthRate = current.amount > 0 ? ((projected.amount - current.amount) / current.amount * 100) : 0;
                            const isPositiveGood = sectorKey === 'loan' ? growthRate <= 0 : growthRate >= 0;
                            const targetPct = (rebalancingTargets[sectorKey] ?? Math.round(100 / Object.keys(sectorInfo).length));

                            return (
                                <div key={sectorKey} className={`p-4 rounded-lg shadow-sm ${sectorInfo[sectorKey].bgClass} border dark:border-gray-700`}>
                                    <div className="flex justify-between items-center mb-2">
                                        <h4 className="font-bold text-gray-900 dark:text-white flex items-center gap-2">
                                            {sectorInfo[sectorKey].icon} {sectorInfo[sectorKey].name}
                                        </h4>
                                        {growthRate !== 0 && (
                                            <span className={`text-xs font-bold px-2 py-1 rounded ${isPositiveGood ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'}`}>
                                                ì¦ê°ìœ¨: {formatPercent(growthRate)}%
                                            </span>
                                        )}
                                    </div>
                                    <div className="grid grid-cols-2 gap-2 text-sm mb-3">
                                        <div>
                                            <span className="text-xs text-gray-500 dark:text-gray-400 block">í˜„ì¬ ê¸ˆì•¡</span>
                                            <span className="font-semibold tabular-nums">{formatNumber(current.amount)}</span>
                                        </div>
                                        <div>
                                            <span className="text-xs text-gray-500 dark:text-gray-400 block">ì˜ˆìƒ ê¸ˆì•¡</span>
                                            <span className="font-semibold tabular-nums">{formatNumber(projected.amount)}</span>
                                        </div>
                                        <div>
                                            <span className="text-xs text-gray-500 dark:text-gray-400 block">í˜„ì¬ ë¹„ì¤‘</span>
                                            <span className="tabular-nums">{formatPercent(current.percentage)}%</span>
                                        </div>
                                        <div>
                                            <span className="text-xs text-gray-500 dark:text-gray-400 block">ì˜ˆìƒ ë¹„ì¤‘</span>
                                            <span className="tabular-nums">{formatPercent(projected.percentage)}%</span>
                                        </div>
                                    </div>
                                    
                                    {assets[sectorKey]?.length > 0 && (
                                        <div className="mt-3 pt-3 border-t border-gray-200 dark:border-gray-700 space-y-2">
                                            {assets[sectorKey].map((asset, idx) => {
                                                const projectedAmount = calculation.projected[sectorKey]?.[idx]?.amount || 0;
                                                const assetGrowth = projectedAmount - asset.amount;
                                                const assetGrowthRate = asset.amount > 0 ? (assetGrowth / asset.amount * 100) : 0;
                                                const isAssetPositiveGood = sectorKey === 'loan' ? assetGrowthRate <= 0 : assetGrowthRate >= 0;
                                                
                                                return (
                                                    <div key={`${sectorKey}-${idx}`} className="flex justify-between items-center text-xs bg-white/50 dark:bg-black/20 p-2 rounded">
                                                        <span className="font-medium truncate flex-1">{asset.name}</span>
                                                        <div className="text-right">
                                                            <div>{formatNumber(asset.amount)} â†’ {formatNumber(projectedAmount)}</div>
                                                            <div className={`${isAssetPositiveGood ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>
                                                                {formatPercent(assetGrowthRate)}%
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                        <div className="p-4 rounded-lg shadow-sm bg-gray-100 dark:bg-gray-800 border dark:border-gray-700">
                            <div className="flex justify-between items-center mb-2">
                                <h4 className="font-bold text-gray-900 dark:text-white">ì´ê³„</h4>
                                <span className="text-xs font-bold px-2 py-1 rounded bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                                    ì¦ê°ìœ¨: {formatPercent(calculation.growth / calculation.currentTotal * 100)}%
                                </span>
                            </div>
                            <div className="grid grid-cols-2 gap-2 text-sm">
                                <div><span className="text-xs text-gray-500 dark:text-gray-400 block">í˜„ì¬ ì´ìì‚°</span><span className="font-bold tabular-nums">{formatNumber(calculation.currentTotal)}</span></div>
                                <div><span className="text-xs text-gray-500 dark:text-gray-400 block">ì˜ˆìƒ ì´ìì‚°</span><span className="font-bold tabular-nums">{formatNumber(calculation.projectedTotal)}</span></div>
                            </div>
                        </div>
                    </div>

                    {/* ë°ìŠ¤í¬íƒ‘ í…Œì´ë¸” ë·° */}
                    <div className="hidden sm:block overflow-x-auto -mx-6 px-6">
                    <table className="w-full text-sm dark:text-gray-300 min-w-[800px]">
                        <thead className="bg-gray-100 dark:bg-gray-700">
                            <tr>
                                <th className="p-3 text-left">ì„¹í„°/í•­ëª©</th>
                                <th className="p-3 text-right">í˜„ì¬ ê¸ˆì•¡</th>
                                <th className="p-3 text-right">ì˜ˆìƒ ê¸ˆì•¡</th>
                                <th className="p-3 text-right">ì¦ê°ë¥ </th>
                                <th className="p-3 text-right">í˜„ì¬ ë¹„ì¤‘</th>
                                <th className="p-3 text-right">ì˜ˆìƒ ë¹„ì¤‘</th>
                                <th className="p-3 text-right">ëª©í‘œ ë¹„ì¤‘</th>
                            </tr>
                        </thead>
                        <tbody>
                            {Object.keys(sectorInfo).map(sectorKey => {
                                const current = currentSectorTotals[sectorKey] || { amount: 0, percentage: 0 };
                                const projected = projectedSectorTotals[sectorKey] || { amount: 0, percentage: 0 };
                                const growthRate = current.amount > 0 ? ((projected.amount - current.amount) / current.amount * 100) : 0;
                                const isPositiveGood = sectorKey === 'loan' ? growthRate <= 0 : growthRate >= 0;
                                const rebalanceStatus = getRebalanceStatus(sectorKey, projected.percentage, false);
                                const targetPct = (rebalancingTargets[sectorKey] ?? Math.round(100 / Object.keys(sectorInfo).length));

                                return (
                                    <React.Fragment key={sectorKey}>
                                        <tr className={`border-t dark:border-gray-700 ${sectorInfo[sectorKey].bgClass} hover:brightness-95 dark:hover:brightness-110 transition-all`}>
                                            <td className="p-3 font-semibold">
                                                {sectorInfo[sectorKey].icon} {sectorInfo[sectorKey].name}
                                            </td>
                                            <td className="p-3 text-right tabular-nums">{formatNumber(current.amount)}</td>
                                            <td className="p-3 text-right tabular-nums">{formatNumber(projected.amount)}</td>
                                            <td className={`p-3 text-right tabular-nums ${isPositiveGood ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>{formatPercent(growthRate)}%</td>
                                            <td className="p-3 text-right tabular-nums">{formatPercent(current.percentage)}%</td>
                                            <td className="p-3 text-right tabular-nums">{formatPercent(projected.percentage)}%</td>
                                            <td className="p-3 text-right tabular-nums">{formatPercent(targetPct)}%</td>
                                        </tr>
                                        {assets[sectorKey]?.map((asset, idx) => {
                                            const projectedAmount = calculation.projected[sectorKey]?.[idx]?.amount || 0;
                                            const assetGrowth = projectedAmount - asset.amount;
                                            const assetGrowthRate = asset.amount > 0 ? (assetGrowth / asset.amount * 100) : 0;
                                            const isAssetPositiveGood = sectorKey === 'loan' ? assetGrowthRate <= 0 : assetGrowthRate >= 0;
                                            const sectorTotal = projected.amount || 1;
                                            const currentAssetPercentageInPortfolio = (currentGrossTotal > 0) ? (asset.amount / currentGrossTotal * 100) : 0;
                                            const assetPercentageInPortfolio = (projectedAmount / projectedGrossTotal * 100);
                                            const currentAssetPercentageInSector = (current.amount > 0) ? (asset.amount / current.amount * 100) : 0;
                                            const projectedAssetPercentageInSector = (projected.amount > 0) ? (projectedAmount / projected.amount * 100) : 0;
                                            const itemTarget = appData.itemTargets?.[asset.id] ?? Math.round(100/(assets[sectorKey]?.length||1));
                                            const itemRebalanceStatus = getRebalanceStatus(asset.id, projectedAssetPercentageInSector, true, asset.id, sectorKey);
                                            
                                            return (
                                                <tr key={`${sectorKey}-${idx}`} className="border-t dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                                                    <td className="p-3 pl-8 text-[11px] dark:text-gray-400">â”” {asset.name}</td>
                                                    <td className="p-3 text-right text-[11px] tabular-nums">{formatNumber(asset.amount)}</td>
                                                    <td className="p-3 text-right text-[11px] tabular-nums">{formatNumber(projectedAmount)}</td>
                                                    <td className={`p-3 text-right text-[11px] tabular-nums ${isAssetPositiveGood ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>{formatPercent(assetGrowthRate)}%</td>
                                                    <td className="p-3 text-right text-[11px] tabular-nums">
                                                        {sectorKey !== 'loan' ? `${formatPercent(currentAssetPercentageInPortfolio)}% (${formatPercent(currentAssetPercentageInSector)}%)` : '-'}
                                                    </td>
                                                    <td className="p-3 text-right text-[11px] tabular-nums">
                                                        {sectorKey !== 'loan' ? `${formatPercent(assetPercentageInPortfolio)}% (${formatPercent(projectedAssetPercentageInSector)}%)` : '-'}
                                                    </td>
                                                    <td className={`p-3 text-right text-[11px] tabular-nums ${itemRebalanceStatus}`}>({formatPercent(itemTarget)}%)</td>
                                                </tr>
                                            );
                                        })}
                                    </React.Fragment>
                                );
                            })}
                            <tr className="border-t-2 border-gray-400 dark:border-gray-600 bg-gray-100 dark:bg-gray-700">
                                <td className="p-3 font-bold">ì´ê³„</td>
                                <td className="p-3 text-right font-bold tabular-nums">{formatNumber(calculation.currentTotal)}</td>
                                <td className="p-3 text-right font-bold tabular-nums">{formatNumber(calculation.projectedTotal)}</td>
                                <td className="p-3 text-right font-bold text-green-600 dark:text-green-400 tabular-nums">{formatPercent(calculation.growth / calculation.currentTotal * 100)}%</td>
                                <td className="p-3 text-right font-bold tabular-nums">100.0%</td>
                                <td className="p-3 text-right font-bold tabular-nums">100.0%</td>
                                <td className="p-3 text-right font-bold tabular-nums">100.0%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                </>
            );

            const renderAssumptionsPanel = () => {
                const assumptions = [
                    {
                        icon: 'ğŸ“ˆ',
                        title: 'ìˆ˜ìµë¥  ë° ì¸í”Œë ˆì´ì…˜',
                        content: [
                            `ì—°ê°„ ì¸í”Œë ˆì´ì…˜ìœ¨: ${inflationRate}% ì ìš© (ë§¤ë…„ ë³µë¦¬)`,
                            'ëª¨ë“  ìì‚°ì˜ ìˆ˜ìµë¥ ì€ ì›” ë³µë¦¬ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.',
                            'ìˆ˜ìˆ˜ë£Œ ë° ì„¸ê¸ˆì€ ë§¤ì›” ìˆ˜ìµ ë°œìƒ ì‹œ ì¦‰ì‹œ ì°¨ê°í•˜ì—¬ ì¬íˆ¬ìë˜ëŠ” ê²ƒìœ¼ë¡œ ê°€ì •í•©ë‹ˆë‹¤.'
                        ]
                    },
                    {
                        icon: 'ğŸ’³',
                        title: 'ëŒ€ì¶œ ë° ìƒí™˜',
                        content: [
                            'ëŒ€ì¶œ ì´ìëŠ” ë§¤ì›” ì›ê¸ˆì— ê°€ì‚°ëœ í›„ ìƒí™˜ì•¡ì´ ì°¨ê°ë©ë‹ˆë‹¤.',
                            'ì›ë¦¬ê¸ˆê· ë“±: ë§¤ì›” ë™ì¼í•œ ê¸ˆì•¡ ìƒí™˜ (ì´ˆê¸° ì´ì ë¹„ì¤‘ ë†’ìŒ)',
                            'ì›ê¸ˆê· ë“±: ë§¤ì›” ì›ê¸ˆ ì¼ì •ì•¡ + ì´ì ìƒí™˜ (ì´ˆê¸° ìƒí™˜ì•¡ ë†’ìŒ)',
                            'ë§Œê¸°ì¼ì‹œ: ë§¤ì›” ì´ìë§Œ ë‚©ë¶€í•˜ë‹¤ ë§Œê¸°ì— ì›ê¸ˆ ì¼ì‹œ ìƒí™˜'
                        ]
                    }
                ];

                return (
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {assumptions.map((item, idx) => (
                            <div key={idx} className="bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-100 dark:border-gray-700 shadow-sm hover:shadow-md transition-shadow">
                                <div className="flex items-center gap-2 mb-3 border-b border-gray-100 dark:border-gray-700 pb-2">
                                    <span className="text-xl">{item.icon}</span>
                                    <h4 className="font-bold text-gray-800 dark:text-white">{item.title}</h4>
                                </div>
                                <ul className="space-y-2">
                                    {item.content.map((text, i) => (
                                        <li key={i} className="text-xs text-gray-600 dark:text-gray-300 flex items-start gap-1.5 leading-relaxed">
                                            <span className="text-blue-500 mt-0.5">â€¢</span>
                                            <span>{text}</span>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        ))}
                        <div className="md:col-span-2 bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl border border-blue-100 dark:border-blue-800">
                            <h4 className="font-bold text-blue-800 dark:text-blue-300 text-sm mb-2">ğŸ’¡ ì°¸ê³ ì‚¬í•­</h4>
                            <p className="text-xs text-blue-700 dark:text-blue-200 leading-relaxed">
                                ë³¸ ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼ëŠ” ì‚¬ìš©ìê°€ ì…ë ¥í•œ ê°€ì •(ìˆ˜ìµë¥ , ë¬¼ê°€ìƒìŠ¹ë¥  ë“±)ì— ê¸°ë°˜í•œ ë‹¨ìˆœ ì˜ˆì¸¡ì¹˜ì´ë©°, 
                                ì‹¤ì œ ë¯¸ë˜ì˜ ìì‚° ê°€ì¹˜ë¥¼ ë³´ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì„¸ê¸ˆ, ìˆ˜ìˆ˜ë£Œ, ì‹œì¥ ë³€ë™ì„± ë“± ë‹¤ì–‘í•œ ë³€ìˆ˜ì— ë”°ë¼ ì‹¤ì œ ê²°ê³¼ëŠ” ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                            </p>
                        </div>
                    </div>
                );
            };

            // [ìˆ˜ì •] ëª¨ë“  Hook ì„ ì–¸ì´ ëë‚œ í›„, ì‹¤ì œ ë Œë”ë§ ì§ì „ì— ë¡œë”© ìƒíƒœë¥¼ ì²´í¬í•˜ì—¬ Hook ê·œì¹™ ìœ„ë°˜ í•´ê²°
            if (isLoading) {
                return <SkeletonDashboard />;
            }

            const renderFunctions = { renderScenarioPanel, renderChartsPanel, renderHistoryPanel, renderBudgetPanel, renderMemoPanel, renderRebalancePanel, renderAssetsPanel, renderExpensesPanel, renderEventsPanel, renderDetailAnalysisPanel, renderAssumptionsPanel };

            // [ì¶”ê°€] ì‚¬ì´ë“œë°” ë‚´ë¹„ê²Œì´ì…˜ í•­ëª© ì •ì˜
            const navLabels = window.navLabels || {};

            return (
                (calculation.error || layoutOrder.length === 0) ? 
                <div className="flex items-center justify-center min-h-screen bg-gray-50">
                    { layoutOrder.length === 0 ? 'ë ˆì´ì•„ì›ƒ ë¡œë”© ì¤‘...' : 'ê³„ì‚° ì˜¤ë¥˜ ë°œìƒ. ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.' }
                    <button onClick={() => { if(confirm('ëª¨ë“  ë¡œì»¬ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³  ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { localStorage.clear(); window.location.reload(); } }} className="mt-4 text-sm text-gray-500 underline hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 cursor-pointer">
                        ë°ì´í„° ì´ˆê¸°í™” (ë³µêµ¬)
                    </button>
                </div>
                :
                    <div className="relative min-h-screen bg-gray-50 dark:bg-gray-900 transition-colors pb-20 sm:pb-0">
                    <div className="sticky top-0 z-50 bg-white dark:bg-gray-800 shadow-sm border-b dark:border-gray-700">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center h-16">
                                <div className="flex items-center gap-3">
                                    <h1 id="app-title" className="text-xl sm:text-2xl font-bold text-gray-900 dark:text-white cursor-pointer" onClick={cycleDisplayMode} title="í´ë¦­í•˜ì—¬ ì‚¬ìš©ì/í”„ë¼ì´ë¹—/ë°ëª¨ ëª¨ë“œ ì „í™˜">
                                        ìì‚° í”Œë˜ë„ˆ {titleText}
                                    </h1>
                                    <span 
                                        className={`px-2 py-0.5 text-[10px] font-bold rounded-full transition-all border ${isPro ? 'bg-amber-100 text-amber-700 border-amber-200 dark:bg-amber-900/30 dark:text-amber-300 dark:border-amber-800' : 'bg-gray-100 text-gray-600 border-gray-200 dark:bg-gray-700 dark:text-gray-400 dark:border-gray-600'}`}
                                    >
                                        {isPro ? 'PRO' : 'FREE'}
                                    </span>
                                </div>
                                <div id="header-actions" className="hidden sm:flex items-center gap-2 sm:gap-4"> 
                                    <button onClick={saveToPDF} className="inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 text-sm leading-4 font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors">ğŸ“„ PDF ì €ì¥</button>
                                    <button onClick={saveAsDefault} className="inline-flex items-center px-3 py-2 border border-blue-300 dark:border-blue-800 text-sm leading-4 font-medium rounded-md text-blue-700 dark:text-blue-400 bg-white dark:bg-gray-700 hover:bg-blue-50 dark:hover:bg-blue-900/30 transition-colors">â­ ê¸°ë³¸ê°’ ì €ì¥</button>
                                    <button onClick={loadCustomDefault} className="inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 text-sm leading-4 font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors">â†©ï¸ ê¸°ë³¸ê°’ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                                    {/* [ì´ë™] ì‹¤í–‰ ì·¨ì†Œ/ë‹¤ì‹œ ì‹¤í–‰ ë²„íŠ¼ (ìš°ì¸¡ìœ¼ë¡œ ì´ë™) */}
                                    <div className="flex items-center bg-white dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600">
                                        <button onClick={() => { undo(); addToast('ì‹¤í–‰ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info'); }} disabled={!canUndo} className="px-3 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600 disabled:opacity-30 disabled:cursor-not-allowed border-r border-gray-300 dark:border-gray-600" title="ì‹¤í–‰ ì·¨ì†Œ (Ctrl+Z)">
                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" /></svg>
                                        </button>
                                        <button onClick={() => { redo(); addToast('ë‹¤ì‹œ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info'); }} disabled={!canRedo} className="px-3 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600 disabled:opacity-30 disabled:cursor-not-allowed" title="ë‹¤ì‹œ ì‹¤í–‰ (Ctrl+Y)">
                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 10h-10a8 8 0 00-8 8v2M21 10l-6 6m6-6l-6-6" /></svg>
                                        </button>
                                    </div>
                                </div>
                                <div className="sm:hidden relative">
                                    <details className="relative">
                                        <summary id="mobile-menu-trigger" className="list-none inline-flex items-center px-3 py-2 border dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200">â˜° ë©”ë‰´</summary>
                                        <div className="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 border dark:border-gray-700 rounded-md shadow-md z-50 p-2 space-y-2">
                                            {!verifiedEmail ? (
                                                <button onClick={handleLogin} className="w-full text-left px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-gray-200 flex items-center gap-2 font-bold text-blue-600 dark:text-blue-400">
                                                    <svg className="w-4 h-4" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                                                    Google ë¡œê·¸ì¸
                                                </button>
                                            ) : (
                                                <>
                                                    <div className="px-3 py-2 text-xs text-gray-500 dark:text-gray-400 border-b dark:border-gray-700 mb-1 truncate">
                                                        {userProfile?.full_name || verifiedEmail}
                                                        <span className={`ml-2 text-[9px] px-1 rounded font-bold ${isPro ? 'bg-amber-100 text-amber-700' : 'bg-gray-100 text-gray-500'}`}>
                                                            {isPro ? 'PRO' : 'FREE'}
                                                        </span>
                                                {/* [ì¶”ê°€] ëª¨ë°”ì¼ ë©”ë‰´ ë‚´ ì‹¤í–‰ ì·¨ì†Œ/ë‹¤ì‹œ ì‹¤í–‰ */}
                                                <div className="flex items-center gap-2 mt-2">
                                                    <button onClick={() => { undo(); addToast('ì‹¤í–‰ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info'); }} disabled={!canUndo} className="flex-1 py-1 text-xs bg-gray-100 dark:bg-gray-700 rounded disabled:opacity-30">â†© ì‹¤í–‰ ì·¨ì†Œ</button>
                                                    <button onClick={() => { redo(); addToast('ë‹¤ì‹œ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info'); }} disabled={!canRedo} className="flex-1 py-1 text-xs bg-gray-100 dark:bg-gray-700 rounded disabled:opacity-30">â†ª ë‹¤ì‹œ ì‹¤í–‰</button>
                                                </div>
                                                        {/* [ì¶”ê°€] ëª¨ë°”ì¼ ë©”ë‰´ ë‚´ ë™ê¸°í™” ìƒíƒœ í‘œì‹œ */}
                                                        {verifiedEmail && (isPro || syncStatus === 'syncing') && (
                                                            <div className="flex items-center gap-1 mt-1">
                                                                <span className={`text-[9px] flex items-center gap-1 ${syncStatus === 'synced' ? 'text-green-600' : syncStatus === 'syncing' ? 'text-yellow-600' : syncStatus === 'error' ? 'text-red-600' : 'text-gray-400'}`}>
                                                                    <span className={`w-1.5 h-1.5 rounded-full ${syncStatus === 'synced' ? 'bg-green-500' : syncStatus === 'syncing' ? 'bg-yellow-500 animate-pulse' : syncStatus === 'error' ? 'bg-red-500' : 'bg-gray-300'}`}></span>
                                                                    {syncStatus === 'synced' ? 'ë™ê¸°í™”ë¨' : syncStatus === 'syncing' ? 'ë™ê¸°í™” ì¤‘' : syncStatus === 'error' ? 'ë™ê¸°í™” ì‹¤íŒ¨' : 'ëŒ€ê¸°'}
                                                                </span>
                                                            </div>
                                                        )}
                                                    </div>
                                                    <button onClick={() => fetchFromCloud(verifiedEmail, isPro, false, true)} className="w-full text-left px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-gray-200 text-sm">ğŸ”„ í´ë¼ìš°ë“œ ë™ê¸°í™”</button>
                                                    <button onClick={() => setIsSuggestionModalOpen(true)} className="w-full text-left px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-gray-200 text-sm">ğŸ’¡ ê¸°ëŠ¥ ì œì•ˆ</button>
                                                    <button onClick={handleLogout} className="w-full text-left px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-gray-200 text-red-500 text-sm">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
                                                </>
                                            )}
                                            <div className="border-t dark:border-gray-700 my-1"></div>
                                            <button onClick={handleDarkModeToggle} className="w-full text-left px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-gray-200 flex items-center">
                                                {!isPro && (
                                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-3.5 w-3.5 mr-2 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clipRule="evenodd" /></svg>
                                                )}
                                                {darkMode ? 'â˜€ï¸ ë¼ì´íŠ¸ëª¨ë“œ' : 'ğŸŒ™ ë‹¤í¬ëª¨ë“œ'}
                                            </button>
                                            <button onClick={saveToPDF} className="w-full text-left px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-gray-200">ğŸ“„ PDF ì €ì¥</button>
                                            <button onClick={() => setIsAIModalOpen(true)} className="w-full text-left px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-gray-200 text-indigo-600 font-bold">ğŸ¤– AI ìì‚° ë¶„ì„</button>
                                            <button onClick={saveAsDefault} className="w-full text-left px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-gray-200">â­ ê¸°ë³¸ê°’ ì €ì¥</button>
                                            <button onClick={loadCustomDefault} className="w-full text-left px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-gray-200">â†©ï¸ ê¸°ë³¸ê°’ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                                        </div>
                                    </details>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* ===== ë©”ì¸ ì½˜í…ì¸  ===== */}
                    <div id="dashboard-content" className="p-4 sm:p-6 max-w-[90rem] mx-auto flex flex-col lg:flex-row gap-8">
                        {/* [ì¶”ê°€] ì‚¬ì´ë“œë°” ë‚´ë¹„ê²Œì´ì…˜ */}
                        <aside className="hidden lg:block w-52 flex-shrink-0">
                            <div className="sticky top-24 space-y-4 max-h-[calc(100vh-6rem)] overflow-y-auto custom-scrollbar">
                            {/* í´ë¼ìš°ë“œ ë™ê¸°í™” ì¹´ë“œ */}
                            <div className="mb-4 p-3 bg-gradient-to-br from-indigo-50 to-blue-50 dark:from-indigo-900/20 dark:to-blue-900/20 rounded-xl border border-indigo-100 dark:border-indigo-800 shadow-sm">
                                <div className="flex items-center justify-between mb-2">
                                    <span className="text-[10px] font-bold text-indigo-600 dark:text-indigo-400 uppercase tracking-wider flex items-center gap-1">
                                        ë‚´ ì •ë³´
                                        {syncStatus === 'error' && <span title={syncError} className="cursor-help text-red-500">âš ï¸</span>}
                                    </span>
                                    {verifiedEmail && (isPro || syncStatus === 'syncing') && (
                                        <div className="flex items-center gap-1.5">
                                            <span className={`text-[9px] font-medium ${syncStatus === 'synced' ? 'text-green-600' : syncStatus === 'syncing' ? 'text-yellow-600' : syncStatus === 'error' ? 'text-red-600' : 'text-gray-400'}`}>
                                                {syncStatus === 'synced' ? (lastSyncTime ? `ë™ê¸°í™”ë¨ (${lastSyncTime})` : 'ë™ê¸°í™”ë¨') : syncStatus === 'syncing' ? 'ë™ê¸°í™” ì¤‘' : syncStatus === 'error' ? 'ë™ê¸°í™” ì‹¤íŒ¨' : 'ëŒ€ê¸°'}
                                            </span>
                                            <div className={`w-2 h-2 rounded-full ${syncStatus === 'synced' ? 'bg-green-500' : syncStatus === 'syncing' ? 'bg-yellow-500 animate-pulse' : syncStatus === 'error' ? 'bg-red-500' : 'bg-gray-300'}`}></div>
                                        </div>
                                    )}
                                </div>
                                
                                {isLoadingCloud ? (
                                    <div className="py-2 text-center">
                                        <div className="inline-block w-4 h-4 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin mb-1"></div>
                                        <div className="text-[10px] text-indigo-600 font-medium">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                                    </div>
                                ) : !verifiedEmail ? (
                                    <button 
                                        onClick={handleLogin} 
                                        className="w-full py-2 bg-white border border-gray-300 text-gray-700 rounded-lg text-[11px] font-bold flex items-center justify-center gap-2 hover:bg-gray-50 transition-colors shadow-sm"
                                    >
                                        <svg className="w-3 h-3" viewBox="0 0 24 24">
                                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/>
                                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                        </svg>
                                        Googleë¡œ ë¡œê·¸ì¸
                                    </button>
                                ) : (
                                    <div className="space-y-2">
                                        <div className="text-[11px] font-bold text-gray-800 dark:text-gray-200 truncate mb-1">
                                            {userProfile?.full_name || verifiedEmail}
                                        </div>
                                        <div className="grid grid-cols-1 gap-2">
                                            <button 
                                                onClick={() => isPro ? setIsSettingsModalOpen(true) : setIsProModalOpen(true)}
                                                className={`w-full py-2.5 rounded-lg text-[11px] font-bold transition-all shadow-md flex items-center justify-center gap-2 ${isPro ? 'bg-indigo-600 text-white hover:bg-indigo-700' : 'bg-gray-200 text-gray-500 dark:bg-gray-700 dark:text-gray-400 cursor-not-allowed'}`}
                                            >
                                                {isPro ? 'âš™ï¸ ì•± ì„¤ì • ë° ë³´ì•ˆ' : 'ğŸ”’ ì•± ì„¤ì • ë° ë³´ì•ˆ'}
                                            </button>
                                            {!isPro && (
                                                <button 
                                                    onClick={async () => {
                                                        const code = prompt('ë°œê¸‰ë°›ì€ í›„ì› ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
                                                        if (code) {
                                                            setIsLoadingCloud(true);
                                                            try {
                                                                const { data, error } = await withRetry(() => 
                                                                    supabase.rpc('redeem_code', { input_code: code.trim() })
                                                                );
                                                                if (error) throw error;
                                                                if (data) {
                                                                    addToast('ğŸ‰ í›„ì› ì½”ë“œê°€ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤! PRO ëª¨ë“œê°€ í™œì„±í™”ë©ë‹ˆë‹¤.', 'success');
                                                                    const { data: { session } } = await withRetry(() => supabase.auth.getSession());
                                                                    if (session) checkSubscription(session, true);
                                                                } else {
                                                                    addToast('âŒ ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ ì´ë¯¸ ì‚¬ìš©ëœ ì½”ë“œì…ë‹ˆë‹¤.', 'error');
                                                                }
                                                            } catch (err) {
                                                                console.error('Redeem error:', err);
                                                                addToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message, 'error');
                                                            } finally {
                                                                setIsLoadingCloud(false);
                                                            }
                                                        }
                                                    }}
                                                    className="w-full py-2 bg-green-50 dark:bg-green-900/30 text-green-600 dark:text-green-400 rounded-lg text-[10px] font-bold hover:bg-green-100 dark:hover:bg-green-900/50 transition-all border border-green-100 dark:border-green-800"
                                                >
                                                    ğŸ« í›„ì› ì½”ë“œ ë“±ë¡
                                                </button>
                                            )}
                                            <button 
                                                onClick={() => setIsSuggestionModalOpen(true)} 
                                                className="w-full py-2 bg-yellow-50 dark:bg-yellow-900/30 text-yellow-600 dark:text-yellow-400 rounded-lg text-[10px] font-bold hover:bg-yellow-100 dark:hover:bg-yellow-900/50 transition-all border border-yellow-100 dark:border-yellow-800"
                                            >
                                                ğŸ’¡ ê¸°ëŠ¥ ì œì•ˆ / ë²„ê·¸ ì‹ ê³ 
                                            </button>
                                            <button onClick={() => handleLogout()} className="w-full py-1.5 text-[10px] text-gray-500 hover:text-red-500 transition-colors">
                                                ğŸšª ë¡œê·¸ì•„ì›ƒ
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>

                            <div className="space-y-1 bg-white dark:bg-gray-900 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-800">
                                <div className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4 px-2">ë¹ ë¥¸ ì´ë™ (ìˆœì„œ ë³€ê²½ ê°€ëŠ¥)</div>
                                {layoutOrder.filter(id => {
                                    if (id === 'scenario') return scenarios.length > 0;
                                    if (id === 'history') return assetHistory.length > 0;
                                    return true;
                                }).map(id => (
                                    <button 
                                        key={id} 
                                        draggable="true"
                                        onDragStart={(e) => handlePanelDragStart(e, id)}
                                        onDragOver={handlePanelDragOver}
                                        onDrop={(e) => handlePanelDrop(e, id)}
                                        onClick={() => scrollToPanel(id)} 
                                        className={`w-full text-left px-2 py-2 text-sm font-medium rounded-lg transition-all flex items-center gap-2 group ${
                                            draggedPanelId === id ? 'bg-blue-50 dark:bg-blue-900/40 opacity-50 border border-dashed border-blue-300' : 'text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/20'
                                        }`}
                                    >
                                        <span className="text-gray-300 group-hover:text-gray-500 cursor-grab active:cursor-grabbing">â‹®â‹®</span>
                                        <span className="group-hover:scale-110 transition-transform">{navLabels[id]?.icon}</span>
                                        <span className="truncate">{navLabels[id]?.title}</span>
                                    </button>
                                ))}
                            </div>
                            <MarketDataWidget darkMode={darkMode} />
                            
                            {/* [ì´ë™] AI ìì‚° ë¶„ì„ ìœ„ì ¯ (ì‹œì¥ ì§€í‘œ ì•„ë˜ë¡œ ì´ë™) */}
                            <div className="mt-4 p-4 bg-gradient-to-br from-indigo-600 to-violet-600 rounded-xl shadow-lg text-white relative overflow-hidden group cursor-pointer transition-transform hover:scale-[1.02]" onClick={() => setIsAIModalOpen(true)}>
                                <div className="absolute top-0 right-0 -mt-2 -mr-2 w-16 h-16 bg-white opacity-10 rounded-full blur-xl group-hover:scale-150 transition-transform duration-500"></div>
                                <div className="relative z-10">
                                    <div className="flex items-center gap-2 mb-2">
                                        <span className="text-2xl">ğŸ¤–</span>
                                        <h3 className="font-bold text-lg">AI ìì‚° ë¶„ì„</h3>
                                    </div>
                                    <p className="text-indigo-100 text-xs leading-relaxed mb-3">
                                        í˜„ì¬ í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ ë¶„ì„í•˜ê³ <br/>ë§ì¶¤í˜• ì¡°ì–¸ì„ ë°›ì•„ë³´ì„¸ìš”.
                                    </p>
                                    <button className="w-full py-2 bg-white/20 hover:bg-white/30 rounded-lg text-xs font-bold transition-colors border border-white/10">
                                        ë¶„ì„ ì‹œì‘í•˜ê¸° â†’
                                    </button>
                                </div>
                            </div>
                            </div>
                        </aside>

                        <div className="flex-1 space-y-8 min-w-0">
                            {layoutOrder.map((panelId, index) => {
                                const panelProps = { 
                                    key: panelId,
                                    id: panelId,
                                    moveUp: () => movePanel(panelId, -1),
                                    moveDown: () => movePanel(panelId, 1),
                                    isFirst: layoutOrder.indexOf(panelId) === 0,
                                    isLast: layoutOrder.indexOf(panelId) === layoutOrder.length - 1,
                                    isCollapsed: !!panelCollapseState[panelId],
                                    onToggle: () => togglePanelCollapse(panelId),
                                };

                                const { renderSummaryPanel, renderScenarioPanel, renderChartsPanel, renderHistoryPanel, renderBudgetPanel, renderMemoPanel, renderRebalancePanel, renderAssetsPanel, renderExpensesPanel, renderEventsPanel, renderDetailAnalysisPanel, renderAssumptionsPanel } = renderFunctions; 

                                switch (panelId) {
                                    case 'summary':
                                        return <PanelWrapper {...panelProps} title="ğŸ“Š ìš”ì•½ ë° ì„¤ì •" className="bg-white dark:bg-gray-900 rounded-lg shadow">
    <SummaryPanel 
        calculation={calculation}
        projectionMonths={projectionMonths}
        baseMonth={baseMonth}
        displayMode={displayMode}
        monthlySalary={monthlySalary}
        setMonthlySalary={setMonthlySalary}
        setBaseMonth={setBaseMonth}
        setIsExportModalOpen={setIsExportModalOpen}
        setIsImportModalOpen={setIsImportModalOpen}
        exportToCSV={exportToCSV}
        importFromCSV={importFromCSV}
        saveToPDF={saveToPDF}
        saveCurrentAsset={saveCurrentAsset}
        goalMode={goalMode}
        setGoalMode={setGoalMode}
        setGoalSeekResult={setGoalSeekResult}
        setProjectionMonths={setProjectionMonths}
        targetAmount={targetAmount}
        setTargetAmount={setTargetAmount}
        calculateGoalSeek={calculateGoalSeek}
        goalSeekResult={goalSeekResult}
        inflationRate={inflationRate}
        setInflationRate={setInflationRate}
        saveScenario={saveScenario}
        onOpenAI={() => setIsAIModalOpen(true)}
    />
    {calculation.warnings && calculation.warnings.length > 0 && (
        <div className="mt-6 p-4 bg-red-50 dark:bg-red-900/20 border-l-4 border-red-500 rounded shadow-sm">
            <h3 className="text-sm font-bold text-red-800 dark:text-red-400 mb-2 flex items-center gap-2">âš ï¸ ì‹œë®¬ë ˆì´ì…˜ ê²½ê³  ({calculation.warnings.length}ê±´)</h3>
            <ul className="text-xs text-red-700 dark:text-red-300 list-disc list-inside space-y-1 max-h-40 overflow-y-auto">
                {calculation.warnings.map((w, i) => (
                    <li key={i}>[ì›” {w.month}] {w.message}</li>
                ))}
            </ul>
        </div>
    )}
</PanelWrapper>;
                                    case 'scenario': 
                                        return scenarios.length > 0 && (
                                            <PanelWrapper key={panelId} {...panelProps} title="ğŸ”€ ì‹œë‚˜ë¦¬ì˜¤ ë¹„êµ" className="bg-gray-50 dark:bg-gray-900 rounded-lg shadow">
                                                {renderScenarioPanel()}
                                            </PanelWrapper>
                                        );
                                    case 'charts':
                                        return (
                                            <PanelWrapper key={panelId} {...panelProps} title="ğŸ© í¬íŠ¸í´ë¦¬ì˜¤ ì°¨íŠ¸">
                                                {renderChartsPanel()}
                                            </PanelWrapper>
                                        );
                                    case 'history':
                                        return assetHistory.length > 0 && (
                                            <PanelWrapper key={panelId} {...panelProps} title="ğŸ“ˆ ìì‚° íˆìŠ¤í† ë¦¬">
                                                {renderHistoryPanel()}
                                            </PanelWrapper>
                                        );
                                    case 'budget':
                                        return (
                                            <PanelWrapper key={panelId} {...panelProps} title="ğŸ’° ì›”ë‚©ì… ì˜ˆì‚° ê´€ë¦¬">
                                                {renderBudgetPanel()}
                                            </PanelWrapper>
                                        );
                                    case 'memo':
                                        return (
                                            <PanelWrapper key={panelId} {...panelProps} title="ğŸ“ ë©”ëª¨">
                                                {renderMemoPanel()}
                                            </PanelWrapper>
                                        );
                                    case 'rebalance':
                                        return (
                                            <PanelWrapper key={panelId} {...panelProps} title="âš ï¸ ë¦¬ë°¸ëŸ°ì‹± ì„¤ì •">
                                                {renderRebalancePanel()}
                                            </PanelWrapper>
                                        );
                                    case 'assets':
                                        return (
                                            <PanelWrapper key={panelId} {...panelProps} title="ğŸ¦ ìì‚° ìƒì„¸ ì…ë ¥">
                                                {renderAssetsPanel()}
                                            </PanelWrapper>
                                        );
                                    case 'expenses':
                                        return (
                                            <PanelWrapper key={panelId} {...panelProps} title="ğŸ’¸ ì›”ë³„ ì§€ì¶œ ê´€ë¦¬">
                                                {renderExpensesPanel()}
                                            </PanelWrapper>
                                        );
                                    case 'events':
                                        return (
                                            <PanelWrapper key={panelId} {...panelProps} title="ğŸ‰ ì´ë²¤íŠ¸ ê´€ë¦¬">
                                                {renderEventsPanel()}
                                            </PanelWrapper>
                                        );
                                    case 'detail-analysis':
                                        return (
                                            <PanelWrapper key={panelId} {...panelProps} title="ğŸ” ìƒì„¸ ë¶„ì„">
                                                {renderDetailAnalysisPanel()}
                                            </PanelWrapper>
                                        );
                                    case 'assumptions':
                                        return (
                                            <PanelWrapper key={panelId} {...panelProps} title="ğŸ’¡ ê³„ì‚° ê°€ì •ì‚¬í•­" className="bg-sky-50 dark:bg-gray-900 rounded-lg shadow">
                                                {renderAssumptionsPanel()}
                                            </PanelWrapper>
                                        );
                                    default: return null;
                                }
                            })}
                            {/* [ì¶”ê°€] í•˜ë‹¨ í‘¸í„° (ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨) */}
                            <div className="mt-12 pt-6 border-t dark:border-gray-800 text-center">
                                <button 
                                    onClick={() => setIsPrivacyModalOpen(true)} 
                                    className="text-xs text-gray-500 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 hover:underline transition-colors"
                                >
                                    ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨
                                </button>
                                <span className="mx-2 text-gray-300 dark:text-gray-700">|</span>
                                <span className="text-xs text-gray-400 dark:text-gray-600">Â© 2024 Asset Planner</span>
                            </div>
                        </div>

                        {/* ===== ëª¨ë°”ì¼ ë²„íŠ¼ ===== */}
                        <div className="sm:hidden flex flex-col gap-2">
                            <button onClick={saveToPDF} className="w-full bg-blue-600 text-white py-3 rounded-lg font-medium">
                                ğŸ“„ PDFë¡œ ì €ì¥
                            </button>
                            <button onClick={saveScenario} className="w-full bg-gray-600 text-white py-3 rounded-lg font-medium">
                                ğŸ’¾ ì‹œë‚˜ë¦¬ì˜¤ ì €ì¥
                            </button>
                        </div>
                    </div>
                    {/* ===== ë¸”ë¡œê·¸ ë°°ë„ˆ ===== */}
                    {!isPro && (
                        <a href="https://blog.naver.com/zocdoc" target="_blank" rel="noopener noreferrer" title="ë¸”ë¡œê·¸ ë°©ë¬¸í•˜ê¸°" className="hidden sm:block fixed bottom-5 right-5 z-50 p-3 bg-white dark:bg-gray-800 rounded-full shadow-lg hover:shadow-xl transition-all transform hover:scale-110">
                            <img src="https://blogpfthumb-phinf.pstatic.net/MjAyMzExMDlfMTY2/MDAxNjk5NTM1OTEzNTY2.eBsibH7tHEJ5FeB3gSWJ3hGqz6mbgqM2TsSKS7c2QRog.CNgc4PQL7zumVLSD72sVI_EB6tsPO_Cwd_LKNj0MiyAg.JPEG.whrekrdl/161.jpg/161.jpg?type=w161" alt="ë„¤ì´ë²„ ë¸”ë¡œê·¸" className="w-10 h-10"/>
                        </a>
                    )}
                    {window.DataTransferModal && (
                        <>
                            <window.DataTransferModal 
                                isOpen={isExportModalOpen} 
                                onClose={() => setIsExportModalOpen(false)} 
                                onConfirm={handleExport} 
                                type="export"
                                initialSelection={exportSelection}
                            />
                            <window.DataTransferModal 
                                isOpen={isImportModalOpen} 
                                onClose={() => setIsImportModalOpen(false)} 
                                onConfirm={(selection) => handleImport(selection)} 
                                type="import"
                                initialSelection={importSelection}
                            />
                        </>
                    )}
                    {window.PrivacyPolicyModal && <window.PrivacyPolicyModal isOpen={isPrivacyModalOpen} onClose={() => setIsPrivacyModalOpen(false)} />}
                    {window.SuggestionModal && <window.SuggestionModal isOpen={isSuggestionModalOpen} onClose={() => setIsSuggestionModalOpen(false)} onSubmit={handleSuggestionSubmit} />}
                    {window.ProFeaturesModal && <window.ProFeaturesModal isOpen={isProModalOpen} onClose={() => setIsProModalOpen(false)} />}
                    
                    {calculation.warnings?.length > 0 && (
                        <div className="fixed inset-0 border-[6px] border-red-500 pointer-events-none z-[9999] animate-pulse opacity-60"></div>
                    )}

                    {/* Mobile Floating Quick Panel (Upgrade) */}
                    <button 
                        onClick={() => setIsQuickPanelOpen(true)}
                        className="sm:hidden fixed bottom-8 right-6 z-50 w-14 h-14 bg-white dark:bg-gray-800 text-blue-600 dark:text-blue-400 rounded-full shadow-[0_8px_30px_rgb(0,0,0,0.12)] border border-gray-100 dark:border-gray-700 flex items-center justify-center transition-all active:scale-90"
                        aria-label="Quick Menu"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16m-7 6h7" />
                        </svg>
                    </button>

                    {/* [ìˆ˜ì •] ëª¨ë°”ì¼ í€µ ë©”ë‰´ë¥¼ modals.jsë¡œ ì´ë™ */}
                    {window.MobileQuickMenu && <window.MobileQuickMenu 
                        isOpen={isQuickPanelOpen}
                        onClose={() => setIsQuickPanelOpen(false)}
                        layoutOrder={layoutOrder}
                        scenarios={scenarios}
                        assetHistory={assetHistory}
                        onNavigate={scrollToPanel}
                    />}

                    {window.OnboardingGuide && <window.OnboardingGuide 
                        isOpen={isGuideOpen} 
                        onClose={() => {
                            setIsGuideOpen(false);
                            localStorage.setItem('asset_planner_guide_completed', 'true');
                        }} 
                        scrollToPanel={scrollToPanel}
                        isPro={isPro}
                    />
                    }
                    {window.EncryptionModal && <window.EncryptionModal 
                        isOpen={isEncryptionModalOpen} 
                        onSelect={handleEncryptionSelect} 
                    />}
                    {window.PasswordPromptModal && <window.PasswordPromptModal 
                        isOpen={isPasswordPromptOpen} 
                        onConfirm={handlePasswordConfirm}
                        onCancel={() => setIsPasswordPromptOpen(false)}
                    />}
                    {window.SettingsModal && <window.SettingsModal 
                        isOpen={isSettingsModalOpen} 
                        onClose={() => setIsSettingsModalOpen(false)}
                        encryptionMode={encryptionMode}
                        onModeChange={handleModeChange}
                        darkMode={darkMode}
                        onThemeToggle={handleDarkModeToggle}
                        logoutBehavior={logoutBehavior}
                        onLogoutBehaviorChange={setLogoutBehavior}
                        onSyncNow={() => fetchFromCloud(verifiedEmail, isPro, false, true)}
                        onLogout={handleLogout}
                    />}
                    {/* [ì¶”ê°€] ì €ì¥ ì™„ë£Œ í† ìŠ¤íŠ¸ */}
                    {showSaveToast && (
                        <div className="fixed bottom-24 left-1/2 transform -translate-x-1/2 z-[100] bg-gray-900/90 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 animate-in fade-in slide-in-from-bottom-4 duration-300">
                            <span className="text-green-400 text-xl">âœ“</span>
                            <span className="text-sm font-bold tracking-tight">ë°ì´í„°ê°€ ì•ˆì „í•˜ê²Œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!</span>
                        </div>
                    )}
                    {/* [ì¶”ê°€] í† ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ */}
                    <div className="fixed bottom-5 left-1/2 transform -translate-x-1/2 z-[110] flex flex-col gap-2 pointer-events-none">
                        {window.Toast && toasts.map(toast => (
                            <window.Toast key={toast.id} message={toast.message} type={toast.type} onClose={() => removeToast(toast.id)} />
                        ))}
                    </div>
                    {window.IconPickerModal && <window.IconPickerModal 
                        isOpen={!!iconPickerState} 
                        onClose={() => setIconPickerState(null)} 
                        onSelect={(icon) => { updateAsset(iconPickerState.sector, iconPickerState.index, 'icon', icon); setIconPickerState(null); }}
                        currentIcon={iconPickerState ? assets[iconPickerState.sector][iconPickerState.index].icon : null}
                    />}
                    {window.AIAnalysisModal && <window.AIAnalysisModal 
                        isOpen={isAIModalOpen} 
                        onClose={() => setIsAIModalOpen(false)} 
                        appData={appData} 
                        calculation={calculation} 
                    />}
                    </div>
            );
        };
        const ScenarioCompare = ({ scenarios, sectorInfo, calculateMonthlyProjection, formatNumber }) => {
            const { useState, useMemo } = React;
            const [selectedIds, setSelectedIds] = useState([]);
            const toggle = (id) => setSelectedIds(prev => prev.includes(id) ? prev.filter(x=>x!==id) : (prev.length<3 ? [...prev,id] : prev));

            const selected = scenarios.filter(s => selectedIds.includes(s.id)).slice(0,3);
            
            const computeScenarioProjections = (scenarioData) => {
                // Use the main calculation logic to get monthly projections
                const tempAppData = { ...scenarioData }; // Create a temporary appData for calculation
                const result = calculateMonthlyProjection(tempAppData, scenarioData.projectionMonths || 12);
                return result.projections;
            };

            const results = useMemo(() => {
                return selected.map(s => ({
                    id: s.id,
                    name: s.name,
                    data: s.data,
                    projections: computeScenarioProjections(s.data)
                }));
            }, [selected]);

            // Determine common months for comparison
            const allMonths = results.flatMap(r => r.projections.map(p => p.month));
            const uniqueMonths = [...new Set(allMonths)].sort((a, b) => a - b);

            // Limit to max 12 comparison points, adjust for long periods
            const maxComparisonMonths = 12;
            let comparisonInterval = 1;
            if (uniqueMonths.length > maxComparisonMonths) {
                comparisonInterval = Math.ceil(uniqueMonths.length / maxComparisonMonths);
            }
            const displayMonths = uniqueMonths.filter((_, index) => index % comparisonInterval === 0);
            if (!displayMonths.includes(uniqueMonths[uniqueMonths.length - 1])) {
                displayMonths.push(uniqueMonths[uniqueMonths.length - 1]); // Always include the last month
            }


            const getMonthLabel = (monthIndex, baseMonthStr) => {
                try {
                    const [y,m] = (baseMonthStr || new Date().toISOString().slice(0,7)).split('-').map(Number);
                    const d = new Date(y, m - 1 + monthIndex);
                    return `${String(d.getFullYear()).slice(2)}ë…„ ${String(d.getMonth()+1).padStart(2,'0')}ì›”`;
                } catch { return `ì›” ${monthIndex}`; }
            };

            return (
                <div>
                    <div className="flex flex-wrap gap-2 mb-3">
                        {scenarios.map(s => (
                            <button key={s.id} onClick={() => toggle(s.id)} className={`px-3 py-1 border dark:border-gray-600 rounded ${selectedIds.includes(s.id) ? 'bg-blue-50 dark:bg-blue-900/40 border-blue-400 dark:border-blue-500 dark:text-blue-300' : 'hover:bg-gray-50 dark:hover:bg-gray-700 dark:text-gray-300'}`}>{s.name}</button>
                        ))}
                    </div>
                    {results.length > 0 ? (
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm dark:text-gray-300">
                                <thead className="bg-gray-100 dark:bg-gray-700">
                                    <tr>
                                        <th className="p-3 text-left">ì„¹í„°/í•­ëª©</th>
                                        {results.map(r => (<th key={r.id} className="p-3 text-right">{r.name} (ìµœì¢…)</th>))}
                                        {results.length === 2 && (
                                            <th className="p-3 text-right">ì°¨ì´(ê¸ˆì•¡/ë¹„ì¤‘)</th>
                                        )}
                                    </tr>
                                </thead>
                                <tbody>
                                    {Object.keys(sectorInfo).map(sectorKey => (
                                        <React.Fragment key={sectorKey}>
                                            <tr className="border-t dark:border-gray-700">
                                                <td className="p-3 font-semibold">{sectorInfo[sectorKey].icon} {sectorInfo[sectorKey].name}</td>
                                                {results.map(r => {
                                                    const finalProjection = r.projections[r.projections.length - 1];
                                                    const sectorTotal = finalProjection?.sectorTotals[sectorKey] || { amount: 0, percentage: 0 };
                                                    return (
                                                        <td key={r.id} className="p-3 text-right">
                                                            {formatNumber(sectorTotal.amount)} ({(sectorTotal.percentage || 0).toFixed(1)}%)
                                                        </td>
                                                    );
                                                })}
                                                {results.length === 2 && (
                                                    <td className="p-3 text-right text-indigo-700 dark:text-indigo-400">
                                                        {(() => {
                                                            const finalA = results[0].projections[results[0].projections.length - 1];
                                                            const finalB = results[1].projections[results[1].projections.length - 1];
                                                            const amountA = finalA?.sectorTotals[sectorKey]?.amount || 0;
                                                            const amountB = finalB?.sectorTotals[sectorKey]?.amount || 0;
                                                            const percentA = finalA?.sectorTotals[sectorKey]?.percentage || 0;
                                                            const percentB = finalB?.sectorTotals[sectorKey]?.percentage || 0;
                                                            const diffAmount = amountB - amountA;
                                                            const diffPercent = percentB - percentA;
                                                            const signAmount = diffAmount >= 0 ? '+' : '';
                                                            const signPercent = diffPercent >= 0 ? '+' : '';
                                                            const isGood = sectorKey === 'loan' ? diffAmount <= 0 : diffAmount >= 0;
                                                            const color = isGood ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
                                                            return (
                                                                <div className={color}>
                                                                    <span>{signAmount}{formatNumber(diffAmount)}</span>
                                                                    <span className="text-xs ml-1">({signPercent}{diffPercent.toFixed(1)}%)</span>
                                                                </div>
                                                            );
                                                        })()}
                                                    </td>
                                                )}
                                            </tr>
                                            {(() => {
                                                const allItems = new Map();
                                                results.forEach(r => {
                                                    const finalProjection = r.projections[r.projections.length - 1];
                                                    finalProjection?.itemTotals[sectorKey]?.forEach(item => {
                                                        const key = item.id || item.name;
                                                        if (!allItems.has(key)) {
                                                            allItems.set(key, { name: item.name });
                                                        }
                                                    });
                                                });
                                                return Array.from(allItems.entries());
                                            })().map(([key, { name }]) => (
                                                <tr key={`${sectorKey}-${key}`} className="border-t dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50">
                                                    <td className="p-3 pl-8 text-sm text-gray-600 dark:text-gray-400">â”” {name}</td>
                                                    {results.map(r => {
                                                        const finalProjection = r.projections[r.projections.length - 1]; 
                                                        const items = finalProjection?.itemTotals[sectorKey] || [];
                                                        const itemData = items.find(item => (item.id || item.name) === key) || { amount: 0, percentage: 0 };
                                                        return (
                                                            <td key={r.id} className="p-3 text-right text-sm">
                                                                <div>{formatNumber(itemData.amount)}</div>
                                                            </td>
                                                        );
                                                    })}
                                                    {results.length === 2 && (
                                                        <td className="p-3 text-right text-sm text-indigo-700 dark:text-indigo-400">
                                                            {(() => {
                                                                const finalA = results[0].projections[results[0].projections.length - 1]; 
                                                                const finalB = results[1].projections[results[1].projections.length - 1]; 
                                                                const itemsA = finalA?.itemTotals[sectorKey] || [];
                                                                const itemsB = finalB?.itemTotals[sectorKey] || [];
                                                                const itemA = itemsA.find(item => (item.id || item.name) === key) || { amount: 0, percentage: 0 };
                                                                const itemB = itemsB.find(item => (item.id || item.name) === key) || { amount: 0, percentage: 0 };

                                                                const diffAmount = itemB.amount - itemA.amount;
                                                                const signAmount = diffAmount >= 0 ? '+' : '';
                                                                const isGood = sectorKey === 'loan' ? diffAmount <= 0 : diffAmount >= 0;
                                                                const color = isGood ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
                                                                return (
                                                                    <div className={color}>
                                                                        <div>{signAmount}{formatNumber(diffAmount)}</div>
                                                                    </div>
                                                                );
                                                            })()}
                                                        </td>
                                                    )}
                                                </tr>
                                            ))
                                            }
                                        </React.Fragment>
                                    ))}
                                    <tr className="border-t-2 border-gray-400 dark:border-gray-600 bg-gray-100 dark:bg-gray-700">
                                        <td className="p-3 font-bold">ì´ê³„</td>
                                        {results.map(r => {
                                            const finalProjection = r.projections[r.projections.length - 1];
                                            return (
                                                <td key={r.id} className="p-3 text-right font-bold">{formatNumber(finalProjection?.total || 0)}</td>
                                            );
                                        })}
                                        {results.length === 2 && (
                                            <td className="p-3 text-right font-bold text-indigo-700 dark:text-indigo-400">
                                                {(() => { 
                                                    const finalA = results[0].projections[results[0].projections.length - 1];
                                                    const finalB = results[1].projections[results[1].projections.length - 1];
                                                    const diff = (finalB?.total || 0) - (finalA?.total || 0); 
                                                    const sign = diff >= 0 ? '+' : '';
                                                    const color = diff >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
                                                    return (
                                                        <div className={color}>{sign}{formatNumber(diff)}</div>
                                                    );
                                                })()}
                                            </td>
                                        )}
                                    </tr>
                                </tbody>
                            </table>

                            {/* Monthly Comparison Table */}
                            <h4 className="text-lg font-semibold text-gray-700 dark:text-gray-300 mt-8 mb-4">ì›”ë³„ ë¹„êµ (ìµœëŒ€ 12ê°œì›”)</h4>
                            <table className="w-full text-sm dark:text-gray-300">
                                <thead className="bg-gray-100 dark:bg-gray-700">
                                    <tr>
                                        <th className="p-3 text-left">ì›”ì°¨</th>
                                        {results.map(r => (<th key={r.id} className="p-3 text-right">{r.name} (ì´ìì‚°)</th>))}
                                        {results.length === 2 && (
                                            <th className="p-3 text-right">ì°¨ì´</th>
                                        )}
                                    </tr>
                                </thead>
                                <tbody>
                                    {displayMonths.map(monthIndex => {
                                        const monthLabel = getMonthLabel(monthIndex, results[0]?.data.baseMonth);
                                        return (
                                            <tr key={monthIndex} className="border-t dark:border-gray-700">
                                                <td className="p-3 font-semibold">{monthLabel}</td>
                                                {results.map(r => {
                                                    const projection = r.projections.find(p => p.month === monthIndex);
                                                    return (
                                                        <td key={r.id} className="p-3 text-right">
                                                            {projection ? formatNumber(projection.total) : '-'}
                                                        </td>
                                                    );
                                                })}
                                                {results.length === 2 && (
                                                    <td className="p-3 text-right text-indigo-700 dark:text-indigo-400">
                                                        {(() => {
                                                            const projA = results[0].projections.find(p => p.month === monthIndex);
                                                            const projB = results[1].projections.find(p => p.month === monthIndex);
                                                            if (projA && projB) {
                                                                const diff = projB.total - projA.total;
                                                                const sign = diff >= 0 ? '+' : '';
                                                                return `${sign}${formatNumber(diff)}`;
                                                            }
                                                            return '-';
                                                        })()}
                                                    </td>
                                                )}
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    ) : (
                        <div className="text-sm text-gray-500">ë¹„êµí•  ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ìµœëŒ€ 3ê°œ ì„ íƒí•˜ì„¸ìš”.</div>
                    )}
                </div>
            );
        };
        
        // [ì¶”ê°€] ê³„ì‚°ê¸° ê¸°ëŠ¥ì´ í¬í•¨ëœ ì…ë ¥ ì»´í¬ë„ŒíŠ¸
        const CalculatorInput = ({ value, onChange, className, placeholder, style, ...props }) => {
            const [localValue, setLocalValue] = useState(value);
            const [isEditing, setIsEditing] = useState(false);

            useEffect(() => {
                if (!isEditing) {
                    setLocalValue(value);
                }
            }, [value, isEditing]);

            const safeEvaluate = (str) => {
                try {
                    // ìˆ«ì, ì—°ì‚°ì(+, -, *, /), ê´„í˜¸, ì†Œìˆ˜ì , ê³µë°±ë§Œ í—ˆìš©
                    if (/[^0-9+\-*/.()\s]/.test(str)) return null;
                    // Function ìƒì„±ìë¥¼ ì‚¬ìš©í•˜ì—¬ ì•ˆì „í•˜ê²Œ ê³„ì‚°
                    // eslint-disable-next-line no-new-func
                    const result = new Function('return ' + str)();
                    return isFinite(result) ? result : null;
                } catch (e) {
                    return null;
                }
            };

            const handleBlur = () => {
                setIsEditing(false);
                const strVal = String(localValue).trim();
                
                if (/[\+\-\*\/]/.test(strVal)) {
                    const result = safeEvaluate(strVal);
                    if (result !== null) {
                        const finalVal = Math.round(result * 100) / 100; // ì†Œìˆ˜ì  2ìë¦¬ ë°˜ì˜¬ë¦¼
                        onChange({ target: { value: finalVal } });
                        setLocalValue(finalVal);
                    } else {
                        setLocalValue(value); // ê³„ì‚° ì‹¤íŒ¨ ì‹œ ì›ë˜ ê°’ ë³µêµ¬
                    }
                } else {
                    onChange({ target: { value: strVal } });
                }
            };

            return (
                <input
                    type={isEditing ? "text" : "number"}
                    value={localValue}
                    onChange={(e) => setLocalValue(e.target.value)}
                    onBlur={handleBlur}
                    onFocus={() => setIsEditing(true)}
                    onKeyDown={(e) => e.key === 'Enter' && e.target.blur()}
                    className={className}
                    placeholder={placeholder}
                    style={style}
                    step="any"
                    {...props}
                />
            );
        };

        // [ìµœì í™”] ìì‚° ì…ë ¥ í–‰ ì»´í¬ë„ŒíŠ¸ ë¶„ë¦¬ ë° React.memo ì ìš©
        // ê°œë³„ í•­ëª© ìˆ˜ì • ì‹œ ë‹¤ë¥¸ í•­ëª©ë“¤ì˜ ë¶ˆí•„ìš”í•œ ë¦¬ë Œë”ë§ ë°©ì§€
        const AssetRow = React.memo(({ 
            sectorKey, 
            index, 
            asset, 
            updateAsset, 
            removeAsset, 
            accountOptions, 
            sectorInfo,
            sectorTotal,
            rgb,
            itemRec
        }) => {
            const assetPercentage = (Number(asset.amount || 0) / sectorTotal) * 100;
            const amountBgStyle = { backgroundImage: `linear-gradient(to right, rgba(${rgb}, 0.15) ${assetPercentage}%, transparent ${assetPercentage}%)` };

            return (
                <div className="bg-white dark:bg-gray-900 rounded-lg p-4 shadow-sm hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors flex items-center gap-3" role="group" aria-label={`${asset.name} ì…ë ¥ í–‰`}>
                    <div className="flex-1">
                    {sectorKey !== 'loan' ? (
                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-7 gap-3 items-center">
                            <input type="text" placeholder="í•­ëª©ëª…" aria-label="í•­ëª©ëª…" className="border rounded px-2 py-1 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={asset.name} onChange={(e) => updateAsset(sectorKey, index, 'name', e.target.value)} />
                            <div>
                                <label className="block text-xs text-gray-500 dark:text-gray-200 sm:hidden">í˜„ì¬ê¸ˆì•¡</label>
                                <CalculatorInput aria-label="í˜„ì¬ê¸ˆì•¡" style={amountBgStyle} className="w-full border rounded px-2 py-1 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={asset.amount} onChange={(e) => updateAsset(sectorKey, index, 'amount', e.target.value)} />
                            </div>
                            <div>
                                <label className="block text-xs text-gray-500 dark:text-gray-200 sm:hidden">ìˆ˜ìµë¥ (%)</label>
                                <input type="number" step="0.1" aria-label="ìˆ˜ìµë¥ " className="w-full border rounded px-2 py-1 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={asset.rate} onChange={(e) => updateAsset(sectorKey, index, 'rate', e.target.value)} />
                            </div>
                            <div>
                                <label className="block text-xs text-gray-500 dark:text-gray-200 sm:hidden">ìˆ˜ìˆ˜ë£Œ/ì„¸ê¸ˆ(%)</label>
                                <input type="number" step="0.001" aria-label="ìˆ˜ìˆ˜ë£Œ ë° ì„¸ê¸ˆ" className="w-full border rounded px-2 py-1 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={asset.feeRate ?? 0} onChange={(e) => updateAsset(sectorKey, index, 'feeRate', e.target.value)} />
                            </div>
                            <div>
                                <label className="block text-xs text-gray-500 dark:text-gray-200 sm:hidden">ì›”ë‚©ì…</label>
                                <div className="relative">
                                    <CalculatorInput aria-label="ì›”ë‚©ì…ì•¡" className="w-full border rounded px-2 py-1 pr-16 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={asset.monthlyContrib} onChange={(e) => updateAsset(sectorKey, index, 'monthlyContrib', e.target.value)} />
                                    {itemRec > 0 && (
                                        <span className="absolute right-2 top-1/2 -translate-y-1/2 text-[10px] text-blue-500 dark:text-blue-400 pointer-events-none font-medium">
                                            ê¶Œì¥ ë‚©ì…: {Math.round(itemRec).toLocaleString()}
                                        </span>
                                    )}
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs text-gray-500 dark:text-gray-200 sm:hidden">ì›”ìˆ˜ì…ì™¸ ë‚©ì…</label>
                                <div className="flex gap-1">
                                    <input type="number" min="0" aria-label="ì›”ìˆ˜ì…ì™¸ ì¶”ê°€ ë‚©ì…ì•¡" className="w-full border rounded px-2 py-1 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={asset.extraContrib} onChange={(e) => updateAsset(sectorKey, index, 'extraContrib', e.target.value)} />
                                    {asset.extraContrib > 0 && (
                                        <select aria-label="ì¶”ê°€ ë‚©ì… ì¶œì²˜ ê³„ì¢Œ" className="w-24 border rounded px-1 py-1 text-[10px] bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={asset.extraFrom} onChange={(e) => updateAsset(sectorKey, index, 'extraFrom', e.target.value)}>
                                            {accountOptions.filter(name => name !== asset.name).map((name, i) => (
                                                <option key={i} value={name}>{name}</option>
                                            ))}
                                        </select>
                                    )}
                                </div>
                            </div>
                            <button onClick={() => removeAsset(sectorKey, index)} aria-label={`${asset.name} ì‚­ì œ`} className="text-red-500 hover:text-red-700 whitespace-nowrap">ì‚­ì œ</button>
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-8 gap-3 items-center">
                            <input type="text" placeholder="í•­ëª©ëª…" aria-label="ëŒ€ì¶œëª…" className="border rounded px-2 py-1 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={asset.name} onChange={(e) => updateAsset(sectorKey, index, 'name', e.target.value)} />
                            <div>
                                <label className="block text-xs text-gray-500 dark:text-gray-200 sm:hidden">í˜„ì¬ì”ì•¡</label>
                                <CalculatorInput aria-label="ëŒ€ì¶œ ì”ì•¡" style={amountBgStyle} className="w-full border rounded px-2 py-1 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={asset.amount} onChange={(e) => updateAsset(sectorKey, index, 'amount', e.target.value)} />
                            </div>
                            <div>
                                <label className="block text-xs text-gray-500 dark:text-gray-200 sm:hidden">ì´ììœ¨(%)</label>
                                <input type="number" step="0.1" aria-label="ëŒ€ì¶œ ì´ììœ¨" className="w-full border rounded px-2 py-1 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={asset.rate} onChange={(e) => updateAsset(sectorKey, index, 'rate', e.target.value)} />
                            </div>
                            <div>
                                <label className="block text-xs text-gray-500 dark:text-gray-200 sm:hidden">ì›” ìƒí™˜ì•¡</label>
                                <CalculatorInput aria-label="ì›” ìƒí™˜ì•¡" placeholder="0ì´ë©´ ìë™ê³„ì‚°" className="w-full border rounded px-2 py-1 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={asset.monthlyContrib} onChange={(e) => updateAsset(sectorKey, index, 'monthlyContrib', e.target.value)} />
                            </div>
                            <div>
                                <label className="block text-xs text-gray-500 dark:text-gray-200 sm:hidden">ë§Œê¸°(ê°œì›”)</label>
                                <input type="number" aria-label="ëŒ€ì¶œ ë§Œê¸° ê°œì›” ìˆ˜" className="w-full border rounded px-2 py-1 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={asset.maturityMonth ?? 12} onChange={(e) => updateAsset(sectorKey, index, 'maturityMonth', e.target.value)} />
                            </div>
                            <div>
                                <label className="block text-xs text-gray-500 dark:text-gray-200 sm:hidden">ìƒí™˜ ë°©ì‹</label>
                                <select aria-label="ìƒí™˜ ë°©ì‹" className="w-full border rounded px-2 py-1 text-xs bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={asset.repaymentMethod || 'ì›ë¦¬ê¸ˆê· ë“±'} onChange={(e) => updateAsset(sectorKey, index, 'repaymentMethod', e.target.value)}>
                                    <option value="ì›ë¦¬ê¸ˆê· ë“±">ì›ë¦¬ê¸ˆê· ë“±</option>
                                    <option value="ì›ê¸ˆê· ë“±">ì›ê¸ˆê· ë“±</option>
                                    <option value="ë§Œê¸°ì¼ì‹œ">ë§Œê¸°ì¼ì‹œ</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-xs text-gray-500 dark:text-gray-200 sm:hidden">ìƒí™˜ ê³„ì¢Œ</label>
                                <select aria-label="ìƒí™˜ ì¶œê¸ˆ ê³„ì¢Œ" className="w-full border rounded px-2 py-1 text-xs bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={asset.repaymentAccount} onChange={(e) => updateAsset(sectorKey, index, 'repaymentAccount', e.target.value)}>
                                    {accountOptions.filter(name => name !== asset.name).map((name, i) => (
                                        <option key={i} value={name}>{name}</option>
                                    ))}
                                </select>
                            </div>
                            <button onClick={() => removeAsset(sectorKey, index)} aria-label={`${asset.name} ì‚­ì œ`} className="text-red-500 hover:text-red-700 whitespace-nowrap">ì‚­ì œ</button>
                        </div>
                    )}
                    </div>
                </div>
            );
        });

        // [ìˆ˜ì •] modals.jsë¡œ ì´ë™ëœ ErrorBoundary ì‚¬ìš©
        const ErrorBoundary = window.ErrorBoundary || React.Fragment;

        ReactDOM.createRoot(document.getElementById('root')).render(
            <ErrorBoundary>
                <AssetDashboard />
            </ErrorBoundary>
        );
    </script>
</body>
</html>