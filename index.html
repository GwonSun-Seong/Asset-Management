<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í†µí•© ìì‚° ë¶„ì„ ëŒ€ì‹œë³´ë“œ</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        deposit: { 50: '#eff6ff', 500: '#3b82f6', 600: '#2563eb' },
                        savings: { 50: '#f0fdf4', 500: '#22c55e', 600: '#16a34a' },
                        investment: { 50: '#fff7ed', 500: '#f97316', 600: '#ea580c' },
                        pension: { 50: '#faf5ff', 500: '#a855f7', 600: '#9333ea' },
                        realestate: { 50: '#fef7f0', 500: '#f59e0b', 600: '#d97706' },
                        car: { 50: '#ecfeff', 500: '#06b6d4', 600: '#0891b2' },
                        loan: { 50: '#f3f4f6', 500: '#6b7280', 600: '#4b5563' },
                        misc: { 50: '#f3f4f6', 500: '#6b7280', 600: '#4b5563' }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script>
        // ===== ê¸°ë³¸ê°’ ì„¤ì • (ì„œë²„/ë¡œì»¬ ì „í™˜ ê°€ëŠ¥) =====
        const USE_SERVER_CONFIG = false; // true: ì„œë²„ì—ì„œ ë¡œë“œ, false: ë¡œì»¬ í•˜ë“œì½”ë”© ì‚¬ìš©

        // ê³µê°œìš© ê¸°ë³¸ê°’ (ì œ3ì ê³µê°œ ì‹œ ì‚¬ìš©)
        const publicDefaultData = {
            projectionMonths: 12,
          monthlySalary: 280,
            targetAmount: 10000, // ëª©í‘œ ìì‚° ê¸ˆì•¡ (ë§Œì›)
            goalMode: 'period', // 'period' ë˜ëŠ” 'target'
            darkMode: false, // [ì¶”ê°€] ë‹¤í¬ ëª¨ë“œ ìƒíƒœ
            rebalancingMode: 'simple', // 'simple' | 'advanced'
            assets: {
                deposit: [
                    { name: 'ë¹„ìƒê¸ˆí†µì¥', amount: 100, rate: 2.0, feeRate: 0, monthlyContrib: 10, extraContrib: 0, extraFrom: '' },
                    { name: 'ìƒí™œë¹„í†µì¥', amount: 30, rate: 2.0, feeRate: 0, monthlyContrib: 0, extraContrib: 0, extraFrom: '' },
                    { name: 'ì¹´ì¹´ì˜¤ë¹„ìƒê¸ˆ', amount: 30, rate: 2.0, feeRate: 0, monthlyContrib: 0, extraContrib: 0, extraFrom: '' }
                ],
                savings: [
                    { name: 'ì²­ë…„ë„ì•½ê³„ì¢Œ', amount: 140, rate: 6.0, feeRate: 0, monthlyContrib: 0, extraContrib: 70, extraFrom: 'ë¹„ìƒê¸ˆí†µì¥' },
                    { name: 'ì²­ì•½ì €ì¶•', amount: 180, rate: 6.0, feeRate: 0, monthlyContrib: 10, extraContrib: 0, extraFrom: '' }
                ],
                investment: [
                    { name: 'ì§ì ‘íˆ¬ìê³„ì¢Œ', amount: 1400, rate: 10.0, feeRate: 0, monthlyContrib: 0, extraContrib: 0, extraFrom: '' },
                    { name: 'ISAê³„ì¢Œ', amount: 500, rate: 10.0, feeRate: 0, monthlyContrib: 100, extraContrib: 0, extraFrom: '' },
                    { name: 'ê¸ˆíˆ¬ì', amount: 0, rate: 3.0, feeRate: 0, monthlyContrib: 30, extraContrib: 0, extraFrom: '' },
                    { name: 'ë¹„íŠ¸ì½”ì¸', amount: 0, rate: 12.0, feeRate: 0, monthlyContrib: 15, extraContrib: 0, extraFrom: '' }
                ],
                pension: [
                    { name: 'ì—°ê¸ˆì €ì¶•', amount: 199, rate: 10.0, feeRate: 0, monthlyContrib: 10, extraContrib: 0, extraFrom: '' }
                ],
                realestate: [
                    { name: 'ì•„íŒŒíŠ¸', amount: 0, rate: 5.0, feeRate: 0, monthlyContrib: 0, extraContrib: 0, extraFrom: '' }
                ],
                car: [
                    { name: 'ìë™ì°¨', amount: 70, rate: -2.0, feeRate: 0, monthlyContrib: 0, extraContrib: 0, extraFrom: '' }
                ],
                loan: [
                    { name: 'ì‹ ìš©ëŒ€ì¶œ', amount: 0, rate: 3.0, feeRate: 0, monthlyContrib: 0, extraContrib: 0, extraFrom: '' }
                ],
                misc: [
                    { name: 'ê¸°íƒ€ìì‚°', amount: 0, rate: 2.0, feeRate: 0, monthlyContrib: 0, extraContrib: 0, extraFrom: '' }
                ]
            },
            monthlyExpenses: [
                { name: 'ìƒí™œë¹„', amount: 100 }
            ],
            expenseEvents: [],
            rebalancingAlerts: {
                deposit: { warning: 5, danger: 10 },
                savings: { warning: 5, danger: 10 },
                investment: { warning: 5, danger: 10 },
                pension: { warning: 5, danger: 10 },
                realestate: { warning: 5, danger: 10 },
                misc: { warning: 5, danger: 10 }
            },
            simpleThresholds: { warning: 5, danger: 10 },
            rebalancingTargets: { /* ì„¹í„°ë³„ ëª©í‘œ ë¹„ì¤‘(%) í•©ê³„ 100 */ }
        };

        
        // ì„œë²„ ì„¤ì • ë¡œë“œ í•¨ìˆ˜ (ì£¼ì„ ì²˜ë¦¬/í•´ì œë¡œ ì „í™˜)
        async function loadServerConfig() {
            if (!USE_SERVER_CONFIG) return publicDefaultData;
            
            try {
                // const response = await fetch('/api/defaultconfig');
                // return await response.json();
                return publicDefaultData; // ì„œë²„ ì—°ê²° ì‹¤íŒ¨ì‹œ ê¸°ë³¸ê°’ ì‚¬ìš©
            } catch (error) {
                console.error('ì„œë²„ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', error);
                return publicDefaultData;
            }
        }
    </script>

    <script type="text/babel">
            const { useState, useMemo, useEffect, useRef } = React;


        // TO-BE (const AssetDashboard... ì´ì „ì— ì¶”ê°€)
        // [ì¶”ê°€] ë¦¬ë°¸ëŸ°ì‹± ì‹œê°í™”ë¥¼ ìœ„í•œ ëˆ„ì  ë§‰ëŒ€ ê·¸ë˜í”„ ì»´í¬ë„ŒíŠ¸
        const StackedBarDisplay = ({ targets, sectorInfo }) => {
            const validSectors = Object.keys(sectorInfo).filter(k => k !== 'loan');
            const defaultPct = Math.round(100 / validSectors.length);
            
            const total = validSectors.reduce((sum, key) => {
                return sum + (targets[key] ?? defaultPct);
            }, 0);

            // 100% ê¸°ì¤€ìœ¼ë¡œ ë¹„ìœ¨ ì¬ê³„ì‚° (ì •ê·œí™”)
            const normalizedTargets = validSectors.map(key => {
                const value = targets[key] ?? defaultPct;
                return {
                    key: key,
                    name: sectorInfo[key].name,
                    color: sectorInfo[key].color,
                    percentage: total === 0 ? 0 : (value / total) * 100,
                    originalValue: value
                };
            });

            return (
                <div className="w-full mb-4">
                    <div className="flex h-6 w-full rounded-full overflow-hidden border border-gray-300 dark:border-gray-600 bg-gray-200 dark:bg-gray-700">
                        {normalizedTargets.map(item => (
                            <div
                                key={item.key}
                                className={`flex items-center justify-center bg-${item.color}-500 transition-all duration-300`}
                                style={{ width: `${item.percentage}%` }}
                                title={`${item.name}: ${item.originalValue}%`}
                            >
                                <span className="text-xs font-medium text-white overflow-hidden whitespace-nowrap px-1">
                                    {item.percentage > 10 ? `${item.originalValue}%` : ''}
                                </span>
                            </div>
                        ))}
                    </div>
                    {total !== 100 && (
                        <div className="text-right text-xs text-red-600 dark:text-red-400 mt-1">
                            ì´í•©ì´ {total}%ì…ë‹ˆë‹¤. 100%ë¡œ ì¡°ì •í•´ì£¼ì„¸ìš”.
                        </div>
                    )}
                </div>
            );
        };

        const AssetDashboard = () => {
            // ===== ëª¨ë“  ìƒíƒœë¥¼ ë¨¼ì € ì„ ì–¸ =====
            const [appData, setAppData] = useState(null);
            const [scenarios, setScenarios] = useState([]);
            const [goalSeekResult, setGoalSeekResult] = useState(null);
            const [autoDepositAccount, setAutoDepositAccount] = useState('ìƒí™œë¹„í†µì¥');
            // ì°¨íŠ¸ refë“¤
            const currentPieRef = useRef(null);
            const projectedPieRef = useRef(null);
            const comparisonBarRef = useRef(null);
            const historyChartRef = useRef(null);
            // ì„¹í„° ì ‘í˜ ìƒíƒœëŠ” í•­ìƒ ìƒë‹¨ì—ì„œ ì„ ì–¸í•˜ì—¬ í›… ìˆœì„œ ê³ ì •
            const [hiddenSectors, setHiddenSectors] = useState(() => {
                try {
                    const raw = localStorage.getItem('assetDashboardHiddenSectors');
                    return raw ? JSON.parse(raw) : {};
                } catch { return {}; }
            });
            useEffect(()=>{
                try {
                    localStorage.setItem('assetDashboardHiddenSectors', JSON.stringify(hiddenSectors));
                } catch {}
            }, [hiddenSectors]);
            
            // ===== ì´ˆê¸° ë°ì´í„° ë¡œë“œ =====
            useEffect(() => {
                const loadInitialData = async () => {
                const serverData = await loadServerConfig();
                const baseData = publicDefaultData; // <-- ì´ë ‡ê²Œ ìˆ˜ì •
                try {
                const savedData = localStorage.getItem('assetDashboardDataV3');
                const savedScenarios = localStorage.getItem('assetDashboardScenarios');

                // [ìˆ˜ì •] ì•„ë˜ ifë¬¸ ì¶”ê°€
                if (savedScenarios) {
                    setScenarios(JSON.parse(savedScenarios));
                }

                if (savedData) {
                            const parsedData = JSON.parse(savedData);
                            // ìƒˆë¡œìš´ í•„ë“œë“¤ ì¶”ê°€
                            if (!parsedData.targetAmount) parsedData.targetAmount = baseData.targetAmount;
                            if (!parsedData.goalMode) parsedData.goalMode = baseData.goalMode;
                            if (!parsedData.assets.realestate) parsedData.assets.realestate = baseData.assets.realestate;
                            if (!parsedData.assets.misc) parsedData.assets.misc = baseData.assets.misc;
                            if (!parsedData.rebalancingAlerts) parsedData.rebalancingAlerts = baseData.rebalancingAlerts;
                            // ë§ˆì´ê·¸ë ˆì´ì…˜: ìì‚°ë³„ ìˆ˜ìˆ˜ë£Œ/ì„¸ê¸ˆ í•„ë“œ ê¸°ë³¸ê°’(0)
                            Object.keys(parsedData.assets||{}).forEach(sector=>{
                                (parsedData.assets[sector]||[]).forEach(a=>{ if (a.feeRate === undefined) a.feeRate = 0; });
                            });
                            setAppData(parsedData);
                        } else {
                            setAppData(baseData);
                        }
                        
                    } catch (error) {
                        console.error("ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:", error);
                        setAppData(baseData);
                    }
                };
                
                loadInitialData();
            }, []);

            // ===== ë°ì´í„° ìë™ ì €ì¥ =====
            useEffect(() => {
            if (appData) {
                localStorage.setItem('assetDashboardDataV3', JSON.stringify(appData));
            }
            }, [appData]);

            // useRefë¥¼ ì‚¬ìš©í•˜ì—¬ ì²« ë Œë”ë§ì¸ì§€ ì¶”ì í•˜ëŠ” ë³€ìˆ˜ ì¶”ê°€
            const isInitialMount = useRef(true);

            useEffect(() => {
                // ì²« ë Œë”ë§ì¼ ê²½ìš°, ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•Šê³  ìŠ¤ìœ„ì¹˜ë§Œ falseë¡œ ë³€ê²½
                if (isInitialMount.current) {
                    isInitialMount.current = false;
                } else {
                    // ì²« ë Œë”ë§ì´ ì•„ë‹ ë•Œë§Œ localStorageì— ì €ì¥
                    localStorage.setItem('assetDashboardScenarios', JSON.stringify(scenarios));
                }
            }, [scenarios]);

            // ===== ìì‚° íˆìŠ¤í† ë¦¬ ê´€ë¦¬ =====
            const [assetHistory, setAssetHistory] = React.useState([]);
            
            // íˆìŠ¤í† ë¦¬ ë°ì´í„° ë¡œë“œ
            React.useEffect(() => {
                try {
                    const savedHistory = localStorage.getItem('assetDashboardHistory');
                    if (savedHistory) {
                        setAssetHistory(JSON.parse(savedHistory));
                    }
                } catch (error) {
                    console.error('íˆìŠ¤í† ë¦¬ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                }
            }, []);

            // íˆìŠ¤í† ë¦¬ ë°ì´í„° ì €ì¥
            React.useEffect(() => {
                if (assetHistory.length > 0) {
                    localStorage.setItem('assetDashboardHistory', JSON.stringify(assetHistory));
                }
            }, [assetHistory]);

            // í˜„ì¬ ìì‚° ì €ì¥ í•¨ìˆ˜
            const saveCurrentAsset = () => {
                try {
                    const now = new Date();
                    const currentDate = now.toISOString().split('T')[0]; // YYYY-MM-DD
                    const currentTime = now.toTimeString().split(' ')[0]; // HH:MM:SS
                    const netWorth = calculation?.grand || 0;
                    
                    setAssetHistory(prev => {
                        const newHistory = [...prev];
                        const existingIndex = newHistory.findIndex(item => item.date === currentDate);
                        
                        if (existingIndex >= 0) {
                            // ê°™ì€ ë‚ ì§œê°€ ìˆìœ¼ë©´ ì‹œê°„ ì •ë³´ì™€ í•¨ê»˜ ì—…ë°ì´íŠ¸ (ë§ˆì§€ë§‰ ì‹œê°„ëŒ€ë§Œ ìœ ì§€)
                            newHistory[existingIndex] = { 
                                date: currentDate, 
                                time: currentTime,
                                netWorth,
                                timestamp: now.getTime()
                            };
                        } else {
                            // ìƒˆë¡œìš´ ë‚ ì§œë©´ ì¶”ê°€
                            newHistory.push({ 
                                date: currentDate, 
                                time: currentTime,
                                netWorth,
                                timestamp: now.getTime()
                            });
                        }
                        
                        // íƒ€ì„ìŠ¤íƒ¬í”„ìˆœìœ¼ë¡œ ì •ë ¬ (ìµœì‹ ì´ ë§ˆì§€ë§‰)
                        return newHistory.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
                    });
                    
                    alert(`í˜„ì¬ ìˆœìì‚° ${formatNumber(netWorth)}ë§Œì›ì´ íˆìŠ¤í† ë¦¬ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\n(${currentDate} ${currentTime})`);
                } catch (error) {
                    console.error('ìì‚° ì €ì¥ ì˜¤ë¥˜:', error);
                    alert('ìì‚° ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            };

            // ===== ë°ì´í„° ì´ì‚¿ì§ì‹¸ê¸° ê¸°ëŠ¥ =====
            const exportAssetData = () => {
                try {
                    const exportData = {
                        appData: appData,
                        scenarios: scenarios,
                        assetHistory: assetHistory,
                        exportDate: new Date().toISOString(),
                        version: '1.0'
                    };
                    
                    const jsonString = JSON.stringify(exportData);
                    const compressedDataArray = pako.deflate(jsonString);
                    const binaryString = String.fromCharCode.apply(null, compressedDataArray);
                    const compressed = btoa(binaryString);
                    
                    // í´ë¦½ë³´ë“œì— ë³µì‚¬
                    navigator.clipboard.writeText(compressed).then(() => {
                        alert('ìì‚° ë°ì´í„°ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\në‹¤ë¥¸ ê¸°ê¸°ì—ì„œ "ìì‚° ë¶ˆëŸ¬ì˜¤ê¸°" ë²„íŠ¼ì„ ëˆŒëŸ¬ ë¶™ì—¬ë„£ê¸°í•˜ì„¸ìš”.');
                    }).catch(() => {
                        // í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨ ì‹œ í…ìŠ¤íŠ¸ ì˜ì—­ìœ¼ë¡œ í‘œì‹œ
                        const textArea = document.createElement('textarea');
                        textArea.value = compressed;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        alert('ìì‚° ë°ì´í„°ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\në‹¤ë¥¸ ê¸°ê¸°ì—ì„œ "ìì‚° ë¶ˆëŸ¬ì˜¤ê¸°" ë²„íŠ¼ì„ ëˆŒëŸ¬ ë¶™ì—¬ë„£ê¸°í•˜ì„¸ìš”.');
                    });
                } catch (error) {
                    console.error('ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜:', error);
                    alert('ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            };

            const importAssetData = () => {
            const compressedData = prompt('ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ë³µì‚¬í•œ ì•”í˜¸ë¬¸ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”:');
            if (!compressedData) return;
            
            try {
                // [ìˆ˜ì •] Base64 ë””ì½”ë”© (ì´ì§„ ë¬¸ìì—´ ë°˜í™˜)
                const binaryString = atob(compressedData);
                
                // [ìˆ˜ì •] ì´ì§„ ë¬¸ìì—´ì„ Uint8Arrayë¡œ ë³€í™˜
                const compressedDataArray = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    compressedDataArray[i] = binaryString.charCodeAt(i);
                }
                
                // [ìˆ˜ì •] pako.inflateë¡œ ì••ì¶• í•´ì œ (UTF-8 ë¬¸ìì—´ë¡œ)
                const jsonString = pako.inflate(compressedDataArray, { to: 'string' });
                const importData = JSON.parse(jsonString);
                
                if (!importData.appData || !importData.version) {
                    throw new Error('ì˜ëª»ëœ ë°ì´í„° í˜•ì‹ì…ë‹ˆë‹¤.');
                }
                    
                    if (confirm('í˜„ì¬ ë°ì´í„°ë¥¼ ëª¨ë‘ ë®ì–´ì“°ê³  ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        setAppData(importData.appData);
                        setScenarios(importData.scenarios || []);
                        setAssetHistory(importData.assetHistory || []);
                        alert('ìì‚° ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™€ì¡ŒìŠµë‹ˆë‹¤!');
                    }
                } catch (error) {
                    console.error('ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error);
                    alert('ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nì•”í˜¸ë¬¸ì„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.');
                }
            };

            // ===== ê¸°ë³¸ê°’ ì„¤ì • (appDataê°€ ì—†ì„ ë•Œë„ ì•ˆì „í•˜ê²Œ) =====
            const {
                projectionMonths = 12, monthlySalary = 280, assets = {}, monthlyExpenses = [], 
                incomeEvents = [], expenseEvents = [], targetAmount = 10000, 
                goalMode = 'period', rebalancingAlerts = {}, baseMonth = new Date().toISOString().slice(0,7),
                rebalancingMode = 'simple', simpleThresholds = { warning: 5, danger: 10 }, rebalancingTargets = {}
            } = appData || {};
            const applyTax = false;
            // ===== Setter í•¨ìˆ˜ë“¤ =====
            const setProjectionMonths = (value) => setAppData(prev => ({ ...prev, projectionMonths: value }));
            const setMonthlySalary = (value) => setAppData(prev => ({ ...prev, monthlySalary: value }));
            const setAssets = (value) => setAppData(prev => ({ ...prev, assets: typeof value === 'function' ? value(prev.assets) : value }));
            const setMonthlyExpenses = (value) => setAppData(prev => ({ 
                ...prev, 
                monthlyExpenses: typeof value === 'function' ? value(Array.isArray(prev.monthlyExpenses) ? prev.monthlyExpenses : []) : value 
            }));
            const setIncomeEvents = (value) => setAppData(prev => ({ 
                ...prev, 
                incomeEvents: typeof value === 'function' ? value(Array.isArray(prev.incomeEvents) ? prev.incomeEvents : []) : value 
            }));
            const setExpenseEvents = (value) => setAppData(prev => ({ 
                ...prev, 
                expenseEvents: typeof value === 'function' ? value(Array.isArray(prev.expenseEvents) ? prev.expenseEvents : []) : value 
            }));
            
            const setTargetAmount = (value) => setAppData(prev => ({ ...prev, targetAmount: value }));
            const setGoalMode = (value) => setAppData(prev => ({ ...prev, goalMode: value }));
            const setRebalancingAlerts = (value) => setAppData(prev => ({ ...prev, rebalancingAlerts: typeof value === 'function' ? value(prev.rebalancingAlerts) : value }));
            const setBaseMonth = (value) => setAppData(prev => ({ ...prev, baseMonth: value }));
            const setRebalancingMode = (value) => setAppData(prev => ({ ...prev, rebalancingMode: value }));
            const setSimpleThresholds = (value) => setAppData(prev => ({ ...prev, simpleThresholds: typeof value === 'function' ? value(prev.simpleThresholds) : value }));
            const setRebalancingTargets = (value) => setAppData(prev => ({ ...prev, rebalancingTargets: typeof value === 'function' ? value(prev.rebalancingTargets) : value }));



            const saveAsDefault = () => {
                if (confirm('í˜„ì¬ ì„¤ì •ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    localStorage.setItem('assetDashboardCustomDefault', JSON.stringify(appData));
                    alert('í˜„ì¬ ì„¤ì •ì´ ê¸°ë³¸ê°’ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
            };

            const loadCustomDefault = () => {
                try {
                    const customDefault = localStorage.getItem('assetDashboardCustomDefault');
                    if (customDefault) {
                        if (confirm('ì €ì¥ëœ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                            const parsed = JSON.parse(customDefault);
                            // ìŠ¤í‚¤ë§ˆ ë³´ì •: ëˆ„ë½ í•„ë“œ ì±„ì›€
                            const fallback = publicDefaultData;
                            if (!parsed.assets) parsed.assets = fallback.assets;
                            if (!parsed.monthlySalary) parsed.monthlySalary = fallback.monthlySalary;
                            if (!parsed.projectionMonths) parsed.projectionMonths = fallback.projectionMonths;
                            setAppData(parsed);
                            localStorage.setItem('assetDashboardUseDevDefaults','false');
                            alert('ì €ì¥ëœ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        }
                    } else {
                        if (confirm('ì €ì¥ëœ ê¸°ë³¸ê°’ì´ ì—†ìŠµë‹ˆë‹¤.\nì‚¬ì´íŠ¸ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                            setAppData(publicDefaultData);
                            alert('ì €ì¥ëœ ê¸°ë³¸ê°’ì´ ì—†ì–´ ì‚¬ì´íŠ¸ ê¸°ë³¸ê°’ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
                        }
                    }
                } catch (error) {
                    console.error('ê¸°ë³¸ê°’ ë¡œë“œ ì˜¤ë¥˜:', error);
                    alert('ê¸°ë³¸ê°’ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            };

            // ===== ê°œì„ ëœ PDF ì €ì¥ í•¨ìˆ˜ =====
            const saveToPDF = async () => {
                try {
                    // ë¡œë”© ì•Œë¦¼ í‘œì‹œ
                    const loadingAlert = document.createElement('div');
                    loadingAlert.className = 'fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded shadow-lg z-50';
                    loadingAlert.textContent = 'PDF ìƒì„± ì¤‘...';
                    document.body.appendChild(loadingAlert);

                    // ìš”ì†Œ í™•ì¸
                    const element = document.getElementById('dashboard-content');
                    if (!element) {
                        throw new Error('ëŒ€ì‹œë³´ë“œ ì½˜í…ì¸ ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }

                    // html2canvas ì˜µì…˜ ê°œì„ 
                    const canvas = await html2canvas(element, {
                        scale: 1.5,
                        useCORS: true,
                        allowTaint: false,
                        backgroundColor: '#f9fafb',
                        logging: false,
                        width: element.scrollWidth,
                        height: element.scrollHeight,
                        scrollX: 0,
                        scrollY: 0
                    });
                    
                    const imgData = canvas.toDataURL('image/png', 0.8);
                    
                    // jsPDF ì¸ìŠ¤í„´ìŠ¤ ìƒì„± í™•ì¸ (UMD ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í˜¸í™˜)
                    const JSPDF_NS = window.jspdf || window.jsPDF || window.jsPDFModule;
                    if (!JSPDF_NS || !JSPDF_NS.jsPDF) {
                        throw new Error('PDF ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                    const pdf = new JSPDF_NS.jsPDF('p', 'mm', 'a4');
                    const imgWidth = 210;
                    const pageHeight = 295;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 0;

                    // ì²« í˜ì´ì§€
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;

                    // ì¶”ê°€ í˜ì´ì§€
                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }

                    // íŒŒì¼ëª… ìƒì„±
                    const fileName = `ìì‚°ë¶„ì„ë³´ê³ ì„œ_${new Date().toISOString().split('T')[0]}.pdf`;
                    pdf.save(fileName);
                    
                    // ì„±ê³µ ì•Œë¦¼
                    loadingAlert.textContent = 'PDF ì €ì¥ ì™„ë£Œ!';
                    loadingAlert.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow-lg z-50';
                    
                    setTimeout(() => {
                        if (document.body.contains(loadingAlert)) {
                            document.body.removeChild(loadingAlert);
                        }
                    }, 2000);

                } catch (error) {
                    console.error('PDF ì €ì¥ ì˜¤ë¥˜:', error);
                    
                    // ì˜¤ë¥˜ ì•Œë¦¼
                    const errorAlert = document.createElement('div');
                    errorAlert.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded shadow-lg z-50';
                    errorAlert.textContent = `PDF ì €ì¥ ì‹¤íŒ¨: ${error.message}`;
                    document.body.appendChild(errorAlert);
                    
                    setTimeout(() => {
                        if (document.body.contains(errorAlert)) {
                            document.body.removeChild(errorAlert);
                        }
                    }, 5000);
                    // í˜¹ì‹œ ë‚¨ì•„ìˆëŠ” ë¡œë”© ì•Œë¦¼ ì œê±°
                    document.querySelectorAll('.fixed.top-4.right-4').forEach(el => {
                        if (el.textContent.includes('PDF')) {
                            el.parentNode && el.parentNode.removeChild(el);
                        }
                    });
                }
            };

            // ===== ì‹œë‚˜ë¦¬ì˜¤ ê´€ë¦¬ í•¨ìˆ˜ë“¤ =====
            const saveScenario = () => {
                const name = prompt('ì‹œë‚˜ë¦¬ì˜¤ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:');
                if (name && name.trim()) {
                    const newScenario = {
                        id: Date.now(),
                        name: name.trim(),
                        data: { ...appData },
                        createdAt: new Date().toISOString()
                    };
                    setScenarios(prev => [...prev, newScenario]);
                    alert('ì‹œë‚˜ë¦¬ì˜¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
            };

            const loadScenario = (scenario) => {
                if (confirm(`"${scenario.name}" ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    setAppData(scenario.data);
                }
            };

            const deleteScenario = (id) => {
                if (confirm('ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    setScenarios(prev => prev.filter(s => s.id !== id));
                }
            };

            // ===== ì˜ˆì‚° ê³„ì‚° =====
            const totalMonthlyExpense = useMemo(() => {
                if (!monthlyExpenses || !Array.isArray(monthlyExpenses)) return 0;
                return monthlyExpenses.reduce((sum, e) => sum + (e.amount || 0), 0);
            }, [monthlyExpenses]);
            
            const totalSectorMonthlyContrib = useMemo(() => {
                if (!assets || typeof assets !== 'object') return 0;
                let sum = 0;
                Object.entries(assets).forEach(([sector, arr]) => {
                    if (Array.isArray(arr)) {
                        arr.forEach(asset => { sum += asset.monthlyContrib || 0; });
                    }
                });
                return sum;
            }, [assets]);
            
            const maxSectorMonthlyContrib = useMemo(() => Math.max(0, monthlySalary - totalMonthlyExpense), [monthlySalary, totalMonthlyExpense]);
            const autoDepositAmount = Math.max(0, maxSectorMonthlyContrib - totalSectorMonthlyContrib);

            // ===== ìë™ì…ê¸ˆ ë°˜ì˜ í•¨ìˆ˜ =====
            const applyAutoDeposit = () => {
                if (autoDepositAmount > 0) {
                    setAssets(prev => {
                        const next = { ...prev };
                        let updated = false;
                        Object.keys(next).forEach(sectorKey => {
                            if (Array.isArray(next[sectorKey])) {
                                next[sectorKey] = next[sectorKey].map(asset => {
                                    if (asset.name === autoDepositAccount) {
                                        updated = true;
                                        return { ...asset, monthlyContrib: (asset.monthlyContrib || 0) + autoDepositAmount };
                                    }
                                    return asset;
                                });
                            }
                        });
                        return next;
                    });
                    alert(`${autoDepositAccount}ì— ${autoDepositAmount}ë§Œì› ì›”ë‚©ì…ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                }
            };

            // ===== ê°œì„ ëœ ëª©í‘œ ë‹¬ì„± ê³„ì‚° =====
            const calculateGoalSeek = () => {
                if (!targetAmount || targetAmount <= 0) {
                    alert('ìœ íš¨í•œ ëª©í‘œ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                let months = 0;
                let currentAssets = {};
                
                // í˜„ì¬ ìì‚° ìƒíƒœ ë³µì‚¬
                Object.keys(assets).forEach(sector => {
                    if (Array.isArray(assets[sector])) {
                        currentAssets[sector] = assets[sector].map(asset => ({ ...asset }));
                    } else {
                        currentAssets[sector] = [];
                    }
                });

                const monthlyGrowth = totalSectorMonthlyContrib + autoDepositAmount;
                
                // ë§¤ì›” ì‹œë®¬ë ˆì´ì…˜
                while (months < 1000) {
                    months++;
                    
                    // ë³µë¦¬ ìˆ˜ìµë¥  ì ìš© (ìì‚°ë³„ ìˆ˜ìˆ˜ë£Œ/ì„¸ê¸ˆ ë°˜ì˜)
                    Object.keys(currentAssets).forEach(sector => {
                        currentAssets[sector].forEach(asset => {
                            const feeRate = (asset.feeRate || 0) / 100;
                            let effectiveRate = (asset.rate / 100) * (1 - feeRate);
                            const monthlyRate = 1 + (effectiveRate / 12);
                            asset.amount *= monthlyRate;
                        });
                    });

                    // ì´ë²¤íŠ¸ ì ìš©
                    incomeEvents.forEach(event => {
                        if (months >= event.startMonth && months <= event.endMonth) {
                            if (currentAssets[event.targetSector] && currentAssets[event.targetSector][event.targetAsset]) {
                                currentAssets[event.targetSector][event.targetAsset].amount += event.amount;
                            }
                        }
                    });

                   (expenseEvents || []).forEach(event => { // ğŸ‘ˆ [ê°œì„ ] (expenseEvents || [])ë¡œ ì•ˆì •ì„± í™•ë³´
                    if (months >= event.startMonth && months <= event.endMonth) {
                        const arr = currentAssets[event.targetSector]; // ğŸ‘ˆ [ê°œì„ ] ì§€ì •ëœ ì„¹í„°
                        if (arr && arr[event.targetAsset]) { // ğŸ‘ˆ [ê°œì„ ] ì§€ì •ëœ ê³„ì¢Œ
                            arr[event.targetAsset].amount = Math.max(0, arr[event.targetAsset].amount - event.amount);
                        }
                    }
                });

                    // ì›”ê¸‰ ë° ì§€ì¶œ
                    const livingAccount = currentAssets.deposit?.find(d => d.name === 'ìƒí™œë¹„í†µì¥');
                    if (livingAccount) {
                        livingAccount.amount += monthlySalary;
                        livingAccount.amount -= totalMonthlyExpense;
                    }

                    // ì›”ë‚©ì… ì ìš©
                    Object.keys(currentAssets).forEach(sector => {
                        currentAssets[sector].forEach(asset => {
                            if (asset.monthlyContrib > 0) {
                                if (sector === 'loan') {
                                    asset.amount = Math.max(0, (asset.amount || 0) - asset.monthlyContrib);

                                    // ğŸ‘‡ [ê°œì„ ] ì—¬ê¸°ì„œëŠ” ë©”ì¸ ë¡œì§ê³¼ ë™ì¼í•˜ê²Œ ì§€ì •ëœ ìƒí™˜ê³„ì¢Œì—ì„œ ë¹¼ì•¼ í•©ë‹ˆë‹¤.
                                    const accountName = asset.repaymentAccount || 'ìƒí™œë¹„í†µì¥';
                                    const allAccounts = Object.values(currentAssets).flat();
                                    const paymentSourceAccount = allAccounts.find(a => a.name === accountName);
                                    if (paymentSourceAccount) {
                                        paymentSourceAccount.amount -= asset.monthlyContrib;
                                    }

                                } else {
                                    asset.amount += asset.monthlyContrib;
                                    // ğŸ‘‡ [ê°œì„ ] ëŒ€ì¶œì´ ì•„ë‹ ë•Œë§Œ ìƒí™œë¹„í†µì¥ì—ì„œ ì°¨ê° (else ì•ˆìœ¼ë¡œ ì´ë™)
                                    if (livingAccount && asset.name !== 'ìƒí™œë¹„í†µì¥') {
                                        livingAccount.amount -= asset.monthlyContrib;
                                    }
                                }
                            }
                        });
                    });

                    // ìë™ì…ê¸ˆ (ëŒ€ì¶œ ìƒí™˜ ì²˜ë¦¬)
                    if (autoDepositAmount > 0) {
                        const allAccounts = Object.values(currentAssets).flat();
                        const targetAccount = allAccounts.find(d => d.name === autoDepositAccount);
                        if (targetAccount && livingAccount && targetAccount.name !== 'ìƒí™œë¹„í†µì¥') {
                            if ((Object.entries(currentAssets).find(([k,v]) => (v||[]).some(a => a.name===autoDepositAccount))||[])[0] === 'loan') {
                                targetAccount.amount = Math.max(0, (targetAccount.amount || 0) - autoDepositAmount);
                            } else {
                                targetAccount.amount += autoDepositAmount;
                            }
                            livingAccount.amount -= autoDepositAmount;
                        }
                    }

                    // ì›”ìˆ˜ì…ì™¸ ë‚©ì… (ëŒ€ì¶œ ìƒí™˜ ì²˜ë¦¬)
                    Object.keys(currentAssets).forEach(sector => {
                        currentAssets[sector].forEach(asset => {
                            if (asset.extraContrib > 0 && asset.extraFrom) {
                                if (sector === 'loan') {
                                    asset.amount = Math.max(0, (asset.amount || 0) - asset.extraContrib);
                                } else {
                                    asset.amount += asset.extraContrib;
                                }
                                const fromAccountArray = Object.values(currentAssets).flat();
                                const fromAccount = fromAccountArray.find(d => d.name === asset.extraFrom);
                                if (fromAccount) {
                                    const actualDeduction = Math.min(asset.extraContrib, fromAccount.amount);
                                    fromAccount.amount -= actualDeduction;
                                    if (actualDeduction < asset.extraContrib) {
                                        if (sector === 'loan') {
                                            asset.amount += (asset.extraContrib - actualDeduction);
                                        } else {
                                            asset.amount -= (asset.extraContrib - actualDeduction);
                                        }
                                    }
                                }
                            }
                        });
                    });

                    // ì´ ìì‚° ê³„ì‚°
                    const currentTotal = Object.values(currentAssets).flat().reduce((sum, asset) => sum + asset.amount, 0);
                    
                    if (currentTotal >= targetAmount) {
                        setGoalSeekResult(`ëª©í‘œ ë‹¬ì„±ê¹Œì§€ ì•½ ${months}ê°œì›” ì†Œìš”ë©ë‹ˆë‹¤.`);
                        setProjectionMonths(months);
                        return;
                    }
                }

                setGoalSeekResult('í˜„ì¬ ì¡°ê±´ìœ¼ë¡œëŠ” 1000ê°œì›” ë‚´ ëª©í‘œ ë‹¬ì„±ì´ ì–´ë µìŠµë‹ˆë‹¤.');
            };

Â  Â  Â  Â  Â  Â  // ===== ë©”ì¸ ê³„ì‚° ë¡œì§ =====
Â  Â  Â  Â  Â  Â  const calculation = useMemo(() => {
Â  Â  Â  Â  Â  Â  Â  Â  if (!appData || !assets || typeof assets !== 'object') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  initial: {},
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  projected: {},
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentTotal: 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  projectedTotal: 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  growth: 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  grand: 0 // [ìˆ˜ì •] grandë„ 0ìœ¼ë¡œ ì´ˆê¸°í™”
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const months = projectionMonths;
Â  Â  Â  Â  Â  Â  Â  Â  let currentAssets = {};
Â  Â  Â  Â  Â  Â  Â  Â  Object.keys(assets).forEach(sector => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (Array.isArray(assets[sector])) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentAssets[sector] = assets[sector].map(asset => ({ ...asset }));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentAssets[sector] = [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  // [ì¶”ê°€] ì‹œë®¬ë ˆì´ì…˜ì„ ìœ„í•œ ëª¨ë“  ê³„ì¢Œ ëª©ë¡ ìºì‹± (ë§¤ì›” ì°¾ì§€ ì•Šë„ë¡)
Â  Â  Â  Â  Â  Â  Â  Â  const allAccountsFlat = Object.values(currentAssets).flat();

Â  Â  Â  Â  Â  Â  Â  Â  for (let month = 1; month <= months; month++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ë³µë¦¬ ìˆ˜ìµë¥  ì ìš© (ìì‚°ë³„ ìˆ˜ìˆ˜ë£Œ/ì„¸ê¸ˆ ë°˜ì˜)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Object.keys(currentAssets).forEach(sector => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // [ìˆ˜ì •] ëŒ€ì¶œ ì„¹í„°ëŠ” ì´ì ê³„ì‚°ì„ ë³„ë„ë¡œ í•˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ì œì™¸
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (sector === 'loan') return; 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentAssets[sector].forEach(asset => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const feeRate = (asset.feeRate || 0) / 100;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let effectiveRate = (asset.rate / 100) * (1 - feeRate);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const monthlyRate = 1 + (effectiveRate / 12);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  asset.amount *= monthlyRate;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // [ì¶”ê°€] ëŒ€ì¶œ ì´ì ê³„ì‚° (ë‚©ì… ì „)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // (ìƒí™˜ë°©ì‹ë³„ ë³µì¡í•œ ë¡œì§ ëŒ€ì‹ , í˜„ì¬ ì”ì•¡ ê¸°ì¤€ ì›” ì´ììœ¨ì„ ë‹¨ìˆœ ì ìš©)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  (currentAssets.loan || []).forEach(loan => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (loan.amount > 0 && loan.rate > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const monthlyInterest = loan.amount * (loan.rate / 100) / 12;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loan.amount += monthlyInterest; // ì´ìê°€ ì›ê¸ˆì— ë”í•´ì§
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ì´ë²¤íŠ¸ ì ìš©
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  (incomeEvents || []).forEach(event => { // [ìˆ˜ì •] null ë°©ì–´
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (month >= event.startMonth && month <= event.endMonth) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (currentAssets[event.targetSector] && currentAssets[event.targetSector][event.targetAsset]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentAssets[event.targetSector][event.targetAsset].amount += event.amount;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â   Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  (expenseEvents || []).forEach(event => { // [ìˆ˜ì •] null ë°©ì–´
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (month >= event.startMonth && month <= event.endMonth) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const arr = currentAssets[event.targetSector];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (arr && arr[event.targetAsset]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  arr[event.targetAsset].amount = Math.max(0, arr[event.targetAsset].amount - event.amount);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ì›”ê¸‰ ë° ì§€ì¶œ
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const livingAccount = allAccountsFlat.find(d => d.name === 'ìƒí™œë¹„í†µì¥');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (livingAccount) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  livingAccount.amount += monthlySalary;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  livingAccount.amount -= totalMonthlyExpense;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ì›”ë‚©ì… ì ìš©
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Object.keys(currentAssets).forEach(sector => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentAssets[sector].forEach(asset => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (asset.monthlyContrib > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let paymentSourceAccount = null;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (sector === 'loan') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // [ìˆ˜ì •] ëŒ€ì¶œ ìƒí™˜ ë¡œì§
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const paymentAmount = Math.min(asset.amount, asset.monthlyContrib); // ì”ì•¡ ì´ìƒ ìƒí™˜ ë°©ì§€
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  asset.amount = Math.max(0, asset.amount - paymentAmount);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // [ìˆ˜ì •] ì§€ì •ëœ ìƒí™˜ê³„ì¢Œì—ì„œ ì¶œê¸ˆ
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const accountName = asset.repaymentAccount || 'ìƒí™œë¹„í†µì¥';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  paymentSourceAccount = allAccountsFlat.find(a => a.name === accountName);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (paymentSourceAccount) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  paymentSourceAccount.amount -= paymentAmount;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // [ê¸°ì¡´] ìì‚° ë‚©ì… ë¡œì§
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  asset.amount += asset.monthlyContrib;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // [ìˆ˜ì •] ìƒí™œë¹„í†µì¥ì—ì„œ ì¶œê¸ˆ (ê¸°ë³¸ê°’)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (livingAccount && asset.name !== 'ìƒí™œë¹„í†µì¥') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  livingAccount.amount -= asset.monthlyContrib;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â   Â  Â });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ìë™ì…ê¸ˆ
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (autoDepositAmount > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const targetAccount = allAccountsFlat.find(d => d.name === autoDepositAccount);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (targetAccount && livingAccount && targetAccount.name !== 'ìƒí™œë¹„í†µì¥') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  targetAccount.amount += autoDepositAmount;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  livingAccount.amount -= autoDepositAmount;
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ì›”ìˆ˜ì…ì™¸ ë‚©ì…
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Object.keys(currentAssets).forEach(sector => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentAssets[sector].forEach(asset => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (asset.extraContrib > 0 && asset.extraFrom) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const fromAccount = allAccountsFlat.find(d => d.name === asset.extraFrom);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let actualDeduction = 0;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (fromAccount) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  actualDeduction = Math.min(asset.extraContrib, fromAccount.amount);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fromAccount.amount -= actualDeduction;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (sector === 'loan') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // [ìˆ˜ì •] ëŒ€ì¶œ ì¶”ê°€ ìƒí™˜ (ì‹¤ì œ ì°¨ê°ëœ ê¸ˆì•¡ë§Œ)
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  asset.amount = Math.max(0, asset.amount - actualDeduction);
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â   Â  Â  Â  Â  // [ê¸°ì¡´] ìì‚° ì¶”ê°€ ë‚©ì… (ì‹¤ì œ ì°¨ê°ëœ ê¸ˆì•¡ë§Œ ë”í•¨)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  asset.amount += actualDeduction;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const calculateTotal = (assetData) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let sum = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Object.keys(assetData).forEach(sector => {
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const sectorSum = (assetData[sector]||[]).reduce((s,a)=> s + (a.amount||0), 0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sum += (sector === 'loan') ? -sectorSum : sectorSum;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return sum;
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  const currentTotal = calculateTotal(assets);
 Â  Â  Â  Â  Â  Â  Â  const projectedTotal = calculateTotal(currentAssets);

Â  Â  Â  Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  initial: assets,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  projected: currentAssets,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentTotal,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  projectedTotal,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  growth: projectedTotal - currentTotal,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  grand: currentTotal // ìˆœìì‚° ì¶”ê°€
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  }, [appData, assets, projectionMonths, monthlySalary, monthlyExpenses, incomeEvents, expenseEvents, autoDepositAccount]);


            
           
            // ===== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ =====
            const formatNumber = (num) => Math.round(num).toLocaleString();
            const formatPercent = (num) => num.toFixed(1);
            
            const calculateGrossTotal = (assetData) => {
                if (!assetData || typeof assetData !== 'object') return 0;
                let sum = 0;
                Object.keys(assetData).forEach(sector => {
                    if (sector === 'loan') return; // ë¶€ì±„ ì œì™¸
                    const arr = assetData[sector] || [];
                    sum += arr.reduce((s,a)=> s + (a.amount||0), 0);
                });
                return sum;
            };

            const getSectorTotals = (assetData, total) => {
                const totals = {};
                if (!assetData || typeof assetData !== 'object') return totals;
                
                Object.keys(assetData).forEach(sector => {
                    if (sector === 'loan') return; // ëŒ€ì¶œì€ ë¹„ìœ¨/ì°¨íŠ¸ ê³„ì‚°ì—ì„œ ì œì™¸
                    if (Array.isArray(assetData[sector])) {
                        const sectorTotal = assetData[sector].reduce((sum, asset) => sum + (asset.amount || 0), 0);
                        totals[sector] = { amount: sectorTotal, percentage: total > 0 ? (sectorTotal / total * 100) : 0 };
                    }
                });
                return totals;
            };

            const currentGrossTotal = calculateGrossTotal(calculation.initial);
            const projectedGrossTotal = calculateGrossTotal(calculation.projected);
            const currentSectorTotals = getSectorTotals(calculation.initial, currentGrossTotal);
            const projectedSectorTotals = getSectorTotals(calculation.projected, projectedGrossTotal);

            // ===== ë¦¬ë°¸ëŸ°ì‹± ê²½ê³  í•¨ìˆ˜ (ëª©í‘œ ë¹„ì¤‘ ê¸°ì¤€ í¸ì°¨) =====
            const getRebalanceStatus = (sectorKey, percentage) => {
                const target = rebalancingTargets[sectorKey] ?? (100 / Object.keys(sectorInfo).length);
                const deviation = Math.abs(percentage - target);
                const thresholds = rebalancingMode === 'simple' ? simpleThresholds : (rebalancingAlerts[sectorKey] || { warning: 5, danger: 10 });
                if (deviation >= thresholds.danger) return 'bg-red-100 text-red-800';
                if (deviation >= thresholds.warning) return 'bg-yellow-100 text-yellow-800';
                return '';
            };

            // ===== ìë™ì…ê¸ˆ ê³„ì‚°ì‹ í‘œì‹œ í•¨ìˆ˜ =====
            const getAutoDepositBreakdown = () => {
                const breakdown = [];
                Object.keys(assets).forEach(sectorKey => {
                    if (Array.isArray(assets[sectorKey])) {
                        assets[sectorKey].forEach(asset => {
                            if (asset.monthlyContrib > 0) {
                                breakdown.push({
                                    sector: sectorKey,
                                    name: asset.name,
                                    amount: asset.monthlyContrib
                                });
                            }
                        });
                    }
                });
                return breakdown;
            };

            const autoDepositBreakdown = getAutoDepositBreakdown();

            // ===== ì°¨íŠ¸ ì„¤ì • =====
            useEffect(() => {
    if (!appData || !currentPieRef.current || !projectedPieRef.current || !comparisonBarRef.current) return;

    const sectorColors = {
        deposit: '#3b82f6',
        savings: '#22c55e',
        investment: '#f97316',
        pension: '#a855f7',
        realestate: '#f59e0b',
        car: '#06b6d4',
        loan: '#6b7280',
        misc: '#6b7280'
    };
    const sectorLabels = {
        deposit: 'ì…ì¶œê¸ˆí†µì¥',
        savings: 'ì €ì¶•',
        investment: 'íˆ¬ì',
        pension: 'ì—°ê¸ˆ',
        realestate: 'ë¶€ë™ì‚°',
        car: 'ìë™ì°¨',
        loan: 'ëŒ€ì¶œ',
        misc: 'ê¸°íƒ€'
    };

    // ê¸°ì¡´ ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ê°€ ìˆë‹¤ë©´ íŒŒê´´í•©ë‹ˆë‹¤.
    [currentPieRef, projectedPieRef, comparisonBarRef].forEach(ref => {
        if (ref.current && ref.current._chart) {
            ref.current._chart.destroy();
        }
    });

    // ì°¨íŠ¸ ë°ì´í„° ì¤€ë¹„
    const filteredKeys = Object.keys(currentSectorTotals).filter(k => k !== 'loan');
    const currentLabels = filteredKeys.map(key => sectorLabels[key]);
    const currentData = filteredKeys.map(key => currentSectorTotals[key].amount);
    const currentColors = filteredKeys.map(key => sectorColors[key]);
    const projectedKeys = Object.keys(projectedSectorTotals).filter(k => k !== 'loan');
    const projectedLabels = projectedKeys.map(key => sectorLabels[key]);
    const projectedData = projectedKeys.map(key => projectedSectorTotals[key].amount);

    const forecastDateText = (() => {
        const [y,m] = (baseMonth || new Date().toISOString().slice(0,7)).split('-').map(Number);
        const date = new Date(y, m - 1 + projectionMonths);
        return `${String(date.getFullYear()).slice(2)}ë…„ ${String(date.getMonth()+1).padStart(2,'0')}ì›”`;
    })();

    // í˜„ì¬ í¬íŠ¸í´ë¦¬ì˜¤ ì°¨íŠ¸
    currentPieRef.current._chart = new Chart(currentPieRef.current, {
        type: 'pie',
        data: { labels: currentLabels, datasets: [{ data: currentData, backgroundColor: currentColors }] },
        options: {
            responsive: true,
            plugins: { 
                legend: { position: 'bottom' },
                title: { display: true, text: 'í˜„ì¬ í¬íŠ¸í´ë¦¬ì˜¤' },
                datalabels: {
                    anchor: 'end', // ë¼ë²¨ì„ ìŠ¬ë¼ì´ìŠ¤ ë°”ê¹¥ìª½ ëì— ê³ ì •
                    align: 'start', // ë¼ë²¨ í…ìŠ¤íŠ¸ë¥¼ ì‹œì‘ ë¶€ë¶„ì— ì •ë ¬
                    offset: 15, // ìŠ¬ë¼ì´ìŠ¤ì—ì„œ ë¼ë²¨ê¹Œì§€ì˜ ê±°ë¦¬
                    color: '#111827',
                    formatter: (v, ctx) => { const total = currentData.reduce((a,b)=>a+b,0)||1; const p = v/total*100; return p > 5 ? `${p.toFixed(1)}%` : ''; }, // 5% ë¯¸ë§Œì€ ìˆ¨ê¹€
                    font: { weight: 'bold', size: 11 }
                }
            }
        },
        plugins: [ChartDataLabels]
    });

    // ì˜ˆìƒ í¬íŠ¸í´ë¦¬ì˜¤ ì°¨íŠ¸
    projectedPieRef.current._chart = new Chart(projectedPieRef.current, {
        type: 'pie',
        data: { labels: projectedLabels, datasets: [{ data: projectedData, backgroundColor: currentColors }] },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom' },
                title: { display: true, text: `${projectionMonths}ê°œì›” í›„ ì˜ˆìƒ ${forecastDateText ? `(${forecastDateText})` : ''}` },
                datalabels: {
                    anchor: 'end',
                    align: 'start',
                    offset: 15,
                    color: '#111827',
                    formatter: (v, ctx) => { const total = projectedData.reduce((a,b)=>a+b,0)||1; const p = v/total*100; return p > 5 ? `${p.toFixed(1)}%` : ''; },
                    font: { weight: 'bold', size: 11 }
                }
            }
        },
        plugins: [ChartDataLabels]
    });

    // ë¹„êµ ì°¨íŠ¸
comparisonBarRef.current._chart = new Chart(comparisonBarRef.current, {
    type: 'bar',
    data: {
        labels: currentLabels,
        datasets: [
            { label: 'í˜„ì¬', data: currentData, backgroundColor: 'rgba(59, 130, 246, 0.6)' },
            { label: 'ì˜ˆìƒ', data: projectedData, backgroundColor: 'rgba(34, 197, 94, 0.6)' }
        ]
    },
    options: {
        responsive: true,
        scales: { x: { position: 'bottom' }, y: { beginAtZero: true } },
        plugins: {
            legend: { position: 'bottom' },
            title: { display: true, text: 'í˜„ì¬ ìì‚° vs ì˜ˆìƒ ìì‚°' },
            datalabels: {
                        anchor: 'center', // [ìˆ˜ì •] ë§‰ëŒ€ ì¤‘ì•™ì— ìœ„ì¹˜
                        align: 'center',  // [ìˆ˜ì •] ë§‰ëŒ€ ì¤‘ì•™ì— ì •ë ¬
                        color: '#ffffff', // [ìˆ˜ì •] í°ìƒ‰ìœ¼ë¡œ ë³€ê²½
                        font: { 
                            size: 10,
                            weight: 'bold' // [ì¶”ê°€] êµµê²Œ
                        },
                        // [ì¶”ê°€] ê°€ë…ì„±ì„ ìœ„í•œ í…ìŠ¤íŠ¸ ê·¸ë¦¼ì
                        textStrokeColor: 'rgba(0,0,0,0.4)',
                        textStrokeWidth: 2,
                        formatter: (value, context) => {
                            // [ìˆ˜ì •] 0 ì´í•˜ëŠ” í‘œì‹œ ì•ˆí•¨
                            if (value <= 0) return '';
                            return `${Math.round(value).toLocaleString()}`;
                        }
            }
        }
    },
    plugins: [ChartDataLabels]
});

    // íˆìŠ¤í† ë¦¬ ì°¨íŠ¸
    if (historyChartRef.current && assetHistory.length > 0) {
        // ê¸°ì¡´ ì°¨íŠ¸ íŒŒê´´
        if (historyChartRef.current._chart) {
            historyChartRef.current._chart.destroy();
        }
        
        const historyLabels = assetHistory.map(item => {
            const date = new Date(item.date);
            const timeStr = item.time ? ` ${item.time.split(':').slice(0, 2).join(':')}` : '';
            return `${date.getMonth() + 1}/${date.getDate()}${timeStr}`;
        });
        const historyData = assetHistory.map(item => item.netWorth);
        
        historyChartRef.current._chart = new Chart(historyChartRef.current, {
            type: 'line',
            data: {
                labels: historyLabels,
                datasets: [{
                    label: 'ìˆœìì‚° (ë§Œì›)',
                    data: historyData,
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.1,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' },
                    title: { display: true, text: 'ìì‚° íˆìŠ¤í† ë¦¬' }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }
}, [appData, calculation, projectionMonths, baseMonth, assetHistory]);




            // ===== ë¡œë”© ìƒíƒœ ì²˜ë¦¬ =====
            if (!appData) {
                return <div className="flex items-center justify-center min-h-screen">ë¡œë”© ì¤‘...</div>;
            }

            // ===== ìì‚° ê´€ë¦¬ í•¨ìˆ˜ë“¤ =====
            const addAsset = (sector) => setAssets(prev => ({
                ...prev,
                [sector]: [...(prev[sector] || []), {
                    name: 'ìƒˆ í•­ëª©',
                    amount: 0,
                    rate: sector === 'loan' ? 3.0 : (sector === 'car' ? -2.0 : 10.0),
                    feeRate: 0,
                    monthlyContrib: 0, // ëŒ€ì¶œì˜ ê²½ìš° 'ì›” ìƒí™˜ì•¡'ìœ¼ë¡œ ì‚¬ìš©
                    extraContrib: 0, // ëŒ€ì¶œì˜ ê²½ìš° 'ì¶”ê°€ ìƒí™˜ì•¡'ìœ¼ë¡œ ì‚¬ìš©
                    extraFrom: (Object.values(prev).flat().find(a => a.name === 'ìƒí™œë¹„í†µì¥')?.name) || (Object.values(prev).flat()[0]?.name) || '', // 'ì¶”ê°€ ìƒí™˜' ì¶œê¸ˆ ê³„ì¢Œ
                    // [ì¶”ê°€] ëŒ€ì¶œ ì „ìš© í•„ë“œ ê¸°ë³¸ê°’
                    repaymentMethod: 'ì›ë¦¬ê¸ˆê· ë“±', // ìƒí™˜ë°©ì‹
                    repaymentAccount: (Object.values(prev).flat().find(a => a.name === 'ìƒí™œë¹„í†µì¥')?.name) || (Object.values(prev).flat()[0]?.name) || '' // 'ì›” ìƒí™˜ì•¡' ì¶œê¸ˆ ê³„ì¢Œ
                }]
            }));

            const updateAsset = (sector, index, field, value) => {
            // ğŸ‘‡ [ê°œì„ ] ìˆ«ìì—¬ì•¼ í•˜ëŠ” í•„ë“œ ëª©ë¡ì„ ë§Œë“­ë‹ˆë‹¤.
            const numberFields = ['amount', 'rate', 'feeRate', 'monthlyContrib', 'extraContrib'];

            // ğŸ‘‡ [ê°œì„ ] í•´ë‹¹ í•„ë“œë§Œ ìˆ«ìë¡œ ë³€í™˜í•˜ê³ , ë‚˜ë¨¸ì§€ëŠ”(ê³„ì¢Œ ì´ë¦„ ë“±) ë¬¸ìì—´ë¡œ ë‘¡ë‹ˆë‹¤.
            const newValue = numberFields.includes(field) ? Number(value) : value;

            if ((field === 'monthlyContrib' || field === 'extraContrib') && newValue < 0) return;
            setAssets(prev => ({
                ...prev,
                [sector]: prev[sector].map((asset, i) => i === index ? { ...asset, [field]: newValue } : asset)
            }));
        };

            const removeAsset = (sector, index) => setAssets(prev => ({
                ...prev,
                [sector]: prev[sector].filter((_, i) => i !== index)
            }));

            // ===== ì§€ì¶œ ê´€ë¦¬ í•¨ìˆ˜ë“¤ =====
            const addExpense = () => setMonthlyExpenses(prev => [...prev, { name: 'ìƒˆ ì§€ì¶œ', amount: 0 }]);
            const updateExpense = (index, field, value) => setMonthlyExpenses(prev => prev.map((expense, i) => 
                i === index ? { ...expense, [field]: field === 'name' ? value : Number(value) } : expense
            ));
            const removeExpense = (index) => setMonthlyExpenses(prev => prev.filter((_, i) => i !== index));

            // ===== ì„¹í„° ì •ë³´ (í•¨ìˆ˜ ì •ì˜ ì „ì— ìœ„ì¹˜) =====
            const sectorInfo = {
                deposit: { name: 'ì…ì¶œê¸ˆí†µì¥', color: 'deposit', icon: 'ğŸ¦' },
                savings: { name: 'ì €ì¶•', color: 'savings', icon: 'ğŸ’°' },
                investment: { name: 'íˆ¬ì', color: 'investment', icon: 'ğŸ“ˆ' },
                pension: { name: 'ì—°ê¸ˆ', color: 'pension', icon: 'ğŸ›ï¸' },
                realestate: { name: 'ë¶€ë™ì‚°', color: 'realestate', icon: 'ğŸ ' },
                car: { name: 'ìë™ì°¨', color: 'car', icon: 'ğŸš—' },
                loan: { name: 'ëŒ€ì¶œ', color: 'loan', icon: 'ğŸ’³' },
                misc: { name: 'ê¸°íƒ€', color: 'misc', icon: 'ğŸ“¦' }
            };

            // ===== ì´ë²¤íŠ¸ ê´€ë¦¬ í•¨ìˆ˜ë“¤ =====
            const addIncomeEvent = () => {
                try {
                    setIncomeEvents(prev => {
                        // prevê°€ ë°°ì—´ì´ ì•„ë‹ˆë©´ ë¹ˆ ë°°ì—´ë¡œ ì´ˆê¸°í™”
                        const currentEvents = Array.isArray(prev) ? prev : [];
                        return [...currentEvents, { 
                            name: 'ìƒˆ ìˆ˜ì… ì´ë²¤íŠ¸', amount: 0, startMonth: 1, endMonth: 1, targetSector: 'deposit', targetAsset: 0 
                        }];
                    });
                } catch (error) {
                    console.error('Error adding income event:', error);
                }
            };
            
            const updateIncomeEvent = (index, field, value) => {
                try {
                    // incomeEventsê°€ ë°°ì—´ì¸ì§€ í™•ì¸
                    if (!Array.isArray(incomeEvents)) {
                        console.warn('incomeEvents is not an array:', incomeEvents);
                        return;
                    }
                    
                    // ì…ë ¥ê°’ ê²€ì¦
                    if (index < 0 || index >= incomeEvents.length) {
                        console.warn('Invalid income event index:', index);
                        return;
                    }
                    
                    let newValue = value;
                    
                    // ìˆ«ì í•„ë“œ ê²€ì¦
                    if (field === 'amount' || field === 'startMonth' || field === 'endMonth' || field === 'targetAsset') {
                        const numValue = Number(value);
                        if (isNaN(numValue)) {
                            console.warn('Invalid number value:', value);
                            return;
                        }
                        newValue = Math.max(0, numValue); // ìŒìˆ˜ ë°©ì§€
                    }
                    
                    // ì„¹í„° í•„ë“œ ê²€ì¦
                    if (field === 'targetSector' && !Object.keys(sectorInfo).includes(value)) {
                        console.warn('Invalid target sector:', value);
                        return;
                    }
                    
                    setIncomeEvents(prev => {
                        if (!Array.isArray(prev)) {
                            console.warn('Previous incomeEvents is not an array:', prev);
                            return prev;
                        }
                        return prev.map((event, i) => 
                            i === index ? { ...event, [field]: newValue } : event
                        );
                    });
                } catch (error) {
                    console.error('Error updating income event:', error);
                }
            };
            
            const removeIncomeEvent = (index) => {
                try {
                    // incomeEventsê°€ ë°°ì—´ì¸ì§€ í™•ì¸
                    if (!Array.isArray(incomeEvents)) {
                        console.warn('incomeEvents is not an array:', incomeEvents);
                        return;
                    }
                    
                    // ì¸ë±ìŠ¤ ê²€ì¦
                    if (index < 0 || index >= incomeEvents.length) {
                        console.warn('Invalid income event index for removal:', index);
                        return;
                    }
                    
                    setIncomeEvents(prev => {
                        if (!Array.isArray(prev)) {
                            console.warn('Previous incomeEvents is not an array:', prev);
                            return prev;
                        }
                        return prev.filter((_, i) => i !== index);
                    });
                } catch (error) {
                    console.error('Error removing income event:', error);
                }
            };

            const addExpenseEvent = () => setExpenseEvents(prev => {
            const currentEvents = Array.isArray(prev) ? prev : []; // ğŸ‘ˆ [ê°œì„ ] ë°°ì—´ì¸ì§€ í™•ì¸
            return [...currentEvents, { 
                name: 'ìƒˆ ì§€ì¶œ ì´ë²¤íŠ¸', amount: 0, startMonth: 1, endMonth: 1, targetSector: 'deposit', targetAsset: 0 
            }];
        });
            const updateExpenseEvent = (index, field, value) => {
            // ğŸ‘‡ [ê°œì„ ] 'updateIncomeEvent'ì™€ ë™ì¼í•œ ë¡œì§ ì ìš©
            let newValue = value;
            const numberFields = ['amount', 'startMonth', 'endMonth', 'targetAsset'];

            if (numberFields.includes(field)) {
                const numValue = Number(value);
                if (!isNaN(numValue)) {
                    newValue = Math.max(0, numValue); // ìŒìˆ˜ ë°©ì§€
                }
            }

            setExpenseEvents(prev => {
                if (!Array.isArray(prev)) return [];
                return prev.map((event, i) =>
                    i === index ? { ...event, [field]: newValue } : event
                );
            });
        };
            const removeExpenseEvent = (index) => setExpenseEvents(prev => {
            if (!Array.isArray(prev)) return []; // ğŸ‘ˆ [ê°œì„ ] ë°°ì—´ì´ ì•„ë‹ˆë©´ ì¤‘ë‹¨
            return prev.filter((_, i) => i !== index);
        });
            // ===== ë¦¬ë°¸ëŸ°ì‹± ì•Œë¦¼ ì„¤ì • í•¨ìˆ˜ë“¤ =====
            const updateRebalancingAlert = (sector, type, value) => {
                setRebalancingAlerts(prev => ({
                    ...prev,
                    [sector]: { ...prev[sector], [type]: Number(value) }
                }));
            };


            const savingsPanelSectors = ['deposit','savings','investment','misc'];
            const assetsPanelSectors = ['realestate','car','misc'];
            const loanPanelSectors = ['loan'];

            return (
                <div className="min-h-screen bg-gray-50">
                    {/* ===== ìƒë‹¨ ê³ ì • í—¤ë” ===== */}
                    <div className="sticky top-0 z-50 bg-white shadow-sm border-b">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center h-16">
                                <h1 id="app-title" className="text-xl sm:text-2xl font-bold text-gray-900">í†µí•© ìì‚° ë¶„ì„ ëŒ€ì‹œë³´ë“œ</h1>
                                <div className="hidden sm:flex items-center gap-2 sm:gap-4">
                                    <button onClick={saveToPDF} className="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">ğŸ“„ PDF ì €ì¥</button>
                                    <button onClick={saveScenario} className="inline-flex items-center px-3 py-2 border border-gray-300 text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">ğŸ’¾ ì‹œë‚˜ë¦¬ì˜¤ ì €ì¥</button>
                                    <button onClick={saveAsDefault} className="inline-flex items-center px-3 py-2 border border-blue-300 text-sm leading-4 font-medium rounded-md text-blue-700 bg-white hover:bg-blue-50">â­ ê¸°ë³¸ê°’ ì €ì¥</button>
                                    <button onClick={loadCustomDefault} className="inline-flex items-center px-3 py-2 border border-gray-300 text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">â†©ï¸ ê¸°ë³¸ê°’ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                                </div>
                                <div className="sm:hidden relative">
                                    <details className="relative">
                                        <summary className="list-none inline-flex items-center px-3 py-2 border rounded-md bg-white text-gray-700">â˜° ë©”ë‰´</summary>
                                        <div className="absolute right-0 mt-2 w-48 bg-white border rounded-md shadow-md z-50 p-2 space-y-2">
                                            <button onClick={saveToPDF} className="w-full text-left px-3 py-2 rounded hover:bg-gray-100">ğŸ“„ PDF ì €ì¥</button>
                                            <button onClick={saveScenario} className="w-full text-left px-3 py-2 rounded hover:bg-gray-100">ğŸ’¾ ì‹œë‚˜ë¦¬ì˜¤ ì €ì¥</button>
                                            <button onClick={saveAsDefault} className="w-full text-left px-3 py-2 rounded hover:bg-gray-100">â­ ê¸°ë³¸ê°’ ì €ì¥</button>
                                            <button onClick={loadCustomDefault} className="w-full text-left px-3 py-2 rounded hover:bg-gray-100">â†©ï¸ ê¸°ë³¸ê°’ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                                        </div>
                                    </details>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* ===== ë©”ì¸ ì½˜í…ì¸  ===== */}
                    <div id="dashboard-content" className="p-4 sm:p-6 max-w-7xl mx-auto space-y-6 sm:space-y-8">
                        
                        {/* ===== ê¸°ë³¸ ì„¤ì • + ìš”ì•½ (ë³‘í•©) ===== */}
                        <div className="grid grid-cols-1 gap-6">
                            <div className="bg-white rounded-lg shadow p-6">
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 items-stretch">
                                    <div className="bg-gray-50 rounded-lg p-4 flex flex-col justify-between">
                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <h2 className="text-lg font-semibold mb-2 text-gray-600">í˜„ì¬ ì´ìì‚°</h2>
                                                <p className="text-2xl sm:text-3xl font-bold text-blue-600">{formatNumber(calculation.currentTotal)}ë§Œì›</p>
                                            </div>
                                            <div>
                                                <h2 className="text-lg font-semibold mb-2 text-gray-600">{projectionMonths}ê°œì›” í›„ ì˜ˆìƒ <span className="text-gray-400 text-sm">({(() => { try { const [y,m]= (baseMonth||'').split('-').map(Number); const d = new Date(y||new Date().getFullYear(), (m||1)-1, 1); d.setMonth(d.getMonth()+projectionMonths); return `${String(d.getFullYear()).slice(2)}ë…„ ${String(d.getMonth()+1).padStart(2,'0')}ì›”`; } catch { return ''; } })()})</span></h2>
                                                <p className="text-2xl sm:text-3xl font-bold text-green-600">{formatNumber(calculation.projectedTotal)}ë§Œì›</p>
                                                <p className="text-sm text-gray-500 mt-2">ì¦ê°€ì•¡: +{formatNumber(calculation.growth)}ë§Œì› ({formatPercent((calculation.growth) / Math.max(1, calculation.currentTotal) * 100)}%)</p>
                                            </div>
                                        </div>
                                        <p className="text-xs text-gray-500 mt-3">{(() => { try { const [y,m]= (baseMonth||'').split('-').map(Number); const d=new Date(y||new Date().getFullYear(),(m||1)-1,1); const to=new Date(d); to.setMonth(to.getMonth()+projectionMonths); const fmt=(dt)=> `${String(dt.getFullYear()).slice(2)}ë…„ ${String(dt.getMonth()+1).padStart(2,'0')}ì›”`; return `ê¸°ì¤€ì›”: ${fmt(d)} â†’ ${fmt(to)}`; } catch { return ''; } })()}</p>
                                        
                                        {/* ìƒˆë¡œìš´ ê¸°ëŠ¥ ë²„íŠ¼ë“¤ */}
                                        <div className="mt-4 pt-4 border-t border-gray-200">
                                            <div className="space-y-2">
                                                <div className="grid grid-cols-2 gap-2">
                                                    <button onClick={saveCurrentAsset} className="px-3 py-2 bg-blue-500 text-white text-sm rounded hover:bg-blue-600 transition-colors">
                                                        ğŸ’¾ í˜„ì¬ ìì‚° ì €ì¥
                                                    </button>
                                                    <div className="px-3 py-2 bg-gray-100 text-gray-600 text-sm rounded text-center">
                                                        íˆìŠ¤í† ë¦¬: {assetHistory.length}ê°œ
                                                    </div>
                                                </div>
                                                <div className="grid grid-cols-2 gap-2">
                                                    <button onClick={exportAssetData} className="px-3 py-2 bg-green-500 text-white text-sm rounded hover:bg-green-600 transition-colors">
                                                        ğŸ“¤ ë°ì´í„° ë‚´ë³´ë‚´ê¸°
                                                    </button>
                                                    <button onClick={importAssetData} className="px-3 py-2 bg-purple-500 text-white text-sm rounded hover:bg-purple-600 transition-colors">
                                                        ğŸ“¥ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <h2 className="text-lg font-semibold mb-4 text-gray-700">ê¸°ë³¸ ì„¤ì •</h2>
                                        <div className="space-y-4">
                                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">ì›”ê¸‰ (ë§Œì›)</label>
                                                    <input type="number" className="w-full border rounded px-3 py-2" value={monthlySalary} onChange={(e) => setMonthlySalary(Number(e.target.value))} />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">ê¸°ì¤€ì›”</label>
                                                    <input type="month" className="w-full border rounded px-3 py-2" value={baseMonth} onChange={(e) => setBaseMonth(e.target.value)} />
                                                </div>
                                            </div>
                                            <div className="bg-blue-50 p-4 rounded-lg">
                                                <h3 className="text-sm font-medium text-blue-700 mb-3">ëª©í‘œ ì„¤ì • ëª¨ë“œ</h3>
                                                <div className="space-y-3">
                                                    <div className="flex items-center">
                                                        <input id="period-mode" type="radio" name="goalMode" value="period" checked={goalMode === 'period'} onChange={(e) => setGoalMode(e.target.value)} className="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" />
                                                        <label htmlFor="period-mode" className="ml-2 block text-sm text-gray-900">ê¸°ê°„ ì„¤ì • ëª¨ë“œ</label>
                                                    </div>
                                                    <div className="flex items-center">
                                                        <input id="target-mode" type="radio" name="goalMode" value="target" checked={goalMode === 'target'} onChange={(e) => setGoalMode(e.target.value)} className="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" />
                                                        <label htmlFor="target-mode" className="ml-2 block text-sm text-gray-900">ëª©í‘œ ìì‚° ëª¨ë“œ</label>
                                                    </div>
                                                </div>
                                            </div>
                                            {goalMode === 'period' ? (
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">ì˜ˆìƒ ê¸°ê°„ (ê°œì›”)</label>
                                                    <input type="number" className="w-full border rounded px-3 py-2" value={projectionMonths} onChange={(e) => setProjectionMonths(Number(e.target.value))} />
                                                </div>
                                            ) : (
                                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                                    <div>
                                                        <label className="block text-sm font-medium text-gray-700 mb-2">ëª©í‘œ ìì‚° (ë§Œì›)</label>
                                                        <input type="number" className="w-full border rounded px-3 py-2" value={targetAmount} onChange={(e) => setTargetAmount(Number(e.target.value))} />
                                                    </div>
                                                    <div className="flex items-end">
                                                        <button onClick={calculateGoalSeek} className="w-full bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">ëª©í‘œ ë‹¬ì„± ê³„ì‚°</button>
                                                    </div>
                                                </div>
                                            )}
                                            {goalSeekResult && (
                                                <div className="mt-4 p-3 bg-green-50 border border-green-200 rounded"><p className="text-green-800 font-medium">{goalSeekResult}</p></div>
                                            )}
                                            <div className="flex flex-wrap gap-2"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* ===== ì‹œë‚˜ë¦¬ì˜¤ ê´€ë¦¬ ===== */}
                        {scenarios.length > 0 && (
                            <div className="bg-white rounded-lg shadow p-6">
                                <div className="flex flex-col lg:flex-row lg:items-start gap-6">
                                    <div className="flex-1">
                                        <h3 className="text-lg font-semibold text-gray-700 mb-4">ì €ì¥ëœ ì‹œë‚˜ë¦¬ì˜¤</h3>
                                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                            {scenarios.map(scenario => (
                                                <div key={scenario.id} className="border rounded-lg p-4">
                                                    <h4 className="font-medium text-gray-900">{scenario.name}</h4>
                                                    <p className="text-sm text-gray-500">{new Date(scenario.createdAt).toLocaleDateString()}</p>
                                                    <div className="mt-2 flex gap-2">
                                                        <button onClick={() => loadScenario(scenario)} className="flex-1 px-3 py-1 rounded text-sm bg-indigo-500 text-white hover:bg-indigo-600">ë¶ˆëŸ¬ì˜¤ê¸°</button>
                                                        <button onClick={() => deleteScenario(scenario.id)} className="px-3 py-1 rounded text-sm bg-rose-500 text-white hover:bg-rose-600">ì‚­ì œ</button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="flex-1">
                                        <h3 className="text-lg font-semibold text-gray-700 mb-3">ì‹œë‚˜ë¦¬ì˜¤ ë¹„êµ (ìµœëŒ€ 3ê°œ)</h3>
                                        <ScenarioCompare scenarios={scenarios} sectorInfo={sectorInfo} />
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* ===== í¬íŠ¸í´ë¦¬ì˜¤ ì°¨íŠ¸ ===== */}
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div className="bg-white rounded-lg shadow p-4">
                                <canvas ref={currentPieRef} height="300"></canvas>
                            </div>
                            <div className="bg-white rounded-lg shadow p-4">
                                <canvas ref={projectedPieRef} height="300"></canvas>
                            </div>
                            <div className="bg-white rounded-lg shadow p-4">
                                <canvas ref={comparisonBarRef} height="300"></canvas>
                            </div>
                        </div>

                        {/* ===== ìì‚° íˆìŠ¤í† ë¦¬ ì°¨íŠ¸ ===== */}
                        {assetHistory.length > 0 && (
                            <div className="bg-white rounded-lg shadow p-6">
                                <h3 className="text-lg font-semibold text-gray-700 mb-4">ğŸ“ˆ ìì‚° íˆìŠ¤í† ë¦¬</h3>
                                <div className="bg-gray-50 rounded-lg p-4">
                                    <canvas ref={historyChartRef} height="200"></canvas>
                                </div>
                                <div className="mt-4 text-sm text-gray-600">
                                    ì´ {assetHistory.length}ê°œì˜ ê¸°ë¡ì´ ìˆìŠµë‹ˆë‹¤. 
                                    ìµœê·¼ ê¸°ë¡: {assetHistory[assetHistory.length - 1]?.date} {assetHistory[assetHistory.length - 1]?.time ? `(${assetHistory[assetHistory.length - 1].time.split(':').slice(0, 2).join(':')})` : ''} ({formatNumber(assetHistory[assetHistory.length - 1]?.netWorth)}ë§Œì›)
                                </div>
                            </div>
                        )}

                        {/* ===== ì›”ë‚©ì… ì˜ˆì‚° ê´€ë¦¬ (ê°œì„ ëœ ê³„ì‚°ì‹ í‘œì‹œ) ===== */}
                        <div className="bg-blue-50 rounded-lg shadow p-6">
                            <h3 className="text-lg font-semibold text-blue-700 mb-4">ğŸ’° ì›”ë‚©ì… ì˜ˆì‚° ê´€ë¦¬</h3>
                            <div className="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-4">
                                <div className="text-center">
                                    <div className="text-sm text-gray-600">ì›”ìˆ˜ì…</div>
                                    <div className="text-xl font-bold text-blue-600">{formatNumber(monthlySalary)}ë§Œì›</div>
                                </div>
                                <div className="text-center">
                                    <div className="text-sm text-gray-600">ì›”ë³„ ì§€ì¶œ</div>
                                    <div className="text-xl font-bold text-red-600">{formatNumber(totalMonthlyExpense)}ë§Œì›</div>
                                </div>
                                <div className="text-center">
                                    <div className="text-sm text-gray-600">ì›”ë‚©ì… ê°€ëŠ¥ì•¡</div>
                                    <div className="text-xl font-bold text-green-600">{formatNumber(maxSectorMonthlyContrib)}ë§Œì›</div>
                                </div>
                                <div className="text-center">
                                    <div className="text-sm text-gray-600">ì›”ë‚©ì… ì‚¬ìš©ì•¡</div>
                                    <div className={`text-xl font-bold ${totalSectorMonthlyContrib > maxSectorMonthlyContrib ? 'text-red-600' : 'text-blue-600'}`}>
                                        {formatNumber(totalSectorMonthlyContrib)}ë§Œì›
                                    </div>
                                </div>
                            </div>
                            
                            {totalSectorMonthlyContrib > maxSectorMonthlyContrib && (
                                <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                                    âš ï¸ ì›”ë‚©ì… í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ì›”ìˆ˜ì…ì™¸ ë‚©ì…ì„ ì´ìš©í•˜ê±°ë‚˜ ì›”ë‚©ì…ì„ ì¤„ì—¬ì£¼ì„¸ìš”.
                                </div>
                            )}
                            
                            {/* ì”ì—¬ì•¡ ê³„ì‚°ì‹ í‘œì‹œ */}
                            <div className="bg-white rounded-lg p-4 mb-4">
                                <h4 className="text-sm font-medium text-gray-700 mb-3">ğŸ’¡ ì”ì—¬ì•¡ ê³„ì‚°ì‹</h4>
                                <div className="text-sm space-y-2">
                                    <div className="flex justify-between">
                                        <span>ì›”ìˆ˜ì…</span>
                                        <span className="font-medium text-blue-600">+{formatNumber(monthlySalary)}ë§Œì›</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span>ì›”ë³„ ì§€ì¶œ</span>
                                        <span className="font-medium text-red-600">-{formatNumber(totalMonthlyExpense)}ë§Œì›</span>
                                    </div>
                                    <hr className="border-gray-200" />
                                    <div className="flex justify-between font-medium">
                                        <span>ì›”ë‚©ì… ê°€ëŠ¥ì•¡</span>
                                        <span className="text-green-600">{formatNumber(maxSectorMonthlyContrib)}ë§Œì›</span>
                                    </div>
                                    <div className="text-xs text-gray-500 mt-2">í˜„ì¬ ì›”ë‚©ì… ì„¤ì •:</div>
                                    {autoDepositBreakdown.map((item, index) => (
                                        <div key={index} className="flex justify-between text-xs">
                                            <span className={`text-${sectorInfo[item.sector]?.color || 'gray'}-600`}>
                                                {sectorInfo[item.sector]?.icon} {item.name}
                                            </span>
                                            <span className="font-medium">-{formatNumber(item.amount)}ë§Œì›</span>
                                        </div>
                                    ))}
                                    <hr className="border-gray-200" />
                                    <div className="flex justify-between font-bold">
                                        <span>ì”ì—¬ì•¡</span>
                                        <span className="text-green-600">{formatNumber(autoDepositAmount)}ë§Œì›</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div className="flex flex-col sm:flex-row items-center justify-between bg-white rounded-lg p-4 gap-4">
                                <div className="text-center sm:text-left">
                                    <div className="text-sm text-gray-600">ì”ì—¬ì•¡</div>
                                    <div className="text-2xl font-bold text-green-600">{formatNumber(autoDepositAmount)}ë§Œì›</div>
                                    <div className="text-xs text-gray-500">
                                    ì›”ë‚©ì… ê°€ëŠ¥ì•¡ {formatNumber(maxSectorMonthlyContrib)}ë§Œì› - ì›”ë‚©ì… ì‚¬ìš©ì•¡ {formatNumber(totalSectorMonthlyContrib)}ë§Œì›
                                    </div>
                                </div>
                                <div className="flex flex-col sm:flex-row items-center gap-2">
                                    <div>
                                        <div className="text-sm text-gray-600 text-center sm:text-left">ì”ì—¬ì•¡ ì…ê¸ˆ í†µì¥</div>
                                        <select className="border rounded px-3 py-2" value={autoDepositAccount} onChange={e => setAutoDepositAccount(e.target.value)}>
                                            {Object.values(assets).flat().filter(item => item.name !== 'ìƒˆ í•­ëª©').map((asset, idx) => (
                                                <option key={idx} value={asset.name}>{asset.name}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <button onClick={applyAutoDeposit} disabled={autoDepositAmount <= 0} className="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 disabled:bg-gray-300 disabled:cursor-not-allowed">
                                        ë°˜ì˜í•˜ê¸°
                                    </button>
                                </div>
                            </div>
                        </div>

                    {/* ===== ë¦¬ë°¸ëŸ°ì‹± ì„¤ì • ===== */}
                    <div className="bg-yellow-50 dark:bg-yellow-900/20 rounded-lg shadow p-6">
                        <h3 className="text-lg font-semibold text-yellow-700 dark:text-yellow-300 mb-2">âš ï¸ ë¦¬ë°¸ëŸ°ì‹± ì„¤ì •</h3>
                        {/* [ì¶”ê°€] JS ë¡œì§: ì´í•© ê³„ì‚° ë° ìë™ì¡°ì • í•¨ìˆ˜ */}
                        {(() => {
                            const validSectors = Object.keys(sectorInfo).filter(k=>k!=='loan');
                            const defaultPct = Math.round(100 / validSectors.length);
                            
                            // [ì¶”ê°€] í˜„ì¬ ì´í•© ê³„ì‚°
                            const totalTarget = validSectors.reduce((sum, key) => {
                                const value = rebalancingTargets[key];
                                // valueê°€ undefinedë‚˜ nullì¼ ê²½ìš° defaultPctë¥¼, 0ì¼ ê²½ìš° 0ì„ ì‚¬ìš©
                                const numericValue = (value === undefined || value === null) ? defaultPct : Number(value);
                                return sum + numericValue;
                            }, 0);

                            // [ì¶”ê°€] 100% ìë™ì¡°ì • í•¨ìˆ˜
                            const handleNormalize = () => {
                                if (totalTarget === 0) return;
                                const newTargets = {};
                                validSectors.forEach(key => {
                                    const value = rebalancingTargets[key];
                                    const currentVal = (value === undefined || value === null) ? defaultPct : Number(value);
                                    newTargets[key] = Math.round((currentVal / totalTarget) * 100);
                                });

                                // 100% ë§ì¶”ê¸° (ê°€ì¥ í° í•­ëª©ì— ì˜¤ì°¨ ëª°ì•„ì£¼ê¸°)
                                const finalTotal = Object.values(newTargets).reduce((s, v) => s + v, 0);
                                const diff = 100 - finalTotal;
                                if (diff !== 0) {
                                    const maxKey = Object.keys(newTargets).reduce((a, b) => newTargets[a] > newTargets[b] ? a : b);
                                    newTargets[maxKey] += diff;
                                }
                                setRebalancingTargets(newTargets);
                            };

                            return (
                                <>
                                    {/* [ì¶”ê°€] ë‹¨ì¼ ëˆ„ì  ë§‰ëŒ€ ê·¸ë˜í”„ */}
                                    <StackedBarDisplay targets={rebalancingTargets} sectorInfo={sectorInfo} />

                                    <div className="mb-4 grid grid-cols-1 lg:grid-cols-3 gap-4 text-sm">
                                        <div className="flex items-center gap-4">
                                            <label className="inline-flex items-center gap-2 text-gray-700 dark:text-gray-200">
                                                <input type="radio" name="reb-mode" className="h-4 w-4" checked={rebalancingMode==='simple'} onChange={() => setRebalancingMode('simple')} />
                                                ê°„ë‹¨ ëª¨ë“œ (ê³µí†µ ì„ê³„ê°’)
                                            </label>
                                            <label className="inline-flex items-center gap-2 text-gray-700 dark:text-gray-200">
                                                <input type="radio" name="reb-mode" className="h-4 w-4" checked={rebalancingMode==='advanced'} onChange={() => setRebalancingMode('advanced')} />
                                                ì‹¬í™” ëª¨ë“œ (ì„¹í„°ë³„ ì„ê³„ê°’)
                                            </label>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <span className="text-gray-700 dark:text-gray-200 whitespace-nowrap">ê³µí†µ ì„ê³„ê°’</span>
                                            <label className="text-xs text-gray-600 dark:text-gray-300">ê²½ê³ </label>
                                            <input type="number" className="w-16 border rounded px-2 py-1 text-sm bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={simpleThresholds.warning} onChange={(e)=> setSimpleThresholds(prev=>({...prev, warning: Number(e.target.value)}))} disabled={rebalancingMode!=='simple'} />
                                            <label className="text-xs text-gray-600 dark:text-gray-300">ìœ„í—˜</label>
                                            <input type="number" className="w-16 border rounded px-2 py-1 text-sm bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={simpleThresholds.danger} onChange={(e)=> setSimpleThresholds(prev=>({...prev, danger: Number(e.target.value)}))} disabled={rebalancingMode!=='simple'} />
                                        </div>
                                        {/* [ìˆ˜ì •] ì´í•© í‘œì‹œ ë° ìë™ì¡°ì • ë²„íŠ¼ */}
                                        <div className="flex items-center gap-2">
                                            <span className="text-gray-700 dark:text-gray-200 whitespace-nowrap">ëª©í‘œ ë¹„ì¤‘ ì´í•©:</span>
                                            <span className={`font-bold ${totalTarget !== 100 ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400'}`}>
                                                {totalTarget}%
                                            </span>
                                            <button 
                                                onClick={handleNormalize} 
                                                className="ml-2 px-3 py-1 bg-yellow-600 text-white text-xs rounded hover:bg-yellow-700 disabled:bg-gray-400"
                                                disabled={totalTarget === 100}
                                            >
                                                100% ìë™ì¡°ì •
                                            </button>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                        {validSectors.map(sectorKey => {
                                            const currentValue = rebalancingTargets[sectorKey] ?? defaultPct;
                                            return (
                                                <div key={sectorKey} className="bg-white dark:bg-gray-800 rounded-lg p-4">
                                                    <h4 className="font-medium text-gray-900 dark:text-white mb-2">{sectorInfo[sectorKey].icon} {sectorInfo[sectorKey].name}</h4>
                                                    <div className="space-y-2">
                                                        {/* [ìˆ˜ì •] ê¸°ì¡´ ìˆ«ì ì…ë ¥ ë°©ì‹ ìœ ì§€ */}
                                                        <div className="flex items-center gap-2">
                                                            <label className="block text-xs text-gray-600 dark:text-gray-300 whitespace-nowrap">ëª©í‘œ ë¹„ì¤‘ (%)</label>
                                                            <input 
                                                                type="number" 
                                                                min="0" 
                                                                max="100" 
                                                                step="1"
                                                                className="w-full border rounded px-2 py-1 text-sm bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" 
                                                                value={currentValue} 
                                                                onChange={(e)=> setRebalancingTargets(prev=> ({ ...prev, [sectorKey]: Number(e.target.value) }))} 
                                                            />
                                                        </div>
                                                        {rebalancingMode==='advanced' && (
                                                            <>
                                                                <div>
                                                                    <label className="block text-xs text-gray-600 dark:text-gray-300">ê²½ê³  ì„ê³„ê°’ (í¸ì°¨ %)</label>
                                                                    <input type="number" className="w-full border rounded px-2 py-1 text-sm bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={rebalancingAlerts[sectorKey]?.warning ?? 5} onChange={(e)=> updateRebalancingAlert(sectorKey, 'warning', e.target.value)} />
                                                                </div>
                                                                <div>
                                                                    <label className="block text-xs text-gray-600 dark:text-gray-300">ìœ„í—˜ ì„ê³„ê°’ (í¸ì°¨ %)</label>
                                                                    <input type="number" className="w-full border rounded px-2 py-1 text-sm bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={rebalancingAlerts[sectorKey]?.danger ?? 10} onChange={(e)=> updateRebalancingAlert(sectorKey, 'danger', e.target.value)} />
                                                                </div>
                                                            </>
                                                        )}
                                                    </div>
                                                </div>
                                            )
                                        })}
                                    </div>
                                </>
                            );
                        })()}
                    </div>

                        {/* ===== ì„¹í„°ë³„ ìì‚° ê´€ë¦¬ ===== */}
                        {Object.keys(sectorInfo).map(sectorKey => (
                            <div key={sectorKey} className={`bg-${sectorInfo[sectorKey].color}-50 rounded-lg shadow p-6`}>
                <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                    <button type="button" onClick={()=> setHiddenSectors(prev=> ({...prev, [sectorKey]: !prev[sectorKey]}))} className={`text-left text-xl font-semibold text-${sectorInfo[sectorKey].color}-700 flex items-center gap-2`}>
                                        <span>{sectorInfo[sectorKey].icon}</span>
                                        {sectorInfo[sectorKey].name}
                                        <span className="text-sm bg-white px-2 py-1 rounded">
                                            í˜„ì¬: {formatPercent(currentSectorTotals[sectorKey]?.percentage || 0)}% â†’ 
                                            ì˜ˆìƒ: {formatPercent(projectedSectorTotals[sectorKey]?.percentage || 0)}%
                                        </span>
                        <span className="ml-2 text-xs text-gray-500">{hiddenSectors[sectorKey] ? '(ì ‘í˜)' : '(í¼ì¹¨)'}</span>
                    </button>
                    <div className="flex items-center gap-2">
                        <button onClick={() => addAsset(sectorKey)} className={`bg-${sectorInfo[sectorKey].color}-500 text-white px-4 py-2 rounded hover:bg-${sectorInfo[sectorKey].color}-600 whitespace-nowrap`}>
                            + í•­ëª© ì¶”ê°€
                        </button>
                    </div>
                                </div>
                {!hiddenSectors[sectorKey] && (
                <div className="space-y-4">
                                    {assets[sectorKey]?.map((asset, index) => {
                                        const projectedAmount = calculation.projected[sectorKey]?.[index]?.amount || 0;
                                        const sectorTotal = projectedSectorTotals[sectorKey]?.amount || 1;
                                        const assetPercentage = (projectedAmount / sectorTotal * 100);
                                        
                                        // TO-BE (assets[sectorKey]?.map ë‚´ë¶€)
                                        return (
                                            <div key={index} className="bg-white dark:bg-gray-800 rounded-lg p-4 shadow-sm">
                                                {/* [ìˆ˜ì •] ëŒ€ì¶œ(loan)ê³¼ ê·¸ ì™¸ ìì‚°ì„ ë¶„ê¸° ì²˜ë¦¬ */}

                                                {/* === ìì‚°/ê¸°íƒ€ í•­ëª© (ëŒ€ì¶œ ì œì™¸) === */}
                                                {sectorKey !== 'loan' && (
                                                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-8 gap-3 items-center">
                                                        <input type="text" placeholder="í•­ëª©ëª…" className="border rounded px-2 py-1 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={asset.name} onChange={(e) => updateAsset(sectorKey, index, 'name', e.target.value)} />
                                                        <div>
                                                            <label className="block text-xs text-gray-500 dark:text-gray-400">í˜„ì¬ê¸ˆì•¡</label>
                                                            <input type="number" className="w-full border rounded px-2 py-1 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={asset.amount} onChange={(e) => updateAsset(sectorKey, index, 'amount', e.target.value)} />
                                                        </div>
                                                        <div>
                                                            <label className="block text-xs text-gray-500 dark:text-gray-400">ìˆ˜ìµë¥ (%)</label>
                                                            <input type="number" step="0.1" className="w-full border rounded px-2 py-1 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={asset.rate} onChange={(e) => updateAsset(sectorKey, index, 'rate', e.target.value)} />
                                                        </div>
                                                        <div>
                                                            <label className="block text-xs text-gray-500 dark:text-gray-400">ìˆ˜ìˆ˜ë£Œ/ì„¸ê¸ˆ(%)</label>
                                                            <input type="number" step="0.001" className="w-full border rounded px-2 py-1 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={asset.feeRate ?? 0} onChange={(e) => updateAsset(sectorKey, index, 'feeRate', e.target.value)} />
                                                        </div>
                                                        <div>
                                                            <label className="block text-xs text-gray-500 dark:text-gray-400">ì›”ë‚©ì…</label>
                                                            <input type="number" className="w-full border rounded px-2 py-1 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={asset.monthlyContrib} onChange={(e) => updateAsset(sectorKey, index, 'monthlyContrib', e.target.value)} />
                                                        </div>
                                                        <div>
                                                            <label className="block text-xs text-gray-500 dark:text-gray-400">ì›”ìˆ˜ì…ì™¸ ë‚©ì…</label>
                                                            <input type="number" min="0" className="w-full border rounded px-2 py-1 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={asset.extraContrib} onChange={(e) => updateAsset(sectorKey, index, 'extraContrib', e.target.value)} />
                                                        </div>
                                                        {asset.extraContrib > 0 && (
                                                            <div>
                                                                <label className="block text-xs text-gray-500 dark:text-gray-400">ì¶œê¸ˆê³„ì¢Œ</label>
                                                                <select className="w-full border rounded px-2 py-1 text-xs bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={asset.extraFrom} onChange={(e) => updateAsset(sectorKey, index, 'extraFrom', e.target.value)}>
                                                                    {Object.values(assets).flat().filter(a => a.name !== asset.name).map((d, i) => (
                                                                        <option key={i} value={d.name}>{d.name}</option>
                                                                    ))}
                                                                </select>
                                                            </div>
                                                        )}
                                                        <div className="text-sm">
                                                            <div className="text-gray-600 dark:text-gray-300">ì˜ˆìƒ: {formatNumber(projectedAmount)}ë§Œì›</div>
                                                            <div className={`text-gray-500 dark:text-gray-400`}>
                                                                ë¹„ì¤‘: <span className={`${(() => {
                                                                    const validSectorTotal = projectedSectorTotals[sectorKey]?.amount || 0;
                                                                    const assetPercentage = (validSectorTotal > 0) ? (projectedAmount / validSectorTotal * 100) : 0;
                                                                    const target = rebalancingTargets[sectorKey] ?? Math.round(100 / Object.keys(sectorInfo).length);
                                                                    const diff = Math.abs(assetPercentage - target);
                                                                    const warn = (rebalancingMode==='simple' ? simpleThresholds.warning : (rebalancingAlerts[sectorKey]?.warning ?? 5));
                                                                    const danger = (rebalancingMode==='simple' ? simpleThresholds.danger : (rebalancingAlerts[sectorKey]?.danger ?? 10));
                                                                    if (diff >= danger) return 'text-red-500';
                                                                    if (diff >= warn) return 'text-yellow-500';
                                                                    return 'text-green-600 dark:text-green-400';
                                                                })()}`}>{
                                                                    (() => {
                                                                        const validSectorTotal = projectedSectorTotals[sectorKey]?.amount || 0;
                                                                        const assetPercentage = (validSectorTotal > 0) ? (projectedAmount / validSectorTotal * 100) : 0;
                                                                        return formatPercent(assetPercentage);
                                                                    })()
                                                                }%</span>
                                                            </div>
                                                        </div>
                                                        <button onClick={() => removeAsset(sectorKey, index)} className="text-red-500 hover:text-red-700 whitespace-nowrap">ì‚­ì œ</button>
                                                    </div>
                                                )}

                                                {/* === ëŒ€ì¶œ ì „ìš© í•­ëª© === */}
                                                {sectorKey === 'loan' && (
                                                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-8 gap-3 items-center">
                                                        {/* í•­ëª©ëª… */}
                                                        <input type="text" placeholder="í•­ëª©ëª…" className="border rounded px-2 py-1 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={asset.name} onChange={(e) => updateAsset(sectorKey, index, 'name', e.target.value)} />
                                                        {/* í˜„ì¬ì”ì•¡ */}
                                                        <div>
                                                            <label className="block text-xs text-gray-500 dark:text-gray-400">í˜„ì¬ì”ì•¡</label>
                                                            <input type="number" className="w-full border rounded px-2 py-1 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={asset.amount} onChange={(e) => updateAsset(sectorKey, index, 'amount', e.target.value)} />
                                                        </div>
                                                        {/* ì´ììœ¨ */}
                                                        <div>
                                                            <label className="block text-xs text-gray-500 dark:text-gray-400">ì´ììœ¨(%)</label>
                                                            <input type="number" step="0.1" className="w-full border rounded px-2 py-1 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={asset.rate} onChange={(e) => updateAsset(sectorKey, index, 'rate', e.target.value)} />
                                                        </div>
                                                        {/* ì›” ìƒí™˜ì•¡ */}
                                                        <div>
                                                            <label className="block text-xs text-gray-500 dark:text-gray-400">ì›” ìƒí™˜ì•¡</label>
                                                            <input type="number" className="w-full border rounded px-2 py-1 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={asset.monthlyContrib} onChange={(e) => updateAsset(sectorKey, index, 'monthlyContrib', e.target.value)} />
                                                        </div>
                                                        {/* ìƒí™˜ë°©ì‹ */}
                                                        <div>
                                                            <label className="block text-xs text-gray-500 dark:text-gray-400">ìƒí™˜ë°©ì‹</label>
                                                            <select 
                                                                className="w-full border rounded px-2 py-1 text-xs bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" 
                                                                value={asset.repaymentMethod} 
                                                                onChange={(e) => updateAsset(sectorKey, index, 'repaymentMethod', e.target.value)}
                                                            >
                                                                <option value="ì›ë¦¬ê¸ˆê· ë“±">ì›ë¦¬ê¸ˆê· ë“±</option>
                                                                <option value="ì›ê¸ˆê· ë“±">ì›ê¸ˆê· ë“±</option>
                                                                <option value="ë§Œê¸°ì¼ì‹œ">ë§Œê¸°ì¼ì‹œ</option>
                                                            </select>
                                                        </div>
                                                        {/* ìƒí™˜ê³„ì¢Œ (ì›”) */}
                                                        <div>
                                                            <label className="block text-xs text-gray-500 dark:text-gray-400">ìƒí™˜ê³„ì¢Œ (ì›”)</label>
                                                            <select 
                                                                className="w-full border rounded px-2 py-1 text-xs bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" 
                                                                value={asset.repaymentAccount} 
                                                                onChange={(e) => updateAsset(sectorKey, index, 'repaymentAccount', e.target.value)}
                                                            >
                                                                {Object.values(assets).flat().filter(a => a.name !== asset.name).map((d, i) => (
                                                                    <option key={i} value={d.name}>{d.name}</option>
                                                                ))}
                                                            </select>
                                                        </div>
                                                        {/* ì¶”ê°€ ìƒí™˜ì•¡ */}
                                                        <div>
                                                            <label className="block text-xs text-gray-500 dark:text-gray-400">ì¶”ê°€ ìƒí™˜ (ì›”ìˆ˜ì…ì™¸)</label>
                                                            <input type="number" min="0" className="w-full border rounded px-2 py-1 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={asset.extraContrib} onChange={(e) => updateAsset(sectorKey, index, 'extraContrib', e.target.value)} />
                                                        </div>
                                                        {/* ì¶”ê°€ ìƒí™˜ê³„ì¢Œ */}
                                                        {asset.extraContrib > 0 && (
                                                            <div>
                                                                <label className="block text-xs text-gray-500 dark:text-gray-400">ì¶œê¸ˆê³„ì¢Œ (ì¶”ê°€)</label>
                                                                <select className="w-full border rounded px-2 py-1 text-xs bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={asset.extraFrom} onChange={(e) => updateAsset(sectorKey, index, 'extraFrom', e.target.value)}>
                                                                    {Object.values(assets).flat().filter(a => a.name !== asset.name).map((d, i) => (
                                                                        <option key={i} value={d.name}>{d.name}</option>
                                                                    ))}
                                                                </select>
                                                            </div>
                                                        )}
                                                        {/* ì˜ˆìƒì”ì•¡ ë° ì‚­ì œ */}
                                                        <div className="text-sm">
                                                            <div className="text-gray-600 dark:text-gray-300">ì˜ˆìƒì”ì•¡: {formatNumber(projectedAmount)}ë§Œì›</div>
                                                        </div>
                                                        <button onClick={() => removeAsset(sectorKey, index)} className="text-red-500 hover:text-red-700 whitespace-nowrap">ì‚­ì œ</button>
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                                )}
                            </div>
                        ))}

                        {/* ===== ì›”ë³„ ì§€ì¶œ ê´€ë¦¬ ===== */}
                        <div className="bg-red-50 rounded-lg shadow p-6">
                            <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                                <h2 className="text-xl font-semibold text-red-700 flex items-center gap-2">ğŸ’¸ ì›”ë³„ ì§€ì¶œ</h2>
                                <button onClick={addExpense} className="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 whitespace-nowrap">+ ì§€ì¶œ ì¶”ê°€</button>
                            </div>
                            <div className="space-y-3">
                                {monthlyExpenses.map((expense, index) => (
                                    <div key={index} className="bg-white rounded-lg p-3 shadow-sm">
                                        <div className="grid grid-cols-1 sm:grid-cols-4 gap-3 items-center">
                                            <input type="text" placeholder="ì§€ì¶œëª…" className="border rounded px-2 py-1" value={expense.name} onChange={(e) => updateExpense(index, 'name', e.target.value)} />
                                            <input type="number" placeholder="ê¸ˆì•¡(ë§Œì›)" className="border rounded px-2 py-1" value={expense.amount} onChange={(e) => updateExpense(index, 'amount', e.target.value)} />
                                            <div className="text-sm text-gray-600">ì—°ê°„: {formatNumber(expense.amount * projectionMonths)}ë§Œì›</div>
                                            <button onClick={() => removeExpense(index)} className="text-red-500 hover:text-red-700 whitespace-nowrap">ì‚­ì œ</button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* ===== ì´ë²¤íŠ¸ì„± ìˆ˜ì… ê´€ë¦¬ ===== */}
<div className="bg-green-50 rounded-lg shadow p-6">
    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
        <h2 className="text-xl font-semibold text-green-700 flex items-center gap-2">ğŸ’° ì´ë²¤íŠ¸ì„± ìˆ˜ì… (ì„±ê³¼ê¸‰, ìš©ëˆ ë“±)</h2>
        <button onClick={addIncomeEvent} className="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 whitespace-nowrap">+ ìˆ˜ì… ì´ë²¤íŠ¸ ì¶”ê°€</button>
    </div>
    <div className="text-xs text-gray-600 mb-4 bg-white p-3 rounded-lg border border-green-100">
        ğŸ’¡ í•­ëª© ì„¤ëª…: ì´ë²¤íŠ¸ëª… | ê¸ˆì•¡ | ì‹œì‘ ì›” | ì¢…ë£Œ ì›” | ì…ê¸ˆì²˜(ì„¹í„°/ê³„ì¢Œ)
        <div className="mt-1 text-gray-500">
            ì˜ˆ: 3~8ê°œì›” ì…ë ¥ ì‹œ, ê¸°ì¤€ì›” ê¸°ì¤€ <strong>{(() => { 
                try { 
                    const baseMonthStr = baseMonth || '';
                    if (!baseMonthStr) return 'ê¸°ì¤€ì›” ì„¤ì • í•„ìš”';
                    const [y,m] = baseMonthStr.split('-').map(Number);
                    if (!y || !m) return 'ê¸°ì¤€ì›” í˜•ì‹ ì˜¤ë¥˜';
                    const d = new Date(y, m-1, 1);
                    if (isNaN(d.getTime())) return 'ë‚ ì§œ ê³„ì‚° ì˜¤ë¥˜';
                    const fmt = (dt) => `${String(dt.getFullYear()).slice(2)}ë…„ ${String(dt.getMonth()+1).padStart(2,'0')}ì›”`;
                    const s = new Date(d);
                    s.setMonth(s.getMonth() + 3);
                    const e = new Date(d);
                    e.setMonth(e.getMonth() + 8);
                    if (isNaN(s.getTime()) || isNaN(e.getTime())) return 'ë‚ ì§œ ê³„ì‚° ì˜¤ë¥˜';
                    return `${fmt(s)}ë¶€í„° ${fmt(e)}ê¹Œì§€`;
                } catch (error) { 
                    console.error('Date calculation error:', error);
                    return 'ë‚ ì§œ ê³„ì‚° ì˜¤ë¥˜';
                } 
            })()}</strong>
        </div>
    </div>
    <div className="space-y-4">
        {incomeEvents && incomeEvents.length > 0 ? incomeEvents.map((event, index) => {
            // ì´ë²¤íŠ¸ ë°ì´í„° ê²€ì¦
            if (!event || typeof event !== 'object') {
                console.warn('Invalid event data at index:', index);
                return null;
            }
            
            return (
            <div key={index} className="bg-white rounded-lg p-4 shadow-sm border">
                {/* Changed: ì¼ê´€ì„±ì„ ìœ„í•´ 8ì—´ ê·¸ë¦¬ë“œ ì‹œìŠ¤í…œìœ¼ë¡œ í†µì¼í•˜ê³  ë°˜ì‘í˜• ê°œì„  */}
                <div className="grid grid-cols-1 md:grid-cols-4 lg:grid-cols-8 gap-4 items-end">
                    {/* --- ì´ë²¤íŠ¸ëª… --- */}
                    <div className="md:col-span-2 lg:col-span-2">
                        <label className="block text-sm font-medium text-gray-700 mb-1">ì´ë²¤íŠ¸ëª…</label>
                        <input type="text" placeholder="ì´ë²¤íŠ¸ëª…" className="w-full border rounded-md px-3 py-2" value={event.name} onChange={(e) => updateIncomeEvent(index, 'name', e.target.value)} />
                    </div>
                    {/* --- ê¸ˆì•¡ --- */}
                    <div className="md:col-span-2 lg:col-span-1">
                        <label className="block text-sm font-medium text-gray-700 mb-1">ê¸ˆì•¡</label>
                        <input type="number" placeholder="ê¸ˆì•¡" className="w-full border rounded-md px-3 py-2" value={event.amount} onChange={(e) => updateIncomeEvent(index, 'amount', e.target.value)} />
                    </div>
                    {/* --- ì‹œì‘ ì›” --- */}
                    <div className="md:col-span-2 lg:col-span-1">
                        <label className="block text-sm font-medium text-gray-700 mb-1">ì‹œì‘ ì›”</label>
                        <input type="number" placeholder="ê°œì›”ì°¨" className="w-full border rounded-md px-3 py-2" value={event.startMonth} onChange={(e) => updateIncomeEvent(index, 'startMonth', e.target.value)} />
                        
                        {/* ğŸ‘‡ [ì¶”ê°€] ì´ divë¥¼ input ë°”ë¡œ ì•„ë˜ì— ë‹¤ì‹œ ì¶”ê°€í•©ë‹ˆë‹¤. */}
                        <div className="text-xs text-gray-500 mt-1">{(() => { 
                            try { 
                                const [y,m] = (baseMonth||'').split('-').map(Number);
                                const d = new Date(y, m-1, 1);
                                const s = new Date(d);
                                s.setMonth(s.getMonth() + Number(event.startMonth || 0) - 1); // ğŸ‘ˆ [ê°œì„ ] -1 ì¶”ê°€
                                return `${String(s.getFullYear()).slice(2)}ë…„ ${String(s.getMonth()+1).padStart(2,'0')}ì›” ë¶€í„°`;
                            } catch { return ''; } 
                        })()}</div>

                    </div>
                    {/* --- ì¢…ë£Œ ì›” --- */}
                    <div className="md:col-span-2 lg:col-span-1">
                        <label className="block text-sm font-medium text-gray-700 mb-1">ì¢…ë£Œ ì›”</label>
                        <input type="number" placeholder="ê°œì›”ì°¨" className="w-full border rounded-md px-3 py-2" value={event.endMonth} onChange={(e) => updateIncomeEvent(index, 'endMonth', e.target.value)} />

                        {/* ğŸ‘‡ [ì¶”ê°€] ì´ divë„ input ë°”ë¡œ ì•„ë˜ì— ë‹¤ì‹œ ì¶”ê°€í•©ë‹ˆë‹¤. */}
                        <div className="text-xs text-gray-500 mt-1">{(() => { 
                            try { 
                                const [y,m] = (baseMonth||'').split('-').map(Number);
                                const d = new Date(y, m-1, 1);
                                const e = new Date(d);
                                e.setMonth(e.getMonth() + Number(event.endMonth || 0) - 1); // ğŸ‘ˆ [ê°œì„ ] -1 ì¶”ê°€
                                return `${String(e.getFullYear()).slice(2)}ë…„ ${String(e.getMonth()+1).padStart(2,'0')}ì›” ê¹Œì§€`;
                            } catch { return ''; } 
                        })()}</div>

                    </div>
                    {/* --- ì…ê¸ˆì²˜ --- */}
                    <div className="md:col-span-3 lg:col-span-2">
                        <label className="block text-sm font-medium text-gray-700 mb-1">ì…ê¸ˆì²˜</label>
                        <div className="grid grid-cols-2 gap-2">
                            <select className="w-full border rounded-md px-3 py-2" value={event.targetSector} onChange={(e) => updateIncomeEvent(index, 'targetSector', e.target.value)}>
                                {Object.keys(sectorInfo).map(key => (
                                    <option key={key} value={key}>{sectorInfo[key].name}</option>
                                ))}
                            </select>
                            <select className="w-full border rounded-md px-3 py-2" value={event.targetAsset} onChange={(e) => updateIncomeEvent(index, 'targetAsset', e.target.value)}>
                                {assets[event.targetSector]?.map((asset, assetIndex) => (
                                    <option key={assetIndex} value={assetIndex}>{asset.name}</option>
                                ))}
                            </select>
                        </div>
                    </div>
                    {/* --- ì‚­ì œ ë²„íŠ¼ --- */}
                    <div className="md:col-span-1 lg:col-span-1 flex items-end justify-center h-full">
                        <button onClick={() => removeIncomeEvent(index)} className="text-red-500 hover:text-red-700 font-medium whitespace-nowrap">ì‚­ì œ</button>
                    </div>
                </div>
            </div>
            );
        }) : (
            <div className="text-center text-gray-500 py-8">
                <p>ì´ë²¤íŠ¸ì„± ìˆ˜ì…ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                <p className="text-sm">ìœ„ì˜ "+ ìˆ˜ì… ì´ë²¤íŠ¸ ì¶”ê°€" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì¶”ê°€í•˜ì„¸ìš”.</p>
            </div>
        )}
    </div>
</div>

{/* ===== ì´ë²¤íŠ¸ì„± ì§€ì¶œ ê´€ë¦¬ ===== */}
<div className="bg-orange-50 rounded-lg shadow p-6">
    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
        <h2 className="text-xl font-semibold text-orange-700 flex items-center gap-2">ğŸ›’ ì´ë²¤íŠ¸ì„± ì§€ì¶œ (ì—¬í–‰, ëŒ€í˜•êµ¬ë§¤ ë“±)</h2>
        <button onClick={addExpenseEvent} className="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 whitespace-nowrap">+ ì§€ì¶œ ì´ë²¤íŠ¸ ì¶”ê°€</button>
    </div>
    <div className="text-xs text-gray-600 mb-4 bg-white p-3 rounded-lg border border-orange-100">
        ğŸ’¡ í•­ëª© ì„¤ëª…: ì´ë²¤íŠ¸ëª… | ê¸ˆì•¡ | ì‹œì‘ ì›” | ì¢…ë£Œ ì›” | ì¶œê¸ˆì²˜(ì„¹í„°/ê³„ì¢Œ)
        <div className="mt-1 text-gray-500">
            ì˜ˆ: 2~5ê°œì›” ì…ë ¥ ì‹œ, ê¸°ì¤€ì›” ê¸°ì¤€ <strong>{(() => { try { const [y,m]= (baseMonth||'').split('-').map(Number); const d=new Date(y||new Date().getFullYear(),(m||1)-1,1); const fmt=(dt)=> `${String(dt.getFullYear()).slice(2)}ë…„ ${String(dt.getMonth()+1).padStart(2,'0')}ì›”`; const s=new Date(d); s.setMonth(s.getMonth()+2); const e=new Date(d); e.setMonth(e.getMonth()+5); return `${fmt(s)}ë¶€í„° ${fmt(e)}ê¹Œì§€`; } catch { return ''; } })()}</strong>
        </div>
    </div>
    <div className="space-y-4">
        {expenseEvents.map((event, index) => (
            <div key={index} className="bg-white rounded-lg p-4 shadow-sm border">
                {/* Changed: ìˆ˜ì… ë¶€ë¶„ê³¼ ë™ì¼í•œ 8ì—´ ê·¸ë¦¬ë“œ ì‹œìŠ¤í…œìœ¼ë¡œ í†µì¼ */}
                <div className="grid grid-cols-1 md:grid-cols-4 lg:grid-cols-8 gap-4 items-end">
                    {/* --- ì´ë²¤íŠ¸ëª… --- */}
                    <div className="md:col-span-2 lg:col-span-2">
                        <label className="block text-sm font-medium text-gray-700 mb-1">ì´ë²¤íŠ¸ëª…</label>
                        <input type="text" placeholder="ì´ë²¤íŠ¸ëª…" className="w-full border rounded-md px-3 py-2" value={event.name} onChange={(e) => updateExpenseEvent(index, 'name', e.target.value)} />
                    </div>
                    {/* --- ê¸ˆì•¡ --- */}
                    <div className="md:col-span-2 lg:col-span-1">
                        <label className="block text-sm font-medium text-gray-700 mb-1">ê¸ˆì•¡</label>
                        <input type="number" placeholder="ê¸ˆì•¡" className="w-full border rounded-md px-3 py-2" value={event.amount} onChange={(e) => updateExpenseEvent(index, 'amount', e.target.value)} />
                    </div>
                    {/* --- ì‹œì‘ ì›” --- */}
                    <div className="md:col-span-2 lg:col-span-1">
                        <label className="block text-sm font-medium text-gray-700 mb-1">ì‹œì‘ ì›”</label>
                        <input type="number" placeholder="ê°œì›”ì°¨" className="w-full border rounded-md px-3 py-2" value={event.startMonth} onChange={(e) => updateExpenseEvent(index, 'startMonth', e.target.value)} />
                        
                        {/* ğŸ‘‡ [ì¶”ê°€] ì´ divë¥¼ input ë°”ë¡œ ì•„ë˜ì— ì¶”ê°€í•©ë‹ˆë‹¤. */}
                        <div className="text-xs text-gray-500 mt-1">{(() => { 
                            try { 
                                const [y,m] = (baseMonth||'').split('-').map(Number);
                                const d = new Date(y, m-1, 1);
                                const s = new Date(d);
                                s.setMonth(s.getMonth() + Number(event.startMonth || 0) - 1); // ğŸ‘ˆ [ê°œì„ ] -1 ì¶”ê°€
                                return `${String(s.getFullYear()).slice(2)}ë…„ ${String(s.getMonth()+1).padStart(2,'0')}ì›” ë¶€í„°`;
                            } catch { return ''; } 
                        })()}</div>

                    </div>
                    {/* --- ì¢…ë£Œ ì›” --- */}
                    <div className="md:col-span-2 lg:col-span-1">
                        <label className="block text-sm font-medium text-gray-700 mb-1">ì¢…ë£Œ ì›”</label>
                        <input type="number" placeholder="ê°œì›”ì°¨" className="w-full border rounded-md px-3 py-2" value={event.endMonth} onChange={(e) => updateExpenseEvent(index, 'endMonth', e.target.value)} />

                        {/* ğŸ‘‡ [ì¶”ê°€] ì´ divë„ input ë°”ë¡œ ì•„ë˜ì— ì¶”ê°€í•©ë‹ˆë‹¤. */}
                        <div className="text-xs text-gray-500 mt-1">{(() => { 
                            try { 
                                const [y,m] = (baseMonth||'').split('-').map(Number);
                                const d = new Date(y, m-1, 1);
                                const e = new Date(d);
                                e.setMonth(e.getMonth() + Number(event.endMonth || 0) - 1); // ğŸ‘ˆ [ê°œì„ ] -1 ì¶”ê°€
                                return `${String(e.getFullYear()).slice(2)}ë…„ ${String(e.getMonth()+1).padStart(2,'0')}ì›” ê¹Œì§€`;
                            } catch { return ''; } 
                        })()}</div>

                    </div>
                    {/* --- ì¶œê¸ˆì²˜ --- */}
                    <div className="md:col-span-3 lg:col-span-2">
                        <label className="block text-sm font-medium text-gray-700 mb-1">ì¶œê¸ˆì²˜</label>
                        <div className="grid grid-cols-2 gap-2">
                            <select className="w-full border rounded-md px-3 py-2" value={event.targetSector || 'deposit'} onChange={(e) => updateExpenseEvent(index, 'targetSector', e.target.value)}>
                                {Object.keys(sectorInfo).map(key => (
                                    <option key={key} value={key}>{sectorInfo[key].name}</option>
                                ))}
                            </select>
                            <select className="w-full border rounded-md px-3 py-2" value={event.targetAsset || 0} onChange={(e) => updateExpenseEvent(index, 'targetAsset', e.target.value)}>
                                {assets[event.targetSector || 'deposit']?.map((asset, assetIndex) => (
                                    <option key={assetIndex} value={assetIndex}>{asset.name}</option>
                                ))}
                            </select>
                        </div>
                    </div>
                    {/* --- ì‚­ì œ ë²„íŠ¼ --- */}
                    <div className="md:col-span-1 lg:col-span-1 flex items-end justify-center h-full">
                        <button onClick={() => removeExpenseEvent(index)} className="text-red-500 hover:text-red-700 font-medium whitespace-nowrap">ì‚­ì œ</button>
                    </div>
                </div>
            </div>
        ))}
    </div>
</div>

                        {/* ===== ìƒì„¸ ë¶„ì„ í…Œì´ë¸” ===== */}
                        <div className="bg-white rounded-lg shadow p-6">
                            <h2 className="text-xl font-semibold text-gray-700 mb-4">ìƒì„¸ ë¶„ì„</h2>
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm">
                                    <thead className="bg-gray-100">
                                        <tr>
                                            <th className="p-3 text-left">ì„¹í„°/í•­ëª©</th>
                                            <th className="p-3 text-right">í˜„ì¬ ê¸ˆì•¡</th>
                                            <th className="p-3 text-right">ì˜ˆìƒ ê¸ˆì•¡</th>
                                            <th className="p-3 text-right">ì¦ê°ë¥ </th>
                                            <th className="p-3 text-right">í˜„ì¬ ë¹„ì¤‘</th>
                                            <th className="p-3 text-right">ì˜ˆìƒ ë¹„ì¤‘</th>
                                            <th className="p-3 text-right">ëª©í‘œ ë¹„ì¤‘</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {Object.keys(sectorInfo).map(sectorKey => {
                                            const current = currentSectorTotals[sectorKey] || { amount: 0, percentage: 0 };
                                            const projected = projectedSectorTotals[sectorKey] || { amount: 0, percentage: 0 };
                                            const growthRate = current.amount > 0 ? ((projected.amount - current.amount) / current.amount * 100) : 0;
                                            const rebalanceStatus = getRebalanceStatus(sectorKey, projected.percentage);
                                            const targetPct = (rebalancingTargets[sectorKey] ?? Math.round(100 / Object.keys(sectorInfo).length));
                                            
                                            return (
                                                <React.Fragment key={sectorKey}>
                                                    <tr className={`border-t bg-${sectorInfo[sectorKey].color}-50 ${rebalanceStatus}`}>
                                                        <td className="p-3 font-semibold">
                                                            {sectorInfo[sectorKey].icon} {sectorInfo[sectorKey].name}
                                                        </td>
                                                        <td className="p-3 text-right">{formatNumber(current.amount)}</td>
                                                        <td className="p-3 text-right">{formatNumber(projected.amount)}</td>
                                                        <td className={`p-3 text-right ${growthRate >= 0 ? 'text-green-600' : 'text-red-600'}`}>{formatPercent(growthRate)}%</td>
                                                        <td className="p-3 text-right">{formatPercent(current.percentage)}%</td>
                                                        <td className="p-3 text-right">{formatPercent(projected.percentage)}%</td>
                                                        <td className="p-3 text-right">{formatPercent(targetPct)}%</td>
                                                    </tr>
                                                    {assets[sectorKey]?.map((asset, idx) => {
                                                        const projectedAmount = calculation.projected[sectorKey]?.[idx]?.amount || 0;
                                                        const assetGrowth = projectedAmount - asset.amount;
                                                        const assetGrowthRate = asset.amount > 0 ? (assetGrowth / asset.amount * 100) : 0;
                                                        const sectorTotal = projected.amount || 1;
                                                        const assetPercentage = (projectedAmount / sectorTotal * 100);
                                                        
                                                        return (
                                                            <tr key={`${sectorKey}-${idx}`} className="border-t bg-gray-50">
                                                                <td className="p-3 pl-8 text-sm">â”” {asset.name}</td>
                                                                <td className="p-3 text-right text-sm">{formatNumber(asset.amount)}</td>
                                                                <td className="p-3 text-right text-sm">{formatNumber(projectedAmount)}</td>
                                                                <td className={`p-3 text-right text-sm ${assetGrowthRate >= 0 ? 'text-green-600' : 'text-red-600'}`}>{formatPercent(assetGrowthRate)}%</td>
                                                                <td className="p-3 text-right text-sm">-</td>
                                                                <td className="p-3 text-right text-sm">{formatPercent(assetPercentage)}%</td>
                                                                <td className="p-3 text-right text-sm">-</td>
                                                            </tr>
                                                        );
                                                    })}
                                                </React.Fragment>
                                            );
                                        })}
                                        <tr className="border-t-2 border-gray-400 bg-gray-100">
                                            <td className="p-3 font-bold">ì´ê³„</td>
                                            <td className="p-3 text-right font-bold">{formatNumber(calculation.currentTotal)}</td>
                                            <td className="p-3 text-right font-bold">{formatNumber(calculation.projectedTotal)}</td>
                                            <td className="p-3 text-right font-bold text-green-600">{formatPercent(calculation.growth / calculation.currentTotal * 100)}%</td>
                                            <td className="p-3 text-right font-bold">100.0%</td>
                                            <td className="p-3 text-right font-bold">100.0%</td>
                                            <td className="p-3 text-right font-bold">100.0%</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                        </div>

                        {/* ===== ê°€ì •ì‚¬í•­ ===== */}
                        <div className="bg-blue-50 rounded-lg p-4 text-sm text-gray-700">
                            <h3 className="font-semibold mb-2">ğŸ’¡ ê³„ì‚° ê°€ì •ì‚¬í•­</h3>
                            <ul className="list-disc list-inside space-y-1">
                                <li>ìˆ˜ìµë¥ ì€ ì›”ë³µë¦¬ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.</li>
                                <li>{applyTax ? 'ë°°ë‹¹ì†Œë“ì„¸(15.4%) í¬í•¨ ì„¸í›„ ìˆ˜ìµë¥  ì ìš©' : 'ë°°ë‹¹ì†Œë“ì„¸ ì œì™¸ ì„¸ì „ ìˆ˜ìµë¥  ì ìš©'}</li>
                                <li>ì´ë²¤íŠ¸ì„± ìˆ˜ì…ì€ ì§€ì •ëœ ê³„ì¢Œì— ì…ê¸ˆë˜ë©°, ì´ë²¤íŠ¸ì„± ì§€ì¶œì€ ìƒí™œë¹„í†µì¥ì—ì„œ ì°¨ê°ë©ë‹ˆë‹¤.</li>
                                <li>ì›”ìˆ˜ì…ì™¸ ë‚©ì…ì€ ì§€ì •ëœ ì¶œê¸ˆí†µì¥ì—ì„œ ì°¨ê°ë©ë‹ˆë‹¤.</li>
                                <li>ë¦¬ë°¸ëŸ°ì‹±: ê²½ê³ (ë…¸ë€ìƒ‰), ìœ„í—˜(ë¹¨ê°„ìƒ‰) ì„ê³„ê°’ì— ë”°ë¼ í‘œì‹œë©ë‹ˆë‹¤.</li>
                            </ul>
                        </div>

                        {/* ===== ëª¨ë°”ì¼ ë²„íŠ¼ ===== */}
                        <div className="sm:hidden flex flex-col gap-2">
                            <button onClick={saveToPDF} className="w-full bg-blue-600 text-white py-3 rounded-lg font-medium">
                                ğŸ“„ PDFë¡œ ì €ì¥
                            </button>
                            <button onClick={saveScenario} className="w-full bg-gray-600 text-white py-3 rounded-lg font-medium">
                                ğŸ’¾ ì‹œë‚˜ë¦¬ì˜¤ ì €ì¥
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const ScenarioCompare = ({ scenarios, sectorInfo }) => {
            const [selectedIds, setSelectedIds] = React.useState([]);
            const toggle = (id) => setSelectedIds(prev => prev.includes(id) ? prev.filter(x=>x!==id) : (prev.length<3 ? [...prev,id] : prev));

            const selected = scenarios.filter(s => selectedIds.includes(s.id)).slice(0,3);

            const compute = (data) => {
                const months = data.projectionMonths || 12;
                const monthlySalary = data.monthlySalary || 0;
                const monthlyExpenses = data.monthlyExpenses || [];
                const totalMonthlyExpense = monthlyExpenses.reduce((sum, e) => sum + (e.amount || 0), 0);
                const assets = JSON.parse(JSON.stringify(data.assets || {}));
                const incomeEvents = data.incomeEvents || [];
                const expenseEvents = data.expenseEvents || [];
                const monthlyContribSum = Object.values(assets).flat().reduce((s,a)=> s + (a.monthlyContrib||0),0);
                const maxContrib = Math.max(0, monthlySalary - totalMonthlyExpense);
                const autoDepositAmount = Math.max(0, maxContrib - monthlyContribSum);
                for (let m=1; m<=months; m++) {
                    Object.keys(assets).forEach(sector => {
                        assets[sector].forEach(asset => {
                            const feeRate = (asset.feeRate || 0) / 100;
                            let effectiveRate = ((asset.rate || 0) / 100) * (1 - feeRate);
                            asset.amount *= (1 + effectiveRate / 12);
                        });
                    });
                    incomeEvents.forEach(ev => {
                        if (m >= ev.startMonth && m <= ev.endMonth) {
                            const arr = assets[ev.targetSector];
                            if (arr && arr[ev.targetAsset]) arr[ev.targetAsset].amount += ev.amount;
                        }
                    });
                    const living = assets.deposit?.find(d => d.name === 'ìƒí™œë¹„í†µì¥');
                    if (living) {
                        living.amount += monthlySalary;
                        living.amount -= totalMonthlyExpense;
                    }
                    Object.keys(assets).forEach(sector => {
                    assets[sector].forEach(asset => {
                        if (asset.monthlyContrib > 0) {
                            if (sector === 'loan') {
                                asset.amount = Math.max(0, (asset.amount || 0) - asset.monthlyContrib);

                                // ğŸ‘‡ [ê°œì„ ] ì—¬ê¸°ë„ ë©”ì¸ ë¡œì§ì²˜ëŸ¼ ì§€ì •ëœ ìƒí™˜ê³„ì¢Œì—ì„œ ë¹¼ë„ë¡ ìˆ˜ì •
                                const accountName = asset.repaymentAccount || 'ìƒí™œë¹„í†µì¥';
                                const allAccounts = Object.values(assets).flat();
                                const paymentSourceAccount = allAccounts.find(a => a.name === accountName);
                                if (paymentSourceAccount) {
                                    paymentSourceAccount.amount -= asset.monthlyContrib;
                                }

                            } else {
                                asset.amount += asset.monthlyContrib;
                                // ğŸ‘‡ [ê°œì„ ] ëŒ€ì¶œì´ ì•„ë‹ ë•Œë§Œ ìƒí™œë¹„í†µì¥ì—ì„œ ì°¨ê° (else ì•ˆìœ¼ë¡œ ì´ë™)
                                if (living && asset.name !== 'ìƒí™œë¹„í†µì¥') {
                                    living.amount -= asset.monthlyContrib; 
                                }
                            }
                        }
                    });
                });
                    if (autoDepositAmount > 0 && living) {
                        living.amount -= autoDepositAmount; // ë‹¨ìˆœí™” ìœ ì§€
                    }
                    expenseEvents.forEach(ev => {
                        if (m >= ev.startMonth && m <= ev.endMonth && living) {
                            living.amount = Math.max(0, living.amount - ev.amount);
                        }
                    });
                }
                const totals = {};
                Object.keys(assets).forEach(sector => { totals[sector] = (assets[sector]||[]).reduce((s,a)=> s + (a.amount||0), 0); });
                const gross = Object.keys(totals).filter(k=>k!=='loan').reduce((s,k)=> s + (totals[k]||0), 0);
                const grand = Object.keys(totals).reduce((s,k)=> s + (k==='loan' ? -(totals[k]||0) : (totals[k]||0)), 0);
                const percentages = {};
                Object.keys(totals).forEach(sector => { percentages[sector] = (sector!=='loan' && gross>0) ? (totals[sector]/gross*100) : 0; });
                return { assets, totals, gross, grand, percentages };
            };

            const results = selected.map(s => ({ id: s.id, name: s.name, ...compute(s.data) }));

            return (
                <div>
                    <div className="flex flex-wrap gap-2 mb-3">
                        {scenarios.map(s => (
                            <button key={s.id} onClick={() => toggle(s.id)} className={`px-3 py-1 border rounded ${selectedIds.includes(s.id) ? 'bg-blue-50 border-blue-400' : 'hover:bg-gray-50'}`}>{s.name}</button>
                        ))}
                    </div>
                    {results.length > 0 ? (
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm">
                                <thead className="bg-gray-100">
                                    <tr>
                                        <th className="p-3 text-left">ì„¹í„°/í•­ëª©</th>
                                        {results.map(r => (<th key={r.id} className="p-3 text-right">{r.name}</th>))}
                                        {results.length===2 && (
                                            <th className="p-3 text-right">ì°¨ì´(ê¸ˆì•¡/ë¹„ì¤‘)</th>
                                        )}
                                    </tr>
                                </thead>
                                <tbody>
                                    {Object.keys(sectorInfo).map(sectorKey => (
                                        <React.Fragment key={sectorKey}>
                                            <tr className="border-t">
                                                <td className="p-3 font-semibold">{sectorInfo[sectorKey].icon} {sectorInfo[sectorKey].name}</td>
                                                {results.map(r => (
                                                    <td key={r.id} className="p-3 text-right">
                                                        {Math.round((r.totals[sectorKey]||0)).toLocaleString()} ({(r.percentages[sectorKey]||0).toFixed(1)}%)
                                                    </td>
                                                ))}
                                                {results.length===2 && (
                                                    <td className="p-3 text-right text-indigo-700">
                                                        {(() => {
                                                            const a=results[0], b=results[1];
                                                            const diff=(b.totals[sectorKey]||0)-(a.totals[sectorKey]||0);
                                                            const pdiff=(b.percentages[sectorKey]||0)-(a.percentages[sectorKey]||0);
                                                            const sign=diff>=0?'+':'';
                                                            const psign=pdiff>=0?'+':'';
                                                            return `${sign}${Math.round(diff).toLocaleString()} (${psign}${pdiff.toFixed(1)}%)`;
                                                        })()}
                                                    </td>
                                                )}
                                            </tr>
                                            {results[0]?.assets[sectorKey]?.map((item, idx) => (
                                                <tr key={`${sectorKey}-${idx}`} className="border-t bg-gray-50">
                                                    <td className="p-3 pl-8 text-sm">â”” {item.name}</td>
                                                    {results.map(r => (
                                                        <td key={r.id} className="p-3 text-right text-sm">{Math.round((r.assets[sectorKey]?.[idx]?.amount || 0)).toLocaleString()}</td>
                                                    ))}
                                                    {results.length===2 && (
                                                        <td className="p-3 text-right text-sm text-indigo-700">
                                                            {(() => {
                                                                const a=results[0], b=results[1];
                                                                const av=(a.assets[sectorKey]?.[idx]?.amount||0), bv=(b.assets[sectorKey]?.[idx]?.amount||0);
                                                                const diff=bv-av; const sign=diff>=0?'+':'';
                                                                return `${sign}${Math.round(diff).toLocaleString()}`;
                                                            })()}
                                                        </td>
                                                    )}
                                                </tr>
                                            ))}
                                        </React.Fragment>
                                    ))}
                                    <tr className="border-t-2 border-gray-400 bg-gray-100">
                                        <td className="p-3 font-bold">ì´ê³„</td>
                                        {results.map(r => (<td key={r.id} className="p-3 text-right font-bold">{Math.round(r.grand).toLocaleString()} (100.0%)</td>))}
                                        {results.length===2 && (
                                            <td className="p-3 text-right font-bold text-indigo-700">
                                                {(() => { const a=results[0], b=results[1]; const diff=b.grand-a.grand; const sign=diff>=0?'+':''; return `${sign}${Math.round(diff).toLocaleString()} (0.0%)`; })()}
                                            </td>
                                        )}
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    ) : (
                        <div className="text-sm text-gray-500">ë¹„êµí•  ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ìµœëŒ€ 3ê°œ ì„ íƒí•˜ì„¸ìš”.</div>
                    )}
                </div>
            );
        };

     

        // ì—ëŸ¬ ë°”ìš´ë”ë¦¬ ì»´í¬ë„ŒíŠ¸
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }

            componentDidCatch(error, errorInfo) {
                console.error('Error caught by boundary:', error, errorInfo);
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen bg-gray-50 flex flex-col items-center justify-center gap-4 p-4">
                            <div className="text-red-400 text-center max-w-md">
                                <h2 className="text-xl font-bold mb-2">Something went wrong</h2>
                                <p className="text-sm mb-4">An error occurred while rendering the component.</p>
                                <button 
                                    onClick={() => this.setState({ hasError: false, error: null })}
                                    className="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors"
                                >
                                    Try again
                                </button>
                            </div>
                            {this.state.error && (
                                <details className="text-red-300 text-xs max-w-md">
                                    <summary className="cursor-pointer">Error details</summary>
                                    <pre className="mt-2 p-2 bg-red-900/20 rounded overflow-auto">
                                        {this.state.error.message}
                                    </pre>
                                </details>
                            )}
                        </div>
                    );
                }

                return this.props.children;
            }
        }

        ReactDOM.createRoot(document.getElementById('root')).render(
            <ErrorBoundary>
                <AssetDashboard />
            </ErrorBoundary>
        );
    </script>
</body>
</html>
