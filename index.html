<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìì‚° í”Œë˜ë„ˆ</title>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4329438160019487"
     crossorigin="anonymous"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="config.js"></script>
    <script>
        // [ì¶”ê°€] ì‹œìŠ¤í…œ ë‹¤í¬ëª¨ë“œ ì„¤ì • ë¬´ì‹œí•˜ê³  'class' ì „ëµ ì‚¬ìš© (ìˆ˜ë™ í† ê¸€ ì „ìš©)
        if (typeof tailwind !== 'undefined') {
            tailwind.config = tailwind.config || {};
            tailwind.config.darkMode = 'class';
        }
    </script>
    <script src="defaultData.js"></script>
    <script src="utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-gradient@0.6.1/dist/chartjs-plugin-gradient.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // [ì¶”ê°€] ì¸ì•± ë¸Œë¼ìš°ì €(ì¹´ì¹´ì˜¤í†¡) ê°ì§€ ë° ì™¸ë¶€ ë¸Œë¼ìš°ì € ì „í™˜ ìŠ¤í¬ë¦½íŠ¸
        (function() {
            const userAgent = navigator.userAgent.toLowerCase();
            const targetUrl = window.location.href;

            if (userAgent.indexOf('kakaotalk') > -1) {
                if (userAgent.indexOf('android') > -1) {
                    location.href = 'intent://' + targetUrl.replace(/https?:\/\//i, '') + '#Intent;scheme=https;end';
                } else if (userAgent.indexOf('iphone') > -1 || userAgent.indexOf('ipad') > -1) {
                    location.href = 'kakaotalk://web/openExternal?url=' + encodeURIComponent(targetUrl);
                }
            }
        })();
    </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-200">
    <div id="root"></div>

    <script>
        // ===== ê¸°ë³¸ê°’ ì„¤ì • (ì„œë²„/ë¡œì»¬ ì „í™˜ ê°€ëŠ¥) =====
        const USE_SERVER_CONFIG = false; // true: ì„œë²„ì—ì„œ ë¡œë“œ, false: ë¡œì»¬ í•˜ë“œì½”ë”© ì‚¬ìš©

    </script>

    <script type="text/babel">
            const { useState, useMemo, useEffect, useRef } = React;

        // [ì¶”ê°€] ë°ì´í„° ì „ì†¡ ëª¨ë‹¬ ì»´í¬ë„ŒíŠ¸
        const DataTransferModal = ({ isOpen, onClose, onConfirm, type, initialSelection }) => {
            const [selectedItems, setSelectedItems] = useState(initialSelection || { appData: true, scenarios: true, assetHistory: true });

            const handleCheckboxChange = (e) => {
                setSelectedItems(prev => ({ ...prev, [e.target.name]: e.target.checked }));
            };
 
            const handleConfirm = () => {
                onConfirm(selectedItems);
                onClose();
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg shadow-xl p-6 w-96">
                        <h3 className="text-lg font-semibold mb-4">{type === 'export' ? 'ë°ì´í„° ë‚´ë³´ë‚´ê¸°' : 'ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°'}</h3>
                        <p className="text-sm text-gray-600 mb-4">
                            {type === 'export' ? 'ë‚´ë³´ë‚¼ ë°ì´í„° í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.' : 'ë¶ˆëŸ¬ì˜¬ ë°ì´í„° í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”. (ê¸°ì¡´ ë°ì´í„°ëŠ” ë®ì–´ì“°ì—¬ì§‘ë‹ˆë‹¤.)'}
                        </p>
                        <div className="space-y-2 mb-6">
                            <label className="flex items-center">
                                <input type="checkbox" name="appData" checked={selectedItems.appData} onChange={handleCheckboxChange} className="mr-2" /> 
                                <span className="text-gray-800">ê¸°ë³¸ ìì‚° ë°ì´í„° (ê³„ì¢Œ, ì§€ì¶œ, ì´ë²¤íŠ¸, ë©”ëª¨ ë“±)</span>
                            </label>
                            <label className="flex items-center">
                                <input type="checkbox" name="scenarios" checked={selectedItems.scenarios} onChange={handleCheckboxChange} className="mr-2" />
                                <span className="text-gray-800">ì €ì¥ëœ ì‹œë‚˜ë¦¬ì˜¤</span>
                            </label>
                            <label className="flex items-center">
                                <input type="checkbox" name="assetHistory" checked={selectedItems.assetHistory} onChange={handleCheckboxChange} className="mr-2" />
                                <span className="text-gray-800">ìì‚° íˆìŠ¤í† ë¦¬</span>
                            </label>
                        </div>
                        <div className="flex justify-end space-x-3">
                            <button onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300">ì·¨ì†Œ</button>
                            <button onClick={handleConfirm} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">í™•ì¸</button>
                        </div>
                    </div>
                </div>
            );
        };

        // [ì¶”ê°€] ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ ëª¨ë‹¬
        const PrivacyPolicyModal = ({ isOpen, onClose }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] flex flex-col">
                        <div className="p-6 border-b dark:border-gray-700 flex justify-between items-center">
                            <h3 className="text-xl font-bold text-gray-900 dark:text-white">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</h3>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" /></svg>
                            </button>
                        </div>
                        <div className="p-6 overflow-y-auto text-sm text-gray-700 dark:text-gray-300 space-y-4">
                            <p><strong>1. ê°œì¸ì •ë³´ì˜ ì²˜ë¦¬ ëª©ì </strong><br/>
                            'ìì‚° í”Œë˜ë„ˆ'(ì´í•˜ 'ì„œë¹„ìŠ¤')ëŠ” ë‹¤ìŒì˜ ëª©ì ì„ ìœ„í•˜ì—¬ ê°œì¸ì •ë³´ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤. ì²˜ë¦¬í•˜ê³  ìˆëŠ” ê°œì¸ì •ë³´ëŠ” ë‹¤ìŒì˜ ëª©ì  ì´ì™¸ì˜ ìš©ë„ë¡œëŠ” ì´ìš©ë˜ì§€ ì•Šìœ¼ë©° ì´ìš© ëª©ì ì´ ë³€ê²½ë˜ëŠ” ê²½ìš°ì—ëŠ” ë³„ë„ì˜ ë™ì˜ë¥¼ ë°›ëŠ” ë“± í•„ìš”í•œ ì¡°ì¹˜ë¥¼ ì´í–‰í•  ì˜ˆì •ì…ë‹ˆë‹¤.<br/>
                            - ì„œë¹„ìŠ¤ ì œê³µ ë° ì½˜í…ì¸  ì´ìš©: ìì‚° ì‹œë®¬ë ˆì´ì…˜ ë°ì´í„° ì €ì¥ ë° ë™ê¸°í™” (ì„ íƒ ì‚¬í•­)</p>

                            <p><strong>2. ì²˜ë¦¬í•˜ëŠ” ê°œì¸ì •ë³´ì˜ í•­ëª©</strong><br/>
                            ì„œë¹„ìŠ¤ëŠ” ê¸°ë³¸ì ì¸ ê¸°ëŠ¥ ì´ìš© ì‹œ ë³„ë„ì˜ ê°œì¸ì •ë³´ë¥¼ ìˆ˜ì§‘í•˜ì§€ ì•Šìœ¼ë©°, ëª¨ë“  ë°ì´í„°ëŠ” ì‚¬ìš©ìì˜ ë¸Œë¼ìš°ì €(Local Storage)ì— ì €ì¥ë©ë‹ˆë‹¤.<br/>
                            ë‹¨, 'í´ë¼ìš°ë“œ ë™ê¸°í™”(PRO)' ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš°ì— í•œí•˜ì—¬ ë‹¤ìŒì˜ ì •ë³´ê°€ ìˆ˜ì§‘ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br/>
                            - í•„ìˆ˜í•­ëª©: ì´ë©”ì¼ ì£¼ì†Œ, í”„ë¡œí•„ ì´ë¯¸ì§€, ì´ë¦„ (Google ë¡œê·¸ì¸ ì‹œ ì œê³µë˜ëŠ” ì •ë³´)<br/>
                            - ìˆ˜ì§‘ë°©ë²•: Google OAuth 2.0 ì—°ë™</p>

                            <p><strong>3. ê°œì¸ì •ë³´ì˜ ì²˜ë¦¬ ë° ë³´ìœ  ê¸°ê°„</strong><br/>
                            ì„œë¹„ìŠ¤ëŠ” ë²•ë ¹ì— ë”°ë¥¸ ê°œì¸ì •ë³´ ë³´ìœ Â·ì´ìš©ê¸°ê°„ ë˜ëŠ” ì •ë³´ì£¼ì²´ë¡œë¶€í„° ê°œì¸ì •ë³´ë¥¼ ìˆ˜ì§‘ ì‹œì— ë™ì˜ë°›ì€ ê°œì¸ì •ë³´ ë³´ìœ Â·ì´ìš©ê¸°ê°„ ë‚´ì—ì„œ ê°œì¸ì •ë³´ë¥¼ ì²˜ë¦¬Â·ë³´ìœ í•©ë‹ˆë‹¤.<br/>
                            - íšŒì› íƒˆí‡´ ì‹œ ì¦‰ì‹œ íŒŒê¸°</p>

                            <p><strong>4. ì¿ í‚¤(Cookie)ì˜ ìš´ìš© ë° ê±°ë¶€</strong><br/>
                            ì„œë¹„ìŠ¤ëŠ” ì´ìš©ìì—ê²Œ ê°œë³„ì ì¸ ë§ì¶¤ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•˜ê¸° ìœ„í•´ ì´ìš©ì •ë³´ë¥¼ ì €ì¥í•˜ê³  ìˆ˜ì‹œë¡œ ë¶ˆëŸ¬ì˜¤ëŠ” 'ì¿ í‚¤(cookie)'ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.<br/>
                            - ì¿ í‚¤ ë“± ì‚¬ìš© ëª©ì : ì´ìš©ìì˜ ì ‘ì† ë¹ˆë„ë‚˜ ë°©ë¬¸ ì‹œê°„ ë“±ì„ ë¶„ì„, ì´ìš©ìì˜ ì·¨í–¥ê³¼ ê´€ì‹¬ë¶„ì•¼ë¥¼ íŒŒì•… ë° ìì·¨ ì¶”ì <br/>
                            - ì¿ í‚¤ ì„¤ì • ê±°ë¶€ ë°©ë²•: ì›¹ë¸Œë¼ìš°ì € ìƒë‹¨ì˜ ë„êµ¬ - ì¸í„°ë„· ì˜µì…˜ - ê°œì¸ì •ë³´ ë©”ë‰´ì˜ ì˜µì…˜ ì„¤ì •ì„ í†µí•´ ì¿ í‚¤ ì €ì¥ì„ ê±°ë¶€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                            
                            <p><strong>5. ê´‘ê³  ê²Œì¬</strong><br/>
                            ë³¸ ì„œë¹„ìŠ¤ëŠ” Google AdSenseë¥¼ í†µí•´ ê´‘ê³ ë¥¼ ê²Œì¬í•  ìˆ˜ ìˆìœ¼ë©°, ì´ ê³¼ì •ì—ì„œ Googleì€ ì¿ í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©ìì˜ ì´ì „ ë°©ë¬¸ ê¸°ë¡ì„ ë°”íƒ•ìœ¼ë¡œ ê´‘ê³ ë¥¼ ì œê³µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                        </div>
                        <div className="p-6 border-t dark:border-gray-700 flex justify-end">
                            <button onClick={onClose} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">ë‹«ê¸°</button>
                        </div>
                    </div>
                </div>
            );
        };

        // [ì¶”ê°€] ê¸°ëŠ¥ ì œì•ˆ ëª¨ë‹¬
        const SuggestionModal = ({ isOpen, onClose, onSubmit }) => {
            const [content, setContent] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);

            if (!isOpen) return null;

            const handleSubmit = async () => {
                if (!content.trim()) return alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                setIsSubmitting(true);
                await onSubmit(content);
                setIsSubmitting(false);
                setContent('');
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6">
                        <h3 className="text-lg font-bold text-gray-900 dark:text-white mb-4">ğŸ’¡ ê¸°ëŠ¥ ì œì•ˆ ë° ì˜ê²¬ ë³´ë‚´ê¸°</h3>
                        <textarea
                            className="w-full h-32 p-3 border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 mb-4 resize-none"
                            placeholder="ì–´ë–¤ ê¸°ëŠ¥ì´ í•„ìš”í•˜ì‹ ê°€ìš”? ììœ ë¡­ê²Œ ì˜ê²¬ì„ ë‚¨ê²¨ì£¼ì„¸ìš”."
                            value={content}
                            onChange={(e) => setContent(e.target.value)}
                        />
                        <div className="flex justify-end gap-2">
                            <button onClick={onClose} className="px-4 py-2 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">ì·¨ì†Œ</button>
                            <button 
                                onClick={handleSubmit} 
                                disabled={isSubmitting}
                                className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50 flex items-center gap-2"
                            >
                                {isSubmitting ? 'ì „ì†¡ ì¤‘...' : 'ë³´ë‚´ê¸°'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // [ì¶”ê°€] PRO ê¸°ëŠ¥ ì•ˆë‚´ ëª¨ë‹¬
        const ProFeaturesModal = ({ isOpen, onClose }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md overflow-hidden">
                        <div className="p-6 border-b dark:border-gray-700 flex justify-between items-center">
                            <h3 className="text-xl font-bold text-gray-900 dark:text-white">PRO ê¸°ëŠ¥ ì•ˆë‚´</h3>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" /></svg>
                            </button>
                        </div>
                        <div className="p-6">
                            <table className="w-full text-sm text-left">
                                <thead className="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                                    <tr>
                                        <th className="px-4 py-2">ê¸°ëŠ¥</th>
                                        <th className="px-4 py-2 text-center">FREE</th>
                                        <th className="px-4 py-2 text-center text-blue-600 dark:text-blue-400">PRO</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y dark:divide-gray-700">
                                    <tr>
                                        <td className="px-4 py-3 dark:text-gray-300">ë°ì´í„° ì €ì¥</td>
                                        <td className="px-4 py-3 text-center text-gray-500">Local storage</td>
                                        <td className="px-4 py-3 text-center font-semibold dark:text-white">Cloud Sync</td>
                                    </tr>
                                    <tr>
                                        <td className="px-4 py-3 dark:text-gray-300">í…Œë§ˆ ì„¤ì •</td>
                                        <td className="px-4 py-3 text-center text-gray-500">-</td>
                                        <td className="px-4 py-3 text-center font-semibold dark:text-white">Theme Toggle</td>
                                    </tr>
                                    <tr>
                                        <td className="px-4 py-3 dark:text-gray-300">ë¶„ì„ ë„êµ¬</td>
                                        <td className="px-4 py-3 text-center text-gray-500">Basic stats</td>
                                        <td className="px-4 py-3 text-center font-semibold dark:text-white">Inflation Analysis</td>
                                    </tr>
                                    <tr>
                                        <td className="px-4 py-3 dark:text-gray-300">ì‹œë®¬ë ˆì´ì…˜</td>
                                        <td className="px-4 py-3 text-center text-gray-500">-</td>
                                        <td className="px-4 py-3 text-center font-semibold dark:text-white">Scenario Comparison</td>
                                    </tr>
                                </tbody>
                            </table>
                            <div className="mt-6 flex flex-col gap-2">
                                <button onClick={() => window.open('https://blog.naver.com/zocdoc', '_blank')} className="w-full py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition-colors">ê°œë°œì í›„ì›í•˜ê³  PRO í™œì„±í™”í•˜ê¸°</button>
                                <button onClick={onClose} className="w-full py-2 text-gray-500 text-sm hover:underline">ë‚˜ì¤‘ì— í•˜ê¸°</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // [ì¶”ê°€] ì˜¨ë³´ë”© ê°€ì´ë“œ ì»´í¬ë„ŒíŠ¸
        const OnboardingGuide = ({ isOpen, onClose, scrollToPanel, isPro }) => {
            const [currentStep, setCurrentStep] = useState(0);
            const [spotlightStyle, setSpotlightStyle] = useState(null);
            const tooltipRef = useRef(null);

            const steps = [
                { id: 'header-actions', title: 'ê¸°ë³¸ê°’ ë° ì‹œë‚˜ë¦¬ì˜¤ ê´€ë¦¬', content: 'ë°ì´í„°ë¥¼ ì €ì¥Â·ë¶ˆëŸ¬ì˜¤ê¸° í•˜ê±°ë‚˜ ë¶„ì„ ê²°ê³¼ë¥¼ PDFë¡œ ë‚´ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.' },
                { id: 'summary', title: 'ìš”ì•½ ë° ì„¤ì •', content: 'í˜„ì¬ ìì‚° í˜„í™©ê³¼ ë¬¼ê°€ ìƒìŠ¹ë¥ ì„ ë°˜ì˜í•œ ë¯¸ë˜ì˜ ì‹¤ì§ˆ ê°€ì¹˜ë¥¼ íŒŒì•…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.' },
                { id: 'charts', title: 'í¬íŠ¸í´ë¦¬ì˜¤ ì°¨íŠ¸', content: 'ìì‚°ì˜ êµ¬ì„± ë¹„ìœ¨ê³¼ ì‹œê°„ì— ë”°ë¥¸ ì„±ì¥ ê³¡ì„ ì„ ì‹œê°ì ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.' },
                { id: 'budget', title: 'ì›”ë‚©ì… ì˜ˆì‚° ê´€ë¦¬', content: 'ì›”ê¸‰ê³¼ ì§€ì¶œì„ ë°”íƒ•ìœ¼ë¡œ ë§¤ë‹¬ ì €ì¶• ê°€ëŠ¥í•œ ê¸ˆì•¡ì„ ê³„ì‚°í•˜ê³  ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.' },
                { id: 'rebalance', title: 'ë¦¬ë°¸ëŸ°ì‹±', content: 'ì„¤ì •í•œ ëª©í‘œ ë¹„ì¤‘ê³¼ í˜„ì¬ ë¹„ì¤‘ì˜ ì°¨ì´ë¥¼ ì²´í¬í•˜ì—¬ íˆ¬ì ê³„íšì„ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.' },
                { id: 'assets', title: 'ìì‚° ìƒì„¸ ì…ë ¥', content: 'ì˜ˆì ê¸ˆ, ì£¼ì‹, ë¶€ë™ì‚° ë“± ë³´ìœ í•˜ì‹  ëª¨ë“  ìì‚°ì„ ì„¹í„°ë³„ë¡œ ìƒì„¸íˆ ê¸°ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.' },
                { id: 'events', title: 'ì´ë²¤íŠ¸ì„± ìˆ˜ì…/ì§€ì¶œ', content: 'ìƒì—¬ê¸ˆì´ë‚˜ ì—¬í–‰ ë“± ë¹„ì •ê¸°ì ì¸ ì¬ë¬´ ì´ë²¤íŠ¸ë¥¼ ì„¤ì •í•˜ì—¬ ì‹œë®¬ë ˆì´ì…˜ì— ë°˜ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.' },
                { id: 'detail-analysis', title: 'ìƒì„¸ ë¶„ì„', content: 'ëª¨ë“  ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼ ìˆ˜ì¹˜ë¥¼ ìƒì„¸í•œ í‘œ ë°ì´í„°ë¡œ í•œëˆˆì— ë¶„ì„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.' }
            ];

            useEffect(() => {
                if (isOpen) {
                    const step = steps[currentStep];
                    scrollToPanel(step.id);
                    
                    // ìŠ¤í¬ë¡¤ ì• ë‹ˆë©”ì´ì…˜ ëŒ€ê¸° í›„ ìŠ¤í¬íŠ¸ë¼ì´íŠ¸ ìœ„ì¹˜ ê³„ì‚°
                    setTimeout(() => {
                        const el = document.getElementById(step.id);
                        if (el) {
                            const rect = el.getBoundingClientRect();
                            const padding = 10;
                            
                            // Tooltip height estimation (fallback to 220 if not yet rendered)
                            const tooltipHeight = tooltipRef.current ? tooltipRef.current.offsetHeight : 220;
                            
                            // Dynamic Flip Logic based on viewport position
                            let tooltipTop;
                            if (rect.top < window.innerHeight / 2) {
                                // Top half -> place below element
                                tooltipTop = rect.bottom + window.scrollY + 15;
                            } else {
                                // Bottom half -> place above element
                                tooltipTop = rect.top + window.scrollY - tooltipHeight - 15;
                            }

                            setSpotlightStyle({
                                top: rect.top + window.scrollY - padding,
                                left: rect.left + window.scrollX - padding,
                                width: rect.width + (padding * 2),
                                height: rect.height + (padding * 2),
                                tooltipTop: tooltipTop,
                                tooltipLeft: Math.min(window.innerWidth - 340, Math.max(20, rect.left + window.scrollX + (rect.width / 2) - 160))
                            });
                        }
                    }, 500);
                }
            }, [currentStep, isOpen]);

            if (!isOpen || !spotlightStyle) return null;

            const handleNext = () => {
                if (currentStep < steps.length - 1) setCurrentStep(prev => prev + 1);
                else handleComplete();
            };

            const handlePrev = () => {
                if (currentStep > 0) setCurrentStep(prev => prev - 1);
            };

            const handleComplete = () => {
                localStorage.setItem('asset_planner_guide_completed', 'true');
                onClose();
            };

            const current = steps[currentStep];

            return (
                <div className="absolute inset-0 z-[9999] pointer-events-none overflow-hidden transition-colors duration-500">
                    {/* Spotlight Hole */}
                    <div 
                        className="absolute rounded-lg transition-all duration-500 ease-in-out pointer-events-auto"
                        style={{
                            top: spotlightStyle.top,
                            left: spotlightStyle.left,
                            width: spotlightStyle.width,
                            height: spotlightStyle.height,
                            boxShadow: '0 0 0 9999px rgba(0, 0, 0, 0.7)'
                        }}
                    />

                    {/* Tooltip Card */}
                    <div 
                        ref={tooltipRef}
                        className="absolute pointer-events-auto w-72 sm:w-80 bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-6 transition-all duration-500"
                        style={{
                            top: spotlightStyle.tooltipTop,
                            left: spotlightStyle.tooltipLeft
                        }}
                    >
                        <div className="flex justify-between items-start mb-2">
                            <span className="text-xs font-bold text-blue-600 dark:text-blue-400 uppercase tracking-wider">Step {currentStep + 1} of {steps.length}</span>
                            {current.isPro && isPro && (
                                <span className="bg-amber-100 text-amber-700 text-[10px] px-2 py-0.5 rounded-full font-bold">PRO FEATURE</span>
                            )}
                        </div>
                        <h4 className="text-lg font-bold text-gray-900 dark:text-white mb-2">{current.title}</h4>
                        <p className="text-sm text-gray-600 dark:text-gray-300 mb-6 leading-relaxed">{current.content}</p>
                        <div className="flex justify-between items-center">
                            <button onClick={handleComplete} className="text-xs text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 underline">Skip</button>
                            <div className="flex gap-2">
                                <button onClick={handlePrev} disabled={currentStep === 0} className="px-3 py-1.5 text-xs font-semibold text-gray-600 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-lg disabled:opacity-30">ì´ì „</button>
                                <button onClick={handleNext} className="px-4 py-1.5 text-xs font-bold text-white bg-blue-600 rounded-lg hover:bg-blue-700 shadow-md">
                                    {currentStep === steps.length - 1 ? 'ì‹œì‘í•˜ê¸°' : 'ë‹¤ìŒ'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // [ìˆ˜ì •] íŒ¨ë„ ë˜í¼ ì»´í¬ë„ŒíŠ¸ (ì ‘ê¸°/í´ê¸° ê¸°ëŠ¥ ì¶”ê°€)
        const PanelWrapper = ({ id, title, moveUp, moveDown, isFirst, isLast, isCollapsed, onToggle, children, className = "bg-white dark:bg-gray-900 rounded-lg shadow" }) => {
            return (
                <div id={id}>
                    <div className="flex justify-between items-center mb-4 cursor-pointer select-none" onClick={onToggle}>
                        <h2 className="text-xl font-semibold text-gray-700 dark:text-white flex items-center gap-2 select-none">
                            <svg xmlns="http://www.w3.org/2000/svg" className={`h-5 w-5 text-gray-500 transform transition-transform duration-200 ${!isCollapsed ? 'rotate-90' : ''}`} viewBox="0 0 20 20" fill="currentColor">
                                <path fillRule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clipRule="evenodd" />
                            </svg>
                            {title}
                        </h2>
                        <div className="flex items-center gap-1">
                            <button 
                                onClick={(e) => {
                                    e.stopPropagation();
                                    moveUp();
                                }} 
                                disabled={isFirst} 
                                className="p-1 rounded-full hover:bg-gray-200 disabled:opacity-30 disabled:cursor-not-allowed"
                                title="ìœ„ë¡œ ì´ë™"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fillRule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clipRule="evenodd" />
                                </svg>
                            </button>
                            <button 
                                onClick={(e) => {
                                    e.stopPropagation();
                                    moveDown();
                                }} 
                                disabled={isLast} 
                                className="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 disabled:opacity-30 disabled:cursor-not-allowed"
                                title="ì•„ë˜ë¡œ ì´ë™"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fillRule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clipRule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    {!isCollapsed && (
                        <div className={className}>
                            {children}
                        </div>
                    )}
                </div>
            );
        };

        // [ì¶”ê°€] ë¦¬ë°¸ëŸ°ì‹± ì‹œê°í™”ë¥¼ ìœ„í•œ ëˆ„ì  ë§‰ëŒ€ ê·¸ë˜í”„ ì»´í¬ë„ŒíŠ¸
        const StackedBarDisplay = ({ targets, sectorInfo }) => {
            const validSectors = Object.keys(sectorInfo).filter(k => k !== 'loan');
            const defaultPct = Math.round(100 / validSectors.length);
            
            const total = validSectors.reduce((sum, key) => {
                return sum + (targets[key] ?? defaultPct);
            }, 0);

            // 100% ê¸°ì¤€ìœ¼ë¡œ ë¹„ìœ¨ ì¬ê³„ì‚° (ì •ê·œí™”)
            const normalizedTargets = validSectors.map(key => {
                const value = targets[key] ?? defaultPct;
                return {
                    key: key,
                    name: sectorInfo[key].name,
                    color: sectorInfo[key].color,
                    percentage: total === 0 ? 0 : (value / total) * 100,
                    originalValue: value
                };
            });

            return (
                <div className="w-full mb-4">
                    <div className="flex h-6 w-full rounded-full overflow-hidden border border-gray-300 dark:border-gray-600 bg-gray-200 dark:bg-gray-700">
                        {normalizedTargets.map(item => (
                            <div
                                key={item.key}
                                className={`flex items-center justify-center bg-${item.color}-500 transition-all duration-300`}
                                style={{ width: `${item.percentage}%` }}
                                title={`${item.name}: ${item.originalValue}%`}
                            >
                                <span className="text-xs font-medium text-white overflow-hidden whitespace-nowrap px-1">
                                    {item.percentage > 10 ? `${item.originalValue}%` : ''}
                                </span>
                            </div>
                        ))}
                    </div>
                    {total !== 100 && (
                        <div className="text-right text-xs text-red-600 dark:text-red-400 mt-1">
                            ì´í•©ì´ {total}%ì…ë‹ˆë‹¤. 100%ë¡œ ì¡°ì •í•´ì£¼ì„¸ìš”.
                        </div>
                    )}
                </div>
            );
        };




        // [ìµœì í™”] ì •ì  ë°ì´í„° ì™¸ë¶€ë¡œ ì´ë™ ë° ìŠ¤íƒ€ì¼ í´ë˜ìŠ¤ í•˜ë“œì½”ë”© (ë‹¤í¬ëª¨ë“œ í•´ê²°)
        const AssetDashboard = () => {
            // config.jsì—ì„œ ë¡œë“œëœ sectorInfo ì‚¬ìš©
            const sectorInfo = window.sectorInfo;
            // ===== ëª¨ë“  ìƒíƒœë¥¼ ë¨¼ì € ì„ ì–¸ =====
            const [appData, setAppData] = useState(null);
            const [darkMode, setDarkMode] = useState(() => localStorage.getItem('assetDashboardDarkMode') === 'true');
            const [inflationRate, setInflationRate] = useState(2.5);
            const [scenarios, setScenarios] = useState([]);
            const [originalUserData, setOriginalUserData] = useState(null); // [ì¶”ê°€] ì›ë³¸ ë°ì´í„° ìºì‹œ
            const [isDemoMode, setIsDemoMode] = useState(false); // [ì¶”ê°€] ë°ëª¨ ëª¨ë“œ ìƒíƒœ
            const [isPro, setIsPro] = useState(false); // [ì¶”ê°€] ìœ ë£Œ ì´ìš©ì ì—¬ë¶€
            const [verifiedEmail, setVerifiedEmail] = useState(null);
            const [userProfile, setUserProfile] = useState(null); // [ì¶”ê°€] ì‚¬ìš©ì í”„ë¡œí•„ ì •ë³´
            const [syncStatus, setSyncStatus] = useState('idle'); // 'idle' | 'syncing' | 'synced' | 'error'
            const [syncError, setSyncStatusError] = useState(''); // [ì¶”ê°€] êµ¬ì²´ì  ì—ëŸ¬ ë©”ì‹œì§€
            const [isLoadingCloud, setIsLoadingCloud] = useState(false); // [ì¶”ê°€] í´ë¼ìš°ë“œ ë¡œë”© ìƒíƒœ
            const [isLoading, setIsLoading] = useState(true); // [ì¶”ê°€] ì•± ì´ˆê¸° ë¡œë”© ìƒíƒœ
            const isFetchingRef = useRef(false); // [ì¶”ê°€] ë™ê¸°í™” ë¬´í•œ ë£¨í”„ ë°©ì§€ë¥¼ ìœ„í•œ Ref
            const isProcessing = useRef(false); // [ì¶”ê°€] ìƒíƒœ ì—…ë°ì´íŠ¸ ë½(Lock)
            const [isCloudLoaded, setIsCloudLoaded] = useState(false); // [ì¶”ê°€] í´ë¼ìš°ë“œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ ì—¬ë¶€ (Race Condition ë°©ì§€)
            const lastSavedDataRef = useRef(''); // [ì¶”ê°€] ì¤‘ë³µ ì €ì¥ ë°©ì§€ë¥¼ ìœ„í•œ ë°ì´í„° ìŠ¤ëƒ…ìƒ·
            const isCheckingSubscriptionRef = useRef(false); // [ì¶”ê°€] êµ¬ë… í™•ì¸ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ Ref

            // [ì¶”ê°€] íƒ€ì„ì•„ì›ƒ í—¬í¼ í•¨ìˆ˜ (30ì´ˆ)
            const withTimeout = (promise, ms = 30000) => {
                return Promise.race([
                    promise,
                    new Promise((_, reject) => setTimeout(() => reject(new Error('ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. (30ì´ˆ)')), ms))
                ]);
            };

            // Cloudflare ë¹Œë“œ ì‹œì ì— í™˜ê²½ ë³€ìˆ˜ë¡œ êµì²´ë  í”Œë ˆì´ìŠ¤í™€ë”
            const SUPABASE_URL = '__SUPABASE_URL__';
            const SUPABASE_KEY = '__SUPABASE_KEY__';
            
            const supabase = useMemo(() => {
                if (SUPABASE_URL.startsWith('__') || SUPABASE_KEY.startsWith('__')) return null;
                return window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            }, []);
            

            const [goalSeekResult, setGoalSeekResult] = useState(null);
            // ì°¨íŠ¸ refë“¤
            const currentPieRef = useRef(null);
            const projectedPieRef = useRef(null);
            const comparisonBarRef = useRef(null);
            const historyChartRef = useRef(null);
            // ì„¹í„° ì ‘í˜ ìƒíƒœëŠ” í•­ìƒ ìƒë‹¨ì—ì„œ ì„ ì–¸í•˜ì—¬ í›… ìˆœì„œ ê³ ì •
            const [hiddenSectors, setHiddenSectors] = useState(() => {
                try {
                    const raw = localStorage.getItem('assetDashboardHiddenSectors');
                    return raw ? JSON.parse(raw) : {};
                } catch { return {}; }
            });
            useEffect(()=>{
                try {
                    localStorage.setItem('assetDashboardHiddenSectors', JSON.stringify(hiddenSectors));
                } catch {}
            }, [hiddenSectors]);

            // [ì¶”ê°€] ë°ì´í„° ì „ì†¡ ëª¨ë‹¬ ìƒíƒœ
            const [isExportModalOpen, setIsExportModalOpen] = useState(false);
            const [isImportModalOpen, setIsImportModalOpen] = useState(false);
            const [exportSelection, setExportSelection] = useState({ appData: true, scenarios: true, assetHistory: true });
            const [importSelection, setImportSelection] = useState({ appData: true, scenarios: true, assetHistory: true });            
            const [isPrivacyModalOpen, setIsPrivacyModalOpen] = useState(false); // [ì¶”ê°€] ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ ëª¨ë‹¬ ìƒíƒœ
            const [isSuggestionModalOpen, setIsSuggestionModalOpen] = useState(false); // [ì¶”ê°€] ê¸°ëŠ¥ ì œì•ˆ ëª¨ë‹¬ ìƒíƒœ
            const [isProModalOpen, setIsProModalOpen] = useState(false); // [ì¶”ê°€] PRO ê¸°ëŠ¥ ì•ˆë‚´ ëª¨ë‹¬ ìƒíƒœ
            const [isQuickPanelOpen, setIsQuickPanelOpen] = useState(false); // [ì¶”ê°€] ëª¨ë°”ì¼ í€µ íŒ¨ë„ ìƒíƒœ
            const [isGuideOpen, setIsGuideOpen] = useState(false); // [ì¶”ê°€] ì˜¨ë³´ë”© ê°€ì´ë“œ ìƒíƒœ
            const [showSaveToast, setShowSaveToast] = useState(false); // [ì¶”ê°€] ì €ì¥ í”¼ë“œë°± ìƒíƒœ
            // [ìˆ˜ì •] ë ˆì´ì•„ì›ƒ ë° íŒ¨ë„ ìƒíƒœ ê´€ë¦¬
            const [layoutOrder, setLayoutOrder] = useState(() => {
                try {
                    const savedOrder = localStorage.getItem('assetDashboardLayoutOrder');
                    const defaultOrder = ['summary', 'scenario', 'charts', 'history', 'budget', 'memo', 'rebalance', 'assets', 'expenses', 'events', 'detail-analysis', 'assumptions'];
                    if (savedOrder) {
                        const parsed = JSON.parse(savedOrder);
                        const missing = defaultOrder.filter(id => !parsed.includes(id));
                        return [...parsed, ...missing];
                    }
                    return defaultOrder;
                } catch {
                    return ['summary', 'scenario', 'charts', 'history', 'budget', 'memo', 'rebalance', 'assets', 'expenses', 'events', 'detail-analysis', 'assumptions'];
                }
            });
            useEffect(() => {
                localStorage.setItem('assetDashboardLayoutOrder', JSON.stringify(layoutOrder));
            }, [layoutOrder]);

            const [panelCollapseState, setPanelCollapseState] = useState(() => {
                try {
                    const savedState = localStorage.getItem('assetDashboardPanelCollapse');
                    return savedState ? JSON.parse(savedState) : {};
                } catch {
                    return {};
                }
            });
            useEffect(() => {
                localStorage.setItem('assetDashboardPanelCollapse', JSON.stringify(panelCollapseState));
            }, [panelCollapseState]);

            const [assetSectorOrder, setAssetSectorOrder] = useState(() => {
                try {
                    const savedOrder = localStorage.getItem('assetDashboardAssetSectorOrder');
                    const defaultOrder = ['deposit', 'savings', 'investment', 'pension', 'realestate', 'car', 'loan', 'misc'];
                    return savedOrder ? JSON.parse(savedOrder) : defaultOrder;
                } catch {
                    return ['deposit', 'savings', 'investment', 'pension', 'realestate', 'car', 'loan', 'misc'];
                }
            });
            useEffect(() => {
                localStorage.setItem('assetDashboardAssetSectorOrder', JSON.stringify(assetSectorOrder));
            }, [assetSectorOrder]);

            // [ì¶”ê°€] ì…ë ¥ í•„ë“œ ì°¸ì¡°ë¥¼ ìœ„í•œ ref
            const assetInputRefs = useRef({});
            
            // [ì¶”ê°€] íŒ¨ë„ ì´ë™ í•¨ìˆ˜
            const scrollToPanel = (id) => {
                const element = document.getElementById(id);
                if (element) {
                    const headerOffset = 100;
                    const elementPosition = element.getBoundingClientRect().top;
                    const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
                    window.scrollTo({ top: offsetPosition, behavior: "smooth" });
                }
            };

            // ===== ì´ˆê¸° ë°ì´í„° ë¡œë“œ =====
            useEffect(() => {
                const loadInitialData = async () => {
                    await loadServerConfig();
                    const baseData = publicDefaultData;
                    
                    // 1. ë¡œì»¬ ë°ì´í„° ë¡œë“œ ì‹œë„
                    try {
                        const savedData = localStorage.getItem('assetDashboardDataV3');
                        const savedScenarios = localStorage.getItem('assetDashboardScenarios');

                if (savedScenarios) {
                    setScenarios(JSON.parse(savedScenarios));
                }

                if (savedData) {
                            const parsedData = JSON.parse(savedData);
                            // ìƒˆë¡œìš´ í•„ë“œë“¤ ì¶”ê°€
                            const mergedData = { // ë³‘í•© ë¡œì§ ê°œì„ 
                                ...baseData,
                                ...parsedData,
                                assets: { ...baseData.assets, ...parsedData.assets }, 
                                rebalancingAlerts: { ...baseData.rebalancingAlerts, ...parsedData.rebalancingAlerts },
                            };
                            if (mergedData.memo === undefined) mergedData.memo = baseData.memo;

                            // ë§ˆì´ê·¸ë ˆì´ì…˜: ID, ëŒ€ì¶œ ì‹œì‘ì¼, ë‹¤í¬ëª¨ë“œ í•„ë“œ ë³´ê°•
                            Object.keys(parsedData.assets||{}).forEach(sector=>{
                                (parsedData.assets[sector]||[]).forEach(a=>{ 
                                    if (!a.id) a.id = Date.now() + Math.random();
                                    if (sector === 'loan' && !a.loanStartDate) a.loanStartDate = parsedData.baseMonth || baseData.baseMonth;
                                });
                            });

                            // ë§ˆì´ê·¸ë ˆì´ì…˜: ìì‚°ë³„ ìˆ˜ìˆ˜ë£Œ/ì„¸ê¸ˆ í•„ë“œ ê¸°ë³¸ê°’(0)
                            Object.keys(parsedData.assets||{}).forEach(sector=>{
                                (parsedData.assets[sector]||[]).forEach(a=>{ if (a.feeRate === undefined) a.feeRate = 0; });
                            });
                            setAppData(mergedData); // [ìˆ˜ì •] parsedData ëŒ€ì‹  mergedData ì‚¬ìš©
                            setOriginalUserData(parsedData); // [ì¶”ê°€]
                            lastSavedDataRef.current = JSON.stringify(mergedData); // [ì¶”ê°€] ì´ˆê¸° ë¡œë“œ ì‹œì  ë°ì´í„° ê¸°ë¡
                        } else {
                            setAppData(baseData);
                            setOriginalUserData(baseData); // [ì¶”ê°€]
                            lastSavedDataRef.current = JSON.stringify(baseData);
                        }
                    } catch (error) {
                        console.error("ë¡œì»¬ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜ (ì´ˆê¸°í™” ì§„í–‰):", error);
                        // [ìˆ˜ì •] ë°ì´í„° ì†ìƒ ì‹œ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì´ˆê¸°í™”í•˜ì—¬ ë¬´í•œ ë¡œë”©/ì—ëŸ¬ ë°©ì§€
                        localStorage.removeItem('assetDashboardDataV3');
                        setAppData(baseData);
                        lastSavedDataRef.current = JSON.stringify(baseData);
                    }

                    // 2. Supabase ì„¸ì…˜ ì²´í¬ (ê³„ì • ì •ë³´ í™•ì¸ ëŒ€ê¸°)
                    if (supabase) {
                        try {
                            // [ìˆ˜ì •] ì„¸ì…˜ ì²´í¬ íƒ€ì„ì•„ì›ƒ 2ì´ˆë¡œ ë‹¨ì¶•
                            const { data: { session }, error } = await withTimeout(supabase.auth.getSession(), 2000);
                            
                            if (error) {
                                console.error('Session error:', error);
                                // ì´ˆê¸° ë¡œë”© ì‹œ alertëŠ” ì‚¬ìš©ì ê²½í—˜ì„ í•´ì¹  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë¡œê·¸ë§Œ ë‚¨ê¹€
                            }

                            if (session) {
                                // ì„¸ì…˜ì´ ìˆìœ¼ë©´ êµ¬ë… ìƒíƒœ í™•ì¸ ë° í´ë¼ìš°ë“œ ë™ê¸°í™” ì‹œë„ (awaitë¡œ ëŒ€ê¸°)
                                await checkSubscription(session, false, mergedData || baseData);
                            }
                        } catch (err) {
                            console.error('Session check error:', err);
                            // íƒ€ì„ì•„ì›ƒ ì‹œ ì¡°ìš©íˆ ì‹¤íŒ¨ ì²˜ë¦¬ (ì´ˆê¸° ë¡œë“œì´ë¯€ë¡œ)
                        }
                    }

                    // 3. ëª¨ë“  ì²´í¬ ì™„ë£Œ í›„ UI ë Œë”ë§ í—ˆìš©
                    setIsLoading(false);
                };
                
                loadInitialData();
            }, []);

            // [ì¶”ê°€] ì˜¨ë³´ë”© ê°€ì´ë“œ íŠ¸ë¦¬ê±° ë¡œì§
            useEffect(() => {
                const guideCompleted = localStorage.getItem('asset_planner_guide_completed');
                if (!isLoading && !guideCompleted) {
                    setIsGuideOpen(true);
                }
            }, [isLoading]);

            // [ì¶”ê°€] í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ (Alt + S) ì €ì¥ ë¡œì§
            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (e.altKey && (e.key === 's' || e.key === 'S')) {
                        e.preventDefault();
                        
                        if (appData) {
                            // 1. ë¡œì»¬ ì €ì¥
                            const currentDataStr = JSON.stringify(appData);
                            localStorage.setItem('assetDashboardDataV3', currentDataStr);
                            localStorage.setItem('assetDashboardLastUpdate', new Date().toISOString());
                            
                            // 2. í´ë¼ìš°ë“œ ì €ì¥ (PROì¸ ê²½ìš° force flag ì‚¬ìš©)
                            if (isPro && verifiedEmail) {
                                saveToCloud(appData, true);
                            }

                            // 3. í”¼ë“œë°± í‘œì‹œ
                            setShowSaveToast(true);
                            setTimeout(() => setShowSaveToast(false), 2000);
                        }
                    }
                };

                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [appData, isPro, verifiedEmail, saveToCloud]);

            // [ì¶”ê°€] í´ë¼ìš°ë“œ ì €ì¥ í—¬í¼ í•¨ìˆ˜ (ì¤‘ë³µ ë¡œì§ ì œê±° ë° ê°•ì œ ì €ì¥ ì§€ì›)
            // [ìˆ˜ì •] ì´ˆê¸° ë¡œë”© ì‹œì ì˜ ìƒíƒœ ë¶ˆì¼ì¹˜ í•´ê²°ì„ ìœ„í•´ email, proStatus ì˜¤ë²„ë¼ì´ë“œ ì¸ì ì¶”ê°€
            const saveToCloud = async (dataToSave, force = false, emailOverride = null, proOverride = null) => {
                const targetEmail = emailOverride || verifiedEmail;

                if (!targetEmail || isDemoMode || !supabase || !dataToSave) return;
                // ê°•ì œ ì €ì¥ì´ ì•„ë‹ˆê³ , í´ë¼ìš°ë“œ ë¡œë“œ ì „ì´ê±°ë‚˜ ë¡œë“œ ì¤‘ì´ë©´ ì¤‘ë‹¨
                if (!force && (!isCloudLoaded || isFetchingRef.current)) return;

                const currentDataStr = JSON.stringify(dataToSave);
                // ê°•ì œ ì €ì¥ì´ ì•„ë‹ˆê³ , ë³€ê²½ ì‚¬í•­ì´ ì—†ìœ¼ë©´ ì¤‘ë‹¨
                if (!force && currentDataStr === lastSavedDataRef.current) return;

                setSyncStatus('syncing');
                try {
                    const { data, error } = await withTimeout(supabase
                        .from('user_assets')
                        .upsert({ 
                            email: targetEmail, 
                            data: dataToSave,
                            updated_at: new Date().toISOString()
                        }, { onConflict: 'email' })
                        .select('updated_at')
                        .single());
                    
                    if (error) throw error;
                    if (data) {
                        setSyncStatus('synced');
                        localStorage.setItem('assetDashboardLastUpdate', data.updated_at);
                        lastSavedDataRef.current = currentDataStr;
                    }
                } catch (error) {
                    console.error('Sync error:', error);
                    setSyncStatus('error');
                    const isAuthError = error.code === '42501' || error.message?.includes('row-level security');
                    setSyncStatusError(isAuthError ? 'ì„œë²„ ì €ì¥ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. (PRO êµ¬ë… ì •ë³´ ë¶ˆì¼ì¹˜)' : (error.message || 'ì €ì¥ ì‹¤íŒ¨'));
                }
            };

            // ===== ë°ì´í„° ìë™ ì €ì¥ =====
            useEffect(() => {
                if (appData && !isDemoMode) {
                    const currentDataStr = JSON.stringify(appData);
                    // [ìµœì í™”] ë³€ê²½ì‚¬í•­ì´ ìˆì„ ë•Œë§Œ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì €ì¥
                    if (currentDataStr !== lastSavedDataRef.current) {
                        localStorage.setItem('assetDashboardDataV3', currentDataStr);
                        localStorage.setItem('assetDashboardLastUpdate', new Date().toISOString());
                        setOriginalUserData(appData);
                        // ì£¼ì˜: lastSavedDataRefëŠ” í´ë¼ìš°ë“œ ë™ê¸°í™” ë¡œì§ì—ì„œë„ ì‚¬ìš©ë˜ë¯€ë¡œ 
                        // ì—¬ê¸°ì„œëŠ” ì—…ë°ì´íŠ¸í•˜ì§€ ì•Šê±°ë‚˜, ë¡œì»¬ ì €ì¥ê³¼ í´ë¼ìš°ë“œ ì €ì¥ì˜ ê¸°ì¤€ì„ ë¶„ë¦¬í•´ì•¼ í•¨.
                        // í˜„ì¬ êµ¬ì¡°ì—ì„œëŠ” í´ë¼ìš°ë“œ ë™ê¸°í™” useEffectì—ì„œ lastSavedDataRefë¥¼ í™œìš©í•˜ë¯€ë¡œ ì—¬ê¸°ì„  ë†”ë‘ .
                    }
                } 
            }, [JSON.stringify(appData), isDemoMode]);

            // useRefë¥¼ ì‚¬ìš©í•˜ì—¬ ì²« ë Œë”ë§ì¸ì§€ ì¶”ì í•˜ëŠ” ë³€ìˆ˜ ì¶”ê°€
            const isInitialMount = useRef(true);

            useEffect(() => {
                // ì²« ë Œë”ë§ì¼ ê²½ìš°, ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•Šê³  ìŠ¤ìœ„ì¹˜ë§Œ falseë¡œ ë³€ê²½
                if (isInitialMount.current) {
                    isInitialMount.current = false;
                } else {
                    // ì²« ë Œë”ë§ì´ ì•„ë‹ ë•Œë§Œ localStorageì— ì €ì¥
                    localStorage.setItem('assetDashboardScenarios', JSON.stringify(scenarios));
                }
            }, [scenarios]);

            // ===== ìì‚° íˆìŠ¤í† ë¦¬ ê´€ë¦¬ =====
            const [assetHistory, setAssetHistory] = React.useState([]);
            const [showProjectionInHistory, setShowProjectionInHistory] = useState(false);
            
            // íˆìŠ¤í† ë¦¬ ë°ì´í„° ë¡œë“œ
            React.useEffect(() => {
                try {
                    const savedHistory = localStorage.getItem('assetDashboardHistory');
                    if (savedHistory) {
                        setAssetHistory(JSON.parse(savedHistory));
                    }
                } catch (error) {
                    console.error('íˆìŠ¤í† ë¦¬ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                }
            }, []);

            // íˆìŠ¤í† ë¦¬ ë°ì´í„° ì €ì¥
            React.useEffect(() => {
                if (assetHistory.length > 0) {
                    localStorage.setItem('assetDashboardHistory', JSON.stringify(assetHistory));
                }
            }, [assetHistory]);

            // í˜„ì¬ ìì‚° ì €ì¥ í•¨ìˆ˜
            const saveCurrentAsset = () => {
                try {
                    const now = new Date();
                    const currentDate = now.toISOString().split('T')[0]; // YYYY-MM-DD
                    const currentTime = now.toTimeString().split(' ')[0]; // HH:MM:SS
                    const netWorth = calculation?.grand || 0;
                    
                    setAssetHistory(prev => {
                        const newHistory = [...prev];
                        const existingIndex = newHistory.findIndex(item => item.date === currentDate);
                        
                        if (existingIndex >= 0) {
                            // ê°™ì€ ë‚ ì§œê°€ ìˆìœ¼ë©´ ì‹œê°„ ì •ë³´ì™€ í•¨ê»˜ ì—…ë°ì´íŠ¸ (ë§ˆì§€ë§‰ ì‹œê°„ëŒ€ë§Œ ìœ ì§€)
                            newHistory[existingIndex] = { 
                                date: currentDate, 
                                time: currentTime,
                                netWorth,
                                timestamp: now.getTime()
                            };
                        } else {
                            // ìƒˆë¡œìš´ ë‚ ì§œë©´ ì¶”ê°€
                            newHistory.push({ 
                                date: currentDate, 
                                time: currentTime,
                                netWorth,
                                timestamp: now.getTime()
                            });
                        }
                        
                        // íƒ€ì„ìŠ¤íƒ¬í”„ìˆœìœ¼ë¡œ ì •ë ¬ (ìµœì‹ ì´ ë§ˆì§€ë§‰)
                        return newHistory.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
                    });
                    
                    alert(`í˜„ì¬ ìˆœìì‚° ${formatNumber(netWorth, displayMode)}ë§Œì›ì´ íˆìŠ¤í† ë¦¬ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\n(${currentDate} ${currentTime})`);
                } catch (error) {
                    console.error('ìì‚° ì €ì¥ ì˜¤ë¥˜:', error);
                    alert('ìì‚° ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            };

            // ===== ë°ì´í„° ì´ì‚¿ì§ì‹¸ê¸° ê¸°ëŠ¥ =====
            const handleExport = async (selection) => {
                try {
                    const exportData = {};
                    if (selection.appData) exportData.appData = appData; 
                    if (selection.scenarios) exportData.scenarios = scenarios;
                    if (selection.assetHistory) exportData.assetHistory = assetHistory;

                    exportData.exportDate = new Date().toISOString();
                    exportData.version = '1.0';
 
                    const jsonString = JSON.stringify(exportData);
                    const compressedDataArray = pako.deflate(jsonString);
                    const binaryString = String.fromCharCode.apply(null, compressedDataArray);
                    const compressed = btoa(binaryString);

                    // í´ë¦½ë³´ë“œì— ë³µì‚¬
                    navigator.clipboard.writeText(compressed).then(() => {
                        alert('ìì‚° ë°ì´í„°ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\në‹¤ë¥¸ ê¸°ê¸°ì—ì„œ "ìì‚° ë¶ˆëŸ¬ì˜¤ê¸°" ë²„íŠ¼ì„ ëˆŒëŸ¬ ë¶™ì—¬ë„£ê¸°í•˜ì„¸ìš”.');
                    }).catch(() => {
                        // í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨ ì‹œ í…ìŠ¤íŠ¸ ì˜ì—­ìœ¼ë¡œ í‘œì‹œ
                        const textArea = document.createElement('textarea');
                        textArea.value = compressed;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        alert('ìì‚° ë°ì´í„°ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\në‹¤ë¥¸ ê¸°ê¸°ì—ì„œ "ìì‚° ë¶ˆëŸ¬ì˜¤ê¸°" ë²„íŠ¼ì„ ëˆŒëŸ¬ ë¶™ì—¬ë„£ê¸°í•˜ì„¸ìš”.');
                    });
                } catch (error) {
                    console.error('ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜:', error);
                    alert('ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            };

            const handleImport = (selection) => {
                const compressedData = prompt('ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ë³µì‚¬í•œ ì•”í˜¸ë¬¸ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”:');
                if (!compressedData) return;
                
                try {
                    const binaryString = atob(compressedData);
                    const compressedDataArray = new Uint8Array(binaryString.length);
                    for (let i = 0; i < binaryString.length; i++) {
                        compressedDataArray[i] = binaryString.charCodeAt(i);
                    }
                    const jsonString = pako.inflate(compressedDataArray, { to: 'string' });
                    const importData = JSON.parse(jsonString);
                    
                    if (!importData.version) {
                        throw new Error('ì˜ëª»ëœ ë°ì´í„° í˜•ì‹ì…ë‹ˆë‹¤.');
                    }

                    if (confirm('í˜„ì¬ ë°ì´í„°ë¥¼ ëª¨ë‘ ë®ì–´ì“°ê³  ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        if (selection.appData && importData.appData) setAppData(importData.appData);
                        if (selection.scenarios && importData.scenarios) setScenarios(importData.scenarios);
                        if (selection.assetHistory && importData.assetHistory) setAssetHistory(importData.assetHistory);
                        alert('ìì‚° ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™€ì¡ŒìŠµë‹ˆë‹¤!');
                    }
                } catch (error) {
                    console.error('ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error);
                    alert('ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nì•”í˜¸ë¬¸ì„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.');
                }
            };

            // ===== ê¸°ë³¸ê°’ ì„¤ì • (appDataê°€ ì—†ì„ ë•Œë„ ì•ˆì „í•˜ê²Œ) =====
            const {
                projectionMonths = 12, monthlySalary = 280, assets = {}, monthlyExpenses = [],
                targetAmount = 10000, 
                goalMode = 'period', displayMode = 'amount',
                rebalancingAlerts = {}, baseMonth = new Date().toISOString().slice(0,7),
                mainCashFlowAccount = 'ìƒí™œë¹„í†µì¥',
                rebalancingTargets = {},
                memo = '' // [ì¶”ê°€]
            } = appData || {};

            // [ê°œì„ ] nullì´ë‚˜ ì˜ëª»ëœ ë°ì´í„°ê°€ ë“¤ì–´ì™€ë„ í•­ìƒ ë°°ì—´ì„ì„ ë³´ì¥
            const incomeEvents = Array.isArray(appData?.incomeEvents) ? appData.incomeEvents : [];
            const expenseEvents = Array.isArray(appData?.expenseEvents) ? appData.expenseEvents : [];

            const applyTax = false;
            // ===== Setter í•¨ìˆ˜ë“¤ =====
            const setProjectionMonths = (value) => setAppData(prev => ({ ...prev, projectionMonths: Math.max(0, value) }));
            const setMonthlySalary = (value) => setAppData(prev => ({ ...prev, monthlySalary: value }));
            const setAssets = (value) => setAppData(prev => ({ ...prev, assets: typeof value === 'function' ? value(prev.assets) : value }));
            const setMonthlyExpenses = (value) => setAppData(prev => ({ 
                ...prev, 
                monthlyExpenses: typeof value === 'function' ? value(Array.isArray(prev.monthlyExpenses) ? prev.monthlyExpenses : []) : value 
            }));

            // [ì´ë™] Setter í•¨ìˆ˜ë“¤ì„ handleDarkModeToggleë³´ë‹¤ ìƒë‹¨ìœ¼ë¡œ ì´ë™í•˜ì—¬ ì°¸ì¡° ì˜¤ë¥˜ ë°©ì§€
            const setMainCashFlowAccount = (value) => setAppData(prev => ({ ...prev, mainCashFlowAccount: value }));
            const setIncomeEvents = (value) => setAppData(prev => ({ 
                ...prev, 
                incomeEvents: typeof value === 'function' ? value(Array.isArray(prev.incomeEvents) ? prev.incomeEvents : []) : value 
            }));
            const setExpenseEvents = (value) => setAppData(prev => ({ 
                ...prev, 
                expenseEvents: typeof value === 'function' ? value(Array.isArray(prev.expenseEvents) ? prev.expenseEvents : []) : value 
            }));
            
            const setTargetAmount = (value) => setAppData(prev => ({ ...prev, targetAmount: value }));
            const setGoalMode = (value) => setAppData(prev => ({ ...prev, goalMode: value }));
            const setDisplayMode = (value) => setAppData(prev => ({ ...prev, displayMode: value })); 
            const setRebalancingAlerts = (value) => setAppData(prev => ({ ...prev, rebalancingAlerts: typeof value === 'function' ? value(prev.rebalancingAlerts) : value }));
            const setBaseMonth = (value) => setAppData(prev => ({ ...prev, baseMonth: value }));
            const setRebalancingTargets = (value) => setAppData(prev => ({ ...prev, rebalancingTargets: typeof value === 'function' ? value(prev.rebalancingTargets) : value }));
            const setMemo = (value) => setAppData(prev => ({ ...prev, memo: value }));

            // [ì¶”ê°€] ë‹¤í¬ëª¨ë“œ í† ê¸€ í•¸ë“¤ëŸ¬ (PRO ì œí•œ ë¡œì§)
            const handleDarkModeToggle = () => {
                if (!isPro) {
                    return setIsProModalOpen(true);
                }
                setDarkMode(!darkMode);
            };

            // [ìˆ˜ì •] ë‹¤í¬ëª¨ë“œ í´ë˜ìŠ¤ ì ìš© (isPro ì—¬ë¶€ì™€ ë¬´ê´€í•˜ê²Œ ìƒíƒœ ê¸°ë°˜ ì ìš©)
            useEffect(() => {
                if (darkMode) {
                    document.documentElement.classList.add('dark');
                    document.documentElement.style.colorScheme = 'dark';
                } else {
                    document.documentElement.classList.remove('dark');
                    document.documentElement.style.colorScheme = 'light';
                }
                localStorage.setItem('assetDashboardDarkMode', darkMode);
            }, [darkMode]);

            // [ì¶”ê°€] PRO ê¶Œí•œ ìƒì‹¤ ì‹œ íˆìŠ¤í† ë¦¬ ì˜ˆìƒ ìì‚° í‘œì‹œ ê°•ì œ í•´ì œ
            useEffect(() => {
                if (!isPro && showProjectionInHistory) {
                    setShowProjectionInHistory(false);
                }
            }, [isPro, showProjectionInHistory]);


            // ===== Supabase ì—°ë™ ë¡œì§ =====
            // [ìˆ˜ì •] ë¡œê·¸ì•„ì›ƒ í•¸ë“¤ëŸ¬: ë¬´í•œ ë£¨í”„ ë°©ì§€ë¥¼ ìœ„í•´ skipSignOut íŒŒë¼ë¯¸í„° ì¶”ê°€
            const handleLogout = async (skipSignOut = false) => {
                isProcessing.current = true;
                // ì´ë¯¸ ì„¸ì…˜ì´ ì¢…ë£Œë˜ì–´ í˜¸ì¶œëœ ê²½ìš° signOut ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
                if (supabase && !skipSignOut) await supabase.auth.signOut();
                setVerifiedEmail(null); 
                setUserProfile(null);
                setIsPro(false);
                // setAppData(publicDefaultData); // [ìˆ˜ì •] ë¡œê·¸ì•„ì›ƒ ì‹œ í˜„ì¬ ë°ì´í„° ìœ ì§€ (ë¡œì»¬ ëª¨ë“œ ì „í™˜)
                setSyncStatus('idle');
                setSyncStatusError('');
                setIsCloudLoaded(false); // [ì¶”ê°€] ë¡œë“œ ìƒíƒœ ì´ˆê¸°í™”
                isProcessing.current = false;
            };

            // [ì¶”ê°€] êµ¬ë… ìƒíƒœ í™•ì¸ ë° ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ (ì¬ì‚¬ìš© ê°€ëŠ¥í•˜ë„ë¡ ë¶„ë¦¬)
            const checkSubscription = async (session, isManualCheck = false, localDataOverride = null) => {
                if (!session?.user) return;
                if (isCheckingSubscriptionRef.current && !isManualCheck) return; // ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
                
                if (isManualCheck) setIsLoadingCloud(true);
                isCheckingSubscriptionRef.current = true;

                // [ìˆ˜ì •] ë¡œê·¸ì¸ ìƒíƒœ ìš°ì„  ë°˜ì˜ (DB ì¡°íšŒ ì‹¤íŒ¨í•˜ë”ë¼ë„ ë¡œê·¸ì¸ì€ ìœ ì§€)
                setVerifiedEmail(session.user.email);
                setUserProfile(session.user.user_metadata);

                // ì˜¤í”„ë¼ì¸ ìƒíƒœ ê°ì§€ ì‹œ DB ì¡°íšŒ ìƒëµ
                if (!navigator.onLine) {
                    console.warn('Offline: Skipping subscription check');
                    isCheckingSubscriptionRef.current = false;
                    if (isManualCheck) setIsLoadingCloud(false);
                    return;
                }

                try {
                    // [ê°œì„ ] DB ì¡°íšŒ ì¬ì‹œë„ ë¡œì§ (ìµœëŒ€ 3íšŒ)
                    let profile = null;
                    let fetchError = null;

                    for (let i = 0; i < 3; i++) {
                        const { data, error } = await withTimeout(supabase
                            .from('user_profiles')
                            .select('is_paid')
                            .eq('id', session.user.id)
                            .maybeSingle(), 5000);
                        
                        if (!error) {
                            profile = data;
                            fetchError = null;
                            break; // ì„±ê³µ ì‹œ ë£¨í”„ íƒˆì¶œ
                        }
                        fetchError = error;
                        await new Promise(r => setTimeout(r, 1000)); // 1ì´ˆ ëŒ€ê¸° í›„ ì¬ì‹œë„
                    }
                    
                    if (!fetchError) {
                        const proStatus = profile ? profile.is_paid : false;
                        setIsPro(proStatus);

                        if (isManualCheck) {
                            alert(`êµ¬ë… ìƒíƒœê°€ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.\ní˜„ì¬ ìƒíƒœ: ${proStatus ? 'PRO (ìœ ë£Œ)' : 'FREE (ë¬´ë£Œ)'}`);
                        }

                        // PRO ê¶Œí•œì´ í™•ì¸ëœ ê²½ìš°ì—ë§Œ í´ë¼ìš°ë“œ ë°ì´í„° ë¡œë“œ ì‹œë„
                        if (proStatus) {
                            await fetchFromCloud(session.user.email, proStatus, true, false, localDataOverride);
                        }
                    } else {
                        console.warn('Profile fetch error after retries:', fetchError);
                        // DB ì—ëŸ¬ê°€ ë‚˜ë„ ë¡œê·¸ì¸ì€ ìœ ì§€í•˜ë˜ PRO ê¶Œí•œë§Œ falseë¡œ ì„¤ì •
                        // DB ì¡°íšŒ ì‹¤íŒ¨ ì‹œ ê¸°ì¡´ ê¶Œí•œ ìœ ì§€
                        if (isManualCheck) alert('ì„œë²„ ì—°ê²° ìƒíƒœê°€ ì¢‹ì§€ ì•Šì•„ êµ¬ë… ì •ë³´ë¥¼ í™•ì¸í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    }
                } catch (err) {
                    console.error('Subscription check error:', err);
                    // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ê¸°ì¡´ ê¶Œí•œ ìœ ì§€
                    if (isManualCheck) alert('êµ¬ë… ìƒíƒœ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                } finally {
                    isCheckingSubscriptionRef.current = false;
                    if (isManualCheck) setIsLoadingCloud(false);
                }
            };

            // [ì¶”ê°€] ê¸°ëŠ¥ ì œì•ˆ ì „ì†¡ í•¸ë“¤ëŸ¬
            const handleSuggestionSubmit = async (content) => {
                if (!supabase) return;
                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) return alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');

                    // [ìˆ˜ì •] user_profiles í…Œì´ë¸”ì˜ suggestions ì»¬ëŸ¼ì— ë‚´ìš© ì¶”ê°€ (Append ë°©ì‹)
                    // 1. ê¸°ì¡´ ë‚´ìš© ì¡°íšŒ
                    const { data: currentProfile, error: fetchError } = await supabase
                        .from('user_profiles')
                        .select('suggestions')
                        .eq('id', user.id)
                        .maybeSingle();
                    
                    if (fetchError) throw fetchError;

                    // 2. ê¸°ì¡´ ë‚´ìš©ì— ìƒˆ ë‚´ìš© ì´ì–´ë¶™ì´ê¸° (íƒ€ì„ìŠ¤íƒ¬í”„ í¬í•¨)
                    const timestamp = new Date().toLocaleString();
                    const newEntry = `[${timestamp}] ${content}`;
                    const updatedSuggestions = currentProfile?.suggestions 
                        ? currentProfile.suggestions + '\n\n' + newEntry 
                        : newEntry;

                    // 3. ì—…ë°ì´íŠ¸ ì‹¤í–‰
                    const { error } = await supabase
                        .from('user_profiles')
                        .update({ suggestions: updatedSuggestions })
                        .eq('id', user.id);
                    
                    if (error) throw error;
                    alert('ì†Œì¤‘í•œ ì˜ê²¬ ê°ì‚¬í•©ë‹ˆë‹¤! ê°œë°œìì—ê²Œ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } catch (error) {
                    console.error('Suggestion error:', error);
                    alert('ì˜ê²¬ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            };

            useEffect(() => {
                // [ìˆ˜ì •] ì´ˆê¸° ë¡œë”© ë¡œì§ì€ loadInitialDataë¡œ í†µí•©ë˜ì—ˆìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” Auth ë¦¬ìŠ¤ë„ˆë§Œ ê´€ë¦¬
                if (!supabase) return;

                // onAuthStateChangeëŠ” ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ì´ë²¤íŠ¸ ê°ì§€ìš©

                const { data: { subscription } } = supabase.auth.onAuthStateChange(async (event, session) => {
                    if (session && !isProcessing.current) {
                        // [ìˆ˜ì •] ì´ë²¤íŠ¸ íƒ€ì… ì²´í¬ ì™„í™”: ì„¸ì…˜ì´ ìˆê³  ë°ì´í„° ë¡œë“œ ì¤‘ì´ ì•„ë‹ˆë©´ ìƒíƒœ ë™ê¸°í™”
                        // SIGNED_IN ë¿ë§Œ ì•„ë‹ˆë¼ INITIAL_SESSION(ìƒˆë¡œê³ ì¹¨) ë“± ìœ íš¨ ì„¸ì…˜ ì´ë²¤íŠ¸ ëŒ€ì‘
                        if (!isFetchingRef.current && (event === 'SIGNED_IN' || event === 'INITIAL_SESSION')) {
                            await checkSubscription(session);
                        }
                    } else if (!session) {
                        // ì„¸ì…˜ì´ ì—†ìœ¼ë©´ ë¡œì»¬ ìƒíƒœ ì´ˆê¸°í™” (ì´ë¯¸ ë¡œê·¸ì•„ì›ƒëœ ìƒíƒœì´ë¯€ë¡œ signOut í˜¸ì¶œ ì•ˆ í•¨)
                        handleLogout(true);
                    }
                });

                return () => subscription.unsubscribe();
            }, [supabase]);

            const handleLogin = async () => {
                if (!supabase) return alert('ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                try {
                    const { error } = await withTimeout(supabase.auth.signInWithOAuth({
                        provider: 'google',
                        options: { redirectTo: window.location.origin }
                    }));
                    if (error) alert('ë¡œê·¸ì¸ ì˜¤ë¥˜: ' + error.message);
                } catch (err) {
                    alert('ë¡œê·¸ì¸ ìš”ì²­ ì‹œê°„ ì´ˆê³¼: ' + err.message);
                }
            };

            // ì‹¤ì‹œê°„ í´ë¼ìš°ë“œ ë™ê¸°í™” (Debounced)
            useEffect(() => {
                if (!appData) return;
                const AUTO_SYNC_DELAY = 2000; // [ì„¤ì •] ìë™ ë™ê¸°í™” ëŒ€ê¸° ì‹œê°„ (ms) - í˜„ì¬ 2ì´ˆ
                const timer = setTimeout(() => {
                    saveToCloud(appData);
                }, AUTO_SYNC_DELAY);
                return () => clearTimeout(timer);
            }, [JSON.stringify(appData), isPro, verifiedEmail, isDemoMode, isCloudLoaded]);

            // í´ë¼ìš°ë“œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
            // [ìˆ˜ì •] isManual ì¸ì ì¶”ê°€
            const fetchFromCloud = async (email = verifiedEmail, pro = isPro, isInitialLoad = false, isManual = false, localDataOverride = null) => {
                if (isProcessing.current) return;

                setSyncStatus('syncing');
                setIsLoadingCloud(true);
                setSyncStatusError('');
                try {
                    const { data, error } = await withTimeout(supabase
                        .from('user_assets')
                        .select('data, updated_at')
                        .eq('email', email)
                        .maybeSingle());
                    
                    if (error) throw error;

                    if (data && data.data) {
                        const localLastUpdate = localStorage.getItem('assetDashboardLastUpdate');
                        const cloudLastUpdate = data.updated_at;

                        let shouldLoad = false;

                        // 1. ìˆ˜ë™ ë™ê¸°í™” ë²„íŠ¼ í´ë¦­ ì‹œ: ë¬´ì¡°ê±´ ë¡œë“œ
                        if (isManual) {
                            shouldLoad = true;
                        } 
                        // 2. ë¡œì»¬ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°: ë¬´ì¡°ê±´ ë¡œë“œ
                        else if (!localLastUpdate) {
                            shouldLoad = true;
                        } 
                        // 3. íƒ€ì„ìŠ¤íƒ¬í”„ ë¹„êµ
                        else {
                            const cloudTime = new Date(cloudLastUpdate).getTime();
                            const localTime = new Date(localLastUpdate).getTime();

                            // [ìˆ˜ì •] í´ë¼ìš°ë“œê°€ ë” ìµœì‹ ì´ê±°ë‚˜, ë¡œê·¸ì¸(ì´ˆê¸° ë¡œë“œ) ì‹œì ì—ëŠ” íƒ€ì„ìŠ¤íƒ¬í”„ê°€ ê°™ë”ë¼ë„ í™•ì‹¤í•œ ë™ê¸°í™”ë¥¼ ìœ„í•´ ë¡œë“œ
                            if (cloudTime > localTime || (isInitialLoad && cloudTime === localTime)) {
                                shouldLoad = true;
                            } else if (isInitialLoad && localTime > cloudTime) {
                                // [ìˆ˜ì •] ë¡œê·¸ì¸ ì§í›„ ë¡œì»¬ì´ ë” ìµœì‹ ì¼ ê²½ìš°: ì‚¬ìš©ìì—ê²Œ ì„ íƒê¶Œ ë¶€ì—¬
                                const cloudDateStr = new Date(cloudLastUpdate).toLocaleString();
                                const localDateStr = new Date(localLastUpdate).toLocaleString();
                                
                                if (confirm(`âš ï¸ ë°ì´í„° ì¶©ëŒ ê°ì§€\n\nâ˜ï¸ í´ë¼ìš°ë“œ: ${cloudDateStr}\nğŸ’» ë‚´ ê¸°ê¸°: ${localDateStr} (ë” ìµœì‹ )\n\ní´ë¼ìš°ë“œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™€ì„œ ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì·¨ì†Œ ì‹œ í˜„ì¬ ê¸°ê¸°ì˜ ë°ì´í„°ê°€ ìœ ì§€ë˜ë©°, ì ì‹œ í›„ í´ë¼ìš°ë“œì— ì €ì¥ë©ë‹ˆë‹¤.)`)) {
                                    shouldLoad = true;
                                } else {
                                    shouldLoad = false;
                                    // [ìˆ˜ì •] ë¡œì»¬ ìœ ì§€ë¥¼ ì„ íƒí–ˆìœ¼ë¯€ë¡œ, í˜„ì¬ ë¡œì»¬ ë°ì´í„°ë¥¼ í´ë¼ìš°ë“œì— ê°•ì œ ë™ê¸°í™”
                                    // localDataOverrideê°€ ìˆìœ¼ë©´(ì´ˆê¸° ë¡œë“œ ì‹œ) ê·¸ê²ƒì„ ì‚¬ìš©, ì•„ë‹ˆë©´ í˜„ì¬ appData ì‚¬ìš©
                                    setIsCloudLoaded(true); // ì €ì¥ í—ˆìš© ìƒíƒœë¡œ ë³€ê²½
                                    // [ìˆ˜ì •] ìƒíƒœ ì—…ë°ì´íŠ¸ ì „ì´ë¯€ë¡œ ì¸ìë¡œ ë°›ì€ email, pro ì •ë³´ë¥¼ ì§ì ‘ ì „ë‹¬
                                    saveToCloud(localDataOverride || appData, true, email, pro);
                                }
                            }
                        }

                        if (shouldLoad) {
                            
                            // [í•µì‹¬] ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë™ì•ˆ ìë™ ì €ì¥(Sync)ì´ íŠ¸ë¦¬ê±°ë˜ì§€ ì•Šë„ë¡ ë½ ì„¤ì •
                            isFetchingRef.current = true;
                            setAppData(data.data);
                            localStorage.setItem('assetDashboardLastUpdate', cloudLastUpdate);
                            lastSavedDataRef.current = JSON.stringify(data.data); // [ì¶”ê°€] ë¡œë“œëœ ë°ì´í„°ë¥¼ ê¸°ì¤€ì ìœ¼ë¡œ ì„¤ì •
                            // React ë Œë”ë§ ì‚¬ì´í´ ì´í›„ ë½ í•´ì œ
                            setTimeout(() => { isFetchingRef.current = false; }, 500);
                        }

                        setSyncStatus('synced');
                        setIsCloudLoaded(true); // [ì¶”ê°€] ë¡œë“œ ì™„ë£Œ í”Œë˜ê·¸ ì„¤ì •
                    } else {
                        // [ìˆ˜ì •] ì‹ ê·œ ì‚¬ìš©ì ì˜ˆì™¸ ì²˜ë¦¬
                        // RLS ì •ì±…ìƒ PRO ìœ ì €ë§Œ INSERT ê°€ëŠ¥í•˜ë¯€ë¡œ, FREE ìœ ì €ëŠ” INSERT ì‹œë„í•˜ì§€ ì•ŠìŒ
                        if (email) {
                            const { data: upsertData, error: upsertError } = await withTimeout(supabase
                                .from('user_assets')
                                .upsert({ 
                                    email: email, 
                                    data: publicDefaultData,
                                    updated_at: new Date().toISOString()
                                }, { onConflict: 'email' })
                                .select('updated_at')
                                .single());
                            
                            if (upsertError) throw upsertError;
                            if (upsertData) localStorage.setItem('assetDashboardLastUpdate', upsertData.updated_at);
                        }
                        setSyncStatus('synced');
                        setIsCloudLoaded(true); // [ì¶”ê°€] ì‹ ê·œ ìƒì„± í›„ì—ë„ ë¡œë“œ ì™„ë£Œë¡œ ì²˜ë¦¬
                    }
                } catch (err) {
                    console.error('Fetch error:', err);
                    setSyncStatusError(err.message || 'ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
                    setSyncStatus('error');
                    alert(`ë°ì´í„° ë™ê¸°í™” ì˜¤ë¥˜: ${err.message}`); // [ì¶”ê°€] ì‚¬ìš©ì ì•Œë¦¼
                } finally {
                    setIsLoadingCloud(false);
                }
            };

            // [ì¶”ê°€] ì‹¤ì‹œê°„ ë™ê¸°í™” êµ¬ë… (ë‹¤ë¥¸ ê¸°ê¸° ë³€ê²½ì‚¬í•­ ê°ì§€)
            useEffect(() => {
                if (!supabase || !verifiedEmail) return;

                const channel = supabase
                    .channel('realtime_assets')
                    .on(
                        'postgres_changes',
                        {
                            event: 'UPDATE',
                            schema: 'public',
                            table: 'user_assets',
                            filter: `email=eq.${verifiedEmail}`,
                        },
                        (payload) => {
                            const cloudTime = new Date(payload.new.updated_at).getTime();
                            const localTime = new Date(localStorage.getItem('assetDashboardLastUpdate') || 0).getTime();

                            // ë¡œì»¬ ë°ì´í„°ë³´ë‹¤ ìµœì‹ ì¸ ê²½ìš°ì—ë§Œ ë¡œë“œ (ë¬´í•œ ë£¨í”„ ë°©ì§€)
                            if (cloudTime > localTime) {
                                fetchFromCloud(verifiedEmail, isPro, false, false);
                            }
                        }
                    )
                    .subscribe();

                return () => {
                    supabase.removeChannel(channel);
                };
            }, [supabase, verifiedEmail, isPro]);



            const saveAsDefault = () => {
                if (confirm('í˜„ì¬ ì„¤ì •ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    localStorage.setItem('assetDashboardCustomDefault', JSON.stringify(appData));
                    alert('í˜„ì¬ ì„¤ì •ì´ ê¸°ë³¸ê°’ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
            };

            const loadCustomDefault = () => {
                try {
                    const customDefault = localStorage.getItem('assetDashboardCustomDefault');
                    if (customDefault) {
                        if (confirm('ì €ì¥ëœ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                            const parsed = JSON.parse(customDefault);
                            // ìŠ¤í‚¤ë§ˆ ë³´ì •: ëˆ„ë½ í•„ë“œ ì±„ì›€
                            const fallback = publicDefaultData;
                            if (!parsed.assets) parsed.assets = fallback.assets;
                            if (!parsed.monthlySalary) parsed.monthlySalary = fallback.monthlySalary;
                            if (!parsed.projectionMonths) parsed.projectionMonths = fallback.projectionMonths;
                            setAppData(parsed);
                            setOriginalUserData(parsed); // [ì¶”ê°€]
                            setIsDemoMode(false); // [ì¶”ê°€]
                            localStorage.setItem('assetDashboardUseDevDefaults','false');
                            alert('ì €ì¥ëœ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        }
                    } else {
                        if (confirm('ì €ì¥ëœ ê¸°ë³¸ê°’ì´ ì—†ìŠµë‹ˆë‹¤.\nì‚¬ì´íŠ¸ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                            setAppData(publicDefaultData);
                            setOriginalUserData(publicDefaultData); // [ì¶”ê°€]
                            setIsDemoMode(false); // [ì¶”ê°€]
                            alert('ì €ì¥ëœ ê¸°ë³¸ê°’ì´ ì—†ì–´ ì‚¬ì´íŠ¸ ê¸°ë³¸ê°’ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
                        }
                    }
                } catch (error) {
                    console.error('ê¸°ë³¸ê°’ ë¡œë“œ ì˜¤ë¥˜:', error);
                    alert('ê¸°ë³¸ê°’ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            };

            const cycleDisplayMode = () => {
                // í˜„ì¬: ì‚¬ìš©ì ëª¨ë“œ -> ë‹¤ìŒ: í”„ë¼ì´ë¹— ëª¨ë“œ
                if (!isDemoMode && appData?.displayMode === 'amount') {
                    setAppData(prev => ({ ...prev, displayMode: 'percent' }));
                    alert('í”„ë¼ì´ë¹— ëª¨ë“œë¡œ ì „í™˜í•©ë‹ˆë‹¤. ê¸ˆì•¡ì´ ìˆ¨ê²¨ì§‘ë‹ˆë‹¤.');
                } 
                // í˜„ì¬: í”„ë¼ì´ë¹— ëª¨ë“œ -> ë‹¤ìŒ: ë°ëª¨ ëª¨ë“œ
                else if (!isDemoMode && appData?.displayMode === 'percent') {
                    setAppData(publicDefaultData);
                    setIsDemoMode(true);
                    alert('ë°ëª¨ ëª¨ë“œë¡œ ì „í™˜í•©ë‹ˆë‹¤. ì´ ëª¨ë“œì—ì„œ ë³€ê²½í•œ ë‚´ìš©ì€ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                } 
                // í˜„ì¬: ë°ëª¨ ëª¨ë“œ -> ë‹¤ìŒ: ì‚¬ìš©ì ëª¨ë“œ
                else {
                    // displayModeë¥¼ 'amount'ë¡œ ë˜ëŒë ¤ì•¼ í•©ë‹ˆë‹¤.
                    setAppData({...originalUserData, displayMode: 'amount'});
                    setIsDemoMode(false);
                    alert('ì‚¬ìš©ì ë°ì´í„°ë¡œ ì „í™˜í•©ë‹ˆë‹¤.');
                }
            };

            // ì œëª©ì— í‘œì‹œë  í…ìŠ¤íŠ¸
            const titleText = isDemoMode 
                ? <span className="text-sm text-red-500">(ë°ëª¨ ëª¨ë“œ)</span>
                : appData?.displayMode === 'percent' 
                    ? <span className="text-sm text-blue-500">(í”„ë¼ì´ë¹— ëª¨ë“œ)</span> : null;

            // ===== ê°œì„ ëœ PDF ì €ì¥ í•¨ìˆ˜ =====
            const saveToPDF = async () => {
                try {
                    // ë¡œë”© ì•Œë¦¼ í‘œì‹œ
                    const loadingAlert = document.createElement('div');
                    loadingAlert.className = 'fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded shadow-lg z-50';
                    loadingAlert.textContent = 'PDF ìƒì„± ì¤‘...';
                    document.body.appendChild(loadingAlert);

                    // ìš”ì†Œ í™•ì¸
                    const element = document.getElementById('dashboard-content');
                    if (!element) {
                        throw new Error('ëŒ€ì‹œë³´ë“œ ì½˜í…ì¸ ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }

                    // [ìˆ˜ì •] PDF ì €ì¥ ì‹œ ë¼ì´íŠ¸ëª¨ë“œ ê°•ì œ ì ìš© (onclone í™œìš©)
                    const canvas = await html2canvas(element, {
                        scale: 1.2,
                        useCORS: true,
                        allowTaint: false,
                        // [ìˆ˜ì • ì‚¬í•­ 4] PDF ë°°ê²½ìƒ‰ì„ í°ìƒ‰ìœ¼ë¡œ ëª…ì‹œì  ì„¤ì •
                        backgroundColor: '#ffffff',
                        onclone: (clonedDoc) => {
                            clonedDoc.documentElement.classList.remove('dark');
                            clonedDoc.getElementById('dashboard-content').style.backgroundColor = '#f9fafb';
                        },
                        logging: false,
                        width: element.scrollWidth,
                        height: element.scrollHeight,
                        scrollX: 0,
                        scrollY: 0
                    });
                    
                    const imgData = canvas.toDataURL('image/png', 0.8);
                    
                    // jsPDF ì¸ìŠ¤í„´ìŠ¤ ìƒì„± í™•ì¸ (UMD ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í˜¸í™˜)
                    const JSPDF_NS = window.jspdf || window.jsPDF || window.jsPDFModule;
                    if (!JSPDF_NS || !JSPDF_NS.jsPDF) {
                        throw new Error('PDF ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                    const pdf = new JSPDF_NS.jsPDF('p', 'mm', 'a4');
                    const imgWidth = 210;
                    const pageHeight = 295;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 0;

                    // ì²« í˜ì´ì§€
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;

                    // ì¶”ê°€ í˜ì´ì§€
                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }

                    // íŒŒì¼ëª… ìƒì„±
                    const fileName = `ìì‚°ë¶„ì„ë³´ê³ ì„œ_${new Date().toISOString().split('T')[0]}.pdf`;
                    pdf.save(fileName);
                    
                    // ì„±ê³µ ì•Œë¦¼
                    loadingAlert.textContent = 'PDF ì €ì¥ ì™„ë£Œ!';
                    loadingAlert.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow-lg z-50';
                    
                    setTimeout(() => {
                        if (document.body.contains(loadingAlert)) {
                            document.body.removeChild(loadingAlert);
                        }
                    }, 2000);

                } catch (error) {
                    console.error('PDF ì €ì¥ ì˜¤ë¥˜:', error);
                    
                    // ì˜¤ë¥˜ ì•Œë¦¼
                    const errorAlert = document.createElement('div');
                    errorAlert.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded shadow-lg z-50';
                    errorAlert.textContent = `PDF ì €ì¥ ì‹¤íŒ¨: ${error.message}`;
                    document.body.appendChild(errorAlert);
                    
                    setTimeout(() => {
                        if (document.body.contains(errorAlert)) {
                            document.body.removeChild(errorAlert);
                        }
                    }, 5000);
                    // í˜¹ì‹œ ë‚¨ì•„ìˆëŠ” ë¡œë”© ì•Œë¦¼ ì œê±°
                    document.querySelectorAll('.fixed.top-4.right-4').forEach(el => {
                        if (el.textContent.includes('PDF')) {
                            el.parentNode && el.parentNode.removeChild(el);
                        }
                    });
                }
            };

            // ===== ì‹œë‚˜ë¦¬ì˜¤ ê´€ë¦¬ í•¨ìˆ˜ë“¤ =====
            const saveScenario = () => {
                // [ìˆ˜ì •] ì‹œë‚˜ë¦¬ì˜¤ ì €ì¥ ì‹œ ê¹”ë”í•œ ê¸°ë³¸ ì´ë¦„ ì œê³µ (ì§€ì €ë¶„í•œ ìë™ì™„ì„± ë°©ì§€)
                const name = prompt('ì‹œë‚˜ë¦¬ì˜¤ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', `ì‹œë‚˜ë¦¬ì˜¤ ${new Date().toISOString().slice(0,10)}`);
                if (name && name.trim()) {
                    const newScenario = {
                        id: Date.now(),
                        name: name.trim(),
                        data: { ...appData },
                        createdAt: new Date().toISOString()
                    };
                    setScenarios(prev => [...prev, newScenario]);
                    alert('ì‹œë‚˜ë¦¬ì˜¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
            };

            const loadScenario = (scenario) => {
                if (confirm(`"${scenario.name}" ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    setAppData(scenario.data);
                }
            };

            const deleteScenario = (id) => {
                if (confirm('ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    setScenarios(prev => prev.filter(s => s.id !== id));
                }
            };

            // ===== ì˜ˆì‚° ê³„ì‚° =====
            const totalMonthlyExpense = useMemo(() => {
                if (!monthlyExpenses || !Array.isArray(monthlyExpenses)) return 0;
                return monthlyExpenses.reduce((sum, e) => sum + Number(e.amount || 0), 0);
            }, [monthlyExpenses]);
            
            const totalSectorMonthlyContrib = useMemo(() => {
                if (!assets || typeof assets !== 'object') return 0;
                let sum = 0;
                Object.entries(assets).forEach(([sector, arr]) => {
                    if (Array.isArray(arr)) {
                        arr.forEach(asset => { sum += Number(asset.monthlyContrib || 0); });
                    }
                });
                return sum;
            }, [assets]);
            
            const maxSectorMonthlyContrib = useMemo(() => Math.max(0, monthlySalary - totalMonthlyExpense), [monthlySalary, totalMonthlyExpense]);
            const autoDepositAmount = Math.max(0, maxSectorMonthlyContrib - totalSectorMonthlyContrib);

            // ===== ê°œì„ ëœ ëª©í‘œ ë‹¬ì„± ê³„ì‚° =====
            const calculateGoalSeek = () => {
                if (!targetAmount || targetAmount <= 0) {
                    alert('ìœ íš¨í•œ ëª©í‘œ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                let months = 0;

                // [ìˆ˜ì •] ë©”ì¸ ê³„ì‚° ë¡œì§ì„ ì‚¬ìš©í•˜ì—¬ ëª©í‘œ ë‹¬ì„± ì‹œë®¬ë ˆì´ì…˜
                while (months < 600) { // ìµœëŒ€ 50ë…„(600ê°œì›”)ê¹Œì§€ë§Œ ê³„ì‚°
                    months++;
                    const result = calculateMonthlyProjection(appData, months);
                    const projections = result.projections;

                    // ê³„ì‚° ì¤‘ ì˜¤ë¥˜ ë°œìƒ ì‹œ ì¤‘ë‹¨
                    if (result.error) {
                        setGoalSeekResult(`ê³„ì‚° ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${projections.message}`);
                        // ì˜¤ë¥˜ê°€ ë°œìƒí•œ ì…ë ¥ë€ìœ¼ë¡œ í¬ì»¤ìŠ¤ ì´ë™
                        if (projections.refId) {
                            const targetElement = assetInputRefs.current[projections.refId];
                            if (targetElement) {
                                targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                setTimeout(() => targetElement.focus(), 500);
                            }
                        }
                        return;
                    }

                    const finalProjection = projections[projections.length - 1];
                    if (finalProjection.total >= targetAmount) {
                        setGoalSeekResult(`ëª©í‘œ ë‹¬ì„±ê¹Œì§€ ì•½ ${months}ê°œì›” ì†Œìš”ë©ë‹ˆë‹¤.`);
                        setProjectionMonths(months);
                        return;
                    }
                }
                
                // ë§¤ì›” ì‹œë®¬ë ˆì´ì…˜
                setGoalSeekResult('í˜„ì¬ ì¡°ê±´ìœ¼ë¡œëŠ” 50ë…„ ë‚´ ëª©í‘œ ë‹¬ì„±ì´ ì–´ë µìŠµë‹ˆë‹¤.');
            };

            // [ì¶”ê°€] ë ˆì´ì•„ì›ƒ ì´ë™ í•¨ìˆ˜
            const movePanel = (id, direction) => {
                const index = layoutOrder.indexOf(id);
                if (index === -1) return;
                const newIndex = index + direction;
                if (newIndex < 0 || newIndex >= layoutOrder.length) return;
                const newOrder = [...layoutOrder];
                [newOrder[index], newOrder[newIndex]] = [newOrder[newIndex], newOrder[index]]; // Swap
                setLayoutOrder(newOrder);
            };

            const togglePanelCollapse = (panelId) => {
                setPanelCollapseState(prev => ({
                    ...prev,
                    [panelId]: !prev[panelId]
                }));
            };

            const moveAssetSector = (sectorKey, direction) => {
                const index = assetSectorOrder.indexOf(sectorKey);
                if (index === -1) return;
                const newIndex = index + direction;
                if (newIndex < 0 || newIndex >= assetSectorOrder.length) return;
                const newOrder = [...assetSectorOrder];
                [newOrder[index], newOrder[newIndex]] = [newOrder[newIndex], newOrder[index]]; // Swap
                setAssetSectorOrder(newOrder);
            };

            const calculation = useMemo(() => {
                if (!appData || !appData.assets || typeof appData.assets !== 'object') {
                    return {
                        initial: {},
                        projected: {},
                        currentTotal: 0,
                        projectedTotal: 0,
                        growth: 0,
                        grand: 0,
                        realValue: 0,
                        monthlyProjections: [],
                        warnings: []
                    };
                }
                
                const months = projectionMonths;
                // [ìˆ˜ì •] ì¸í”Œë ˆì´ì…˜ ë³´ì • ë° ì´ë²¤íŠ¸ ë°°ì—´ ì•ˆì „ì„± í™•ë³´ (undefined ë°©ì§€)
                const safeAppData = {
                    ...appData,
                    incomeEvents: Array.isArray(appData.incomeEvents) ? appData.incomeEvents : [],
                    expenseEvents: Array.isArray(appData.expenseEvents) ? appData.expenseEvents : []
                };
                const { projections: monthlyProjections, warnings } = calculateMonthlyProjection({ ...safeAppData, inflationRate }, months);

                if (!monthlyProjections || monthlyProjections.length === 0) {
                    return { error: true, warnings: [] };
                }

                const finalProjection = monthlyProjections[months];

                const calculateTotal = (assetData) => {
                    let sum = 0;
                    Object.keys(assetData).forEach(sector => {
                        const sectorSum = (assetData[sector]||[]).reduce((s,a)=> s + (a.amount||0), 0);
                        sum += (sector === 'loan') ? -sectorSum : sectorSum;
                    });
                    return sum;
                };

                const currentTotal = calculateTotal(appData.assets);
                const projectedTotal = finalProjection ? finalProjection.total : currentTotal;
                
                // [ì¶”ê°€] ì¸í”Œë ˆì´ì…˜ ë³´ì • í˜„ì¬ ê°€ì¹˜ ê³„ì‚° (Summary íŒ¨ë„ íš¨ìœ¨ì„± ê°œì„ )
                const realValue = projectedTotal / Math.pow(1 + inflationRate / 100, months / 12);

                return {
                    initial: appData.assets,
                    projected: finalProjection ? finalProjection.assets : appData.assets,
                    currentTotal,
                    projectedTotal,
                    realValue,
                    growth: projectedTotal - currentTotal,
                    grand: currentTotal,
                    monthlyProjections: monthlyProjections,
                    warnings: warnings
                };
            }, [JSON.stringify(appData), inflationRate, projectionMonths]);



            const currentGrossTotal = calculateGrossTotal(calculation.initial);
            const projectedGrossTotal = calculateGrossTotal(calculation.projected);
            const currentSectorTotals = getSectorTotals(calculation.initial, currentGrossTotal);
            const projectedSectorTotals = getSectorTotals(calculation.projected, projectedGrossTotal);

            // ===== ë¦¬ë°¸ëŸ°ì‹± ê²½ê³  í•¨ìˆ˜ (ëª©í‘œ ë¹„ì¤‘ ê¸°ì¤€ í¸ì°¨) =====
            const getRebalanceStatus = (sectorKey, percentage) => {
                const target = rebalancingTargets[sectorKey] ?? (100 / Object.keys(sectorInfo).length);
                const deviation = Math.abs(percentage - target);
                const thresholds = rebalancingAlerts[sectorKey] || { warning: 5, danger: 10 };
                if (deviation >= thresholds.danger) return 'bg-red-100 text-red-800 dark:bg-red-900/60 dark:text-red-100';
                if (deviation >= thresholds.warning) return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/60 dark:text-yellow-100';
                return '';
            };

            // ===== ìë™ì…ê¸ˆ ê³„ì‚°ì‹ í‘œì‹œ í•¨ìˆ˜ =====
            const getAutoDepositBreakdown = () => {
                const breakdown = [];
                Object.keys(assets).forEach(sectorKey => {
                    if (Array.isArray(assets[sectorKey])) {
                        assets[sectorKey].forEach(asset => {
                            if (asset.monthlyContrib > 0) {
                                breakdown.push({
                                    sector: sectorKey,
                                    name: asset.name,
                                    amount: asset.monthlyContrib
                                });
                            }
                        });
                    }
                });
                return breakdown;
            };

            const autoDepositBreakdown = getAutoDepositBreakdown();

            // ===== ì°¨íŠ¸ ì„¤ì • =====
            useEffect(() => {
    // [ìˆ˜ì •] ì°¨íŠ¸ íŒ¨ë„ì´ ì ‘í˜€ìˆìœ¼ë©´ ë‹¤ì‹œ ê·¸ë¦¬ì§€ ì•ŠìŒ
    if (panelCollapseState['charts']) return;

    if (!appData || !currentPieRef.current || !projectedPieRef.current || !comparisonBarRef.current) return;

    // [ìˆ˜ì •] DOM ë Œë”ë§ í™•ë³´ë¥¼ ìœ„í•´ ì°¨íŠ¸ ìƒì„±ì„ ì•½ê°„ ì§€ì—° (ì°¨íŠ¸ ë¯¸í‘œì‹œ ë¬¸ì œ í•´ê²°)
    const renderTimer = setTimeout(() => {

    const sectorLabels = {
        deposit: 'ì…ì¶œê¸ˆí†µì¥',
        savings: 'ì €ì¶•',
        investment: 'íˆ¬ì',
        pension: 'ì—°ê¸ˆ',
        realestate: 'ë¶€ë™ì‚°',
        car: 'ìë™ì°¨',
        loan: 'ëŒ€ì¶œ',
        misc: 'ê¸°íƒ€'
    };

    // [ì¶”ê°€] ë‹¤í¬ëª¨ë“œ ëŒ€ì‘ ìƒ‰ìƒ ì •ì˜
    const textColor = darkMode ? '#e5e7eb' : '#111827';
    const gridColor = darkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
    const chartBorderColor = darkMode ? '#111827' : '#ffffff';

    // ì°¨íŠ¸ ë°ì´í„° ì¤€ë¹„
    const filteredKeys = Object.keys(currentSectorTotals).filter(k => k !== 'loan');
    const currentLabels = filteredKeys.map(key => sectorLabels[key]);
    const currentData = filteredKeys.map(key => currentSectorTotals[key]?.amount || 0);
    const projectedKeys = Object.keys(projectedSectorTotals).filter(k => k !== 'loan');
    const projectedLabels = projectedKeys.map(key => sectorLabels[key]);
    const projectedData = projectedKeys.map(key => projectedSectorTotals[key].amount);

    const forecastDateText = (() => {
        const [y,m] = (baseMonth || new Date().toISOString().slice(0,7)).split('-').map(Number);
        const date = new Date(y, m - 1 + projectionMonths);
        return `${String(date.getFullYear()).slice(2)}ë…„ ${String(date.getMonth()+1).padStart(2,'0')}ì›”`;
    })();

    const createGradient = (ctx, colors) => {
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, colors.start);
        gradient.addColorStop(1, colors.end);
        return gradient;
    };

    // [ìµœì í™”] ì°¨íŠ¸ ì—…ë°ì´íŠ¸/ìƒì„± í—¬í¼ í•¨ìˆ˜
    const updateOrCreateChart = (ref, config) => {
        if (ref.current) {
            if (ref.current._chart) {
                ref.current._chart.destroy();
            }
            ref.current._chart = new Chart(ref.current, config);
        }
    };

    // í˜„ì¬ í¬íŠ¸í´ë¦¬ì˜¤ ì°¨íŠ¸
    updateOrCreateChart(currentPieRef, {
        type: 'doughnut',
        data: { 
            labels: currentLabels, 
            datasets: [{ 
                data: currentData, 
                backgroundColor: filteredKeys.map(key => {
                    const colors = tailwind.config.theme.extend.colors[key];
                    return createGradient(currentPieRef.current.getContext('2d'), colors);
                }),
                borderWidth: darkMode ? 1.5 : 3,
                borderColor: chartBorderColor,
                hoverBorderWidth: 5,
                hoverBorderColor: chartBorderColor,
                hoverOffset: 40
            }] 
        },
        options: {
            responsive: true,
            animation: {
                animateScale: true,
                animateRotate: true,
                duration: 1500,
                easing: 'easeInOutQuart'
            },
            plugins: { 
                legend: { position: 'bottom', labels: { color: textColor } },
                title: { display: true, text: 'í˜„ì¬ í¬íŠ¸í´ë¦¬ì˜¤', color: textColor },
                datalabels: {
                    anchor: 'end',
                    align: 'start',
                    offset: 20,
                    color: textColor,
                    font: function(context) {
                        return {
                            weight: 'bold',
                            size: context.active ? 16 : 11
                        };
                    },
                    borderRadius: 4,
                    padding: 6,
                    formatter: (value, context) => {
                        const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0) || 1;
                        const percentage = (value / total) * 100;
                        return (percentage > 5 || context.active) ? `${percentage.toFixed(1)}%` : '';
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.85)',
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 13 },
                    padding: 12,
                    cornerRadius: 8,
                    displayColors: true,
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = Math.round(context.parsed).toLocaleString();
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return ` ${label}: ${value}ë§Œì› (${percentage}%)`;
                        }
                    }
                }
            }
        },
        plugins: [ChartDataLabels]
    });

    // ì˜ˆìƒ í¬íŠ¸í´ë¦¬ì˜¤ ì°¨íŠ¸
    updateOrCreateChart(projectedPieRef, {
        type: 'doughnut',
        data: { 
            labels: projectedLabels, 
            datasets: [{ 
                data: projectedData, 
                backgroundColor: projectedKeys.map(key => {
                    const colors = tailwind.config.theme.extend.colors[key];
                    return createGradient(projectedPieRef.current.getContext('2d'), colors);
                }),
                borderWidth: darkMode ? 1.5 : 3,
                borderColor: chartBorderColor,
                hoverBorderWidth: 5,
                hoverBorderColor: chartBorderColor,
                hoverOffset: 40
            }] 
        },
        options: {
            responsive: true,
            animation: {
                animateScale: true,
                animateRotate: true,
                duration: 1500,
                easing: 'easeInOutQuart',
                delay: 200
            },
            plugins: {
                legend: { position: 'bottom', labels: { color: textColor } },
                title: { display: true, text: `${projectionMonths}ê°œì›” í›„ ì˜ˆìƒ ${forecastDateText ? `(${forecastDateText})` : ''}`, color: textColor },
                datalabels: {
                    anchor: 'end', 
                    align: 'start',
                    offset: 20,
                    color: textColor,
                    font: function(context) {
                        return {
                            weight: 'bold',
                            size: context.active ? 16 : 11
                        };
                    },
                    borderRadius: 4,
                    padding: 6,
                    formatter: (value, context) => {
                        const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0) || 1;
                        const percentage = (value / total) * 100;
                        return (percentage > 5 || context.active) ? `${percentage.toFixed(1)}%` : '';
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.85)',
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 13 },
                    padding: 12,
                    cornerRadius: 8,
                    displayColors: true,
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = Math.round(context.parsed).toLocaleString();
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return ` ${label}: ${value}ë§Œì› (${percentage}%)`;
                        }
                    }
                }
            }
        },
        plugins: [ChartDataLabels]
    });

    // ë¹„êµ ì°¨íŠ¸
updateOrCreateChart(comparisonBarRef, {
    type: 'bar',
    data: {
        labels: projectedLabels,
        datasets: [
            { 
                label: 'í˜„ì¬', 
                data: currentData, 
                backgroundColor: 'rgba(156, 163, 175, 0.7)',
                borderColor: chartBorderColor,
                borderWidth: 2,
                borderRadius: 6,
                borderSkipped: false
            },
            { 
                label: 'ì˜ˆìƒ', 
                data: projectedData, 
                backgroundColor: (context) => {
                    const ctx = context.chart.ctx;
                    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                    gradient.addColorStop(0, 'rgba(96, 165, 250, 0.9)');
                    gradient.addColorStop(1, 'rgba(59, 130, 246, 0.8)');
                    return gradient;
                },
                borderColor: chartBorderColor,
                borderWidth: 2,
                borderRadius: 6,
                borderSkipped: false
            }
        ]
    },
    options: {
        responsive: true,
        scales: { 
            x: { 
                position: 'bottom',
                ticks: { color: textColor },
                grid: { color: gridColor }
            }, 
            y: { 
                beginAtZero: true,
                ticks: { color: textColor },
                grid: { color: gridColor }
            } 
        },
        plugins: {
            legend: { 
                position: 'top',
                align: 'end',
                labels: { usePointStyle: true, pointStyle: 'rectRounded', color: textColor }
            },
            title: { 
                display: true, 
                text: 'ğŸ“Š í˜„ì¬ ìì‚° vs ì˜ˆìƒ ìì‚°',
                font: { size: 18, weight: 'bold' }, color: textColor,
                padding: { top: 10, bottom: 20 }
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.85)',
                titleFont: { size: 14, weight: 'bold' },
                bodyFont: { size: 13 },
                padding: 12,
                cornerRadius: 8,
                displayColors: true,
                callbacks: {
                    label: function(context) {
                        const value = Math.round(context.parsed.y).toLocaleString();
                        return ` ${context.dataset.label}: ${value}ë§Œì›`;
                    }
                }
            },
            // ë§‰ëŒ€ ì°¨íŠ¸ì—ì„œëŠ” ë°ì´í„° ë¼ë²¨ì„ ìˆ¨ê²¨ ê¹”ë”í•˜ê²Œ í‘œì‹œ
            datalabels: { display: false }
        }
    },
    plugins: []
}); 

    }, 50); // 50ms ì§€ì—°

    return () => clearTimeout(renderTimer);
            }, [calculation, panelCollapseState['charts'], darkMode]);

            // [ì¶”ê°€] ì»´í¬ë„ŒíŠ¸ ì–¸ë§ˆìš´íŠ¸ ì‹œì—ë§Œ ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ì •ë¦¬
            useEffect(() => {
                return () => {
                    [currentPieRef, projectedPieRef, comparisonBarRef, historyChartRef].forEach(ref => {
                        if (ref.current && ref.current._chart) {
                            ref.current._chart.destroy();
                            ref.current._chart = null;
                        }
                    });
                };
            }, []);


            // [ë¶„ë¦¬] íˆìŠ¤í† ë¦¬ ì°¨íŠ¸ ì „ìš© useEffect
            useEffect(() => {
                if (panelCollapseState['history'] || !historyChartRef.current || assetHistory.length === 0) return;
                 
                // [ì¶”ê°€] ë‹¤í¬ëª¨ë“œ ëŒ€ì‘ ìƒ‰ìƒ ì •ì˜
                const textColor = darkMode ? '#e5e7eb' : '#111827';
                const gridColor = darkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';

                const historyLabels = assetHistory.map(item => {
                    const date = new Date(item.date);
                    const timeStr = item.time ? ` ${item.time.split(':').slice(0, 2).join(':')}` : '';
                    return `${date.getMonth() + 1}/${date.getDate()}${timeStr}`;
                });
                const historyData = assetHistory.map(item => item.netWorth); 
                
                let finalLabels = [...historyLabels];
                let finalHistoryData = [...historyData];
                let projectionData = new Array(historyData.length).fill(null);

                if (showProjectionInHistory && calculation.monthlyProjections && calculation.monthlyProjections.length > 0) {
                    // ë§ˆì§€ë§‰ íˆìŠ¤í† ë¦¬ ì§€ì ê³¼ ì—°ê²°í•˜ì—¬ ì—°ì†ì„± í™•ë³´
                    projectionData[historyData.length - 1] = historyData[historyData.length - 1];
                    
                    calculation.monthlyProjections.forEach((p, idx) => {
                        if (idx === 0) return;
                        
                        // ë¯¸ë˜ ë‚ ì§œ ë¼ë²¨ ìƒì„±
                        const [y, m] = (baseMonth || new Date().toISOString().slice(0, 7)).split('-').map(Number);
                        const d = new Date(y, m - 1 + idx);
                        const label = `${String(d.getFullYear()).slice(2)}ë…„ ${String(d.getMonth() + 1).padStart(2, '0')}ì›” (ì˜ˆìƒ)`;
                        
                        finalLabels.push(label);
                        projectionData.push(Math.floor(p.total)); // ë§Œì› ì´í•˜ ì ˆì‚­
                        finalHistoryData.push(null);
                    });
                }

                const datasets = [
                    {
                        label: 'ìˆœìì‚° (ë§Œì›)',
                        data: finalHistoryData,
                        borderColor: 'rgb(79, 70, 229)',
                        backgroundColor: darkMode ? 'rgba(79, 70, 229, 0.5)' : 'rgba(79, 70, 229, 0.3)',
                        backgroundColor: (context) => {
                            const ctx = context.chart.ctx;
                            const gradient = ctx.createLinearGradient(0, 0, 0, 200);
                            gradient.addColorStop(0, 'rgba(79, 70, 229, 0.3)');
                            gradient.addColorStop(1, 'rgba(79, 70, 229, 0)');
                            return gradient;
                        },
                        tension: 0.3,
                        fill: true,
                        pointBackgroundColor: 'rgb(79, 70, 229)',
                        pointHoverRadius: 6,
                        pointHoverBackgroundColor: 'rgb(255, 255, 255)',
                        pointHoverBorderWidth: 2,
                        pointHoverBorderColor: 'rgb(79, 70, 229)'
                    }
                ];

                if (showProjectionInHistory) {
                    datasets.push({
                        label: 'ì˜ˆìƒ ìì‚° (ë§Œì›)',
                        data: projectionData,
                        borderColor: 'rgba(79, 70, 229, 0.5)',
                        borderDash: [5, 5], // ì ì„  í‘œì‹œ
                        tension: 0.3,
                        fill: false,
                        pointRadius: 2,
                        pointBackgroundColor: 'rgba(79, 70, 229, 0.5)'
                    });
                }

                if (goalMode === 'target' && targetAmount > 0) {
                    datasets.push({
                        label: `ëª©í‘œ ìì‚° (${formatNumber(targetAmount, displayMode)}ë§Œì›)`,
                        data: new Array(finalLabels.length).fill(targetAmount),
                        borderColor: 'rgba(239, 68, 68, 0.8)',
                        borderDash: [5, 5],
                        pointRadius: 0,
                        fill: false,
                        borderWidth: 2
                    });
                }

                // [ìµœì í™”] íˆìŠ¤í† ë¦¬ ì°¨íŠ¸ë„ updateOrCreateChart íŒ¨í„´ ì ìš© (ì§ì ‘ êµ¬í˜„)
                const chartConfig = {
                    type: 'line',
                    data: {
                        labels: finalLabels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom', labels: { color: textColor } },
                            title: { display: false },
                            tooltip: { mode: 'index', intersect: false }
                        },
                        scales: { 
                            y: { 
                                beginAtZero: true,
                                ticks: { color: textColor },
                                grid: { color: gridColor }
                            },
                            x: {
                                ticks: { color: textColor },
                                grid: { color: gridColor }
                            }
                        }
                    }
                };

                if (historyChartRef.current) {
                    if (historyChartRef.current._chart) {
                        historyChartRef.current._chart.destroy();
                    }
                    historyChartRef.current._chart = new Chart(historyChartRef.current, chartConfig);
                }

            }, [assetHistory, panelCollapseState['history'], goalMode, targetAmount, displayMode, showProjectionInHistory, calculation.monthlyProjections, baseMonth, darkMode]); // [ìˆ˜ì •] darkMode ì˜ì¡´ì„± ì¶”ê°€

            // ===== ìì‚° ê´€ë¦¬ í•¨ìˆ˜ë“¤ =====
            const addAsset = (sector) => setAssets(prev => ({
                ...prev,
                [sector]: [...(prev[sector] || []), {
                    id: Date.now() + Math.random(), // ê³ ìœ  ID ì¶”ê°€
                    name: 'ìƒˆ í•­ëª©',
                    amount: 0,
                    rate: sector === 'loan' ? 3.0 : (sector === 'car' ? -2.0 : 10.0),
                    feeRate: 0,
                    monthlyContrib: 0, // ëŒ€ì¶œì˜ ê²½ìš° 'ì›” ìƒí™˜ì•¡'ìœ¼ë¡œ ì‚¬ìš©
                    extraContrib: 0, 
                    extraFrom: (Object.values(prev).flat().find(a => a.name === 'ìƒí™œë¹„í†µì¥')?.name) || (Object.values(prev).flat()[0]?.name) || '',
                    // [ìˆ˜ì •] ëŒ€ì¶œ ì „ìš© í•„ë“œ ì¶”ê°€
                    repaymentMethod: 'ì›ë¦¬ê¸ˆê· ë“±', // ìƒí™˜ë°©ì‹
                    repaymentAccount: (Object.values(prev).flat().find(a => a.name === 'ìƒí™œë¹„í†µì¥')?.name) || (Object.values(prev).flat()[0]?.name) || '',
                    maturityMonth: 36,
                    loanStartDate: baseMonth
                }]
            }));

            const updateAsset = (sector, index, field, value) => {
                const numberFields = ['amount', 'rate', 'feeRate', 'monthlyContrib', 'extraContrib', 'maturityMonth']; 

                let newValue = numberFields.includes(field) ? Number(value) : value; 

                if (numberFields.includes(field) && isNaN(newValue)) {
                    newValue = 0; // ìˆ«ìê°€ ì•„ë‹Œ ê°’ì´ ë“¤ì–´ì˜¤ë©´ 0ìœ¼ë¡œ ì²˜ë¦¬
                }

                if ((field === 'monthlyContrib' || field === 'extraContrib') && newValue < 0) return;
                setAssets(prev => ({
                    ...prev,
                    [sector]: prev[sector].map((asset, i) => i === index ? { ...asset, [field]: newValue } : asset)
                }));
            };

            const removeAsset = (sector, index) => {
                const assetToRemove = assets[sector][index];
                if (assetToRemove.name === mainCashFlowAccount) {
                    const allAccounts = Object.values(assets).flat();
                    const nextAccount = allAccounts.find(a => a.id !== assetToRemove.id);
                    
                    if (nextAccount) {
                        setMainCashFlowAccount(nextAccount.name);
                    } else {
                        alert('ìµœì†Œ í•œ ê°œì˜ ê³„ì¢ŒëŠ” ìœ ì§€ë˜ì–´ì•¼ í•˜ë©°, ì£¼ í˜„ê¸ˆíë¦„ ê³„ì¢Œë¡œ ì„¤ì •ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.');
                        return;
                    }
                }
                setAssets(prev => ({
                    ...prev,
                    [sector]: prev[sector].filter((_, i) => i !== index)
                }));
            };

            // ===== ì§€ì¶œ ê´€ë¦¬ í•¨ìˆ˜ë“¤ =====
            const addExpense = () => setMonthlyExpenses(prev => [...prev, { name: 'ìƒˆ ì§€ì¶œ', amount: 0 }]);
            const updateExpense = (index, field, value) => setMonthlyExpenses(prev => prev.map((expense, i) => 
                i === index ? { ...expense, [field]: field === 'name' ? value : Number(value) } : expense
            ));
            const removeExpense = (index) => setMonthlyExpenses(prev => prev.filter((_, i) => i !== index));

            // ===== ì„¹í„° ì •ë³´ (í•¨ìˆ˜ ì •ì˜ ì „ì— ìœ„ì¹˜) =====
            // ===== ì´ë²¤íŠ¸ ê´€ë¦¬ í•¨ìˆ˜ë“¤ =====
            const addIncomeEvent = () => {
                setIncomeEvents(prev => {
                    // prevê°€ ë°°ì—´ì´ ì•„ë‹ ê²½ìš°ë¥¼ ëŒ€ë¹„í•˜ì—¬ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
                    const currentEvents = Array.isArray(prev) ? prev : [];
                    return [...currentEvents, { 
                        name: 'ìƒˆ ìˆ˜ì… ì´ë²¤íŠ¸', amount: 0, startMonth: baseMonth, endMonth: baseMonth, targetSector: 'deposit', targetAsset: 0 
                    }];
                });
            };
            
            const updateIncomeEvent = (index, field, value) => {
                try {
                    // incomeEventsê°€ ë°°ì—´ì¸ì§€ í™•ì¸
                    if (!Array.isArray(incomeEvents)) {
                        console.warn('incomeEvents is not an array:', incomeEvents);
                        return;
                    }
                    
                    // ì…ë ¥ê°’ ê²€ì¦
                    if (index < 0 || index >= incomeEvents.length) {
                        console.warn('Invalid income event index:', index);
                        return;
                    }
                    
                    let newValue = value;
                    
                    // ìˆ«ì í•„ë“œ ê²€ì¦
                    if (field === 'amount' || field === 'targetAsset') {
                        const numValue = Number(value);
                        if (isNaN(numValue)) {
                            console.warn('Invalid number value:', value);
                            return;
                        }
                        newValue = Math.max(0, numValue); // ìŒìˆ˜ ë°©ì§€
                    }
                    
                    // ì„¹í„° í•„ë“œ ê²€ì¦
                    if (field === 'targetSector' && !Object.keys(sectorInfo).includes(value)) {
                        console.warn('Invalid target sector:', value);
                        return;
                    }
                    
                    setIncomeEvents(prev => {
                        if (!Array.isArray(prev)) {
                            console.warn('Previous incomeEvents is not an array:', prev);
                            return prev;
                        }
                        return prev.map((event, i) => 
                            i === index ? { ...event, [field]: newValue } : event
                        );
                    });
                } catch (error) {
                    console.error('Error updating income event:', error);
                }
            };
            
            const removeIncomeEvent = (index) => {
                try {
                    // incomeEventsê°€ ë°°ì—´ì¸ì§€ í™•ì¸
                    if (!Array.isArray(incomeEvents)) {
                        console.warn('incomeEvents is not an array:', incomeEvents);
                        return;
                    }
                    
                    // ì¸ë±ìŠ¤ ê²€ì¦
                    if (index < 0 || index >= incomeEvents.length) {
                        console.warn('Invalid income event index for removal:', index);
                        return;
                    }
                    
                    setIncomeEvents(prev => {
                        if (!Array.isArray(prev)) {
                            console.warn('Previous incomeEvents is not an array:', prev);
                            return prev;
                        }
                        return prev.filter((_, i) => i !== index);
                    });
                } catch (error) {
                    console.error('Error removing income event:', error);
                }
            };

            const addExpenseEvent = () => setExpenseEvents(prev => {
                // prevê°€ ë°°ì—´ì´ ì•„ë‹ ê²½ìš°ë¥¼ ëŒ€ë¹„í•˜ì—¬ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
                const currentEvents = Array.isArray(prev) ? prev : [];
                return [...currentEvents, { 
                    name: 'ìƒˆ ì§€ì¶œ ì´ë²¤íŠ¸', amount: 0, startMonth: baseMonth, endMonth: baseMonth, targetSector: 'deposit', targetAsset: 0 
                }];
            });
            const updateExpenseEvent = (index, field, value) => {
                let newValue = value;
                const numberFields = ['amount', 'targetAsset'];

                if (numberFields.includes(field)) {
                    const numValue = Number(value);
                    if (!isNaN(numValue)) {
                        newValue = Math.max(0, numValue); // ìŒìˆ˜ ë°©ì§€
                    }
                }

                setExpenseEvents(prev => {
                    // prevê°€ ë°°ì—´ì´ ì•„ë‹ ê²½ìš°ë¥¼ ëŒ€ë¹„í•˜ì—¬ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
                    const currentEvents = Array.isArray(prev) ? prev : [];
                    return currentEvents.map((event, i) =>
                        i === index ? { ...event, [field]: newValue } : event
                    );
                });
            };
            const removeExpenseEvent = (index) => setExpenseEvents(prev => {
                // prevê°€ ë°°ì—´ì´ ì•„ë‹ ê²½ìš°ë¥¼ ëŒ€ë¹„í•˜ì—¬ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
                const currentEvents = Array.isArray(prev) ? prev : [];
                return currentEvents.filter((_, i) => i !== index);
            });
            // ===== ë¦¬ë°¸ëŸ°ì‹± ì•Œë¦¼ ì„¤ì • í•¨ìˆ˜ë“¤ =====
            const updateRebalancingAlert = (sector, type, value) => { 
                setRebalancingAlerts(prev => ({
                    ...prev,
                    [sector]: { ...prev[sector], [type]: Number(value) }
                }));
            };


            const savingsPanelSectors = ['deposit','savings','investment','misc'];
            const assetsPanelSectors = ['realestate','car','misc'];
            const loanPanelSectors = ['loan'];

            const renderSummaryPanel = () => {
                const lastProj = calculation.monthlyProjections && calculation.monthlyProjections[projectionMonths];
                let compLabel = "";
                let compVal = 0;
                let compPct = 0;

                if (!calculation.error && projectionMonths >= 1 && calculation.monthlyProjections?.length > projectionMonths) {
                    if (projectionMonths <= 12) {
                        const prevProj = calculation.monthlyProjections[projectionMonths - 1];
                        compVal = lastProj.total - prevProj.total;
                        compPct = prevProj.total !== 0 ? (compVal / Math.abs(prevProj.total)) * 100 : 0;
                        compLabel = "ì „ì›” ëŒ€ë¹„";
                    } else {
                        const prevProj = calculation.monthlyProjections[projectionMonths - 12];
                        compVal = lastProj.total - prevProj.total;
                        compPct = prevProj.total !== 0 ? (compVal / Math.abs(prevProj.total)) * 100 : 0;
                        compLabel = "1ë…„ ì „ ëŒ€ë¹„";
                    }
                }

                return (
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 transition-colors">
                    <div className="md:col-span-1 bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-blue-900/40 dark:to-indigo-900/40 rounded-xl shadow-lg p-6">
                        <div>
                            <h2 className="text-lg font-semibold mb-2 text-gray-600 dark:text-white">í˜„ì¬ ì´ìì‚°</h2>
                            <p className="text-3xl font-bold text-blue-600 dark:text-blue-400">{formatNumber(calculation.currentTotal, displayMode)}ë§Œì›</p>
                        </div>
                        <div className="mt-6"> 
                            <h2 className="text-lg font-semibold mb-2 text-gray-600 dark:text-white">{projectionMonths}ê°œì›” í›„ ì˜ˆìƒ <span className="text-gray-400 text-sm">({(() => { try { const [y,m]= (baseMonth||'').split('-').map(Number); const d = new Date(y||new Date().getFullYear(), (m||1)-1, 1); d.setMonth(d.getMonth()+projectionMonths); return `${String(d.getFullYear()).slice(2)}ë…„ ${String(d.getMonth()+1).padStart(2,'0')}ì›”`; } catch { return ''; } })()})</span></h2>
                            <p className="text-3xl font-bold text-green-600 dark:text-green-400">{formatNumber(calculation.projectedTotal, displayMode)}ë§Œì›</p>
                            <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">ì˜ˆìƒ ì¦ê°€ì•¡: +{formatNumber(calculation.growth, displayMode)}ë§Œì› ({formatPercent((calculation.growth) / Math.max(1, calculation.currentTotal) * 100)}%)</p>         
                            {compLabel && (
                                <p className="text-xs text-gray-400 mt-1">
                                    ({compLabel}: {compVal >= 0 ? '+' : ''}{formatNumber(compVal, displayMode)}ë§Œì›, {compVal >= 0 ? '+' : ''}{formatPercent(compPct)}%)
                                </p>
                            )}
                            <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                ì¸í”Œë ˆì´ì…˜ ê³ ë ¤ ì‹œ: {formatNumber(calculation.realValue, displayMode)}ë§Œì›
                            </p>
                        </div>
                    </div>
                    <div className="md:col-span-1 bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6"> 
                        <h2 className="text-xl font-bold text-gray-800 dark:text-white mb-4">í•µì‹¬ ì„¤ì •</h2>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 dark:text-white mb-1">ì›”ê¸‰ (ë§Œì›)</label>
                                <input type="number" className="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" value={monthlySalary} onChange={(e) => setMonthlySalary(Number(e.target.value))} />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 dark:text-white mb-1">ê¸°ì¤€ì›” (ê³„ì‚° ì‹œì‘)</label>
                                <input type="month" className="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" value={baseMonth} onChange={(e) => setBaseMonth(e.target.value)} />
                            </div>
                            <div className="pt-4 border-t dark:border-gray-700">
                                <h3 className="text-md font-semibold text-gray-700 dark:text-white mb-2">ë°ì´í„° ê´€ë¦¬</h3>
                                <div className="grid grid-cols-2 sm:grid-cols-2 gap-2">
                                    <button onClick={() => setIsExportModalOpen(true)} className="flex items-center justify-center gap-2 px-2 py-2 bg-green-500 text-white text-[10px] sm:text-xs font-semibold rounded-lg hover:bg-green-600 shadow-sm transition-all">
                                        <span>ğŸ“¤</span> ë°ì´í„° ë‚´ë³´ë‚´ê¸°
                                    </button>
                                    <button onClick={() => setIsImportModalOpen(true)} className="flex items-center justify-center gap-2 px-2 py-2 bg-purple-500 text-white text-[10px] sm:text-xs font-semibold rounded-lg hover:bg-purple-600 shadow-sm transition-all">
                                        <span>ğŸ“¥</span> ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
                                    </button>
                                    <button onClick={saveCurrentAsset} className="col-span-2 flex items-center justify-center gap-2 px-3 py-2 bg-indigo-500 text-white text-sm font-semibold rounded-lg hover:bg-indigo-600 shadow-sm hover:shadow-md transition-all">
                                        <span>ğŸ’¾</span> íˆìŠ¤í† ë¦¬ ì €ì¥
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div className="md:col-span-1 bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6"> 
                        <h2 className="text-xl font-bold text-gray-800 dark:text-white mb-4">ëª©í‘œ ì„¤ì •</h2>
                        <div className="mb-4">
                            <div className="flex border border-gray-200 dark:border-gray-700 rounded-lg p-1 bg-gray-100 dark:bg-gray-900">
                                <button onClick={() => { setGoalMode('period'); setGoalSeekResult(null); }} className={`flex-1 py-2 text-sm font-semibold rounded-md transition-colors ${goalMode === 'period' ? 'bg-white dark:bg-gray-700 text-blue-600 dark:text-blue-400 shadow' : 'text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-800'}`}>
                                    ê¸°ê°„ ê¸°ì¤€
                                </button>
                                <button onClick={() => setGoalMode('target')} className={`flex-1 py-2 text-sm font-semibold rounded-md transition-colors ${goalMode === 'target' ? 'bg-white dark:bg-gray-700 text-blue-600 dark:text-blue-400 shadow' : 'text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-800'}`}>
                                    ìì‚° ê¸°ì¤€
                                </button>
                            </div>
                        </div>

                        <div className="space-y-4"> 
                            {goalMode === 'period' ? (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 dark:text-white mb-1">ì˜ˆìƒ ê¸°ê°„ (ê°œì›”)</label>
                                    <input type="number" min="0" className="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" value={projectionMonths} onChange={(e) => setProjectionMonths(Number(e.target.value))} />
                                </div>
                            ) : (
                                <div className="space-y-2">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 dark:text-white mb-1">ëª©í‘œ ìì‚° (ë§Œì›)</label>
                                        <input type="number" className="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-green-500" value={targetAmount} onChange={(e) => setTargetAmount(Number(e.target.value))} />
                                    </div>
                                    <button onClick={calculateGoalSeek} className="w-full bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 font-semibold shadow-sm hover:shadow-md transition-all">
                                        ë‹¬ì„± ê¸°ê°„ ê³„ì‚°
                                    </button>
                                </div>
                            )}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 dark:text-white mb-1">ì—°ê°„ ì¸í”Œë ˆì´ì…˜ ì¦ê°€ìœ¨ (%)</label>
                                <input type="number" step="0.1" className="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" value={inflationRate} onChange={(e) => setInflationRate(Number(e.target.value))} />
                            </div>
                             
                            {goalMode === 'target' && goalSeekResult && (
                                <div className="mt-2 p-3 bg-green-50 dark:bg-green-900/30 border border-green-200 dark:border-green-800 rounded-lg">
                                    <p className="text-green-800 dark:text-green-300 font-medium text-center">{goalSeekResult}</p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
                );
            };

            const renderScenarioPanel = () => ( 
                <div className="flex flex-col lg:flex-row lg:items-start gap-6">
                    <div className="lg:w-full lg:max-w-md">
                        <h3 className="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-4">ì €ì¥ëœ ì‹œë‚˜ë¦¬ì˜¤</h3>
                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-1 gap-4">
                            {scenarios.map(scenario => (
                                <div key={scenario.id} className="border dark:border-gray-700 rounded-lg p-4">
                                    <h4 className="font-medium text-gray-900 dark:text-white">{scenario.name}</h4>
                                    <p className="text-sm text-gray-500">{new Date(scenario.createdAt).toLocaleDateString()}</p>
                                    <div className="mt-2 flex gap-2">
                                        <button onClick={() => loadScenario(scenario)} className="flex-1 px-3 py-1 rounded text-sm bg-indigo-500 text-white hover:bg-indigo-600">ë¶ˆëŸ¬ì˜¤ê¸°</button>
                                        <button onClick={() => deleteScenario(scenario.id)} className="px-3 py-1 rounded text-sm bg-rose-500 text-white hover:bg-rose-600">ì‚­ì œ</button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                    <div className="flex-grow border-l border-gray-200 dark:border-gray-700 pl-6">
                        <h3 className="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-3">ì‹œë‚˜ë¦¬ì˜¤ ë¹„êµ (ìµœëŒ€ 3ê°œ)</h3>
                        <ScenarioCompare scenarios={scenarios} sectorInfo={sectorInfo} calculateMonthlyProjection={calculateMonthlyProjection} formatNumber={formatNumber} className="bg-gray-50 dark:bg-gray-900" />
                    </div>
                </div>
            );

            const renderChartsPanel = () => ( 
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div className="bg-white dark:bg-slate-800 rounded-lg shadow p-4"><canvas ref={currentPieRef} height="300"></canvas></div>
                    <div className="bg-white dark:bg-slate-800 rounded-lg shadow p-4"><canvas ref={projectedPieRef} height="300"></canvas></div>
                    <div className="bg-white dark:bg-slate-800 rounded-lg shadow p-4"><canvas ref={comparisonBarRef} height="300"></canvas></div>
                </div>
            );
 
            const renderHistoryPanel = () => (
                <>
                    <div className="flex justify-between items-center mb-4 px-4 pt-2">
                        <div className="text-sm text-gray-600 dark:text-gray-400">
                            ì´ {assetHistory.length}ê°œì˜ ê¸°ë¡ì´ ìˆìŠµë‹ˆë‹¤. 
                            ìµœê·¼ ê¸°ë¡: {assetHistory[assetHistory.length - 1]?.date} {assetHistory[assetHistory.length - 1]?.time ? `(${assetHistory[assetHistory.length - 1].time.split(':').slice(0, 2).join(':')})` : ''} ({formatNumber(assetHistory[assetHistory.length - 1]?.netWorth, displayMode)}ë§Œì›)
                        </div>
                        <label className={`flex items-center gap-2 cursor-pointer px-3 py-1 rounded-full border transition-colors ${!isPro ? 'bg-gray-100 border-gray-200' : 'bg-blue-50 dark:bg-blue-900/30 border-blue-100 dark:border-blue-800 hover:bg-blue-100'}`}>
                            <input 
                                type="checkbox" 
                                checked={showProjectionInHistory} 
                                onChange={(e) => {
                                    if (!isPro) {
                                        if (confirm('ë¯¸ë˜ ì˜ˆìƒ ìì‚° í‘œì‹œ ê¸°ëŠ¥ì€ PRO ë²„ì „ì—ì„œë§Œ ì œê³µë©ë‹ˆë‹¤. í›„ì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                                            window.open('https://blog.naver.com/zocdoc', '_blank');
                                        }
                                        return;
                                    }
                                    setShowProjectionInHistory(e.target.checked);
                                }}
                                className={`w-4 h-4 rounded focus:ring-blue-500 ${!isPro ? 'text-gray-400' : 'text-blue-600'}`}
                            />
                            <span className={`text-xs font-semibold flex items-center gap-1 ${!isPro ? 'text-gray-500' : 'text-blue-700'}`}>
                                {!isPro && <span>ğŸ”’</span>}
                                ë¯¸ë˜ ì˜ˆìƒ ìì‚° í‘œì‹œ
                            </span>
                        </label>
                    </div>
                    <div className="bg-gray-50 dark:bg-gray-900/50 rounded-lg p-4">
                        <canvas ref={historyChartRef} height="200"></canvas>
                    </div>
                </>
            );

            const renderBudgetPanel = () => ( 
                <div className="bg-blue-50 dark:bg-slate-800 rounded-lg shadow p-6">
                    <div className="grid grid-cols-2 sm:grid-cols-4 gap-4">
                        <div className="text-center"><div className="text-sm text-gray-600 dark:text-white">ì›”ìˆ˜ì…</div><div className="text-xl font-bold text-blue-600 dark:text-blue-400">{formatNumber(monthlySalary, displayMode)}ë§Œì›</div></div>
                        <div className="text-center"><div className="text-sm text-gray-600 dark:text-white">ì›”ë³„ ì§€ì¶œ</div><div className="text-xl font-bold text-red-600 dark:text-red-400">{formatNumber(totalMonthlyExpense, displayMode)}ë§Œì›</div></div>
                        <div className="text-center"><div className="text-sm text-gray-600 dark:text-white">ì›”ë‚©ì… ê°€ëŠ¥ì•¡</div><div className="text-xl font-bold text-green-600 dark:text-green-400">{formatNumber(maxSectorMonthlyContrib, displayMode)}ë§Œì›</div></div>
                        <div className="text-center"><div className="text-sm text-gray-600 dark:text-white">ì›”ë‚©ì… ì‚¬ìš©ì•¡</div><div className={`text-xl font-bold ${totalSectorMonthlyContrib > maxSectorMonthlyContrib ? 'text-red-600' : 'text-blue-600 dark:text-blue-400'}`}>{formatNumber(totalSectorMonthlyContrib, displayMode)}ë§Œì›</div></div>
                    </div>
                    {totalSectorMonthlyContrib > maxSectorMonthlyContrib && (<div className="bg-red-100 dark:bg-red-900/40 border border-red-400 dark:border-red-800 text-red-700 dark:text-red-300 px-4 py-3 rounded my-4">âš ï¸ ì›”ë‚©ì… í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ì›”ìˆ˜ì…ì™¸ ë‚©ì…ì„ ì´ìš©í•˜ê±°ë‚˜ ì›”ë‚©ì…ì„ ì¤„ì—¬ì£¼ì„¸ìš”.</div>)}
                    <div className="bg-white dark:bg-gray-900 rounded-lg p-4 my-4"><h4 className="text-sm font-medium text-gray-700 dark:text-white mb-3">ğŸ’¡ ì”ì—¬ì•¡ ê³„ì‚°ì‹</h4><div className="text-sm space-y-2"><div className="flex justify-between text-gray-600 dark:text-gray-300"><span>ì›”ìˆ˜ì…</span><span className="font-medium text-blue-600 dark:text-blue-400">+{formatNumber(monthlySalary, displayMode)}ë§Œì›</span></div><div className="flex justify-between text-gray-600 dark:text-gray-300"><span>ì›”ë³„ ì§€ì¶œ</span><span className="font-medium text-red-600 dark:text-red-400">-{formatNumber(totalMonthlyExpense, displayMode)}ë§Œì›</span></div><hr className="border-gray-200 dark:border-gray-700" /><div className="flex justify-between font-medium text-gray-700 dark:text-white"><span>ì›”ë‚©ì… ê°€ëŠ¥ì•¡</span><span className="text-green-600 dark:text-green-400">{formatNumber(maxSectorMonthlyContrib, displayMode)}ë§Œì›</span></div><div className="text-xs text-gray-500 dark:text-gray-400 mt-2">í˜„ì¬ ì›”ë‚©ì… ì„¤ì •:</div>{autoDepositBreakdown.map((item, index) => (<div key={index} className="flex justify-between text-xs text-gray-600 dark:text-gray-300"><span className={`text-${sectorInfo[item.sector]?.color || 'gray'}-600 dark:text-${sectorInfo[item.sector]?.color || 'gray'}-400`}>{sectorInfo[item.sector]?.icon} {item.name}</span><span className="font-medium">-{formatNumber(item.amount, displayMode)}ë§Œì›</span></div>))}<hr className="border-gray-200 dark:border-gray-700" /><div className="flex justify-between font-bold text-gray-800 dark:text-white"><span>ì”ì—¬ì•¡</span><span className="text-green-600 dark:text-green-400">{formatNumber(autoDepositAmount, displayMode)}ë§Œì›</span></div></div></div>
                    <div className="flex flex-col sm:flex-row items-center justify-between bg-white dark:bg-gray-900 rounded-lg p-4 gap-4 mt-4"><div className="text-center sm:text-left"><div className="text-sm text-gray-600 dark:text-white">ì”ì—¬ì•¡</div><div className="text-2xl font-bold text-green-600 dark:text-green-400">{formatNumber(autoDepositAmount, displayMode)}ë§Œì›</div><div className="text-xs text-gray-500 dark:text-gray-400">ì›”ë‚©ì… ê°€ëŠ¥ì•¡ {formatNumber(maxSectorMonthlyContrib, displayMode)}ë§Œì› - ì›”ë‚©ì… ì‚¬ìš©ì•¡ {formatNumber(totalSectorMonthlyContrib, displayMode)}ë§Œì›</div></div><div className="flex flex-col sm:flex-row items-center gap-4"><div><label className="block text-sm text-gray-600 dark:text-gray-400 text-center sm:text-left mb-1">ì›”ê¸‰/ì§€ì¶œ ë° ì”ì—¬ì•¡ ê´€ë¦¬ ê³„ì¢Œ</label><select className="border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded px-3 py-2" value={mainCashFlowAccount} onChange={e => setMainCashFlowAccount(e.target.value)}>{Object.values(assets).flat().filter(item => item.name !== 'ìƒˆ í•­ëª©').map((asset, idx) => (<option key={idx} value={asset.name}>{asset.name}</option>))}</select></div></div></div>
                </div>
            );

            const renderMemoPanel = () => ( 
                <textarea className="w-full h-32 p-3 border dark:border-gray-600 dark:bg-gray-900 dark:text-white rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="ì—¬ê¸°ì— ììœ ë¡­ê²Œ ë©”ëª¨ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”. (ìë™ ì €ì¥ë©ë‹ˆë‹¤)" value={memo} onChange={(e) => setMemo(e.target.value)} />
            );

            const renderRebalancePanel = () => {
                const validSectors = Object.keys(sectorInfo).filter(k=>k!=='loan');
                const defaultPct = Math.round(100 / validSectors.length);
                
                const totalTarget = validSectors.reduce((sum, key) => { 
                    const value = rebalancingTargets[key];
                    const numericValue = (value === undefined || value === null) ? defaultPct : Number(value);
                    return sum + numericValue;
                }, 0);

                const handleNormalize = () => {
                    if (totalTarget === 0) return;
                    const newTargets = {};
                    validSectors.forEach(key => {
                        const value = rebalancingTargets[key];
                        const currentVal = (value === undefined || value === null) ? defaultPct : Number(value);
                        newTargets[key] = Math.round((currentVal / totalTarget) * 100);
                    });

                    const finalTotal = Object.values(newTargets).reduce((s, v) => s + v, 0);
                    const diff = 100 - finalTotal;
                    if (diff !== 0) {
                        const maxKey = Object.keys(newTargets).reduce((a, b) => newTargets[a] > newTargets[b] ? a : b);
                        newTargets[maxKey] += diff;
                    }
                    setRebalancingTargets(newTargets);
                };

                return (
                    <div className="bg-yellow-50 dark:bg-yellow-900/20 rounded-lg shadow p-6"> 
                        <StackedBarDisplay targets={rebalancingTargets} sectorInfo={sectorInfo} />
                        <div className="mb-4 grid grid-cols-1 lg:grid-cols-3 gap-4 text-sm">                                        
                            <div className="flex items-center gap-2">
                                <span className="text-gray-700 dark:text-gray-200 whitespace-nowrap">ëª©í‘œ ë¹„ì¤‘ ì´í•©:</span>
                                <span className={`font-bold ${totalTarget !== 100 ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400'}`}>
                                    {totalTarget}%
                                </span>
                                <button 
                                    onClick={handleNormalize} 
                                    className="ml-2 px-3 py-1 bg-yellow-600 text-white text-xs rounded hover:bg-yellow-700 disabled:bg-gray-400"
                                    disabled={totalTarget === 100}
                                >
                                    100% ìë™ì¡°ì •
                                </button>
                            </div>
                        </div>
                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                            {validSectors.map(sectorKey => {
                                const currentValue = rebalancingTargets[sectorKey] ?? defaultPct;
                                return (
                                    <div key={sectorKey} className="bg-white dark:bg-gray-800 rounded-lg p-4">
                                        <h4 className="font-medium text-gray-900 dark:text-white mb-2">{sectorInfo[sectorKey].icon} {sectorInfo[sectorKey].name}</h4>
                                        <div className="space-y-2">
                                            <div className="flex items-center gap-2">
                                                <label className="block text-xs text-gray-600 dark:text-gray-300 whitespace-nowrap">ëª©í‘œ ë¹„ì¤‘ (%)</label>
                                                <input 
                                                    type="number" 
                                                    min="0" 
                                                    max="100" 
                                                    step="1"
                                                    className="w-full border rounded px-2 py-1 text-sm bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" 
                                                    value={currentValue} 
                                                    onChange={(e)=> setRebalancingTargets(prev=> ({ ...prev, [sectorKey]: Number(e.target.value) }))} 
                                                />
                                            </div>
                                            <>
                                                <div>
                                                    <label className="block text-xs text-gray-600 dark:text-gray-300">ê²½ê³  ì„ê³„ê°’ (í¸ì°¨ %)</label>
                                                    <input type="number" className="w-full border rounded px-2 py-1 text-sm bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={rebalancingAlerts[sectorKey]?.warning ?? 5} onChange={(e)=> updateRebalancingAlert(sectorKey, 'warning', e.target.value)} />
                                                </div>
                                                <div>
                                                    <label className="block text-xs text-gray-600 dark:text-gray-300">ìœ„í—˜ ì„ê³„ê°’ (í¸ì°¨ %)</label>
                                                    <input type="number" className="w-full border rounded px-2 py-1 text-sm bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={rebalancingAlerts[sectorKey]?.danger ?? 10} onChange={(e)=> updateRebalancingAlert(sectorKey, 'danger', e.target.value)} />
                                                </div>
                                            </>
                                        </div>
                                    </div>
                                )
                            })}
                        </div>
                    </div>
                );
            };

            const renderAssetsPanel = () => (
                <div className="space-y-8"> 
                    {assetSectorOrder.map((sectorKey, index) => (
                        <div key={sectorKey} className={`${sectorInfo[sectorKey].bgClass} rounded-lg shadow p-6 transition-colors`}>
                            <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4"> 
                                <button type="button" onClick={()=> setHiddenSectors(prev=> ({...prev, [sectorKey]: !prev[sectorKey]}))} className={`text-left text-xl font-semibold ${sectorInfo[sectorKey].textClass} flex items-center gap-2`}>
                                    <span>{sectorInfo[sectorKey].icon}</span>
                                    {sectorInfo[sectorKey].name}
                                    <span className="text-sm bg-white dark:bg-gray-900 dark:text-white px-2 py-1 rounded">
                                        í˜„ì¬: {formatPercent(currentSectorTotals[sectorKey]?.percentage || 0)}% â†’
                                        ì˜ˆìƒ: {formatPercent(projectedSectorTotals[sectorKey]?.percentage || 0)}%
                                    </span>
                                    <span className="ml-2 text-xs text-gray-500">{hiddenSectors[sectorKey] ? '(ì ‘í˜)' : '(í¼ì¹¨)'}</span>
                                </button>
                                <div className="flex items-center gap-2">
                                    <div className="flex items-center gap-1 bg-white dark:bg-gray-800 rounded-full p-1"> 
                                        <button onClick={() => moveAssetSector(sectorKey, -1)} disabled={index === 0} className="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 disabled:opacity-30 disabled:cursor-not-allowed" title="ìœ„ë¡œ ì´ë™">
                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 15l7-7 7 7" /></svg>
                                        </button> 
                                        <button onClick={() => moveAssetSector(sectorKey, 1)} disabled={index === assetSectorOrder.length - 1} className="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 disabled:opacity-30 disabled:cursor-not-allowed" title="ì•„ë˜ë¡œ ì´ë™">
                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" /></svg>
                                        </button>
                                    </div>
                                    <button onClick={() => addAsset(sectorKey)} className={`bg-${sectorInfo[sectorKey].color}-500 text-white px-4 py-2 rounded hover:bg-${sectorInfo[sectorKey].color}-600 whitespace-nowrap`}>
                                        + í•­ëª© ì¶”ê°€
                                    </button>
                                </div>
                            </div>
                            {!hiddenSectors[sectorKey] && (
                            <div className="space-y-4"> 
                                {assets[sectorKey]?.map((asset, index) => {
                                    const projectedAmount = calculation.projected[sectorKey]?.[index]?.amount || 0;
                                    const sectorTotal = projectedSectorTotals[sectorKey]?.amount || 1;
                                    const assetPercentage = (projectedAmount / sectorTotal * 100);
                                    
                                    const nameRef = el => assetInputRefs.current[`${sectorKey}-${index}-name`] = el;
                                    const amountRef = el => assetInputRefs.current[`${sectorKey}-${index}-amount`] = el;
                                    const monthlyContribRef = el => assetInputRefs.current[`${sectorKey}-${index}-monthlyContrib`] = el;

                                    return (
                                        <div key={asset.id || index} className="bg-white dark:bg-gray-900 rounded-lg p-4 shadow-sm">
                                            {sectorKey !== 'loan' && (
                                                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-8 gap-3 items-center">
                                                    <input ref={nameRef} type="text" placeholder="í•­ëª©ëª…" className="border rounded px-2 py-1 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={asset.name} onChange={(e) => updateAsset(sectorKey, index, 'name', e.target.value)} />
                                                    <div>
                                                        <label className="block text-xs text-gray-500 dark:text-gray-200">í˜„ì¬ê¸ˆì•¡</label>
                                                        <input ref={amountRef} type="number" className="w-full border rounded px-2 py-1 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={asset.amount} onChange={(e) => updateAsset(sectorKey, index, 'amount', e.target.value)} />
                                                    </div>
                                                    <div>
                                                        <label className="block text-xs text-gray-500 dark:text-gray-200">ìˆ˜ìµë¥ (%)</label>
                                                        <input type="number" step="0.1" className="w-full border rounded px-2 py-1 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={asset.rate} onChange={(e) => updateAsset(sectorKey, index, 'rate', e.target.value)} />
                                                    </div>
                                                    <div>
                                                        <label className="block text-xs text-gray-500 dark:text-gray-200">ìˆ˜ìˆ˜ë£Œ/ì„¸ê¸ˆ(%)</label>
                                                        <input type="number" step="0.001" className="w-full border rounded px-2 py-1 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={asset.feeRate ?? 0} onChange={(e) => updateAsset(sectorKey, index, 'feeRate', e.target.value)} />
                                                    </div>
                                                    <div>
                                                        <label className="block text-xs text-gray-500 dark:text-gray-200">ì›”ë‚©ì…</label>
                                                        <input ref={monthlyContribRef} type="number" className="w-full border rounded px-2 py-1 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={asset.monthlyContrib} onChange={(e) => updateAsset(sectorKey, index, 'monthlyContrib', e.target.value)} />
                                                    </div>
                                                    <div>
                                                        <label className="block text-xs text-gray-500 dark:text-gray-200">ì›”ìˆ˜ì…ì™¸ ë‚©ì…</label>
                                                        <input type="number" min="0" className="w-full border rounded px-2 py-1 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={asset.extraContrib} onChange={(e) => updateAsset(sectorKey, index, 'extraContrib', e.target.value)} />
                                                    </div>
                                                    {asset.extraContrib > 0 && (
                                                        <div>
                                                            <label className="block text-xs text-gray-500 dark:text-gray-200">ì¶œê¸ˆê³„ì¢Œ</label>
                                                            <select className="w-full border rounded px-2 py-1 text-xs bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={asset.extraFrom} onChange={(e) => updateAsset(sectorKey, index, 'extraFrom', e.target.value)}>
                                                                {Object.values(assets).flat().filter(a => a.name !== asset.name).map((d, i) => (
                                                                    <option key={i} value={d.name}>{d.name}</option>
                                                                ))}
                                                            </select>
                                                        </div>
                                                    )}
                                                    <div className="text-sm">
                                                        <div className="text-gray-600 dark:text-gray-300">ì˜ˆìƒ: {formatNumber(projectedAmount, displayMode)}ë§Œì›</div>
                                                        <div className={`text-gray-500 dark:text-gray-400`}>
                                                            ë¹„ì¤‘: <span className={`${(() => {
                                                                const validSectorTotal = projectedSectorTotals[sectorKey]?.amount || 0;
                                                                const target = rebalancingTargets[sectorKey] ?? Math.round(100 / Object.keys(sectorInfo).length);
                                                                const diff = Math.abs(projectedSectorTotals[sectorKey]?.percentage - target);
                                                                const warn = rebalancingAlerts[sectorKey]?.warning ?? 5;
                                                                const danger = rebalancingAlerts[sectorKey]?.danger ?? 10;
                                                                if (diff >= danger) return 'text-red-500';
                                                                if (diff >= warn) return 'text-yellow-500';
                                                                return 'text-green-600 dark:text-green-400';
                                                            })()}`}>{
                                                                (() => {
                                                                    const validSectorTotal = projectedSectorTotals[sectorKey]?.amount || 0;
                                                                    const assetPercentage = (validSectorTotal > 0) ? (projectedAmount / validSectorTotal * 100) : 0;
                                                                    return formatPercent(assetPercentage);
                                                                })()
                                                            }%</span>
                                                        </div>
                                                    </div>
                                                    <button onClick={() => removeAsset(sectorKey, index)} className="text-red-500 hover:text-red-700 whitespace-nowrap">ì‚­ì œ</button>
                                                </div>
                                            )}

                                            {sectorKey === 'loan' && (
                                                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-9 gap-3 items-center">
                                                    <input ref={nameRef} type="text" placeholder="í•­ëª©ëª…" className="border rounded px-2 py-1 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={asset.name} onChange={(e) => updateAsset(sectorKey, index, 'name', e.target.value)} />
                                                    <div>
                                                        <label className="block text-xs text-gray-500 dark:text-gray-200">í˜„ì¬ì”ì•¡</label>
                                                        <input ref={amountRef} type="number" className="w-full border rounded px-2 py-1 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={asset.amount} onChange={(e) => updateAsset(sectorKey, index, 'amount', e.target.value)} />
                                                    </div>
                                                    <div>
                                                        <label className="block text-xs text-gray-500 dark:text-gray-200">ì´ììœ¨(%)</label>
                                                        <input type="number" step="0.1" className="w-full border rounded px-2 py-1 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={asset.rate} onChange={(e) => updateAsset(sectorKey, index, 'rate', e.target.value)} />
                                                    </div>
                                                    <div>
                                                        <label className="block text-xs text-gray-500 dark:text-gray-200">ì›” ìƒí™˜ì•¡</label>
                                                        <input ref={monthlyContribRef} type="number" className="w-full border rounded px-2 py-1 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={asset.monthlyContrib} onChange={(e) => updateAsset(sectorKey, index, 'monthlyContrib', e.target.value)} />
                                                    </div>
                                                    <div>
                                                        <label className="block text-xs text-gray-500 dark:text-gray-200">ë§Œê¸°(ê°œì›”)</label>
                                                        <input type="number" className="w-full border rounded px-2 py-1 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={asset.maturityMonth ?? 12} onChange={(e) => updateAsset(sectorKey, index, 'maturityMonth', e.target.value)} />
                                                    </div>
                                                    <div>
                                                        <label className="block text-xs text-gray-500 dark:text-gray-200">ìƒí™˜ë°©ì‹</label>
                                                        <select 
                                                            className="w-full border rounded px-2 py-1 text-xs bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" 
                                                            value={asset.repaymentMethod} 
                                                            onChange={(e) => updateAsset(sectorKey, index, 'repaymentMethod', e.target.value)}
                                                        >
                                                            <option value="ì›ë¦¬ê¸ˆê· ë“±">ì›ë¦¬ê¸ˆê· ë“±</option>
                                                            <option value="ì›ê¸ˆê· ë“±">ì›ê¸ˆê· ë“±</option>
                                                            <option value="ë§Œê¸°ì¼ì‹œ">ë§Œê¸°ì¼ì‹œ</option>
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <label className="block text-xs text-gray-500 dark:text-gray-200">ìƒí™˜ê³„ì¢Œ (ì›”)</label>
                                                        <select 
                                                            className="w-full border rounded px-2 py-1 text-xs bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" 
                                                            value={asset.repaymentAccount} 
                                                            onChange={(e) => updateAsset(sectorKey, index, 'repaymentAccount', e.target.value)}
                                                        >
                                                            {Object.values(assets).flat().filter(a => a.name !== asset.name).map((d, i) => (
                                                                <option key={i} value={d.name}>{d.name}</option>
                                                            ))}
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <label className="block text-xs text-gray-500 dark:text-gray-200">ì¶”ê°€ ìƒí™˜ (ì›”ìˆ˜ì…ì™¸)</label>
                                                        <input type="number" min="0" className="w-full border rounded px-2 py-1 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={asset.extraContrib} onChange={(e) => updateAsset(sectorKey, index, 'extraContrib', e.target.value)} />
                                                    </div>
                                                    {asset.extraContrib > 0 && (
                                                        <div>
                                                            <label className="block text-xs text-gray-500 dark:text-gray-200">ì¶œê¸ˆê³„ì¢Œ (ì¶”ê°€)</label>
                                                            <select className="w-full border rounded px-2 py-1 text-xs bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white" value={asset.extraFrom} onChange={(e) => updateAsset(sectorKey, index, 'extraFrom', e.target.value)}>
                                                                {Object.values(assets).flat().filter(a => a.name !== asset.name).map((d, i) => (
                                                                    <option key={i} value={d.name}>{d.name}</option>
                                                                ))}
                                                            </select>
                                                        </div>
                                                    )}
                                                    <div className="text-sm">
                                                        <div className="text-gray-600 dark:text-gray-300">ì˜ˆìƒì”ì•¡: {formatNumber(projectedAmount, displayMode)}ë§Œì›</div>
                                                    </div>
                                                    <button onClick={() => removeAsset(sectorKey, index)} className="text-red-500 hover:text-red-700 whitespace-nowrap">ì‚­ì œ</button>
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                            )}
                        </div>
                    ))}
                </div>
            );

            const renderExpensesPanel = () => (
                <div className="bg-red-50 dark:bg-red-900/40 rounded-lg shadow p-6"> 
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="text-lg font-semibold text-red-700 dark:text-red-100">ì›”ë³„ ì§€ì¶œ</h3>
                        <button onClick={addExpense} className="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 whitespace-nowrap">+ ì§€ì¶œ ì¶”ê°€</button>
                    </div>
                    <div className="space-y-3">
                        {monthlyExpenses.map((expense, index) => (
                            <div key={index} className="bg-white dark:bg-gray-900 rounded-lg p-3 shadow-sm">
                                <div className="grid grid-cols-1 sm:grid-cols-4 gap-3 items-center">
                                    <input type="text" placeholder="ì§€ì¶œëª…" className="border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded px-2 py-1" value={expense.name} onChange={(e) => updateExpense(index, 'name', e.target.value)} />
                                    <input type="number" placeholder="ê¸ˆì•¡(ë§Œì›)" className="border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded px-2 py-1" value={expense.amount} onChange={(e) => updateExpense(index, 'amount', e.target.value)} />
                                    <div className="text-sm text-gray-600 dark:text-gray-400">ì—°ê°„: {formatNumber(expense.amount * projectionMonths)}ë§Œì›</div>
                                    <button onClick={() => removeExpense(index)} className="text-red-500 hover:text-red-700 whitespace-nowrap">ì‚­ì œ</button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );

            const renderEventsPanel = () => ( 
                <div className="space-y-6">
                    <div className="bg-green-50 dark:bg-green-900/40 rounded-lg shadow p-6">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-semibold text-green-700 dark:text-green-100 flex items-center gap-2">ğŸ’° ì´ë²¤íŠ¸ì„± ìˆ˜ì… (ì„±ê³¼ê¸‰, ìš©ëˆ ë“±)</h3>
                            <button onClick={addIncomeEvent} className="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 whitespace-nowrap">+ ìˆ˜ì… ì´ë²¤íŠ¸ ì¶”ê°€</button>
                        </div>
                        <div className="text-xs text-gray-600 dark:text-gray-400 mb-4 bg-white dark:bg-gray-800 p-3 rounded-lg border border-green-100 dark:border-green-900">
                            ğŸ’¡ í•­ëª© ì„¤ëª…: ì´ë²¤íŠ¸ëª… | ê¸ˆì•¡ | ì‹œì‘ ì›” | ì¢…ë£Œ ì›” | ì…ê¸ˆì²˜(ì„¹í„°/ê³„ì¢Œ)
                            <div className="mt-1 text-gray-500 dark:text-gray-500">
                                ì˜ˆ: 3~8ê°œì›” ì…ë ¥ ì‹œ, ê¸°ì¤€ì›” ê¸°ì¤€ <strong>{(() => { 
                                    try { 
                                        const baseMonthStr = baseMonth || '';
                                        if (!baseMonthStr) return 'ê¸°ì¤€ì›” ì„¤ì • í•„ìš”';
                                        const [y,m] = baseMonthStr.split('-').map(Number);
                                        if (!y || !m) return 'ê¸°ì¤€ì›” í˜•ì‹ ì˜¤ë¥˜';
                                        const d = new Date(y, m-1, 1);
                                        if (isNaN(d.getTime())) return 'ë‚ ì§œ ê³„ì‚° ì˜¤ë¥˜';
                                        const fmt = (dt) => `${String(dt.getFullYear()).slice(2)}ë…„ ${String(dt.getMonth()+1).padStart(2,'0')}ì›”`;
                                        const s = new Date(d);
                                        s.setMonth(s.getMonth() + 3 - 1);
                                        const e = new Date(d);
                                        e.setMonth(e.getMonth() + 8 - 1);
                                        if (isNaN(s.getTime()) || isNaN(e.getTime())) return 'ë‚ ì§œ ê³„ì‚° ì˜¤ë¥˜';
                                        return `${fmt(s)} ~ ${fmt(e)}`;
                                    } catch (error) { 
                                        console.error('Date calculation error:', error);
                                        return 'ë‚ ì§œ ê³„ì‚° ì˜¤ë¥˜';
                                    } 
                                })()}</strong>
                            </div>
                        </div>
                        <div className="space-y-4">
                            {incomeEvents && incomeEvents.length > 0 ? incomeEvents.map((event, index) => {
                                if (!event || typeof event !== 'object') {
                                    console.warn('Invalid event data at index:', index);
                                    return null;
                                }
                                
                                return (
                                <div key={index} className="bg-white dark:bg-gray-900 rounded-lg p-4 shadow-sm border dark:border-gray-700">
                                    <div className="grid grid-cols-1 md:grid-cols-4 lg:grid-cols-8 gap-4 items-end">
                                        <div className="md:col-span-2 lg:col-span-2">
                                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ì´ë²¤íŠ¸ëª…</label>
                                            <input type="text" placeholder="ì´ë²¤íŠ¸ëª…" className="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md px-3 py-2" value={event.name} onChange={(e) => updateIncomeEvent(index, 'name', e.target.value)} />
                                        </div>
                                        <div className="md:col-span-2 lg:col-span-1">
                                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ê¸ˆì•¡</label>
                                            <input type="number" placeholder="ê¸ˆì•¡" className="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md px-3 py-2" value={event.amount} onChange={(e) => updateIncomeEvent(index, 'amount', e.target.value)} />
                                        </div>
                                        <div className="md:col-span-2 lg:col-span-1">
                                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ì‹œì‘ ì›”</label>
                                            <input type="month" className="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md px-3 py-2" value={event.startMonth} onChange={(e) => updateIncomeEvent(index, 'startMonth', e.target.value)} />
                                        </div>
                                        <div className="md:col-span-2 lg:col-span-1">
                                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ì¢…ë£Œ ì›”</label>
                                            <input type="month" className="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md px-3 py-2" value={event.endMonth} onChange={(e) => updateIncomeEvent(index, 'endMonth', e.target.value)} />
                                        </div>
                                        <div className="md:col-span-3 lg:col-span-2">
                                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ì…ê¸ˆì²˜</label>
                                            <div className="grid grid-cols-2 gap-2">
                                                <select className="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md px-3 py-2" value={event.targetSector} onChange={(e) => updateIncomeEvent(index, 'targetSector', e.target.value)}>
                                                    {Object.keys(sectorInfo).map(key => (
                                                        <option key={key} value={key}>{sectorInfo[key].name}</option>
                                                    ))}
                                                </select>
                                                <select className="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md px-3 py-2" value={event.targetAsset} onChange={(e) => updateIncomeEvent(index, 'targetAsset', e.target.value)}>
                                                    {assets[event.targetSector]?.map((asset, assetIndex) => (
                                                        <option key={assetIndex} value={assetIndex}>{asset.name}</option>
                                                    ))}
                                                </select>
                                            </div>
                                        </div>
                                        <div className="md:col-span-1 lg:col-span-1 flex items-end justify-center h-full">
                                            <button onClick={() => removeIncomeEvent(index)} className="text-red-500 hover:text-red-700 font-medium whitespace-nowrap">ì‚­ì œ</button>
                                        </div>
                                    </div>
                                </div>
                                );
                            }) : (
                                <div className="text-center text-gray-500 py-8">
                                    <p>ì´ë²¤íŠ¸ì„± ìˆ˜ì…ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                                    <p className="text-sm">ìœ„ì˜ "+ ìˆ˜ì… ì´ë²¤íŠ¸ ì¶”ê°€" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì¶”ê°€í•˜ì„¸ìš”.</p>
                                </div>
                            )}
                        </div>
                    </div>
                    <div className="bg-orange-50 dark:bg-orange-900/40 rounded-lg shadow p-6">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-semibold text-orange-700 dark:text-orange-100 flex items-center gap-2">ğŸ›’ ì´ë²¤íŠ¸ì„± ì§€ì¶œ (ì—¬í–‰, ëŒ€í˜•êµ¬ë§¤ ë“±)</h3>
                            <button onClick={addExpenseEvent} className="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 whitespace-nowrap">+ ì§€ì¶œ ì´ë²¤íŠ¸ ì¶”ê°€</button>
                        </div>
                        <div className="text-xs text-gray-600 dark:text-gray-400 mb-4 bg-white dark:bg-gray-800 p-3 rounded-lg border border-orange-100 dark:border-orange-900">
                            ğŸ’¡ í•­ëª© ì„¤ëª…: ì´ë²¤íŠ¸ëª… | ê¸ˆì•¡ | ì‹œì‘ ì›” | ì¢…ë£Œ ì›” | ì¶œê¸ˆì²˜(ì„¹í„°/ê³„ì¢Œ)
                            <div className="mt-1 text-gray-500 dark:text-gray-500">
                                ì˜ˆ: 2~5ê°œì›” ì…ë ¥ ì‹œ, ê¸°ì¤€ì›” ê¸°ì¤€ <strong>{(() => { try { const [y,m]= (baseMonth||'').split('-').map(Number); const d=new Date(y||new Date().getFullYear(),(m||1)-1,1); const fmt=(dt)=> `${String(dt.getFullYear()).slice(2)}ë…„ ${String(dt.getMonth()+1).padStart(2,'0')}ì›”`; const s=new Date(d); s.setMonth(s.getMonth()+2-1); const e=new Date(d); e.setMonth(e.getMonth()+5-1); return `${fmt(s)} ~ ${fmt(e)}`; } catch { return ''; } })()}</strong>
                            </div>
                        </div>
                        <div className="space-y-4">
                            {expenseEvents.map((event, index) => (
                                <div key={index} className="bg-white dark:bg-gray-900 rounded-lg p-4 shadow-sm border dark:border-gray-700">
                                    <div className="grid grid-cols-1 md:grid-cols-4 lg:grid-cols-8 gap-4 items-end">
                                        <div className="md:col-span-2 lg:col-span-2">
                                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ì´ë²¤íŠ¸ëª…</label>
                                            <input type="text" placeholder="ì´ë²¤íŠ¸ëª…" className="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md px-3 py-2" value={event.name} onChange={(e) => updateExpenseEvent(index, 'name', e.target.value)} />
                                        </div>
                                        <div className="md:col-span-2 lg:col-span-1">
                                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ê¸ˆì•¡</label>
                                            <input type="number" placeholder="ê¸ˆì•¡" className="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md px-3 py-2" value={event.amount} onChange={(e) => updateExpenseEvent(index, 'amount', e.target.value)} />
                                        </div>
                                        <div className="md:col-span-2 lg:col-span-1">
                                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ì‹œì‘ ì›”</label>
                                            <input type="month" className="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md px-3 py-2" value={event.startMonth} onChange={(e) => updateExpenseEvent(index, 'startMonth', e.target.value)} />
                                        </div>
                                        <div className="md:col-span-2 lg:col-span-1">
                                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ì¢…ë£Œ ì›”</label>
                                            <input type="month" className="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md px-3 py-2" value={event.endMonth} onChange={(e) => updateExpenseEvent(index, 'endMonth', e.target.value)} />
                                        </div>
                                        <div className="md:col-span-3 lg:col-span-2">
                                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ì¶œê¸ˆì²˜</label>
                                            <div className="grid grid-cols-2 gap-2">
                                                <select className="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md px-3 py-2" value={event.targetSector || 'deposit'} onChange={(e) => updateExpenseEvent(index, 'targetSector', e.target.value)}>
                                                    {Object.keys(sectorInfo).map(key => (
                                                        <option key={key} value={key}>{sectorInfo[key].name}</option>
                                                    ))}
                                                </select>
                                                <select className="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md px-3 py-2" value={event.targetAsset || 0} onChange={(e) => updateExpenseEvent(index, 'targetAsset', e.target.value)}>
                                                    {assets[event.targetSector || 'deposit']?.map((asset, assetIndex) => (
                                                        <option key={assetIndex} value={assetIndex}>{asset.name}</option>
                                                    ))}
                                                </select>
                                            </div>
                                        </div>
                                        <div className="md:col-span-1 lg:col-span-1 flex items-end justify-center h-full">
                                            <button onClick={() => removeExpenseEvent(index)} className="text-red-500 hover:text-red-700 font-medium whitespace-nowrap">ì‚­ì œ</button>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );

            const renderDetailAnalysisPanel = () => (
                <div className="overflow-x-auto -mx-6 px-6">
                    <table className="w-full text-sm dark:text-gray-300 min-w-[800px]">
                        <thead className="bg-gray-100 dark:bg-gray-700">
                            <tr>
                                <th className="p-3 text-left">ì„¹í„°/í•­ëª©</th>
                                <th className="p-3 text-right">í˜„ì¬ ê¸ˆì•¡</th>
                                <th className="p-3 text-right">ì˜ˆìƒ ê¸ˆì•¡</th>
                                <th className="p-3 text-right">ì¦ê°ë¥ </th>
                                <th className="p-3 text-right">í˜„ì¬ ë¹„ì¤‘</th>
                                <th className="p-3 text-right">ì˜ˆìƒ ë¹„ì¤‘</th>
                                <th className="p-3 text-right">ëª©í‘œ ë¹„ì¤‘</th>
                            </tr>
                        </thead>
                        <tbody>
                            {Object.keys(sectorInfo).map(sectorKey => {
                                const current = currentSectorTotals[sectorKey] || { amount: 0, percentage: 0 };
                                const projected = projectedSectorTotals[sectorKey] || { amount: 0, percentage: 0 };
                                const growthRate = current.amount > 0 ? ((projected.amount - current.amount) / current.amount * 100) : 0;
                                const isPositiveGood = sectorKey === 'loan' ? growthRate <= 0 : growthRate >= 0;
                                const rebalanceStatus = getRebalanceStatus(sectorKey, projected.percentage);
                                const targetPct = (rebalancingTargets[sectorKey] ?? Math.round(100 / Object.keys(sectorInfo).length));
                                
                                return (
                                    <React.Fragment key={sectorKey}>
                                        <tr className={`border-t dark:border-gray-700 ${sectorInfo[sectorKey].bgClass} ${rebalanceStatus}`}>
                                            <td className="p-3 font-semibold">
                                                {sectorInfo[sectorKey].icon} {sectorInfo[sectorKey].name}
                                            </td>
                                            <td className="p-3 text-right">{formatNumber(current.amount)}</td>
                                            <td className="p-3 text-right">{formatNumber(projected.amount)}</td>
                                            <td className={`p-3 text-right ${isPositiveGood ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>{formatPercent(growthRate)}%</td>
                                            <td className="p-3 text-right">{formatPercent(current.percentage)}%</td>
                                            <td className="p-3 text-right">{formatPercent(projected.percentage)}%</td>
                                            <td className="p-3 text-right">{formatPercent(targetPct)}%</td>
                                        </tr>
                                        {assets[sectorKey]?.map((asset, idx) => {
                                            const projectedAmount = calculation.projected[sectorKey]?.[idx]?.amount || 0;
                                            const assetGrowth = projectedAmount - asset.amount;
                                            const assetGrowthRate = asset.amount > 0 ? (assetGrowth / asset.amount * 100) : 0;
                                            const isAssetPositiveGood = sectorKey === 'loan' ? assetGrowthRate <= 0 : assetGrowthRate >= 0;
                                            const sectorTotal = projected.amount || 1;
                                            const currentAssetPercentageInPortfolio = (currentGrossTotal > 0) ? (asset.amount / currentGrossTotal * 100) : 0;
                                            const assetPercentageInPortfolio = (projectedAmount / projectedGrossTotal * 100);
                                            const currentAssetPercentageInSector = (current.amount > 0) ? (asset.amount / current.amount * 100) : 0;
                                            const projectedAssetPercentageInSector = (projected.amount > 0) ? (projectedAmount / projected.amount * 100) : 0;
                                            
                                            return (
                                                <tr key={`${sectorKey}-${idx}`} className="border-t dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50">
                                                    <td className="p-3 pl-8 text-sm dark:text-gray-400">â”” {asset.name}</td>
                                                    <td className="p-3 text-right text-sm">{formatNumber(asset.amount)}</td>
                                                    <td className="p-3 text-right text-sm">{formatNumber(projectedAmount)}</td>
                                                    <td className={`p-3 text-right text-sm ${isAssetPositiveGood ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>{formatPercent(assetGrowthRate)}%</td>
                                                    <td className="p-3 text-right text-sm">
                                                        {sectorKey !== 'loan' ? `${formatPercent(currentAssetPercentageInPortfolio)}% (${formatPercent(currentAssetPercentageInSector)}%)` : '-'}
                                                    </td>
                                                    <td className="p-3 text-right text-sm">
                                                        {sectorKey !== 'loan' ? `${formatPercent(assetPercentageInPortfolio)}% (${formatPercent(projectedAssetPercentageInSector)}%)` : '-'}
                                                    </td>
                                                    <td className="p-3 text-right text-sm">-</td>
                                                </tr>
                                            );
                                        })}
                                    </React.Fragment>
                                );
                            })}
                            <tr className="border-t-2 border-gray-400 dark:border-gray-600 bg-gray-100 dark:bg-gray-700">
                                <td className="p-3 font-bold">ì´ê³„</td>
                                <td className="p-3 text-right font-bold">{formatNumber(calculation.currentTotal)}</td>
                                <td className="p-3 text-right font-bold">{formatNumber(calculation.projectedTotal)}</td>
                                <td className="p-3 text-right font-bold text-green-600 dark:text-green-400">{formatPercent(calculation.growth / calculation.currentTotal * 100)}%</td>
                                <td className="p-3 text-right font-bold">100.0%</td>
                                <td className="p-3 text-right font-bold">100.0%</td>
                                <td className="p-3 text-right font-bold">100.0%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            );

            const renderAssumptionsPanel = () => (
                <div className="text-sm text-gray-700 dark:text-gray-300">
                    <ul className="list-disc list-inside space-y-1">
                        <li>ìˆ˜ìµë¥ ì€ ì›”ë³µë¦¬ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.</li>
                        <li>{applyTax ? 'ë°°ë‹¹ì†Œë“ì„¸(15.4%) í¬í•¨ ì„¸í›„ ìˆ˜ìµë¥  ì ìš©' : 'ë°°ë‹¹ì†Œë“ì„¸ ì œì™¸ ì„¸ì „ ìˆ˜ìµë¥  ì ìš©'}</li>
                        <li>ëŒ€ì¶œ ìƒí™˜ì€ ì§€ì •ëœ ìƒí™˜ê³„ì¢Œì—ì„œ ìë™ìœ¼ë¡œ ì°¨ê°ë©ë‹ˆë‹¤. ì”ì•¡ ë¶€ì¡± ì‹œ ê²½ê³ ê°€ í‘œì‹œë©ë‹ˆë‹¤.</li>
                        <li>ì›”ìˆ˜ì…ì™¸ ë‚©ì…ì€ ì§€ì •ëœ ì¶œê¸ˆí†µì¥ì—ì„œ ì°¨ê°ë©ë‹ˆë‹¤.</li>
                        <li>ë¦¬ë°¸ëŸ°ì‹±: ê²½ê³ (ë…¸ë€ìƒ‰), ìœ„í—˜(ë¹¨ê°„ìƒ‰) ì„ê³„ê°’ì— ë”°ë¼ í‘œì‹œë©ë‹ˆë‹¤.</li>
                    </ul>
                </div>
            );

            // [ìˆ˜ì •] ëª¨ë“  Hook ì„ ì–¸ì´ ëë‚œ í›„, ì‹¤ì œ ë Œë”ë§ ì§ì „ì— ë¡œë”© ìƒíƒœë¥¼ ì²´í¬í•˜ì—¬ Hook ê·œì¹™ ìœ„ë°˜ í•´ê²°
            if (isLoading) {
                return (
                    <div className="flex flex-col items-center justify-center min-h-screen bg-gray-50 dark:bg-gray-900">
                        <div className="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                        <p className="text-gray-600 dark:text-gray-400 font-medium animate-pulse mb-4">ê³„ì • ì •ë³´ í™•ì¸ ì¤‘...</p>
                        {/* [ì¶”ê°€] ë¡œë”© ì¤‘ ë¹„ìƒ ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ */}
                        <button 
                            onClick={() => handleLogout(true)}
                            className="text-xs text-gray-500 underline hover:text-gray-700 dark:text-gray-500 dark:hover:text-gray-300"
                        >
                            ë¡œê·¸ì•„ì›ƒ (ì·¨ì†Œ)
                        </button>
                    </div>
                );
            }

            const renderFunctions = { renderSummaryPanel, renderScenarioPanel, renderChartsPanel, renderHistoryPanel, renderBudgetPanel, renderMemoPanel, renderRebalancePanel, renderAssetsPanel, renderExpensesPanel, renderEventsPanel, renderDetailAnalysisPanel, renderAssumptionsPanel };

            // [ì¶”ê°€] ì‚¬ì´ë“œë°” ë‚´ë¹„ê²Œì´ì…˜ í•­ëª© ì •ì˜
            const navLabels = window.navLabels || {};

            return (
                (calculation.error || layoutOrder.length === 0) ? 
                <div className="flex items-center justify-center min-h-screen bg-gray-50">
                    { layoutOrder.length === 0 ? 'ë ˆì´ì•„ì›ƒ ë¡œë”© ì¤‘...' : 'ê³„ì‚° ì˜¤ë¥˜ ë°œìƒ. ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.' }
                </div>
                :
                    <div className="relative min-h-screen bg-gray-50 dark:bg-gray-900 transition-colors pb-20 sm:pb-0">
                    <div className="sticky top-0 z-50 bg-white dark:bg-gray-800 shadow-sm border-b dark:border-gray-700">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center h-16">
                                <div className="flex items-center gap-3">
                                    <h1 id="app-title" className="text-xl sm:text-2xl font-bold text-gray-900 dark:text-white cursor-pointer" onClick={cycleDisplayMode} title="í´ë¦­í•˜ì—¬ ì‚¬ìš©ì/í”„ë¼ì´ë¹—/ë°ëª¨ ëª¨ë“œ ì „í™˜">
                                        ìì‚° í”Œë˜ë„ˆ {titleText}
                                    </h1>
                                    <span 
                                        className={`px-2 py-0.5 text-[10px] font-bold rounded-full transition-all border ${isPro ? 'bg-amber-100 text-amber-700 border-amber-200 dark:bg-amber-900/30 dark:text-amber-300 dark:border-amber-800' : 'bg-gray-100 text-gray-600 border-gray-200 dark:bg-gray-700 dark:text-gray-400 dark:border-gray-600'}`}
                                    >
                                        {isPro ? 'PRO' : 'FREE'}
                                    </span>
                                </div>
                                <div id="header-actions" className="hidden sm:flex items-center gap-2 sm:gap-4"> 
                                    <button onClick={handleDarkModeToggle} className="inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 text-sm leading-4 font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors">
                                        {!isPro && (
                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-3.5 w-3.5 mr-1.5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clipRule="evenodd" /></svg>
                                        )}
                                        {darkMode ? 'â˜€ï¸ ë¼ì´íŠ¸' : 'ğŸŒ™ ë‹¤í¬'}
                                    </button>
                                    <button onClick={saveToPDF} className="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">ğŸ“„ PDF ì €ì¥</button>
                                    <button onClick={saveScenario} className="inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 text-sm leading-4 font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors">ğŸ’¾ ì‹œë‚˜ë¦¬ì˜¤ ì €ì¥</button>
                                    <button onClick={saveAsDefault} className="inline-flex items-center px-3 py-2 border border-blue-300 dark:border-blue-800 text-sm leading-4 font-medium rounded-md text-blue-700 dark:text-blue-400 bg-white dark:bg-gray-700 hover:bg-blue-50 dark:hover:bg-blue-900/30 transition-colors">â­ ê¸°ë³¸ê°’ ì €ì¥</button>
                                    <button onClick={loadCustomDefault} className="inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 text-sm leading-4 font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors">â†©ï¸ ê¸°ë³¸ê°’ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                                </div>
                                <div className="sm:hidden relative">
                                    <details className="relative">
                                        <summary className="list-none inline-flex items-center px-3 py-2 border dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200">â˜° ë©”ë‰´</summary>
                                        <div className="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 border dark:border-gray-700 rounded-md shadow-md z-50 p-2 space-y-2">
                                            {!verifiedEmail ? (
                                                <button onClick={handleLogin} className="w-full text-left px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-gray-200 flex items-center gap-2 font-bold text-blue-600 dark:text-blue-400">
                                                    <svg className="w-4 h-4" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                                                    Google ë¡œê·¸ì¸
                                                </button>
                                            ) : (
                                                <>
                                                    <div className="px-3 py-2 text-xs text-gray-500 dark:text-gray-400 border-b dark:border-gray-700 mb-1 truncate">
                                                        {userProfile?.full_name || verifiedEmail}
                                                        <span className={`ml-2 text-[9px] px-1 rounded font-bold ${isPro ? 'bg-amber-100 text-amber-700' : 'bg-gray-100 text-gray-500'}`}>
                                                            {isPro ? 'PRO' : 'FREE'}
                                                        </span>
                                                        {/* [ì¶”ê°€] ëª¨ë°”ì¼ ë©”ë‰´ ë‚´ ë™ê¸°í™” ìƒíƒœ í‘œì‹œ */}
                                                        {isPro && (
                                                            <div className="flex items-center gap-1 mt-1">
                                                                <span className={`text-[9px] flex items-center gap-1 ${syncStatus === 'synced' ? 'text-green-600' : syncStatus === 'syncing' ? 'text-yellow-600' : syncStatus === 'error' ? 'text-red-600' : 'text-gray-400'}`}>
                                                                    <span className={`w-1.5 h-1.5 rounded-full ${syncStatus === 'synced' ? 'bg-green-500' : syncStatus === 'syncing' ? 'bg-yellow-500 animate-pulse' : syncStatus === 'error' ? 'bg-red-500' : 'bg-gray-300'}`}></span>
                                                                    {syncStatus === 'synced' ? 'ë™ê¸°í™”ë¨' : syncStatus === 'syncing' ? 'ë™ê¸°í™” ì¤‘' : syncStatus === 'error' ? 'ë™ê¸°í™” ì‹¤íŒ¨' : 'ëŒ€ê¸°'}
                                                                </span>
                                                            </div>
                                                        )}
                                                    </div>
                                                    <button onClick={() => fetchFromCloud(verifiedEmail, isPro, false, true)} className="w-full text-left px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-gray-200 text-sm">ğŸ”„ í´ë¼ìš°ë“œ ë™ê¸°í™”</button>
                                                    <button onClick={() => setIsSuggestionModalOpen(true)} className="w-full text-left px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-gray-200 text-sm">ğŸ’¡ ê¸°ëŠ¥ ì œì•ˆ</button>
                                                    <button onClick={handleLogout} className="w-full text-left px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-gray-200 text-red-500 text-sm">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
                                                </>
                                            )}
                                            <div className="border-t dark:border-gray-700 my-1"></div>
                                            <button onClick={handleDarkModeToggle} className="w-full text-left px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-gray-200 flex items-center">
                                                {!isPro && (
                                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-3.5 w-3.5 mr-2 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clipRule="evenodd" /></svg>
                                                )}
                                                {darkMode ? 'â˜€ï¸ ë¼ì´íŠ¸ëª¨ë“œ' : 'ğŸŒ™ ë‹¤í¬ëª¨ë“œ'}
                                            </button>
                                            <button onClick={saveToPDF} className="w-full text-left px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-gray-200">ğŸ“„ PDF ì €ì¥</button>
                                            <button onClick={saveScenario} className="w-full text-left px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-gray-200">ğŸ’¾ ì‹œë‚˜ë¦¬ì˜¤ ì €ì¥</button>
                                            <button onClick={saveAsDefault} className="w-full text-left px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-gray-200">â­ ê¸°ë³¸ê°’ ì €ì¥</button>
                                            <button onClick={loadCustomDefault} className="w-full text-left px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-gray-200">â†©ï¸ ê¸°ë³¸ê°’ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                                        </div>
                                    </details>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* ===== ë©”ì¸ ì½˜í…ì¸  ===== */}
                    <div id="dashboard-content" className="p-4 sm:p-6 max-w-[90rem] mx-auto flex flex-col lg:flex-row gap-8">
                        {/* [ì¶”ê°€] ì‚¬ì´ë“œë°” ë‚´ë¹„ê²Œì´ì…˜ */}
                        <aside className="hidden lg:block w-52 flex-shrink-0">
                            <div className="sticky top-24 space-y-4">
                            {/* í´ë¼ìš°ë“œ ë™ê¸°í™” ì¹´ë“œ */}
                            <div className="mb-4 p-3 bg-gradient-to-br from-indigo-50 to-blue-50 dark:from-indigo-900/20 dark:to-blue-900/20 rounded-xl border border-indigo-100 dark:border-indigo-800 shadow-sm">
                                <div className="flex items-center justify-between mb-2">
                                    <span className="text-[10px] font-bold text-indigo-600 dark:text-indigo-400 uppercase tracking-wider flex items-center gap-1">
                                        Cloud Sync
                                        {syncStatus === 'error' && <span title={syncError} className="cursor-help text-red-500">âš ï¸</span>}
                                    </span>
                                    {verifiedEmail && isPro && (
                                        <div className="flex items-center gap-1.5">
                                            <span className={`text-[9px] font-medium ${syncStatus === 'synced' ? 'text-green-600' : syncStatus === 'syncing' ? 'text-yellow-600' : syncStatus === 'error' ? 'text-red-600' : 'text-gray-400'}`}>
                                                {syncStatus === 'synced' ? 'ë™ê¸°í™”ë¨' : syncStatus === 'syncing' ? 'ë™ê¸°í™” ì¤‘' : syncStatus === 'error' ? 'ë™ê¸°í™” ì‹¤íŒ¨' : 'ëŒ€ê¸°'}
                                            </span>
                                            <div className={`w-2 h-2 rounded-full ${syncStatus === 'synced' ? 'bg-green-500' : syncStatus === 'syncing' ? 'bg-yellow-500 animate-pulse' : syncStatus === 'error' ? 'bg-red-500' : 'bg-gray-300'}`}></div>
                                        </div>
                                    )}
                                </div>
                                
                                {isLoadingCloud ? (
                                    <div className="py-2 text-center">
                                        <div className="inline-block w-4 h-4 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin mb-1"></div>
                                        <div className="text-[10px] text-indigo-600 font-medium">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                                    </div>
                                ) : !verifiedEmail ? (
                                    <button 
                                        onClick={handleLogin} 
                                        className="w-full py-2 bg-white border border-gray-300 text-gray-700 rounded-lg text-[11px] font-bold flex items-center justify-center gap-2 hover:bg-gray-50 transition-colors shadow-sm"
                                    >
                                        <svg className="w-3 h-3" viewBox="0 0 24 24">
                                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/>
                                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                        </svg>
                                        Googleë¡œ ë¡œê·¸ì¸
                                    </button>
                                ) : (
                                    <div className="space-y-2">
                                        <div className="flex items-center gap-2">
                                            <div className="flex-1 min-w-0">
                                                <div className="text-[10px] font-bold text-gray-800 dark:text-gray-200 truncate">
                                                    {userProfile?.full_name || verifiedEmail}
                                                </div>
                                                <div className="flex items-center gap-1 mt-0.5">
                                                    <span className={`text-[8px] px-1 rounded font-bold ${isPro ? 'bg-amber-100 text-amber-700' : 'bg-gray-100 text-gray-500'}`}>
                                                        {isPro ? 'PRO' : 'FREE'}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="grid grid-cols-1 gap-1.5 mt-2">
                                            {isPro && (
                                                <button 
                                                    onClick={async () => {
                                                        const { data: { session } } = await supabase.auth.getSession();
                                                        if (session) checkSubscription(session, true);
                                                    }}
                                                    className="w-full py-2 bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-lg text-[10px] font-bold hover:bg-blue-100 dark:hover:bg-blue-900/50 transition-all border border-blue-100 dark:border-blue-800"
                                                >
                                                    ğŸ’³ êµ¬ë… ìƒíƒœ í™•ì¸
                                                </button>
                                            )}
                                            {!isPro && (
                                                <button 
                                                    onClick={async () => {
                                                        const code = prompt('ë°œê¸‰ë°›ì€ í›„ì› ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
                                                        if (code) {
                                                            setIsLoadingCloud(true);
                                                            try {
                                                                const { data, error } = await supabase.rpc('redeem_code', { input_code: code.trim() });
                                                                if (error) throw error;
                                                                if (data) {
                                                                    alert('ğŸ‰ í›„ì› ì½”ë“œê°€ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤! PRO ëª¨ë“œê°€ í™œì„±í™”ë©ë‹ˆë‹¤.');
                                                                    const { data: { session } } = await supabase.auth.getSession();
                                                                    if (session) checkSubscription(session, true);
                                                                } else {
                                                                    alert('âŒ ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ ì´ë¯¸ ì‚¬ìš©ëœ ì½”ë“œì…ë‹ˆë‹¤.');
                                                                }
                                                            } catch (err) {
                                                                console.error('Redeem error:', err);
                                                                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
                                                            } finally {
                                                                setIsLoadingCloud(false);
                                                            }
                                                        }
                                                    }}
                                                    className="w-full py-2 bg-green-50 dark:bg-green-900/30 text-green-600 dark:text-green-400 rounded-lg text-[10px] font-bold hover:bg-green-100 dark:hover:bg-green-900/50 transition-all border border-green-100 dark:border-green-800"
                                                >
                                                    ğŸ« í›„ì› ì½”ë“œ ë“±ë¡
                                                </button>
                                            )}
                                            {isPro && (
                                            <button 
                                                onClick={() => fetchFromCloud(verifiedEmail, isPro, false, true)} 
                                                className="w-full py-2 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 rounded-lg text-[10px] font-bold hover:bg-indigo-100 dark:hover:bg-indigo-900/50 transition-all border border-indigo-100 dark:border-indigo-800"
                                            >
                                                ğŸ”„ í´ë¼ìš°ë“œ ê°•ì œ ë™ê¸°í™”
                                            </button>
                                            )}
                                            <button 
                                                onClick={() => setIsSuggestionModalOpen(true)} 
                                                className="w-full py-2 bg-yellow-50 dark:bg-yellow-900/30 text-yellow-600 dark:text-yellow-400 rounded-lg text-[10px] font-bold hover:bg-yellow-100 dark:hover:bg-yellow-900/50 transition-all border border-yellow-100 dark:border-yellow-800"
                                            >
                                                ğŸ’¡ ê¸°ëŠ¥ ì œì•ˆ / ë²„ê·¸ ì‹ ê³ 
                                            </button>
                                            <button 
                                                onClick={handleLogout} 
                                                className="w-full py-2 bg-gray-50 dark:bg-gray-800 text-gray-500 dark:text-gray-400 rounded-lg text-[10px] font-bold hover:bg-red-50 hover:text-red-500 dark:hover:bg-red-900/20 transition-all border border-gray-200 dark:border-gray-700"
                                            >
                                                ğŸšª ë¡œê·¸ì•„ì›ƒ
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>

                            <div className="space-y-1 bg-white dark:bg-gray-900 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-800">
                                <div className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4 px-2">ë¹ ë¥¸ ì´ë™</div>
                                {layoutOrder.filter(id => {
                                    if (id === 'scenario') return scenarios.length > 0;
                                    if (id === 'history') return assetHistory.length > 0;
                                    return true;
                                }).map(id => (
                                    <button key={id} onClick={() => scrollToPanel(id)} className="w-full text-left px-2 py-2 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-lg transition-all flex items-center gap-2 group">
                                        <span className="group-hover:scale-110 transition-transform">{navLabels[id]?.icon}</span>
                                        <span className="truncate">{navLabels[id]?.title}</span>
                                    </button>
                                ))}
                            </div>
                            </div>
                        </aside>

                        <div className="flex-1 space-y-8 min-w-0">
                            {layoutOrder.map((panelId, index) => {
                                const panelProps = { 
                                    key: panelId,
                                    id: panelId,
                                    moveUp: () => movePanel(panelId, -1),
                                    moveDown: () => movePanel(panelId, 1),
                                    isFirst: index === 0,
                                    isLast: index === layoutOrder.length - 1,
                                    isCollapsed: !!panelCollapseState[panelId],
                                    onToggle: () => togglePanelCollapse(panelId),
                                };

                                const { renderSummaryPanel, renderScenarioPanel, renderChartsPanel, renderHistoryPanel, renderBudgetPanel, renderMemoPanel, renderRebalancePanel, renderAssetsPanel, renderExpensesPanel, renderEventsPanel, renderDetailAnalysisPanel, renderAssumptionsPanel } = renderFunctions; 

                                switch (panelId) {
                                    case 'summary':
                                        return (
                                            <PanelWrapper {...panelProps} title="ğŸ“Š ìš”ì•½ ë° ì„¤ì •" className="bg-white dark:bg-gray-900 rounded-lg shadow">
                                                {renderSummaryPanel()}
                                                {calculation.warnings && calculation.warnings.length > 0 && (
                                                    <div className="mt-6 p-4 bg-red-50 dark:bg-red-900/20 border-l-4 border-red-500 rounded shadow-sm">
                                                        <h3 className="text-sm font-bold text-red-800 dark:text-red-400 mb-2 flex items-center gap-2">âš ï¸ ì‹œë®¬ë ˆì´ì…˜ ê²½ê³  ({calculation.warnings.length}ê±´)</h3>
                                                        <ul className="text-xs text-red-700 dark:text-red-300 list-disc list-inside space-y-1 max-h-40 overflow-y-auto">
                                                            {calculation.warnings.map((w, i) => (
                                                                <li key={i}>[ì›” {w.month}] {w.message}</li>
                                                            ))}
                                                        </ul>
                                                    </div>
                                                )}
                                            </PanelWrapper>
                                        );
                                    case 'scenario': 
                                        return scenarios.length > 0 && (
                                            <PanelWrapper key={panelId} {...panelProps} title="ğŸ”€ ì‹œë‚˜ë¦¬ì˜¤ ë¹„êµ" className="bg-gray-50 dark:bg-gray-900 rounded-lg shadow">
                                                {renderScenarioPanel()}
                                            </PanelWrapper>
                                        );
                                    case 'charts':
                                        return (
                                            <PanelWrapper key={panelId} {...panelProps} title="ğŸ© í¬íŠ¸í´ë¦¬ì˜¤ ì°¨íŠ¸">
                                                {renderChartsPanel()}
                                            </PanelWrapper>
                                        );
                                    case 'history':
                                        return assetHistory.length > 0 && (
                                            <PanelWrapper key={panelId} {...panelProps} title="ğŸ“ˆ ìì‚° íˆìŠ¤í† ë¦¬">
                                                {renderHistoryPanel()}
                                            </PanelWrapper>
                                        );
                                    case 'budget':
                                        return (
                                            <PanelWrapper key={panelId} {...panelProps} title="ğŸ’° ì›”ë‚©ì… ì˜ˆì‚° ê´€ë¦¬">
                                                {renderBudgetPanel()}
                                            </PanelWrapper>
                                        );
                                    case 'memo':
                                        return (
                                            <PanelWrapper key={panelId} {...panelProps} title="ğŸ“ ë©”ëª¨">
                                                {renderMemoPanel()}
                                            </PanelWrapper>
                                        );
                                    case 'rebalance':
                                        return (
                                            <PanelWrapper key={panelId} {...panelProps} title="âš ï¸ ë¦¬ë°¸ëŸ°ì‹± ì„¤ì •">
                                                {renderRebalancePanel()}
                                            </PanelWrapper>
                                        );
                                    case 'assets':
                                        return (
                                            <PanelWrapper key={panelId} {...panelProps} title="ğŸ¦ ìì‚° ìƒì„¸ ì…ë ¥">
                                                {renderAssetsPanel()}
                                            </PanelWrapper>
                                        );
                                    case 'expenses':
                                        return (
                                            <PanelWrapper key={panelId} {...panelProps} title="ğŸ’¸ ì›”ë³„ ì§€ì¶œ ê´€ë¦¬">
                                                {renderExpensesPanel()}
                                            </PanelWrapper>
                                        );
                                    case 'events':
                                        return (
                                            <PanelWrapper key={panelId} {...panelProps} title="ğŸ‰ ì´ë²¤íŠ¸ ê´€ë¦¬">
                                                {renderEventsPanel()}
                                            </PanelWrapper>
                                        );
                                    case 'detail-analysis':
                                        return (
                                            <PanelWrapper key={panelId} {...panelProps} title="ğŸ” ìƒì„¸ ë¶„ì„">
                                                {renderDetailAnalysisPanel()}
                                            </PanelWrapper>
                                        );
                                    case 'assumptions':
                                        return (
                                            <PanelWrapper key={panelId} {...panelProps} title="ğŸ’¡ ê³„ì‚° ê°€ì •ì‚¬í•­" className="bg-sky-50 dark:bg-gray-900 rounded-lg shadow">
                                                {renderAssumptionsPanel()}
                                            </PanelWrapper>
                                        );
                                    default: return null;
                                }
                            })}
                            {/* [ì¶”ê°€] í•˜ë‹¨ í‘¸í„° (ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨) */}
                            <div className="mt-12 pt-6 border-t dark:border-gray-800 text-center">
                                <button 
                                    onClick={() => setIsPrivacyModalOpen(true)} 
                                    className="text-xs text-gray-500 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 hover:underline transition-colors"
                                >
                                    ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨
                                </button>
                                <span className="mx-2 text-gray-300 dark:text-gray-700">|</span>
                                <span className="text-xs text-gray-400 dark:text-gray-600">Â© 2024 Asset Planner</span>
                            </div>
                        </div>

                        {/* ===== ëª¨ë°”ì¼ ë²„íŠ¼ ===== */}
                        <div className="sm:hidden flex flex-col gap-2">
                            <button onClick={saveToPDF} className="w-full bg-blue-600 text-white py-3 rounded-lg font-medium">
                                ğŸ“„ PDFë¡œ ì €ì¥
                            </button>
                            <button onClick={saveScenario} className="w-full bg-gray-600 text-white py-3 rounded-lg font-medium">
                                ğŸ’¾ ì‹œë‚˜ë¦¬ì˜¤ ì €ì¥
                            </button>
                        </div>
                    </div>
                    {/* ===== ë¸”ë¡œê·¸ ë°°ë„ˆ ===== */}
                    {!isPro && (
                        <a href="https://blog.naver.com/zocdoc" target="_blank" rel="noopener noreferrer" title="ë¸”ë¡œê·¸ ë°©ë¬¸í•˜ê¸°" className="fixed bottom-5 right-5 z-50 p-3 bg-white dark:bg-gray-800 rounded-full shadow-lg hover:shadow-xl transition-all transform hover:scale-110">
                            <img src="https://blogpfthumb-phinf.pstatic.net/MjAyMzExMDlfMTY2/MDAxNjk5NTM1OTEzNTY2.eBsibH7tHEJ5FeB3gSWJ3hGqz6mbgqM2TsSKS7c2QRog.CNgc4PQL7zumVLSD72sVI_EB6tsPO_Cwd_LKNj0MiyAg.JPEG.whrekrdl/161.jpg/161.jpg?type=w161" alt="ë„¤ì´ë²„ ë¸”ë¡œê·¸" className="w-10 h-10"/>
                        </a>
                    )}
                    <DataTransferModal 
                        isOpen={isExportModalOpen} 
                        onClose={() => setIsExportModalOpen(false)} 
                        onConfirm={handleExport} 
                        type="export"
                        initialSelection={exportSelection}
                    />
                    <DataTransferModal 
                        isOpen={isImportModalOpen} 
                        onClose={() => setIsImportModalOpen(false)} 
                        onConfirm={(selection) => handleImport(selection)} 
                        type="import"
                        initialSelection={importSelection}
                    />
                    <PrivacyPolicyModal 
                        isOpen={isPrivacyModalOpen} 
                        onClose={() => setIsPrivacyModalOpen(false)} 
                    />
                    <SuggestionModal 
                        isOpen={isSuggestionModalOpen} 
                        onClose={() => setIsSuggestionModalOpen(false)} 
                        onSubmit={handleSuggestionSubmit}
                    />
                    <ProFeaturesModal 
                        isOpen={isProModalOpen} 
                        onClose={() => setIsProModalOpen(false)} 
                    />
                    {calculation.warnings?.length > 0 && (
                        <div className="fixed inset-0 border-[6px] border-red-500 pointer-events-none z-[9999] animate-pulse opacity-60"></div>
                    )}

                    {/* Mobile Floating Quick Panel (Upgrade) */}
                    <button 
                        onClick={() => setIsQuickPanelOpen(true)}
                        className="sm:hidden fixed bottom-6 right-6 z-50 w-14 h-14 bg-blue-600 text-white rounded-full shadow-2xl flex items-center justify-center text-2xl hover:bg-blue-700 transition-transform active:scale-95"
                        aria-label="Quick Menu"
                    >
                        âš¡
                    </button>

                    {isQuickPanelOpen && (
                        <div className="sm:hidden fixed inset-0 z-[60] bg-black/60 backdrop-blur-sm flex items-end justify-center p-4" onClick={() => setIsQuickPanelOpen(false)}>
                            <div className="bg-white dark:bg-gray-800 w-full rounded-2xl p-6 shadow-2xl animate-in slide-in-from-bottom duration-300" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-lg font-bold text-gray-900 dark:text-white">ë¹ ë¥¸ ì´ë™</h3>
                                    <button onClick={() => setIsQuickPanelOpen(false)} className="p-2 text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition-colors">
                                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" /></svg>
                                    </button>
                                </div>
                                <div className="grid grid-cols-3 gap-4">
                                    {layoutOrder.filter(id => navLabels[id]).map(id => (
                                        <button 
                                            key={id} 
                                            onClick={() => { scrollToPanel(id); setIsQuickPanelOpen(false); }}
                                            className="flex flex-col items-center gap-2 p-3 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                                        >
                                            <span className="text-2xl">{navLabels[id]?.icon}</span>
                                            <span className="text-[10px] font-medium text-gray-600 dark:text-gray-400 text-center">{navLabels[id]?.title}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}
                    <OnboardingGuide 
                        isOpen={isGuideOpen} 
                        onClose={() => setIsGuideOpen(false)} 
                        scrollToPanel={scrollToPanel}
                        isPro={isPro}
                    />
                    {/* [ì¶”ê°€] ì €ì¥ ì™„ë£Œ í† ìŠ¤íŠ¸ */}
                    {showSaveToast && (
                        <div className="fixed bottom-24 left-1/2 transform -translate-x-1/2 z-[100] bg-gray-900/90 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 animate-in fade-in slide-in-from-bottom-4 duration-300">
                            <span className="text-green-400 text-xl">âœ“</span>
                            <span className="text-sm font-bold tracking-tight">ë°ì´í„°ê°€ ì•ˆì „í•˜ê²Œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!</span>
                        </div>
                    )}
                    </div>
            );
        };
        const ScenarioCompare = ({ scenarios, sectorInfo, calculateMonthlyProjection, formatNumber }) => {
            const { useState, useMemo } = React;
            const [selectedIds, setSelectedIds] = useState([]);
            const toggle = (id) => setSelectedIds(prev => prev.includes(id) ? prev.filter(x=>x!==id) : (prev.length<3 ? [...prev,id] : prev));

            const selected = scenarios.filter(s => selectedIds.includes(s.id)).slice(0,3);
            
            const computeScenarioProjections = (scenarioData) => {
                // Use the main calculation logic to get monthly projections
                const tempAppData = { ...scenarioData }; // Create a temporary appData for calculation
                const result = calculateMonthlyProjection(tempAppData, scenarioData.projectionMonths || 12);
                return result.projections;
            };

            const results = useMemo(() => {
                return selected.map(s => ({
                    id: s.id,
                    name: s.name,
                    data: s.data,
                    projections: computeScenarioProjections(s.data)
                }));
            }, [selected]);

            // Determine common months for comparison
            const allMonths = results.flatMap(r => r.projections.map(p => p.month));
            const uniqueMonths = [...new Set(allMonths)].sort((a, b) => a - b);

            // Limit to max 12 comparison points, adjust for long periods
            const maxComparisonMonths = 12;
            let comparisonInterval = 1;
            if (uniqueMonths.length > maxComparisonMonths) {
                comparisonInterval = Math.ceil(uniqueMonths.length / maxComparisonMonths);
            }
            const displayMonths = uniqueMonths.filter((_, index) => index % comparisonInterval === 0);
            if (!displayMonths.includes(uniqueMonths[uniqueMonths.length - 1])) {
                displayMonths.push(uniqueMonths[uniqueMonths.length - 1]); // Always include the last month
            }


            const getMonthLabel = (monthIndex, baseMonthStr) => {
                try {
                    const [y,m] = (baseMonthStr || new Date().toISOString().slice(0,7)).split('-').map(Number);
                    const d = new Date(y, m - 1 + monthIndex);
                    return `${String(d.getFullYear()).slice(2)}ë…„ ${String(d.getMonth()+1).padStart(2,'0')}ì›”`;
                } catch { return `ì›” ${monthIndex}`; }
            };

            return (
                <div>
                    <div className="flex flex-wrap gap-2 mb-3">
                        {scenarios.map(s => (
                            <button key={s.id} onClick={() => toggle(s.id)} className={`px-3 py-1 border dark:border-gray-600 rounded ${selectedIds.includes(s.id) ? 'bg-blue-50 dark:bg-blue-900/40 border-blue-400 dark:border-blue-500 dark:text-blue-300' : 'hover:bg-gray-50 dark:hover:bg-gray-700 dark:text-gray-300'}`}>{s.name}</button>
                        ))}
                    </div>
                    {results.length > 0 ? (
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm dark:text-gray-300">
                                <thead className="bg-gray-100 dark:bg-gray-700">
                                    <tr>
                                        <th className="p-3 text-left">ì„¹í„°/í•­ëª©</th>
                                        {results.map(r => (<th key={r.id} className="p-3 text-right">{r.name} (ìµœì¢…)</th>))}
                                        {results.length === 2 && (
                                            <th className="p-3 text-right">ì°¨ì´(ê¸ˆì•¡/ë¹„ì¤‘)</th>
                                        )}
                                    </tr>
                                </thead>
                                <tbody>
                                    {Object.keys(sectorInfo).map(sectorKey => (
                                        <React.Fragment key={sectorKey}>
                                            <tr className="border-t dark:border-gray-700">
                                                <td className="p-3 font-semibold">{sectorInfo[sectorKey].icon} {sectorInfo[sectorKey].name}</td>
                                                {results.map(r => {
                                                    const finalProjection = r.projections[r.projections.length - 1];
                                                    const sectorTotal = finalProjection?.sectorTotals[sectorKey] || { amount: 0, percentage: 0 };
                                                    return (
                                                        <td key={r.id} className="p-3 text-right">
                                                            {formatNumber(sectorTotal.amount)} ({(sectorTotal.percentage || 0).toFixed(1)}%)
                                                        </td>
                                                    );
                                                })}
                                                {results.length === 2 && (
                                                    <td className="p-3 text-right text-indigo-700 dark:text-indigo-400">
                                                        {(() => {
                                                            const finalA = results[0].projections[results[0].projections.length - 1];
                                                            const finalB = results[1].projections[results[1].projections.length - 1];
                                                            const amountA = finalA?.sectorTotals[sectorKey]?.amount || 0;
                                                            const amountB = finalB?.sectorTotals[sectorKey]?.amount || 0;
                                                            const percentA = finalA?.sectorTotals[sectorKey]?.percentage || 0;
                                                            const percentB = finalB?.sectorTotals[sectorKey]?.percentage || 0;
                                                            const diffAmount = amountB - amountA;
                                                            const diffPercent = percentB - percentA;
                                                            const signAmount = diffAmount >= 0 ? '+' : '';
                                                            const signPercent = diffPercent >= 0 ? '+' : '';
                                                            const isGood = sectorKey === 'loan' ? diffAmount <= 0 : diffAmount >= 0;
                                                            const color = isGood ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
                                                            return (
                                                                <div className={color}>
                                                                    <span>{signAmount}{formatNumber(diffAmount)}</span>
                                                                    <span className="text-xs ml-1">({signPercent}{diffPercent.toFixed(1)}%)</span>
                                                                </div>
                                                            );
                                                        })()}
                                                    </td>
                                                )}
                                            </tr>
                                            {(() => {
                                                const allItems = new Map();
                                                results.forEach(r => {
                                                    const finalProjection = r.projections[r.projections.length - 1];
                                                    finalProjection?.itemTotals[sectorKey]?.forEach(item => {
                                                        const key = item.id || item.name;
                                                        if (!allItems.has(key)) {
                                                            allItems.set(key, { name: item.name });
                                                        }
                                                    });
                                                });
                                                return Array.from(allItems.entries());
                                            })().map(([key, { name }]) => (
                                                <tr key={`${sectorKey}-${key}`} className="border-t dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50">
                                                    <td className="p-3 pl-8 text-sm text-gray-600 dark:text-gray-400">â”” {name}</td>
                                                    {results.map(r => {
                                                        const finalProjection = r.projections[r.projections.length - 1]; 
                                                        const items = finalProjection?.itemTotals[sectorKey] || [];
                                                        const itemData = items.find(item => (item.id || item.name) === key) || { amount: 0, percentage: 0 };
                                                        return (
                                                            <td key={r.id} className="p-3 text-right text-sm">
                                                                <div>{formatNumber(itemData.amount)}</div>
                                                            </td>
                                                        );
                                                    })}
                                                    {results.length === 2 && (
                                                        <td className="p-3 text-right text-sm text-indigo-700 dark:text-indigo-400">
                                                            {(() => {
                                                                const finalA = results[0].projections[results[0].projections.length - 1]; 
                                                                const finalB = results[1].projections[results[1].projections.length - 1]; 
                                                                const itemsA = finalA?.itemTotals[sectorKey] || [];
                                                                const itemsB = finalB?.itemTotals[sectorKey] || [];
                                                                const itemA = itemsA.find(item => (item.id || item.name) === key) || { amount: 0, percentage: 0 };
                                                                const itemB = itemsB.find(item => (item.id || item.name) === key) || { amount: 0, percentage: 0 };

                                                                const diffAmount = itemB.amount - itemA.amount;
                                                                const signAmount = diffAmount >= 0 ? '+' : '';
                                                                const isGood = sectorKey === 'loan' ? diffAmount <= 0 : diffAmount >= 0;
                                                                const color = isGood ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
                                                                return (
                                                                    <div className={color}>
                                                                        <div>{signAmount}{formatNumber(diffAmount)}</div>
                                                                    </div>
                                                                );
                                                            })()}
                                                        </td>
                                                    )}
                                                </tr>
                                            ))
                                            }
                                        </React.Fragment>
                                    ))}
                                    <tr className="border-t-2 border-gray-400 dark:border-gray-600 bg-gray-100 dark:bg-gray-700">
                                        <td className="p-3 font-bold">ì´ê³„</td>
                                        {results.map(r => {
                                            const finalProjection = r.projections[r.projections.length - 1];
                                            return (
                                                <td key={r.id} className="p-3 text-right font-bold">{formatNumber(finalProjection?.total || 0)}</td>
                                            );
                                        })}
                                        {results.length === 2 && (
                                            <td className="p-3 text-right font-bold text-indigo-700 dark:text-indigo-400">
                                                {(() => { 
                                                    const finalA = results[0].projections[results[0].projections.length - 1];
                                                    const finalB = results[1].projections[results[1].projections.length - 1];
                                                    const diff = (finalB?.total || 0) - (finalA?.total || 0); 
                                                    const sign = diff >= 0 ? '+' : '';
                                                    const color = diff >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
                                                    return (
                                                        <div className={color}>{sign}{formatNumber(diff)}</div>
                                                    );
                                                })()}
                                            </td>
                                        )}
                                    </tr>
                                </tbody>
                            </table>

                            {/* Monthly Comparison Table */}
                            <h4 className="text-lg font-semibold text-gray-700 dark:text-gray-300 mt-8 mb-4">ì›”ë³„ ë¹„êµ (ìµœëŒ€ 12ê°œì›”)</h4>
                            <table className="w-full text-sm dark:text-gray-300">
                                <thead className="bg-gray-100 dark:bg-gray-700">
                                    <tr>
                                        <th className="p-3 text-left">ì›”ì°¨</th>
                                        {results.map(r => (<th key={r.id} className="p-3 text-right">{r.name} (ì´ìì‚°)</th>))}
                                        {results.length === 2 && (
                                            <th className="p-3 text-right">ì°¨ì´</th>
                                        )}
                                    </tr>
                                </thead>
                                <tbody>
                                    {displayMonths.map(monthIndex => {
                                        const monthLabel = getMonthLabel(monthIndex, results[0]?.data.baseMonth);
                                        return (
                                            <tr key={monthIndex} className="border-t dark:border-gray-700">
                                                <td className="p-3 font-semibold">{monthLabel}</td>
                                                {results.map(r => {
                                                    const projection = r.projections.find(p => p.month === monthIndex);
                                                    return (
                                                        <td key={r.id} className="p-3 text-right">
                                                            {projection ? formatNumber(projection.total) : '-'}
                                                        </td>
                                                    );
                                                })}
                                                {results.length === 2 && (
                                                    <td className="p-3 text-right text-indigo-700 dark:text-indigo-400">
                                                        {(() => {
                                                            const projA = results[0].projections.find(p => p.month === monthIndex);
                                                            const projB = results[1].projections.find(p => p.month === monthIndex);
                                                            if (projA && projB) {
                                                                const diff = projB.total - projA.total;
                                                                const sign = diff >= 0 ? '+' : '';
                                                                return `${sign}${formatNumber(diff)}`;
                                                            }
                                                            return '-';
                                                        })()}
                                                    </td>
                                                )}
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    ) : (
                        <div className="text-sm text-gray-500">ë¹„êµí•  ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ìµœëŒ€ 3ê°œ ì„ íƒí•˜ì„¸ìš”.</div>
                    )}
                </div>
            );
        };

     

        // ì—ëŸ¬ ë°”ìš´ë”ë¦¬ ì»´í¬ë„ŒíŠ¸
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }

            componentDidCatch(error, errorInfo) {
                console.error('Error caught by boundary:', error, errorInfo);
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen bg-red-50 flex flex-col items-center justify-center gap-4 p-4 text-red-800">
                            <div className="text-center max-w-md bg-white p-8 rounded-lg shadow-lg border border-red-200">
                                <h2 className="text-2xl font-bold mb-2">ì•—, ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤!</h2>
                                <p className="text-sm mb-4 text-gray-600">ì»´í¬ë„ŒíŠ¸ë¥¼ ë Œë”ë§í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>
                                <button 
                                    onClick={() => this.setState({ hasError: false, error: null })}
                                    className="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors"
                                >
                                    ë‹¤ì‹œ ì‹œë„
                                </button>
                            </div>
                            {this.state.error && (
                                <details className="text-gray-600 text-xs max-w-md">
                                    <summary className="cursor-pointer">Error details</summary>
                                    <pre className="mt-2 p-2 bg-red-900/20 rounded overflow-auto">
                                        {this.state.error.message}
                                    </pre>
                                </details>
                            )}
                        </div>
                    );
                }

                return this.props.children;
            }
        }

        ReactDOM.createRoot(document.getElementById('root')).render(
            <ErrorBoundary>
                <AssetDashboard />
            </ErrorBoundary>
        );
    </script>
</body>
</html>